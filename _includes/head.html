<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!-- Title -->
  <title>{% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}</title>

  <!-- Preconnect for Performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Critical CSS - Preload -->
  <link rel="preload" href="{{ '/assets/css/app.css' | relative_url }}" as="style">
  <link rel="stylesheet" href="{{ '/assets/css/app.css' | relative_url }}">

  <!-- Fonts - Optimized (reduced weights, async loading) -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap"></noscript>

  <!-- Favicon -->
  <link rel="shortcut icon" type="image/png" href="{{ '/favicon.png' | relative_url }}">
  <link rel="apple-touch-icon" href="{{ '/favicon.png' | relative_url }}">

  <!-- Theme Color -->
  <meta name="theme-color" content="#0a0a0a">
  <meta name="msapplication-TileColor" content="#0a0a0a">

  <!-- Google Search Console Verification -->
  <meta name="google-site-verification" content="NKf2WplkJcEPUejYK5B-wwvCLtHokxnALBswOe0XheM" />

  <!-- SEO -->
  {% seo %}

  <!-- Open Graph Enhanced -->
  <meta property="og:locale" content="zh_TW">
  {% if page.image %}
  <meta property="og:image" content="{{ page.image | absolute_url }}">
  {% elsif site.og_image %}
  <meta property="og:image" content="{{ site.og_image | absolute_url }}">
  {% endif %}

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  {% if site.twitter.username %}
  <meta name="twitter:site" content="@{{ site.twitter.username }}">
  <meta name="twitter:creator" content="@{{ site.twitter.username }}">
  {% endif %}

  <!-- JSON-LD Structured Data - WebSite -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "{{ site.title }}",
    "url": "{{ site.url }}",
    "description": "{{ site.description | escape }}",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "{{ site.url }}/search?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>

  <!-- JSON-LD Structured Data - Organization -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "{{ site.title }}",
    "url": "{{ site.url }}",
    "logo": "{{ '/favicon.png' | absolute_url }}",
    "sameAs": [
      "https://twitter.com/{{ site.twitter.username }}",
      "https://github.com/{{ site.social.github }}"
    ]
  }
  </script>

  <!-- JSON-LD Structured Data - Page/Article -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "{% if page.layout == 'post' %}Article{% else %}WebPage{% endif %}",
    "headline": "{{ page.title | default: site.title | escape }}",
    "description": "{{ page.description | default: page.excerpt | default: site.description | strip_html | truncate: 200 | escape }}",
    {% if page.date %}
    "datePublished": "{{ page.date | date_to_xmlschema }}",
    "dateModified": "{{ page.last_modified_at | default: page.date | date_to_xmlschema }}",
    {% endif %}
    "author": {
      "@type": "Organization",
      "name": "{{ site.author.name | default: site.title }}"
    },
    "publisher": {
      "@type": "Organization",
      "name": "{{ site.title }}",
      "logo": {
        "@type": "ImageObject",
        "url": "{{ '/favicon.png' | absolute_url }}"
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "{{ page.url | absolute_url }}"
    }
    {% if page.image %},
    "image": "{{ page.image | absolute_url }}"
    {% endif %}
    {% if page.tags %},
    "keywords": "{{ page.tags | join: ', ' }}"
    {% endif %}
  }
  </script>

  <!-- JSON-LD Structured Data - BreadcrumbList -->
  {% if page.url != "/" %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "首頁",
        "item": "{{ site.url }}"
      }
      {% assign path_parts = page.url | split: "/" %}
      {% assign current_path = "" %}
      {% for part in path_parts %}
        {% if part != "" %}
          {% assign current_path = current_path | append: "/" | append: part %}
          ,{
            "@type": "ListItem",
            "position": {{ forloop.index | plus: 1 }},
            "name": "{% if forloop.last %}{{ page.title | default: part }}{% else %}{{ part | capitalize }}{% endif %}",
            "item": "{{ site.url }}{{ current_path }}"
          }
        {% endif %}
      {% endfor %}
    ]
  }
  </script>
  {% endif %}

  <!-- KaTeX for Math Rendering -->
  {% if page.math or page.katex %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"
    onload="renderMathInElement(document.body, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '$', right: '$', display: false},
        {left: '\\[', right: '\\]', display: true},
        {left: '\\(', right: '\\)', display: false}
      ],
      throwOnError: false
    });"></script>
  {% endif %}

  <!-- Mermaid for Diagrams -->
  {% if page.mermaid %}
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      mermaid.initialize({
        startOnLoad: true,
        theme: 'dark',
        themeVariables: {
          primaryColor: '#166534',
          primaryTextColor: '#c9d1d9',
          primaryBorderColor: '#30363d',
          lineColor: '#4ade80',
          secondaryColor: '#1a1a1a',
          tertiaryColor: '#0d1117',
          background: '#0a0a0a',
          mainBkg: '#0d1117',
          secondBkg: '#161b22',
          nodeBorder: '#4ade80',
          clusterBkg: '#161b22',
          clusterBorder: '#30363d',
          titleColor: '#4ade80',
          edgeLabelBackground: '#0d1117',
          nodeTextColor: '#c9d1d9'
        },
        flowchart: {
          curve: 'basis',
          htmlLabels: true
        }
      });
    });
  </script>
  {% endif %}

  <!-- RSS Feed -->
  <link rel="alternate" type="application/rss+xml" title="{{ site.title }}" href="{{ '/feed.xml' | relative_url }}">

  <!-- Canonical URL -->
  <link rel="canonical" href="{{ page.url | absolute_url }}">

  <!-- Google Analytics -->
  {% if site.google_analytics and jekyll.environment == 'production' %}
  {% include google-analytics.html %}
  {% endif %}

  <!-- Dark Mode Script (防止閃爍) -->
  <script>
    // 立即設置主題，防止閃爍
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const defaultTheme = '{{ site.theme_settings.default_theme | default: "dark" }}';

      let theme;
      if (savedTheme) {
        theme = savedTheme;
      } else if (defaultTheme === 'auto') {
        theme = prefersDark ? 'dark' : 'light';
      } else {
        theme = defaultTheme;
      }

      document.documentElement.classList.toggle('dark', theme === 'dark');
      document.documentElement.classList.toggle('light', theme === 'light');
    })();
  </script>

  <!-- Custom Head Scripts -->
  {% include head-scripts.html %}
