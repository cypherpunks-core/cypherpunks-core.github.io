<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="zh-TW"><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://cypherpunks-core.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://cypherpunks-core.github.io/" rel="alternate" type="text/html" hreflang="zh-TW" /><updated>2026-01-07T06:27:14+00:00</updated><id>https://cypherpunks-core.github.io/feed.xml</id><title type="html">å¯†ç¢¼é¾å…‹ Cypherpunks Taiwan</title><subtitle>å¯†ç¢¼å­¸ä½¿è‡ªç”±å’Œéš±ç§å†æ¬¡å‰å¤§ã€‚Cryptography makes freedom and privacy great again.</subtitle><author><name>Cypherpunks Taiwan</name><email>01360086@me.mcu.edu.tw</email></author><entry><title type="html">Cypherpunks Taiwan å°èšåœ“æ»¿è½å¹•ï½œè¬è¬æ¯ä¸€ä½åƒèˆ‡é€™å ´è‡ªç”±æŠ€è¡“å°è©±çš„äºº</title><link href="https://cypherpunks-core.github.io/news/community/2025/04/01/Cypherpunks-Taiwan(8)/" rel="alternate" type="text/html" title="Cypherpunks Taiwan å°èšåœ“æ»¿è½å¹•ï½œè¬è¬æ¯ä¸€ä½åƒèˆ‡é€™å ´è‡ªç”±æŠ€è¡“å°è©±çš„äºº" /><published>2025-04-01T00:00:00+00:00</published><updated>2025-04-01T00:00:00+00:00</updated><id>https://cypherpunks-core.github.io/news/community/2025/04/01/Cypherpunks%20Taiwan(8)</id><content type="html" xml:base="https://cypherpunks-core.github.io/news/community/2025/04/01/Cypherpunks-Taiwan(8)/"><![CDATA[<p>3/31ï¼Œæˆ‘å€‘åœ¨ Tempo House äºŒæ¨“ï¼Œæ­£å¼å•Ÿå‹•äº† Cypherpunks Taiwan çš„é‡å•Ÿã€‚é€™æ˜¯ä¸€å ´é—œæ–¼éš±ç§ã€åˆ¶åº¦ã€è‡ªç”±æŠ€è¡“èˆ‡å»ä¸­å¿ƒåŒ–æœªä¾†çš„å°è©±ï¼Œä¹Ÿæ˜¯ä¸€å ´ç”±ç¤¾ç¾¤è‡ªç™¼ç™¼èµ·çš„é›†é«”è¡Œå‹•ã€‚æˆ‘å€‘æƒ³æ‰¾å›ä¸€å€‹ç©ºé–“ï¼Œè®“é—œå¿ƒé€™äº›è­°é¡Œçš„äººå¯ä»¥è¦‹é¢ã€äº¤æµã€å…±æŒ¯ã€‚</p>

<h2 id="-æ„Ÿè¬æ¯ä¸€ä½è¬›è€…ç‚ºç¾å ´å¸¶ä¾†æ·±åˆ»èˆ‡çœŸèª çš„è²éŸ³">ğŸ¤ æ„Ÿè¬æ¯ä¸€ä½è¬›è€…ï¼Œç‚ºç¾å ´å¸¶ä¾†æ·±åˆ»èˆ‡çœŸèª çš„è²éŸ³ï¼š</h2>

<ul>
  <li>
    <p><strong>Dr. Awesome Dogeï½œFounder @Cypherpunks Taiwan</strong></p>

    <p>ã€ŠRevive Cypherpunkã€‹</p>

    <p>å¯†ç¢¼é¾å…‹ä¸åªæ˜¯ç°¡å–®çš„æŠ€è¡“ç¤¾ç¾¤ï¼Œæ›´æ˜¯ä¸€å ´æŒçºŒé€²è¡Œçš„å€«ç†å¯¦è¸é‹å‹•ã€‚å¯†ç¢¼é¾å…‹å€‘å …ä¿¡ï¼š<strong>å”¯æœ‰é€éå¯†ç¢¼å­¸ï¼Œæˆ‘å€‘æ‰èƒ½åœ¨é«˜åº¦ç›£æ§çš„æ•¸ä½ç¤¾æœƒä¸­å¥ªå›è‡ªç”±èˆ‡ä¸»æ¬Š</strong>ã€‚é€™å ´æ´»å‹•è®“ä¾†è‡ªå„åœ‹çš„ Cypherpunks é½Šèšä¸€å ‚ï¼Œäº¤æµå¯¦è¸ç¶“é©—ï¼Œä¸¦å†æ¬¡å¼·èª¿é‚£å¥æ ¸å¿ƒä¿¡å¿µâ€”â€”<strong>ä»¥æŠ€è¡“ç‚ºå·¥å…·ï¼Œä»¥è‡ªç”±ç‚ºæ ¸å¿ƒã€‚</strong></p>
  </li>
  <li>
    <p><strong>Max Wuï½œ Co-Founder @HackMD</strong></p>

    <p>ã€ŠHackMD, the core of community and how it worksã€‹</p>

    <p><strong>HackMD æ˜¯å¯†ç¢¼é¾å…‹ç²¾ç¥åœ¨å”ä½œé ˜åŸŸçš„å¯¦è¸ã€‚é€éç°¡æ½”é–‹æ”¾çš„ Markdown èªè¨€ï¼Œçµåˆ OT èˆ‡ CRDT ç­‰åº•å±¤å”å®šï¼Œè®“ç¤¾ç¾¤èƒ½å¤ è‡ªç”±å»ºæ§‹çŸ¥è­˜ã€ç„¡éœ€ä»°è³´ä¸­å¿ƒåŒ–çš„å¯©æŸ¥èˆ‡æ§åˆ¶</strong>ã€‚æ­£å¦‚å¯†ç¢¼é¾å…‹å€‘ç”¨åŒ¿åç¶²è·¯èˆ‡åŠ å¯†é€šè¨Šå°æŠ—ç›£æ§è³‡æœ¬ä¸»ç¾©ï¼Œ<strong>Max ä¹Ÿé€éå·¥å…·è¨­è¨ˆï¼ŒæŒçºŒè³¦èƒ½ç¤¾ç¾¤ï¼Œå¯¦ç¾æŠ€è¡“ä¸Šçš„è‡ªä¸»èˆ‡è‡ªç”±ã€‚</strong></p>
  </li>
  <li>
    <p><strong>æ—æ—…å¼· Richardï½œ Co-Founder @é–‹æºç¤¾</strong></p>

    <p>ã€Šæˆ‘ï¼ˆå€‘ï¼‰èˆ‡ Cypherpunk çš„è·é›¢ã€‹</p>

    <p>Richard åœ¨å•†æ¥­é ˜åŸŸä¸­çš„è§’è‰²ï¼Œå¯ä»¥è¢«è¦–ç‚ºä¸€ç¨®<strong>å¯¦è¸å¯†ç¢¼é¾å…‹åŸå‰‡çš„åŠªåŠ›</strong>ã€‚Richard å–„ç”¨å…¶åœ¨æˆ°ç•¥å±¤é¢çš„å½±éŸ¿åŠ›ï¼Œå¼•å°æŠ€è¡“èˆ‡ç”¢å“çš„ç™¼å±•æ–¹å‘ï¼Œä½¿å…¶æ›´è²¼è¿‘å¯†ç¢¼é¾å…‹å°ã€Œæ•¸ä½è‡ªä¸»ã€ã€ã€ŒæŠ—è¡¡ç›£æ§ã€çš„æ ¸å¿ƒé¡˜æ™¯ã€‚é€™ç¨®å¯¦è¸å±•ç¾äº†å¯†ç¢¼é¾å…‹ç²¾ç¥åœ¨ç¾å¯¦ä¸–ç•Œä¸­çš„å¦ä¸€ç¨®å¯èƒ½ã€‚</p>
  </li>
  <li>
    <p><strong>Neil Leeï½œåŸ·è¡Œè‘£äº‹ @EchoX</strong></p>

    <p>ã€Šåœ¨ç›£ç®¡å£“åŠ›ä¸‹ï¼Œåˆè¦èˆ‡éš±ç§æŠ€è¡“çš„å¹³è¡¡ã€‹</p>

    <p>å»¶çºŒå¯†ç¢¼é¾å…‹ã€Œ<strong>æˆ‘å€‘ä¸æŒ‡æœ›æ”¿åºœæˆ–ä¼æ¥­çµ¦æˆ‘å€‘éš±ç§ï¼Œæˆ‘å€‘ç”¨å¯†ç¢¼å­¸æè¡›å®ƒ</strong>ã€çš„ç†å¿µï¼ŒNeil æ­£åœ¨ç›£ç®¡èˆ‡æŠ€è¡“çš„ç°è‰²åœ°å¸¶ä¸­ï¼Œæ¢ç´¢åˆè¦æ¡†æ¶ä¸‹çš„éš±ç§ä¿è­·ã€‚EchoX å°‹æ±‚åœ¨ã€Œé€æ˜ vs. éš±ç§ã€ä¹‹é–“æ‰¾åˆ°å¹³è¡¡é»ï¼Œè®“å€‹äººè²¡å‹™è³‡æ–™ä»èƒ½åœ¨æ³•è¦ä¸‹ä¿æŒæ‡‰æœ‰çš„è‡ªä¸»æ€§èˆ‡é˜²è­·åŠ›ã€‚</p>
  </li>
  <li>
    <p><strong>ç‰¹åˆ¥å˜‰è³“ï¼šå¯¶åšå£«ï¼ˆç¾ä»»ç«‹æ³•å§”å“¡ï¼‰ &amp; Peter @Plan B Network</strong></p>

    <p>å…©ä½çš„è‡¨æ™‚å°è«‡ï¼Œå¾æ”¿ç­–ç¾å ´èŠåˆ°ç”¢æ¥­éˆçµèˆ‡è³‡å®‰éš±ç§ï¼Œç²¾å½©å…§å®¹è®“ç¾å ´æ°£æ°›æ²¸é¨°ã€‚<strong>Plan B Network æ›´å¤§æ–¹è´ŠåŠ©å†·éŒ¢åŒ…</strong>ï¼Œè®“èˆ‡æœƒè€…é™¤äº†æ€æƒ³ä¸Šçš„æ”¶ç©«ï¼Œé‚„èƒ½å¯¦éš›å¸¶å›ä¸€ä»½å°è‡ªèº«è³‡ç”¢çš„åŠ å¯†ä¿éšœ</p>
  </li>
</ul>

<h2 id="-æ´»å‹•æˆæœ">ğŸ™ æ´»å‹•æˆæœ</h2>

<p>ç¾å ´è¶…é 60 äººåƒèˆ‡ï¼Œå¾æŠ€è¡“äººã€é–‹æºå·¥ä½œè€…ã€å…¬è·ã€ç ”ç©¶è€…åˆ°åœˆå¤–äººï¼Œé€™å ´æ´»å‹•è­‰æ˜äº†ï¼š</p>

<p><strong>é—œå¿ƒåˆ¶åº¦èˆ‡æŠ€è¡“çš„äººé‚„å¾ˆå¤šï¼Œåªæ˜¯ç¼ºä¸€å€‹èšåœ¨ä¸€èµ·çš„å ´åŸŸã€‚</strong></p>

<ul>
  <li>ğŸ“¸ è¬›è€…ç°¡å ±èˆ‡æ´»å‹•ç…§ç‰‡æ•´ç†ä¸­ï¼Œå¾ŒçºŒå°‡åˆ†äº«è‡³ç¤¾ç¾¤é »é“</li>
  <li>ğŸ“¬ æƒ³åƒèˆ‡ä¸‹ä¸€æ¬¡ï¼Ÿæ­¡è¿åŠ å…¥ Telegram ç¾¤çµ„ï¼š<a href="https://t.me/cypherpunkstw">https://t.me/cypherpunkstw</a></li>
</ul>

<h2 id="æœªä¾†å±•æœ›">æœªä¾†å±•æœ›</h2>

<p><strong>Cypherpunks write code â€” and build community.</strong></p>

<p>æˆ‘å€‘ä¸åªæ˜¯æ‡·èˆŠï¼Œè€Œæ˜¯è©¦è‘—å®šç¾©æœªä¾†çš„ã€Œé–‹æºç¤¾æœƒåŸºç¤å»ºè¨­ã€ã€‚</p>

<p>é€™å ´èšæœƒä¸æ˜¯çµ‚é»ï¼Œè€Œæ˜¯ä¸€è¡Œå‰› commit çš„ç¨‹å¼ç¢¼ã€‚</p>

<p>See you next round.</p>

<p>#CypherpunksTaiwan #Privacy #OpenSource #Web3 #Decentralization #CryptoCulture #TaiwanTechCommunity #HackMD #TONX #Tether #å»ä¸­å¿ƒåŒ– #è³‡æ–™ä¸»æ¬Š</p>

<h2 id="-æ´»å‹•ç²¾é¸ç…§ç‰‡">ğŸ“¸ æ´»å‹•ç²¾é¸ç…§ç‰‡</h2>

<p><img src="/img/151.png" alt="æ´»å‹•é–‹å ´ï¼šDr. Awesome Doge åˆ†äº«ã€ŒRevive Cypherpunkã€" /></p>

<p><img src="/img/152.png" alt="èˆ‡æœƒè€…å°ˆæ³¨è†è½è¬›è€…åˆ†äº«" /></p>

<p><img src="/img/153.png" alt="ç¾å ´äº¤æµè¨è«–ç†±çƒˆ" /></p>

<p><img src="/img/154.png" alt="Cypherpunks Taiwan ç¤¾ç¾¤å¤§åˆç…§" /></p>]]></content><author><name>Cypherpunks Taiwan</name></author><category term="news" /><category term="community" /><category term="cypherpunks" /><category term="privacy" /><category term="decentralization" /><category term="technology" /><category term="community" /><summary type="html"><![CDATA[3/31ï¼Œæˆ‘å€‘åœ¨ Tempo House äºŒæ¨“ï¼Œæ­£å¼å•Ÿå‹•äº† Cypherpunks Taiwan çš„é‡å•Ÿã€‚é€™æ˜¯ä¸€å ´é—œæ–¼éš±ç§ã€åˆ¶åº¦ã€è‡ªç”±æŠ€è¡“èˆ‡å»ä¸­å¿ƒåŒ–æœªä¾†çš„å°è©±ï¼Œä¹Ÿæ˜¯ä¸€å ´ç”±ç¤¾ç¾¤è‡ªç™¼ç™¼èµ·çš„é›†é«”è¡Œå‹•ã€‚æˆ‘å€‘æƒ³æ‰¾å›ä¸€å€‹ç©ºé–“ï¼Œè®“é—œå¿ƒé€™äº›è­°é¡Œçš„äººå¯ä»¥è¦‹é¢ã€äº¤æµã€å…±æŒ¯ã€‚]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://cypherpunks-core.github.io/img/151.png" /><media:content medium="image" url="https://cypherpunks-core.github.io/img/151.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Rust Bitcoin é–‹ç™¼å…¥é–€ï¼ˆå››ï¼‰ï¼šé€²éšæ‡‰ç”¨èˆ‡æ•´åˆ</title><link href="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/rust/2025/03/25/rust-bitcoin-tutorial-4-advanced-applications/" rel="alternate" type="text/html" title="Rust Bitcoin é–‹ç™¼å…¥é–€ï¼ˆå››ï¼‰ï¼šé€²éšæ‡‰ç”¨èˆ‡æ•´åˆ" /><published>2025-03-25T00:00:00+00:00</published><updated>2025-03-25T00:00:00+00:00</updated><id>https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/rust/2025/03/25/rust-bitcoin-tutorial-4-advanced-applications</id><content type="html" xml:base="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/rust/2025/03/25/rust-bitcoin-tutorial-4-advanced-applications/"><![CDATA[<p>é€™æ˜¯ Rust Bitcoin é–‹ç™¼å…¥é–€ç³»åˆ—çš„æœ€å¾Œä¸€ç¯‡ã€‚æœ¬ç¯‡æ¢è¨å¦‚ä½•æ§‹å»ºå®Œæ•´çš„ Bitcoin æ‡‰ç”¨ï¼ŒåŒ…æ‹¬èˆ‡ç¯€é»äº’å‹•ã€éŒ¢åŒ…é–‹ç™¼å’Œå¯¦éš›éƒ¨ç½²è€ƒé‡ã€‚</p>

<p><strong>ç³»åˆ—æ–‡ç« å°èˆªï¼š</strong></p>
<ul>
  <li><a href="/2025/03/22/rust-bitcoin-tutorial-1-environment-basics/">ç¬¬ä¸€ç¯‡ï¼šç’°å¢ƒè¨­ç½®èˆ‡åŸºç¤æ¦‚å¿µ</a></li>
  <li><a href="/2025/03/23/rust-bitcoin-tutorial-2-addresses-transactions/">ç¬¬äºŒç¯‡ï¼šåœ°å€ç”Ÿæˆèˆ‡äº¤æ˜“æ§‹å»º</a></li>
  <li><a href="/2025/03/24/rust-bitcoin-tutorial-3-scripts-signatures/">ç¬¬ä¸‰ç¯‡ï¼šè…³æœ¬èˆ‡ç°½å</a></li>
  <li><strong>ç¬¬å››ç¯‡ï¼šé€²éšæ‡‰ç”¨èˆ‡æ•´åˆ</strong>ï¼ˆæœ¬ç¯‡ï¼‰</li>
</ul>

<hr />

<h2 id="1-å€å¡Šéˆæ•¸æ“šå­˜å–ç­–ç•¥">1. å€å¡Šéˆæ•¸æ“šå­˜å–ç­–ç•¥</h2>

<h3 id="11-ç†è§£ä¸åŒçš„å­˜å–æ–¹å¼">1.1 ç†è§£ä¸åŒçš„å­˜å–æ–¹å¼</h3>

<p>è¦æ§‹å»ºå¯¦éš›çš„ Bitcoin æ‡‰ç”¨ï¼Œä½ éœ€è¦èˆ‡å€å¡Šéˆæ•¸æ“šäº’å‹•ã€‚æœ‰å¹¾ç¨®ä¸»è¦çš„æ–¹å¼å¯ä»¥åšåˆ°é€™ä¸€é»ï¼Œæ¯ç¨®éƒ½æœ‰å…¶å„ªç¼ºé»ã€‚</p>

<p><strong>Bitcoin Core RPC</strong> æ˜¯æœ€ç›´æ¥çš„æ–¹å¼ã€‚ä½ é‹è¡Œä¸€å€‹å®Œæ•´ç¯€é»ï¼Œé€é JSON-RPC ä»‹é¢æŸ¥è©¢æ•¸æ“šã€‚é€™ç¨®æ–¹å¼æä¾›äº†æœ€é«˜çš„å®‰å…¨æ€§å’Œéš±ç§æ€§â€”â€”ä½ ä¸ä¾è³´ä»»ä½•ç¬¬ä¸‰æ–¹ã€‚ç¼ºé»æ˜¯éœ€è¦å­˜å„²å®Œæ•´çš„å€å¡Šéˆï¼ˆæ•¸ç™¾ GBï¼‰ï¼Œä¸”åˆå§‹åŒæ­¥éœ€è¦æ•¸å¤©ã€‚</p>

<p><strong>Electrum å”è­°</strong> ä½¿ç”¨å®¢æˆ¶ç«¯-ä¼ºæœå™¨æ¨¡å¼ã€‚è¼•é‡ç´šå®¢æˆ¶ç«¯é€£æ¥åˆ° Electrum ä¼ºæœå™¨ï¼Œä¼ºæœå™¨ç¶­è­·ä¸€å€‹ç´¢å¼•çš„å€å¡Šéˆæ•¸æ“šåº«ã€‚å®¢æˆ¶ç«¯å¯ä»¥å¿«é€ŸæŸ¥è©¢åœ°å€é¤˜é¡å’Œäº¤æ˜“æ­·å²ï¼Œè€Œä¸éœ€è¦ä¸‹è¼‰å®Œæ•´å€å¡Šéˆã€‚ç¼ºé»æ˜¯ä½ éœ€è¦ä¿¡ä»»ä¼ºæœå™¨æä¾›æ­£ç¢ºçš„æ•¸æ“šï¼ˆé™¤éä½ è‡ªå·±é‹è¡Œä¼ºæœå™¨ï¼‰ã€‚</p>

<p><strong>Esplora API</strong> æ˜¯ Blockstream é–‹ç™¼çš„å¦ä¸€ç¨®è¼•é‡ç´šè§£æ±ºæ–¹æ¡ˆï¼Œé€é REST API æä¾›å€å¡Šéˆæ•¸æ“šã€‚å®ƒé¡ä¼¼æ–¼ Electrumï¼Œä½†ä½¿ç”¨æ¨™æº–çš„ HTTP ä»‹é¢ï¼Œæ›´å®¹æ˜“æ•´åˆã€‚</p>

<p>é¸æ“‡å“ªç¨®æ–¹å¼å–æ±ºæ–¼ä½ çš„æ‡‰ç”¨éœ€æ±‚ã€‚å°æ–¼å€‹äººéŒ¢åŒ…ï¼ŒElectrum æˆ– Esplora é€šå¸¸è¶³å¤ ã€‚å°æ–¼éœ€è¦æœ€é«˜å®‰å…¨æ€§çš„æ‡‰ç”¨ï¼ˆå¦‚äº¤æ˜“æ‰€ï¼‰ï¼Œä½ æ‡‰è©²é‹è¡Œè‡ªå·±çš„å®Œæ•´ç¯€é»ã€‚</p>

<h3 id="12-bitcoin-core-rpc">1.2 Bitcoin Core RPC</h3>

<p>Bitcoin Core æä¾›äº†ä¸€å€‹è±å¯Œçš„ JSON-RPC ä»‹é¢ï¼Œå¯ä»¥æŸ¥è©¢å€å¡Šéˆç‹€æ…‹ã€ç®¡ç†éŒ¢åŒ…å’Œå»£æ’­äº¤æ˜“ã€‚ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">bitcoincore-rpc</code> crate å¯ä»¥æ–¹ä¾¿åœ°å¾ Rust å­˜å–é€™å€‹ä»‹é¢ã€‚</p>

<p>é¦–å…ˆéœ€è¦é…ç½® Bitcoin Core å•Ÿç”¨ RPCï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre># bitcoin.conf
server=1
rpcuser=your_username
rpcpassword=your_password
rpcport=8332  # mainnet
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç„¶å¾Œåœ¨ Rust ä¸­é€£æ¥ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoincore_rpc</span><span class="p">::{</span><span class="n">Auth</span><span class="p">,</span> <span class="n">Client</span><span class="p">,</span> <span class="n">RpcApi</span><span class="p">};</span>

<span class="k">fn</span> <span class="nf">connect_to_node</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Client</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">rpc</span> <span class="o">=</span> <span class="nn">Client</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span>
        <span class="s">"http://127.0.0.1:8332"</span><span class="p">,</span>
        <span class="nn">Auth</span><span class="p">::</span><span class="nf">UserPass</span><span class="p">(</span><span class="s">"your_username"</span><span class="nf">.into</span><span class="p">(),</span> <span class="s">"your_password"</span><span class="nf">.into</span><span class="p">()),</span>
    <span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// é©—è­‰é€£æ¥</span>
    <span class="k">let</span> <span class="n">info</span> <span class="o">=</span> <span class="n">rpc</span><span class="nf">.get_blockchain_info</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"å·²é€£æ¥åˆ° Bitcoin Core"</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"å€å¡Šæ•¸: {}"</span><span class="p">,</span> <span class="n">info</span><span class="py">.blocks</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"åŒæ­¥é€²åº¦: {:.2}%"</span><span class="p">,</span> <span class="n">info</span><span class="py">.verification_progress</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">);</span>

    <span class="nf">Ok</span><span class="p">(</span><span class="n">rpc</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>RPC æä¾›äº†å»£æ³›çš„åŠŸèƒ½ã€‚ä½ å¯ä»¥æŸ¥è©¢å€å¡Šéˆä¿¡æ¯ã€ç²å–ç‰¹å®šå€å¡Šå’Œäº¤æ˜“ã€ç®¡ç†éŒ¢åŒ…ã€ä¼°ç®—è²»ç‡ã€å»£æ’­äº¤æ˜“ç­‰ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">rpc_examples</span><span class="p">(</span><span class="n">rpc</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Client</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// ç²å–æœ€æ–°å€å¡Š</span>
    <span class="k">let</span> <span class="n">best_hash</span> <span class="o">=</span> <span class="n">rpc</span><span class="nf">.get_best_block_hash</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">block</span> <span class="o">=</span> <span class="n">rpc</span><span class="nf">.get_block</span><span class="p">(</span><span class="o">&amp;</span><span class="n">best_hash</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"æœ€æ–°å€å¡ŠåŒ…å« {} ç­†äº¤æ˜“"</span><span class="p">,</span> <span class="n">block</span><span class="py">.txdata</span><span class="nf">.len</span><span class="p">());</span>

    <span class="c1">// ä¼°ç®—è²»ç‡ï¼ˆ6 å€å¡Šç¢ºèªç›®æ¨™ï¼‰</span>
    <span class="k">let</span> <span class="n">fee</span> <span class="o">=</span> <span class="n">rpc</span><span class="nf">.estimate_smart_fee</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="o">=</span> <span class="n">fee</span><span class="py">.fee_rate</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"å»ºè­°è²»ç‡: {} sat/vB"</span><span class="p">,</span> <span class="n">rate</span><span class="nf">.to_sat</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ç²å– mempool ç‹€æ…‹</span>
    <span class="k">let</span> <span class="n">mempool</span> <span class="o">=</span> <span class="n">rpc</span><span class="nf">.get_mempool_info</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Mempool ä¸­æœ‰ {} ç­†å¾…ç¢ºèªäº¤æ˜“"</span><span class="p">,</span> <span class="n">mempool</span><span class="py">.size</span><span class="p">);</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="13-electrum-å”è­°">1.3 Electrum å”è­°</h3>

<p>Electrum å”è­°è¨­è¨ˆç”¨æ–¼è¼•é‡ç´šå®¢æˆ¶ç«¯ã€‚å®ƒè®“ä½ å¯ä»¥å¿«é€ŸæŸ¥è©¢ç‰¹å®šåœ°å€çš„é¤˜é¡å’Œæ­·å²ï¼Œè€Œä¸éœ€è¦æƒææ•´å€‹å€å¡Šéˆã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">electrum_client</span><span class="p">::{</span><span class="n">Client</span><span class="p">,</span> <span class="n">ElectrumApi</span><span class="p">};</span>

<span class="k">fn</span> <span class="nf">electrum_example</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// é€£æ¥åˆ° Electrum ä¼ºæœå™¨</span>
    <span class="k">let</span> <span class="n">client</span> <span class="o">=</span> <span class="nn">Client</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"ssl://electrum.blockstream.info:60002"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// æŸ¥è©¢åœ°å€é¤˜é¡</span>
    <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="nn">Address</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="s">"bc1q..."</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">script</span> <span class="o">=</span> <span class="n">address</span><span class="nf">.script_pubkey</span><span class="p">();</span>

    <span class="k">let</span> <span class="n">balance</span> <span class="o">=</span> <span class="n">client</span><span class="nf">.script_get_balance</span><span class="p">(</span><span class="o">&amp;</span><span class="n">script</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"å·²ç¢ºèªé¤˜é¡: {} sat"</span><span class="p">,</span> <span class="n">balance</span><span class="py">.confirmed</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"æœªç¢ºèªé¤˜é¡: {} sat"</span><span class="p">,</span> <span class="n">balance</span><span class="py">.unconfirmed</span><span class="p">);</span>

    <span class="c1">// ç²å–äº¤æ˜“æ­·å²</span>
    <span class="k">let</span> <span class="n">history</span> <span class="o">=</span> <span class="n">client</span><span class="nf">.script_get_history</span><span class="p">(</span><span class="o">&amp;</span><span class="n">script</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"å…±æœ‰ {} ç­†ç›¸é—œäº¤æ˜“"</span><span class="p">,</span> <span class="n">history</span><span class="nf">.len</span><span class="p">());</span>

    <span class="c1">// ç²å–æœªèŠ±è²»è¼¸å‡º</span>
    <span class="k">let</span> <span class="n">utxos</span> <span class="o">=</span> <span class="n">client</span><span class="nf">.script_list_unspent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">script</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">utxo</span> <span class="k">in</span> <span class="n">utxos</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"UTXO: {}:{} - {} sat"</span><span class="p">,</span>
            <span class="n">utxo</span><span class="py">.tx_hash</span><span class="p">,</span> <span class="n">utxo</span><span class="py">.tx_pos</span><span class="p">,</span> <span class="n">utxo</span><span class="py">.value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Electrum çš„ä¸€å€‹é‡è¦ç‰¹æ€§æ˜¯è¨‚é–±åŠŸèƒ½ã€‚ä½ å¯ä»¥è¨‚é–±ç‰¹å®šåœ°å€çš„è®ŠåŒ–é€šçŸ¥ï¼Œé€™å°æ–¼æ”¯ä»˜è™•ç†å™¨ç­‰éœ€è¦ç›£æ§å…¥å¸³çš„æ‡‰ç”¨å¾ˆæœ‰ç”¨ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">monitor_address</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Client</span><span class="p">,</span> <span class="n">script</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Script</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// è¨‚é–±åœ°å€ç‹€æ…‹è®ŠåŒ–</span>
    <span class="k">let</span> <span class="n">status</span> <span class="o">=</span> <span class="n">client</span><span class="nf">.script_subscribe</span><span class="p">(</span><span class="n">script</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"åˆå§‹ç‹€æ…‹: {:?}"</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

    <span class="c1">// åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œä½ æœƒåœ¨å¾Œå°åŸ·è¡Œç·’ä¸­ç›£è½è®ŠåŒ–</span>
    <span class="c1">// ç•¶åœ°å€æ”¶åˆ°æ–°äº¤æ˜“æ™‚ï¼Œæœƒæ”¶åˆ°é€šçŸ¥</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="2-ä½¿ç”¨-bdk-æ§‹å»ºéŒ¢åŒ…">2. ä½¿ç”¨ BDK æ§‹å»ºéŒ¢åŒ…</h2>

<h3 id="21-ä»€éº¼æ˜¯-bdk">2.1 ä»€éº¼æ˜¯ BDK</h3>

<p>BDKï¼ˆBitcoin Development Kitï¼‰æ˜¯ä¸€å€‹ç¾ä»£åŒ–çš„éŒ¢åŒ…é–‹ç™¼æ¡†æ¶ã€‚å®ƒæŠ½è±¡äº†éŒ¢åŒ…é–‹ç™¼çš„è¤‡é›œæ€§ï¼Œè®“é–‹ç™¼è€…å¯ä»¥å°ˆæ³¨æ–¼æ‡‰ç”¨é‚è¼¯ï¼Œè€Œä¸æ˜¯åº•å±¤çš„å€å¡Šéˆç´°ç¯€ã€‚</p>

<p>BDK çš„è¨­è¨ˆç†å¿µæ˜¯åŸºæ–¼ã€Œæè¿°ç¬¦ã€ï¼ˆdescriptorsï¼‰ã€‚æè¿°ç¬¦æ˜¯ä¸€ç¨®æ¨™æº–åŒ–çš„æ–¹å¼ä¾†æè¿°å¦‚ä½•ç”Ÿæˆåœ°å€å’ŒèŠ±è²»è³‡é‡‘ã€‚é€™ç¨®æ–¹æ³•æ¯”å‚³çµ±çš„ã€Œåœ°å€åˆ—è¡¨ã€æ–¹å¼æ›´éˆæ´»ï¼Œå¯ä»¥è¼•é¬†æ”¯æŒå„ç¨®è…³æœ¬é¡å‹ï¼ˆP2PKHã€P2WPKHã€å¤šç°½ç­‰ï¼‰ã€‚</p>

<p>BDK çš„æ¶æ§‹åˆ†ç‚ºå¹¾å±¤ï¼š</p>

<p><strong>éŒ¢åŒ…å±¤</strong> è™•ç†åœ°å€ç”Ÿæˆã€äº¤æ˜“æ§‹å»ºå’Œç°½åã€‚å®ƒä¸é—œå¿ƒå¦‚ä½•ç²å–å€å¡Šéˆæ•¸æ“šæˆ–å¦‚ä½•å­˜å„²ç‹€æ…‹ã€‚</p>

<p><strong>å€å¡Šéˆå¾Œç«¯</strong> æä¾›å€å¡Šéˆæ•¸æ“šã€‚BDK æ”¯æŒå¤šç¨®å¾Œç«¯ï¼šElectrumã€Esploraã€Bitcoin Core RPC ç­‰ã€‚ä½ å¯ä»¥æ ¹æ“šéœ€æ±‚é¸æ“‡ã€‚</p>

<p><strong>æ•¸æ“šåº«å¾Œç«¯</strong> å­˜å„²éŒ¢åŒ…ç‹€æ…‹ï¼ˆå·²çŸ¥äº¤æ˜“ã€UTXO ç­‰ï¼‰ã€‚BDK æ”¯æŒå…§å­˜æ•¸æ“šåº«ã€SQLite ç­‰ã€‚</p>

<h3 id="22-å‰µå»º-bdk-éŒ¢åŒ…">2.2 å‰µå»º BDK éŒ¢åŒ…</h3>

<p>è®“æˆ‘å€‘å¾å‰µå»ºä¸€å€‹ç°¡å–®çš„éŒ¢åŒ…é–‹å§‹ã€‚æˆ‘å€‘å°‡ä½¿ç”¨åŠ©è¨˜è©ç”Ÿæˆå¯†é‘°ï¼Œå‰µå»ºåŸç”Ÿ SegWitï¼ˆBIP84ï¼‰éŒ¢åŒ…ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bdk</span><span class="p">::{</span>
    <span class="n">Wallet</span><span class="p">,</span>
    <span class="nn">database</span><span class="p">::</span><span class="n">MemoryDatabase</span><span class="p">,</span>
    <span class="nn">bitcoin</span><span class="p">::</span><span class="n">Network</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span> <span class="nn">bip39</span><span class="p">::</span><span class="n">Mnemonic</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">create_wallet</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Wallet</span><span class="o">&lt;</span><span class="n">MemoryDatabase</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="c1">// ç”Ÿæˆæ–°çš„åŠ©è¨˜è©ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­æ‡‰è©²è®“ç”¨æˆ¶å‚™ä»½ï¼‰</span>
    <span class="k">let</span> <span class="n">mnemonic</span> <span class="o">=</span> <span class="nn">Mnemonic</span><span class="p">::</span><span class="nf">generate</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"è«‹å‚™ä»½æ‚¨çš„åŠ©è¨˜è©: {}"</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">);</span>

    <span class="c1">// å¾åŠ©è¨˜è©æ´¾ç”Ÿä¸»å¯†é‘°</span>
    <span class="k">let</span> <span class="n">seed</span> <span class="o">=</span> <span class="n">mnemonic</span><span class="nf">.to_seed</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">xprv</span> <span class="o">=</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">bip32</span><span class="p">::</span><span class="nn">Xpriv</span><span class="p">::</span><span class="nf">new_master</span><span class="p">(</span><span class="nn">Network</span><span class="p">::</span><span class="n">Testnet</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seed</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// å‰µå»º BIP84 æè¿°ç¬¦</span>
    <span class="c1">// å¤–éƒ¨éˆï¼ˆæ¥æ”¶åœ°å€ï¼‰ï¼šm/84'/1'/0'/0/*</span>
    <span class="c1">// å…§éƒ¨éˆï¼ˆæ‰¾é›¶åœ°å€ï¼‰ï¼šm/84'/1'/0'/1/*</span>
    <span class="k">let</span> <span class="n">external</span> <span class="o">=</span> <span class="nd">format!</span><span class="p">(</span><span class="s">"wpkh({}/84'/1'/0'/0/*)"</span><span class="p">,</span> <span class="n">xprv</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">internal</span> <span class="o">=</span> <span class="nd">format!</span><span class="p">(</span><span class="s">"wpkh({}/84'/1'/0'/1/*)"</span><span class="p">,</span> <span class="n">xprv</span><span class="p">);</span>

    <span class="c1">// å‰µå»ºéŒ¢åŒ…</span>
    <span class="k">let</span> <span class="n">wallet</span> <span class="o">=</span> <span class="nn">Wallet</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="n">external</span><span class="p">,</span>
        <span class="nf">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="n">internal</span><span class="p">),</span>
        <span class="nn">Network</span><span class="p">::</span><span class="n">Testnet</span><span class="p">,</span>
        <span class="nn">MemoryDatabase</span><span class="p">::</span><span class="nf">default</span><span class="p">(),</span>
    <span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// ç”Ÿæˆå¹¾å€‹åœ°å€</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">ç”Ÿæˆçš„åœ°å€:"</span><span class="p">);</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..</span><span class="mi">3</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">wallet</span><span class="nf">.get_address</span><span class="p">(</span><span class="nn">bdk</span><span class="p">::</span><span class="nn">wallet</span><span class="p">::</span><span class="nn">AddressIndex</span><span class="p">::</span><span class="n">New</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"  {}: {}"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nf">Ok</span><span class="p">(</span><span class="n">wallet</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æè¿°ç¬¦çš„å¨åŠ›åœ¨æ–¼å…¶éˆæ´»æ€§ã€‚ä½ å¯ä»¥è¼•é¬†å‰µå»ºä¸åŒé¡å‹çš„éŒ¢åŒ…ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1">// å–®ç°½ P2WPKHï¼ˆåŸç”Ÿ SegWitï¼‰</span>
<span class="k">let</span> <span class="n">single_sig</span> <span class="o">=</span> <span class="s">"wpkh([fingerprint/84'/0'/0']xpub.../0/*)"</span><span class="p">;</span>

<span class="c1">// 2-of-3 å¤šç°½</span>
<span class="k">let</span> <span class="n">multisig</span> <span class="o">=</span> <span class="s">"wsh(multi(2,[fp1]xpub1.../0/*,[fp2]xpub2.../0/*,[fp3]xpub3.../0/*))"</span><span class="p">;</span>

<span class="c1">// Taproot</span>
<span class="k">let</span> <span class="n">taproot</span> <span class="o">=</span> <span class="s">"tr([fingerprint/86'/0'/0']xpub.../0/*)"</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="23-åŒæ­¥å’ŒæŸ¥è©¢">2.3 åŒæ­¥å’ŒæŸ¥è©¢</h3>

<p>å‰µå»ºéŒ¢åŒ…å¾Œï¼Œéœ€è¦èˆ‡å€å¡ŠéˆåŒæ­¥ä»¥ç²å–é¤˜é¡å’Œäº¤æ˜“æ­·å²ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bdk</span><span class="p">::{</span>
    <span class="nn">blockchain</span><span class="p">::{</span><span class="n">ElectrumBlockchain</span><span class="p">,</span> <span class="n">GetHeight</span><span class="p">},</span>
    <span class="n">SyncOptions</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">fn</span> <span class="nf">sync_and_query</span><span class="p">(</span><span class="n">wallet</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Wallet</span><span class="o">&lt;</span><span class="n">MemoryDatabase</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// å‰µå»ºå€å¡Šéˆå¾Œç«¯</span>
    <span class="k">let</span> <span class="n">blockchain</span> <span class="o">=</span> <span class="nn">ElectrumBlockchain</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span>
        <span class="nn">electrum_client</span><span class="p">::</span><span class="nn">Client</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"ssl://electrum.blockstream.info:60002"</span><span class="p">)</span><span class="o">?</span>
    <span class="p">);</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"ç•¶å‰å€å¡Šé«˜åº¦: {}"</span><span class="p">,</span> <span class="n">blockchain</span><span class="nf">.get_height</span><span class="p">()</span><span class="o">?</span><span class="p">);</span>

    <span class="c1">// åŒæ­¥éŒ¢åŒ…</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"æ­£åœ¨åŒæ­¥..."</span><span class="p">);</span>
    <span class="n">wallet</span><span class="nf">.sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blockchain</span><span class="p">,</span> <span class="nn">SyncOptions</span><span class="p">::</span><span class="nf">default</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"åŒæ­¥å®Œæˆ"</span><span class="p">);</span>

    <span class="c1">// æŸ¥è©¢é¤˜é¡</span>
    <span class="k">let</span> <span class="n">balance</span> <span class="o">=</span> <span class="n">wallet</span><span class="nf">.get_balance</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">é¤˜é¡:"</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"  å·²ç¢ºèª: {} sat"</span><span class="p">,</span> <span class="n">balance</span><span class="py">.confirmed</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"  å¾…ç¢ºèªå…¥å¸³: {} sat"</span><span class="p">,</span> <span class="n">balance</span><span class="py">.untrusted_pending</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"  å¾…ç¢ºèªå‡ºå¸³: {} sat"</span><span class="p">,</span> <span class="n">balance</span><span class="py">.trusted_pending</span><span class="p">);</span>

    <span class="c1">// åˆ—å‡º UTXO</span>
    <span class="k">let</span> <span class="n">utxos</span> <span class="o">=</span> <span class="n">wallet</span><span class="nf">.list_unspent</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">utxos</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">UTXO:"</span><span class="p">);</span>
        <span class="k">for</span> <span class="n">utxo</span> <span class="k">in</span> <span class="n">utxos</span> <span class="p">{</span>
            <span class="nd">println!</span><span class="p">(</span><span class="s">"  {}:{} - {} sat"</span><span class="p">,</span>
                <span class="n">utxo</span><span class="py">.outpoint.txid</span><span class="p">,</span>
                <span class="n">utxo</span><span class="py">.outpoint.vout</span><span class="p">,</span>
                <span class="n">utxo</span><span class="py">.txout.value</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="24-æ§‹å»ºå’Œç™¼é€äº¤æ˜“">2.4 æ§‹å»ºå’Œç™¼é€äº¤æ˜“</h3>

<p>BDK çš„äº¤æ˜“æ§‹å»ºå™¨æä¾›äº†ç›´è§€çš„ API ä¾†å‰µå»ºäº¤æ˜“ã€‚å®ƒè‡ªå‹•è™•ç†é¸å¹£ã€è²»ç”¨è¨ˆç®—å’Œæ‰¾é›¶ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bdk</span><span class="p">::{</span><span class="n">SignOptions</span><span class="p">,</span> <span class="n">FeeRate</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">bdk</span><span class="p">::</span><span class="nn">blockchain</span><span class="p">::</span><span class="n">Blockchain</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">send_transaction</span><span class="p">(</span>
    <span class="n">wallet</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Wallet</span><span class="o">&lt;</span><span class="n">MemoryDatabase</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">blockchain</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">ElectrumBlockchain</span><span class="p">,</span>
    <span class="n">recipient</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Address</span><span class="p">,</span>
    <span class="n">amount_sat</span><span class="p">:</span> <span class="nb">u64</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Txid</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// æ§‹å»ºäº¤æ˜“</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">wallet</span><span class="nf">.build_tx</span><span class="p">();</span>

    <span class="n">builder</span>
        <span class="c1">// æ·»åŠ æ¥æ”¶è€…</span>
        <span class="nf">.add_recipient</span><span class="p">(</span><span class="n">recipient</span><span class="nf">.script_pubkey</span><span class="p">(),</span> <span class="n">amount_sat</span><span class="p">)</span>
        <span class="c1">// è¨­ç½®è²»ç‡ï¼ˆsat/vBï¼‰</span>
        <span class="nf">.fee_rate</span><span class="p">(</span><span class="nn">FeeRate</span><span class="p">::</span><span class="nf">from_sat_per_vb</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span>
        <span class="c1">// å•Ÿç”¨ RBFï¼ˆå…è¨±ç¨å¾Œæé«˜è²»ç‡ï¼‰</span>
        <span class="nf">.enable_rbf</span><span class="p">();</span>

    <span class="c1">// å®Œæˆæ§‹å»º</span>
    <span class="k">let</span> <span class="p">(</span><span class="k">mut</span> <span class="n">psbt</span><span class="p">,</span> <span class="n">tx_details</span><span class="p">)</span> <span class="o">=</span> <span class="n">builder</span><span class="nf">.finish</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"äº¤æ˜“è©³æƒ…:"</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"  ç™¼é€é‡‘é¡: {} sat"</span><span class="p">,</span> <span class="n">amount_sat</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"  æ‰‹çºŒè²»: {} sat"</span><span class="p">,</span> <span class="n">tx_details</span><span class="py">.fee</span><span class="nf">.unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

    <span class="c1">// ç°½å</span>
    <span class="k">let</span> <span class="n">finalized</span> <span class="o">=</span> <span class="n">wallet</span><span class="nf">.sign</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">psbt</span><span class="p">,</span> <span class="nn">SignOptions</span><span class="p">::</span><span class="nf">default</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">finalized</span> <span class="p">{</span>
        <span class="nn">anyhow</span><span class="p">::</span><span class="nd">bail!</span><span class="p">(</span><span class="s">"ç°½åæœªå®Œæˆ"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// æå–æœ€çµ‚äº¤æ˜“</span>
    <span class="k">let</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">psbt</span><span class="nf">.extract_tx</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">txid</span> <span class="o">=</span> <span class="n">tx</span><span class="nf">.compute_txid</span><span class="p">();</span>

    <span class="c1">// å»£æ’­</span>
    <span class="n">blockchain</span><span class="nf">.broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"äº¤æ˜“å·²å»£æ’­: {}"</span><span class="p">,</span> <span class="n">txid</span><span class="p">);</span>

    <span class="nf">Ok</span><span class="p">(</span><span class="n">txid</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>BDK é‚„æ”¯æŒæ›´è¤‡é›œçš„å ´æ™¯ï¼Œå¦‚æ‰‹å‹•é¸å¹£ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">advanced_transaction</span><span class="p">(</span><span class="n">wallet</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Wallet</span><span class="o">&lt;</span><span class="n">MemoryDatabase</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">wallet</span><span class="nf">.build_tx</span><span class="p">();</span>

    <span class="c1">// æ‰‹å‹•é¸æ“‡ç‰¹å®šçš„ UTXO</span>
    <span class="k">let</span> <span class="n">utxos</span> <span class="o">=</span> <span class="n">wallet</span><span class="nf">.list_unspent</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">utxo</span><span class="p">)</span> <span class="o">=</span> <span class="n">utxos</span><span class="nf">.first</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">builder</span><span class="nf">.add_utxo</span><span class="p">(</span><span class="n">utxo</span><span class="py">.outpoint</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// æˆ–è€…ä½¿ç”¨ç‰¹å®šçš„é¸å¹£ç­–ç•¥</span>
    <span class="c1">// builder.coin_selection(LargestFirstCoinSelection);</span>

    <span class="c1">// æ·»åŠ  OP_RETURN æ•¸æ“š</span>
    <span class="c1">// builder.add_data(&amp;[1, 2, 3, 4]);</span>

    <span class="c1">// è¨­ç½®è‡ªå®šç¾©åºåˆ—è™Ÿï¼ˆç”¨æ–¼æ™‚é–“é–ï¼‰</span>
    <span class="c1">// builder.set_sequence(Sequence::from_height(144));</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="3-å®‰å…¨è€ƒé‡">3. å®‰å…¨è€ƒé‡</h2>

<h3 id="31-å¯†é‘°ç®¡ç†">3.1 å¯†é‘°ç®¡ç†</h3>

<p>å¯†é‘°ç®¡ç†æ˜¯ Bitcoin æ‡‰ç”¨æœ€é—œéµçš„å®‰å…¨é¢å‘ã€‚ç§é‘°ä¸€æ—¦æ´©éœ²ï¼Œè³‡é‡‘å°±æœƒæ°¸ä¹…ä¸Ÿå¤±ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›æœ€ä½³å¯¦è¸ã€‚</p>

<p><strong>å…§å­˜å®‰å…¨</strong>ï¼šæ•æ„Ÿæ•¸æ“šï¼ˆç§é‘°ã€åŠ©è¨˜è©ï¼‰åœ¨ä½¿ç”¨å¾Œæ‡‰è©²ç«‹å³å¾å…§å­˜ä¸­æ¸…é™¤ã€‚Rust çš„ <code class="language-plaintext highlighter-rouge">zeroize</code> crate æä¾›äº†é€™å€‹åŠŸèƒ½ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">zeroize</span><span class="p">::</span><span class="n">Zeroize</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">secure_key_handling</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">secret</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0u8</span><span class="p">;</span> <span class="mi">32</span><span class="p">];</span>
    <span class="c1">// ... ä½¿ç”¨ secret ...</span>

    <span class="c1">// ä½¿ç”¨å®Œç•¢å¾Œæ¸…é›¶</span>
    <span class="n">secret</span><span class="nf">.zeroize</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>æ°¸é ä¸è¦è¨˜éŒ„æ•æ„Ÿæ•¸æ“š</strong>ï¼šæ—¥èªŒä¸­ä¸æ‡‰è©²å‡ºç¾ç§é‘°ã€åŠ©è¨˜è©æˆ–å…¶ä»–æ•æ„Ÿä¿¡æ¯ã€‚é€™æ˜¯ä¸€å€‹å¸¸è¦‹çš„éŒ¯èª¤ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1">// éŒ¯èª¤ï¼ä¸è¦é€™æ¨£åš</span>
<span class="nd">println!</span><span class="p">(</span><span class="s">"ç§é‘°: {}"</span><span class="p">,</span> <span class="n">private_key</span><span class="p">);</span>

<span class="c1">// æ­£ç¢ºï¼šåªè¨˜éŒ„éæ•æ„Ÿä¿¡æ¯</span>
<span class="nd">println!</span><span class="p">(</span><span class="s">"æ­£åœ¨è™•ç†åœ°å€: {}"</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>è€ƒæ…®ä½¿ç”¨ç¡¬é«”éŒ¢åŒ…</strong>ï¼šå°æ–¼ç”Ÿç”¢ç’°å¢ƒï¼Œè€ƒæ…®æ•´åˆç¡¬é«”éŒ¢åŒ…ï¼ˆå¦‚ Ledger æˆ– Trezorï¼‰ã€‚ç§é‘°æ°¸é ä¸é›¢é–‹ç¡¬é«”è¨­å‚™ï¼Œå¤§å¤§é™ä½äº†è¢«ç›œé¢¨éšªã€‚</p>

<h3 id="32-è¼¸å…¥é©—è­‰">3.2 è¼¸å…¥é©—è­‰</h3>

<p>æ°¸é ä¸è¦ä¿¡ä»»å¤–éƒ¨è¼¸å…¥ã€‚åœ¨è™•ç†ç”¨æˆ¶æä¾›çš„åœ°å€æˆ–é‡‘é¡ä¹‹å‰ï¼Œå¿…é ˆé©—è­‰å…¶æœ‰æ•ˆæ€§ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">validate_inputs</span><span class="p">(</span>
    <span class="n">address_str</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">amount_sat</span><span class="p">:</span> <span class="nb">u64</span><span class="p">,</span>
    <span class="n">network</span><span class="p">:</span> <span class="n">Network</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">Amount</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// é©—è­‰åœ°å€æ ¼å¼</span>
    <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="nn">Address</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="n">address_str</span><span class="p">)</span>
        <span class="nf">.map_err</span><span class="p">(|</span><span class="n">e</span><span class="p">|</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nd">anyhow!</span><span class="p">(</span><span class="s">"ç„¡æ•ˆçš„åœ°å€æ ¼å¼: {}"</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// é©—è­‰ç¶²è·¯</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">address</span><span class="nf">.is_valid_for_network</span><span class="p">(</span><span class="n">network</span><span class="p">)</span> <span class="p">{</span>
        <span class="nn">anyhow</span><span class="p">::</span><span class="nd">bail!</span><span class="p">(</span><span class="s">"åœ°å€èˆ‡ç¶²è·¯ä¸åŒ¹é…"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// é©—è­‰é‡‘é¡</span>
    <span class="k">if</span> <span class="n">amount_sat</span> <span class="o">&lt;</span> <span class="mi">546</span> <span class="p">{</span>
        <span class="nn">anyhow</span><span class="p">::</span><span class="nd">bail!</span><span class="p">(</span><span class="s">"é‡‘é¡ä½æ–¼ç²‰å¡µé™åˆ¶"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">amount_sat</span> <span class="o">&gt;</span> <span class="mi">21_000_000</span> <span class="o">*</span> <span class="mi">100_000_000</span> <span class="p">{</span>
        <span class="nn">anyhow</span><span class="p">::</span><span class="nd">bail!</span><span class="p">(</span><span class="s">"é‡‘é¡è¶…é Bitcoin ç¸½ä¾›æ‡‰é‡"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="n">amount</span> <span class="o">=</span> <span class="nn">Amount</span><span class="p">::</span><span class="nf">from_sat</span><span class="p">(</span><span class="n">amount_sat</span><span class="p">);</span>
    <span class="nf">Ok</span><span class="p">((</span><span class="n">address</span><span class="nf">.assume_checked</span><span class="p">(),</span> <span class="n">amount</span><span class="p">))</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="33-éŒ¯èª¤è™•ç†">3.3 éŒ¯èª¤è™•ç†</h3>

<p>é©ç•¶çš„éŒ¯èª¤è™•ç†å°æ–¼å®‰å…¨å’Œç”¨æˆ¶é«”é©—éƒ½å¾ˆé‡è¦ã€‚ä½¿ç”¨çµæ§‹åŒ–çš„éŒ¯èª¤é¡å‹ï¼Œä¸¦ç¢ºä¿ä¸åœ¨éŒ¯èª¤æ¶ˆæ¯ä¸­æ´©éœ²æ•æ„Ÿä¿¡æ¯ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">thiserror</span><span class="p">::</span><span class="n">Error</span><span class="p">;</span>

<span class="nd">#[derive(Error,</span> <span class="nd">Debug)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">WalletError</span> <span class="p">{</span>
    <span class="nd">#[error(</span><span class="s">"é¤˜é¡ä¸è¶³"</span><span class="nd">)]</span>
    <span class="n">InsufficientFunds</span> <span class="p">{</span>
        <span class="n">required</span><span class="p">:</span> <span class="nb">u64</span><span class="p">,</span>
        <span class="n">available</span><span class="p">:</span> <span class="nb">u64</span><span class="p">,</span>
    <span class="p">},</span>

    <span class="nd">#[error(</span><span class="s">"ç„¡æ•ˆçš„æ¥æ”¶åœ°å€"</span><span class="nd">)]</span>
    <span class="n">InvalidAddress</span><span class="p">,</span>

    <span class="nd">#[error(</span><span class="s">"ç¶²è·¯é€£æ¥å¤±æ•—"</span><span class="nd">)]</span>
    <span class="nf">NetworkError</span><span class="p">(</span><span class="nd">#[from]</span> <span class="nn">std</span><span class="p">::</span><span class="nn">io</span><span class="p">::</span><span class="n">Error</span><span class="p">),</span>

    <span class="nd">#[error(</span><span class="s">"äº¤æ˜“æ§‹å»ºå¤±æ•—"</span><span class="nd">)]</span>
    <span class="nf">TransactionError</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1">// åœ¨æ—¥èªŒä¸­åªé¡¯ç¤ºå®‰å…¨çš„ä¿¡æ¯</span>
<span class="k">impl</span> <span class="n">WalletError</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">safe_message</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="nb">str</span> <span class="p">{</span>
        <span class="k">match</span> <span class="k">self</span> <span class="p">{</span>
            <span class="k">Self</span><span class="p">::</span><span class="n">InsufficientFunds</span> <span class="p">{</span> <span class="o">..</span> <span class="p">}</span> <span class="k">=&gt;</span> <span class="s">"é¤˜é¡ä¸è¶³"</span><span class="p">,</span>
            <span class="k">Self</span><span class="p">::</span><span class="n">InvalidAddress</span> <span class="k">=&gt;</span> <span class="s">"åœ°å€é©—è­‰å¤±æ•—"</span><span class="p">,</span>
            <span class="k">Self</span><span class="p">::</span><span class="nf">NetworkError</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="s">"ç¶²è·¯é€£æ¥å•é¡Œ"</span><span class="p">,</span>
            <span class="k">Self</span><span class="p">::</span><span class="nf">TransactionError</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="s">"äº¤æ˜“è™•ç†å¤±æ•—"</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="4-å®Œæ•´éŒ¢åŒ…æ‡‰ç”¨ç¯„ä¾‹">4. å®Œæ•´éŒ¢åŒ…æ‡‰ç”¨ç¯„ä¾‹</h2>

<h3 id="41-æ¶æ§‹è¨­è¨ˆ">4.1 æ¶æ§‹è¨­è¨ˆ</h3>

<p>ä¸€å€‹ç”Ÿç”¢ç´šçš„éŒ¢åŒ…æ‡‰ç”¨éœ€è¦è€ƒæ…®è¨±å¤šé¢å‘ï¼šç”¨æˆ¶ç•Œé¢ã€ç‹€æ…‹ç®¡ç†ã€éŒ¯èª¤è™•ç†ã€æ—¥èªŒè¨˜éŒ„ç­‰ã€‚é€™è£¡æˆ‘å€‘å±•ç¤ºä¸€å€‹ç°¡åŒ–ä½†å®Œæ•´çš„å‘½ä»¤åˆ—éŒ¢åŒ…ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
</pre></td><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">struct</span> <span class="n">WalletApp</span> <span class="p">{</span>
    <span class="n">wallet</span><span class="p">:</span> <span class="n">Wallet</span><span class="o">&lt;</span><span class="n">SqliteDatabase</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">blockchain</span><span class="p">:</span> <span class="n">ElectrumBlockchain</span><span class="p">,</span>
    <span class="n">network</span><span class="p">:</span> <span class="n">Network</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">WalletApp</span> <span class="p">{</span>
    <span class="cd">/// å‰µå»ºæ–°éŒ¢åŒ…</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">create</span><span class="p">(</span>
        <span class="n">name</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">mnemonic</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">passphrase</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">network</span><span class="p">:</span> <span class="n">Network</span><span class="p">,</span>
        <span class="n">data_dir</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Path</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="k">Self</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">// é©—è­‰åŠ©è¨˜è©</span>
        <span class="k">let</span> <span class="n">mnemonic</span> <span class="o">=</span> <span class="nn">Mnemonic</span><span class="p">::</span><span class="nf">parse</span><span class="p">(</span><span class="n">mnemonic</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

        <span class="c1">// æ´¾ç”Ÿå¯†é‘°</span>
        <span class="k">let</span> <span class="n">seed</span> <span class="o">=</span> <span class="n">mnemonic</span><span class="nf">.to_seed</span><span class="p">(</span><span class="n">passphrase</span><span class="p">);</span>
        <span class="k">let</span> <span class="n">xprv</span> <span class="o">=</span> <span class="nn">Xpriv</span><span class="p">::</span><span class="nf">new_master</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seed</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

        <span class="c1">// æ§‹å»ºæè¿°ç¬¦</span>
        <span class="k">let</span> <span class="n">coin_type</span> <span class="o">=</span> <span class="k">if</span> <span class="n">network</span> <span class="o">==</span> <span class="nn">Network</span><span class="p">::</span><span class="n">Bitcoin</span> <span class="p">{</span> <span class="s">"0"</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="s">"1"</span> <span class="p">};</span>
        <span class="k">let</span> <span class="n">external</span> <span class="o">=</span> <span class="nd">format!</span><span class="p">(</span><span class="s">"wpkh({}/84'/{}'/ 0'/0/*)"</span><span class="p">,</span> <span class="n">xprv</span><span class="p">,</span> <span class="n">coin_type</span><span class="p">);</span>
        <span class="k">let</span> <span class="n">internal</span> <span class="o">=</span> <span class="nd">format!</span><span class="p">(</span><span class="s">"wpkh({}/84'/{}'/0'/1/*)"</span><span class="p">,</span> <span class="n">xprv</span><span class="p">,</span> <span class="n">coin_type</span><span class="p">);</span>

        <span class="c1">// å‰µå»ºæ•¸æ“šåº«</span>
        <span class="k">let</span> <span class="n">db_path</span> <span class="o">=</span> <span class="n">data_dir</span><span class="nf">.join</span><span class="p">(</span><span class="nd">format!</span><span class="p">(</span><span class="s">"{}.db"</span><span class="p">,</span> <span class="n">name</span><span class="p">));</span>
        <span class="k">let</span> <span class="n">database</span> <span class="o">=</span> <span class="nn">SqliteDatabase</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

        <span class="c1">// å‰µå»ºéŒ¢åŒ…</span>
        <span class="k">let</span> <span class="n">wallet</span> <span class="o">=</span> <span class="nn">Wallet</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">external</span><span class="p">,</span> <span class="nf">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="n">internal</span><span class="p">),</span> <span class="n">network</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

        <span class="c1">// é€£æ¥å€å¡Šéˆ</span>
        <span class="k">let</span> <span class="n">electrum_url</span> <span class="o">=</span> <span class="k">match</span> <span class="n">network</span> <span class="p">{</span>
            <span class="nn">Network</span><span class="p">::</span><span class="n">Bitcoin</span> <span class="k">=&gt;</span> <span class="s">"ssl://electrum.blockstream.info:60002"</span><span class="p">,</span>
            <span class="n">_</span> <span class="k">=&gt;</span> <span class="s">"ssl://electrum.blockstream.info:60002"</span><span class="p">,</span>
        <span class="p">};</span>
        <span class="k">let</span> <span class="n">blockchain</span> <span class="o">=</span> <span class="nn">ElectrumBlockchain</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span>
            <span class="nn">electrum_client</span><span class="p">::</span><span class="nn">Client</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">electrum_url</span><span class="p">)</span><span class="o">?</span>
        <span class="p">);</span>

        <span class="nf">Ok</span><span class="p">(</span><span class="k">Self</span> <span class="p">{</span> <span class="n">wallet</span><span class="p">,</span> <span class="n">blockchain</span><span class="p">,</span> <span class="n">network</span> <span class="p">})</span>
    <span class="p">}</span>

    <span class="cd">/// åŒæ­¥éŒ¢åŒ…</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">sync</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.wallet</span><span class="nf">.sync</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="py">.blockchain</span><span class="p">,</span> <span class="nn">SyncOptions</span><span class="p">::</span><span class="nf">default</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
        <span class="nf">Ok</span><span class="p">(())</span>
    <span class="p">}</span>

    <span class="cd">/// ç²å–é¤˜é¡</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">balance</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Balance</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="k">self</span><span class="py">.wallet</span><span class="nf">.get_balance</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
        <span class="nf">Ok</span><span class="p">(</span><span class="n">Balance</span> <span class="p">{</span>
            <span class="n">confirmed</span><span class="p">:</span> <span class="n">b</span><span class="py">.confirmed</span><span class="p">,</span>
            <span class="n">pending</span><span class="p">:</span> <span class="n">b</span><span class="py">.untrusted_pending</span> <span class="o">+</span> <span class="n">b</span><span class="py">.trusted_pending</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="cd">/// ç²å–æ–°åœ°å€</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new_address</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="nf">Ok</span><span class="p">(</span><span class="k">self</span><span class="py">.wallet</span><span class="nf">.get_address</span><span class="p">(</span><span class="nn">AddressIndex</span><span class="p">::</span><span class="n">New</span><span class="p">)</span><span class="o">?</span><span class="py">.address</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="cd">/// ç™¼é€äº¤æ˜“</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">send</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="k">self</span><span class="p">,</span>
        <span class="n">recipient</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Address</span><span class="p">,</span>
        <span class="n">amount</span><span class="p">:</span> <span class="n">Amount</span><span class="p">,</span>
        <span class="n">fee_rate</span><span class="p">:</span> <span class="nb">f32</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Txid</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">// é©—è­‰</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">recipient</span><span class="nf">.is_valid_for_network</span><span class="p">(</span><span class="k">self</span><span class="py">.network</span><span class="p">)</span> <span class="p">{</span>
            <span class="nn">anyhow</span><span class="p">::</span><span class="nd">bail!</span><span class="p">(</span><span class="s">"åœ°å€ç¶²è·¯ä¸åŒ¹é…"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// æ§‹å»ºäº¤æ˜“</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">self</span><span class="py">.wallet</span><span class="nf">.build_tx</span><span class="p">();</span>
        <span class="n">builder</span>
            <span class="nf">.add_recipient</span><span class="p">(</span><span class="n">recipient</span><span class="nf">.script_pubkey</span><span class="p">(),</span> <span class="n">amount</span><span class="nf">.to_sat</span><span class="p">())</span>
            <span class="nf">.fee_rate</span><span class="p">(</span><span class="nn">FeeRate</span><span class="p">::</span><span class="nf">from_sat_per_vb</span><span class="p">(</span><span class="n">fee_rate</span><span class="p">))</span>
            <span class="nf">.enable_rbf</span><span class="p">();</span>

        <span class="k">let</span> <span class="p">(</span><span class="k">mut</span> <span class="n">psbt</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">builder</span><span class="nf">.finish</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

        <span class="c1">// ç°½å</span>
        <span class="k">self</span><span class="py">.wallet</span><span class="nf">.sign</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">psbt</span><span class="p">,</span> <span class="nn">SignOptions</span><span class="p">::</span><span class="nf">default</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

        <span class="c1">// å»£æ’­</span>
        <span class="k">let</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">psbt</span><span class="nf">.extract_tx</span><span class="p">();</span>
        <span class="k">self</span><span class="py">.blockchain</span><span class="nf">.broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

        <span class="nf">Ok</span><span class="p">(</span><span class="n">tx</span><span class="nf">.compute_txid</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">Balance</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">confirmed</span><span class="p">:</span> <span class="nb">u64</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">pending</span><span class="p">:</span> <span class="nb">u64</span><span class="p">,</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="42-å‘½ä»¤åˆ—ä»‹é¢">4.2 å‘½ä»¤åˆ—ä»‹é¢</h3>

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">clap</code> crate å¯ä»¥è¼•é¬†å‰µå»ºå‘½ä»¤åˆ—ä»‹é¢ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">clap</span><span class="p">::{</span><span class="n">Parser</span><span class="p">,</span> <span class="n">Subcommand</span><span class="p">};</span>

<span class="nd">#[derive(Parser)]</span>
<span class="nd">#[command(name</span> <span class="nd">=</span> <span class="s">"btc-wallet"</span><span class="nd">)]</span>
<span class="nd">#[command(about</span> <span class="nd">=</span> <span class="s">"ç°¡å–®çš„ Bitcoin éŒ¢åŒ…"</span><span class="nd">)]</span>
<span class="k">struct</span> <span class="n">Cli</span> <span class="p">{</span>
    <span class="nd">#[command(subcommand)]</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">Commands</span><span class="p">,</span>

    <span class="nd">#[arg(long,</span> <span class="nd">default_value</span> <span class="nd">=</span> <span class="s">"testnet"</span><span class="nd">)]</span>
    <span class="n">network</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>

    <span class="nd">#[arg(long,</span> <span class="nd">default_value</span> <span class="nd">=</span> <span class="s">"~/.btc-wallet"</span><span class="nd">)]</span>
    <span class="n">data_dir</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="nd">#[derive(Subcommand)]</span>
<span class="k">enum</span> <span class="n">Commands</span> <span class="p">{</span>
    <span class="cd">/// å‰µå»ºæ–°éŒ¢åŒ…</span>
    <span class="n">Create</span> <span class="p">{</span> <span class="n">name</span><span class="p">:</span> <span class="nb">String</span> <span class="p">},</span>

    <span class="cd">/// å¾åŠ©è¨˜è©æ¢å¾©</span>
    <span class="n">Restore</span> <span class="p">{</span> <span class="n">name</span><span class="p">:</span> <span class="nb">String</span> <span class="p">},</span>

    <span class="cd">/// é¡¯ç¤ºé¤˜é¡</span>
    <span class="n">Balance</span> <span class="p">{</span> <span class="n">name</span><span class="p">:</span> <span class="nb">String</span> <span class="p">},</span>

    <span class="cd">/// ç²å–æ–°åœ°å€</span>
    <span class="n">Address</span> <span class="p">{</span> <span class="n">name</span><span class="p">:</span> <span class="nb">String</span> <span class="p">},</span>

    <span class="cd">/// ç™¼é€ Bitcoin</span>
    <span class="nb">Send</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="n">to</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="n">amount</span><span class="p">:</span> <span class="nb">u64</span><span class="p">,</span>
        <span class="nd">#[arg(default_value</span> <span class="nd">=</span> <span class="s">"10"</span><span class="nd">)]</span>
        <span class="n">fee_rate</span><span class="p">:</span> <span class="nb">f32</span><span class="p">,</span>
    <span class="p">},</span>

    <span class="cd">/// åˆ—å‡ºäº¤æ˜“</span>
    <span class="n">History</span> <span class="p">{</span> <span class="n">name</span><span class="p">:</span> <span class="nb">String</span> <span class="p">},</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">cli</span> <span class="o">=</span> <span class="nn">Cli</span><span class="p">::</span><span class="nf">parse</span><span class="p">();</span>

    <span class="k">match</span> <span class="n">cli</span><span class="py">.command</span> <span class="p">{</span>
        <span class="nn">Commands</span><span class="p">::</span><span class="n">Create</span> <span class="p">{</span> <span class="n">name</span> <span class="p">}</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="c1">// ç”ŸæˆåŠ©è¨˜è©ä¸¦å‰µå»ºéŒ¢åŒ…</span>
            <span class="k">let</span> <span class="n">mnemonic</span> <span class="o">=</span> <span class="nn">Mnemonic</span><span class="p">::</span><span class="nf">generate</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
            <span class="nd">println!</span><span class="p">(</span><span class="s">"æ‚¨çš„åŠ©è¨˜è©ï¼ˆè«‹å®‰å…¨å‚™ä»½ï¼‰:</span><span class="se">\n</span><span class="s">{}"</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">);</span>

            <span class="k">let</span> <span class="n">wallet</span> <span class="o">=</span> <span class="nn">WalletApp</span><span class="p">::</span><span class="nf">create</span><span class="p">(</span>
                <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="n">mnemonic</span><span class="nf">.to_string</span><span class="p">(),</span>
                <span class="s">""</span><span class="p">,</span>
                <span class="nf">parse_network</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cli</span><span class="py">.network</span><span class="p">)</span><span class="o">?</span><span class="p">,</span>
                <span class="nn">Path</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cli</span><span class="py">.data_dir</span><span class="p">),</span>
            <span class="p">)</span><span class="o">?</span><span class="p">;</span>

            <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="n">wallet</span><span class="nf">.new_address</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
            <span class="nd">println!</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">éŒ¢åŒ…å·²å‰µå»º"</span><span class="p">);</span>
            <span class="nd">println!</span><span class="p">(</span><span class="s">"æ‚¨çš„ç¬¬ä¸€å€‹åœ°å€: {}"</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nn">Commands</span><span class="p">::</span><span class="n">Balance</span> <span class="p">{</span> <span class="n">name</span> <span class="p">}</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">wallet</span> <span class="o">=</span> <span class="nf">load_wallet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cli</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
            <span class="n">wallet</span><span class="nf">.sync</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
            <span class="k">let</span> <span class="n">balance</span> <span class="o">=</span> <span class="n">wallet</span><span class="nf">.balance</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
            <span class="nd">println!</span><span class="p">(</span><span class="s">"å·²ç¢ºèª: {} sat"</span><span class="p">,</span> <span class="n">balance</span><span class="py">.confirmed</span><span class="p">);</span>
            <span class="nd">println!</span><span class="p">(</span><span class="s">"å¾…ç¢ºèª: {} sat"</span><span class="p">,</span> <span class="n">balance</span><span class="py">.pending</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// ... å…¶ä»–å‘½ä»¤ ...</span>
    <span class="p">}</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="5-å¯¦æˆ°å°ˆæ¡ˆæ”¯ä»˜è™•ç†å™¨">5. å¯¦æˆ°å°ˆæ¡ˆï¼šæ”¯ä»˜è™•ç†å™¨</h2>

<p>è®“æˆ‘å€‘æ§‹å»ºä¸€å€‹ç°¡å–®çš„æ”¯ä»˜è™•ç†å™¨ï¼Œå±•ç¤ºå¦‚ä½•å°‡æ‰€å­¸çŸ¥è­˜æ‡‰ç”¨åˆ°å¯¦éš›å ´æ™¯ã€‚</p>

<h3 id="51-è¨­è¨ˆ">5.1 è¨­è¨ˆ</h3>

<p>æ”¯ä»˜è™•ç†å™¨éœ€è¦ï¼š</p>
<ol>
  <li>ç‚ºæ¯ç­†è¨‚å–®ç”Ÿæˆå”¯ä¸€çš„æ”¯ä»˜åœ°å€</li>
  <li>ç›£æ§åœ°å€çš„å…¥å¸³</li>
  <li>ç¢ºèªä»˜æ¬¾å¾Œé€šçŸ¥å•†å®¶</li>
</ol>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="k">pub</span> <span class="k">struct</span> <span class="n">PaymentProcessor</span> <span class="p">{</span>
    <span class="n">wallet</span><span class="p">:</span> <span class="n">WalletApp</span><span class="p">,</span>
    <span class="n">pending_payments</span><span class="p">:</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="n">PaymentRequest</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">PaymentRequest</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">address</span><span class="p">:</span> <span class="n">Address</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">amount</span><span class="p">:</span> <span class="n">Amount</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">expires_at</span><span class="p">:</span> <span class="nb">u64</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">callback_url</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">PaymentConfirmation</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">txid</span><span class="p">:</span> <span class="n">Txid</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">amount</span><span class="p">:</span> <span class="n">Amount</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">confirmations</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="52-å‰µå»ºæ”¯ä»˜è«‹æ±‚">5.2 å‰µå»ºæ”¯ä»˜è«‹æ±‚</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="k">impl</span> <span class="n">PaymentProcessor</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">create_payment</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span>
        <span class="n">order_id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="n">amount</span><span class="p">:</span> <span class="n">Amount</span><span class="p">,</span>
        <span class="n">callback_url</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="n">ttl_seconds</span><span class="p">:</span> <span class="nb">u64</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">PaymentRequest</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">// ç”Ÿæˆæ–°åœ°å€</span>
        <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="k">self</span><span class="py">.wallet</span><span class="nf">.new_address</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

        <span class="c1">// è¨ˆç®—éæœŸæ™‚é–“</span>
        <span class="k">let</span> <span class="n">now</span> <span class="o">=</span> <span class="nn">SystemTime</span><span class="p">::</span><span class="nf">now</span><span class="p">()</span>
            <span class="nf">.duration_since</span><span class="p">(</span><span class="n">UNIX_EPOCH</span><span class="p">)</span><span class="o">?</span>
            <span class="nf">.as_secs</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">expires_at</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">ttl_seconds</span><span class="p">;</span>

        <span class="k">let</span> <span class="n">request</span> <span class="o">=</span> <span class="n">PaymentRequest</span> <span class="p">{</span>
            <span class="n">order_id</span><span class="p">:</span> <span class="n">order_id</span><span class="nf">.clone</span><span class="p">(),</span>
            <span class="n">address</span><span class="p">:</span> <span class="n">address</span><span class="nf">.clone</span><span class="p">(),</span>
            <span class="n">amount</span><span class="p">,</span>
            <span class="n">expires_at</span><span class="p">,</span>
            <span class="n">callback_url</span><span class="p">,</span>
        <span class="p">};</span>

        <span class="c1">// å­˜å„²å¾…è™•ç†æ”¯ä»˜</span>
        <span class="k">self</span><span class="py">.pending_payments</span><span class="nf">.insert</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">request</span><span class="nf">.clone</span><span class="p">());</span>

        <span class="nf">Ok</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="53-ç›£æ§æ”¯ä»˜">5.3 ç›£æ§æ”¯ä»˜</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="rouge-code"><pre><span class="k">impl</span> <span class="n">PaymentProcessor</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">async</span> <span class="k">fn</span> <span class="nf">monitor_payments</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">interval</span> <span class="o">=</span> <span class="nn">tokio</span><span class="p">::</span><span class="nn">time</span><span class="p">::</span><span class="nf">interval</span><span class="p">(</span><span class="nn">Duration</span><span class="p">::</span><span class="nf">from_secs</span><span class="p">(</span><span class="mi">30</span><span class="p">));</span>

        <span class="k">loop</span> <span class="p">{</span>
            <span class="n">interval</span><span class="nf">.tick</span><span class="p">()</span><span class="k">.await</span><span class="p">;</span>

            <span class="c1">// åŒæ­¥éŒ¢åŒ…</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nf">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">=</span> <span class="k">self</span><span class="py">.wallet</span><span class="nf">.sync</span><span class="p">()</span> <span class="p">{</span>
                <span class="nd">eprintln!</span><span class="p">(</span><span class="s">"åŒæ­¥éŒ¯èª¤: {}"</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// æª¢æŸ¥æ¯å€‹å¾…è™•ç†æ”¯ä»˜</span>
            <span class="k">let</span> <span class="n">now</span> <span class="o">=</span> <span class="nn">SystemTime</span><span class="p">::</span><span class="nf">now</span><span class="p">()</span>
                <span class="nf">.duration_since</span><span class="p">(</span><span class="n">UNIX_EPOCH</span><span class="p">)</span>
                <span class="nf">.unwrap</span><span class="p">()</span>
                <span class="nf">.as_secs</span><span class="p">();</span>

            <span class="k">let</span> <span class="k">mut</span> <span class="n">completed</span> <span class="o">=</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
            <span class="k">let</span> <span class="k">mut</span> <span class="n">expired</span> <span class="o">=</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span> <span class="k">in</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.pending_payments</span> <span class="p">{</span>
                <span class="c1">// æª¢æŸ¥éæœŸ</span>
                <span class="k">if</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="n">request</span><span class="py">.expires_at</span> <span class="p">{</span>
                    <span class="n">expired</span><span class="nf">.push</span><span class="p">(</span><span class="n">order_id</span><span class="nf">.clone</span><span class="p">());</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="c1">// æª¢æŸ¥æ˜¯å¦æ”¶åˆ°ä»˜æ¬¾</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span> <span class="o">=</span> <span class="k">self</span><span class="nf">.check_payment</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="n">confirmation</span><span class="py">.confirmations</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="p">{</span>
                        <span class="k">self</span><span class="nf">.notify_payment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="py">.callback_url</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">confirmation</span><span class="p">)</span><span class="k">.await</span><span class="p">;</span>
                        <span class="n">completed</span><span class="nf">.push</span><span class="p">(</span><span class="n">order_id</span><span class="nf">.clone</span><span class="p">());</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1">// æ¸…ç†å·²å®Œæˆå’ŒéæœŸçš„æ”¯ä»˜</span>
            <span class="k">for</span> <span class="n">id</span> <span class="k">in</span> <span class="n">completed</span> <span class="p">{</span>
                <span class="k">self</span><span class="py">.pending_payments</span><span class="nf">.remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">id</span> <span class="k">in</span> <span class="n">expired</span> <span class="p">{</span>
                <span class="k">self</span><span class="py">.pending_payments</span><span class="nf">.remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">check_payment</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">PaymentRequest</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">PaymentConfirmation</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">// æŸ¥è©¢åœ°å€çš„äº¤æ˜“</span>
        <span class="c1">// æª¢æŸ¥æ˜¯å¦æœ‰ç¬¦åˆé‡‘é¡çš„å…¥å¸³</span>
        <span class="c1">// è¿”å›ç¢ºèªä¿¡æ¯</span>
        <span class="nb">None</span>
    <span class="p">}</span>

    <span class="k">async</span> <span class="k">fn</span> <span class="nf">notify_payment</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">,</span> <span class="n">confirmation</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">PaymentConfirmation</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ç™¼é€ HTTP å›èª¿é€šçŸ¥å•†å®¶</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="6-æ¸¬è©¦ç­–ç•¥">6. æ¸¬è©¦ç­–ç•¥</h2>

<h3 id="61-å–®å…ƒæ¸¬è©¦">6.1 å–®å…ƒæ¸¬è©¦</h3>

<p>å–®å…ƒæ¸¬è©¦æ‡‰è©²è¦†è“‹æ‰€æœ‰æ ¸å¿ƒé‚è¼¯ï¼Œä¸ä¾è³´å¤–éƒ¨æœå‹™ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="nd">#[cfg(test)]</span>
<span class="k">mod</span> <span class="n">tests</span> <span class="p">{</span>
    <span class="k">use</span> <span class="k">super</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

    <span class="nd">#[test]</span>
    <span class="k">fn</span> <span class="nf">test_address_generation</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">mnemonic</span> <span class="o">=</span> <span class="s">"abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about"</span><span class="p">;</span>
        <span class="c1">// é€™æ˜¯ä¸€å€‹å·²çŸ¥çš„æ¸¬è©¦åŠ©è¨˜è©ï¼Œå¯ä»¥é©—è­‰æ´¾ç”Ÿçµæœ</span>

        <span class="k">let</span> <span class="n">seed</span> <span class="o">=</span> <span class="nn">Mnemonic</span><span class="p">::</span><span class="nf">parse</span><span class="p">(</span><span class="n">mnemonic</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">()</span><span class="nf">.to_seed</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
        <span class="k">let</span> <span class="n">xprv</span> <span class="o">=</span> <span class="nn">Xpriv</span><span class="p">::</span><span class="nf">new_master</span><span class="p">(</span><span class="nn">Network</span><span class="p">::</span><span class="n">Testnet</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seed</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">();</span>

        <span class="c1">// é©—è­‰æ´¾ç”Ÿçš„åœ°å€ç¬¦åˆé æœŸ</span>
    <span class="p">}</span>

    <span class="nd">#[test]</span>
    <span class="k">fn</span> <span class="nf">test_amount_validation</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// æœ‰æ•ˆé‡‘é¡</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="nf">validate_amount</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">546</span><span class="p">,</span> <span class="mi">1_000_000</span><span class="p">)</span><span class="nf">.is_ok</span><span class="p">());</span>

        <span class="c1">// ä½æ–¼ç²‰å¡µé™åˆ¶</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="nf">validate_amount</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">546</span><span class="p">,</span> <span class="mi">1_000_000</span><span class="p">)</span><span class="nf">.is_err</span><span class="p">());</span>

        <span class="c1">// è¶…éä¸Šé™</span>
        <span class="nd">assert!</span><span class="p">(</span><span class="nf">validate_amount</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">,</span> <span class="mi">546</span><span class="p">,</span> <span class="mi">1_000_000</span><span class="p">)</span><span class="nf">.is_err</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="62-regtest-æ•´åˆæ¸¬è©¦">6.2 Regtest æ•´åˆæ¸¬è©¦</h3>

<p>å°æ–¼éœ€è¦å¯¦éš›å€å¡Šéˆäº’å‹•çš„æ¸¬è©¦ï¼Œä½¿ç”¨ regtest ç¶²è·¯ã€‚Regtest æ˜¯ä¸€å€‹æœ¬åœ°æ¸¬è©¦ç¶²è·¯ï¼Œä½ å¯ä»¥éš¨æ™‚ç”Ÿæˆå€å¡Šï¼Œéå¸¸é©åˆæ¸¬è©¦ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># å•Ÿå‹• regtest ç¯€é»</span>
bitcoind <span class="nt">-regtest</span> <span class="nt">-daemon</span>

<span class="c"># ç”Ÿæˆå€å¡Š</span>
bitcoin-cli <span class="nt">-regtest</span> generatetoaddress 101 &lt;your-address&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nd">#[cfg(test)]</span>
<span class="k">mod</span> <span class="n">integration_tests</span> <span class="p">{</span>
    <span class="nd">#[test]</span>
    <span class="nd">#[ignore]</span>  <span class="c1">// éœ€è¦ regtest ç’°å¢ƒ</span>
    <span class="k">fn</span> <span class="nf">test_full_transaction_flow</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// 1. é€£æ¥åˆ° regtest ç¯€é»</span>
        <span class="c1">// 2. ç”Ÿæˆä¸€äº›å€å¡Šä»¥ç²å¾—å¯èŠ±è²»çš„ UTXO</span>
        <span class="c1">// 3. å‰µå»ºä¸¦ç™¼é€äº¤æ˜“</span>
        <span class="c1">// 4. ç”Ÿæˆå€å¡Šç¢ºèªäº¤æ˜“</span>
        <span class="c1">// 5. é©—è­‰çµæœ</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="7-ç¸½çµ">7. ç¸½çµ</h2>

<p>æœ¬ç³»åˆ—å¸¶ä½ å¾é›¶é–‹å§‹å­¸ç¿’ä½¿ç”¨ Rust é–‹ç™¼ Bitcoin æ‡‰ç”¨ã€‚æˆ‘å€‘æ¶µè“‹äº†ï¼š</p>

<p><strong>ç¬¬ä¸€ç¯‡</strong>ï¼šRust ç’°å¢ƒè¨­ç½®ã€rust-bitcoin åŸºç¤é¡å‹ã€å¯†ç¢¼å­¸åŸèª</p>

<p><strong>ç¬¬äºŒç¯‡</strong>ï¼šHD éŒ¢åŒ…ã€åœ°å€ç”Ÿæˆã€UTXO æ¨¡å‹ã€äº¤æ˜“æ§‹å»º</p>

<p><strong>ç¬¬ä¸‰ç¯‡</strong>ï¼šBitcoin Scriptã€å¤šç°½ã€ECDSA å’Œ Schnorr ç°½åã€Miniscript</p>

<p><strong>ç¬¬å››ç¯‡</strong>ï¼šç¯€é»äº’å‹•ã€BDK éŒ¢åŒ…é–‹ç™¼ã€å®‰å…¨æœ€ä½³å¯¦è¸</p>

<h3 id="é€²ä¸€æ­¥å­¸ç¿’">é€²ä¸€æ­¥å­¸ç¿’</h3>

<p>æŒæ¡äº†é€™äº›åŸºç¤å¾Œï¼Œä½ å¯ä»¥ç¹¼çºŒæ¢ç´¢ï¼š</p>

<ul>
  <li><strong>Taproot æ·±å…¥</strong>ï¼šMASTã€è…³æœ¬æ¨¹ã€MuSig2</li>
  <li><strong>é–ƒé›»ç¶²è·¯</strong>ï¼šä½¿ç”¨ LDKï¼ˆLightning Development Kitï¼‰</li>
  <li><strong>éš±ç§æŠ€è¡“</strong>ï¼šCoinJoinã€PayJoinã€Silent Payments</li>
  <li><strong>Layer 2</strong>ï¼šç‹€æ…‹é€šé“ã€Rollups</li>
</ul>

<p>Bitcoin æ˜¯ä¸€å€‹ä¸æ–·ç™¼å±•çš„ç”Ÿæ…‹ç³»çµ±ã€‚ä¿æŒå­¸ç¿’ï¼Œé—œæ³¨ BIP ææ¡ˆå’Œç¤¾å€è¨è«–ï¼Œä½ æœƒç™¼ç¾é€™å€‹é ˜åŸŸæœ‰ç„¡é™çš„å¯èƒ½æ€§ã€‚</p>

<hr />

<h2 id="åƒè€ƒè³‡æº">åƒè€ƒè³‡æº</h2>

<h3 id="å®˜æ–¹æ–‡æª”">å®˜æ–¹æ–‡æª”</h3>
<ul>
  <li><a href="https://docs.rs/bitcoin">rust-bitcoin</a></li>
  <li><a href="https://docs.rs/bdk">BDK</a></li>
  <li><a href="https://docs.rs/lightning">LDK</a></li>
</ul>

<h3 id="å­¸ç¿’è³‡æº">å­¸ç¿’è³‡æº</h3>
<ul>
  <li><a href="https://developer.bitcoin.org/">Bitcoin Developer Guide</a></li>
  <li><a href="https://learnmeabitcoin.com/">Learn Me a Bitcoin</a></li>
  <li><a href="https://github.com/bitcoinbook/bitcoinbook">Mastering Bitcoin</a></li>
</ul>

<h3 id="ç¤¾ç¾¤">ç¤¾ç¾¤</h3>
<ul>
  <li><a href="https://github.com/rust-bitcoin">rust-bitcoin GitHub</a></li>
  <li><a href="https://discord.gg/dstn4dQ">BDK Discord</a></li>
  <li><a href="https://bitcoin.stackexchange.com/">Bitcoin StackExchange</a></li>
</ul>

<hr />

<p>æ­å–œå®Œæˆ Rust Bitcoin é–‹ç™¼å…¥é–€ç³»åˆ—ï¼ä½ ç¾åœ¨æœ‰äº†æ§‹å»º Bitcoin æ‡‰ç”¨çš„å …å¯¦åŸºç¤ã€‚å¯¦è¸æ˜¯æœ€å¥½çš„å­¸ç¿’æ–¹å¼â€”â€”é–‹å§‹æ§‹å»ºä½ çš„ç¬¬ä¸€å€‹å°ˆæ¡ˆå§ï¼</p>]]></content><author><name>Cypherpunks Taiwan</name></author><category term="æŠ€è¡“æ•™å­¸" /><category term="Bitcoin" /><category term="Rust" /><category term="Rust" /><category term="Bitcoin" /><category term="RPC" /><category term="Electrum" /><category term="BDK" /><category term="éŒ¢åŒ…é–‹ç™¼" /><category term="ç¯€é»äº’å‹•" /><summary type="html"><![CDATA[é€™æ˜¯ Rust Bitcoin é–‹ç™¼å…¥é–€ç³»åˆ—çš„æœ€å¾Œä¸€ç¯‡ã€‚æœ¬ç¯‡æ¢è¨å¦‚ä½•æ§‹å»ºå®Œæ•´çš„ Bitcoin æ‡‰ç”¨ï¼ŒåŒ…æ‹¬èˆ‡ç¯€é»äº’å‹•ã€éŒ¢åŒ…é–‹ç™¼å’Œå¯¦éš›éƒ¨ç½²è€ƒé‡ã€‚]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" /><media:content medium="image" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Cypherpunks Taiwan é‡å•Ÿï¼šæˆ‘å€‘ç‚ºä½•å†æ¬¡èšé›†ï¼Ÿ</title><link href="https://cypherpunks-core.github.io/news/community/2025/03/24/Cypherpunks-Taiwan-%E9%87%8D%E5%95%9F-%E6%88%91%E5%80%91%E7%82%BA%E4%BD%95%E5%86%8D%E6%AC%A1%E8%81%9A%E9%9B%86/" rel="alternate" type="text/html" title="Cypherpunks Taiwan é‡å•Ÿï¼šæˆ‘å€‘ç‚ºä½•å†æ¬¡èšé›†ï¼Ÿ" /><published>2025-03-24T00:00:00+00:00</published><updated>2025-03-24T00:00:00+00:00</updated><id>https://cypherpunks-core.github.io/news/community/2025/03/24/Cypherpunks%20Taiwan%20%E9%87%8D%E5%95%9F%EF%BC%9A%E6%88%91%E5%80%91%E7%82%BA%E4%BD%95%E5%86%8D%E6%AC%A1%E8%81%9A%E9%9B%86%EF%BC%9F</id><content type="html" xml:base="https://cypherpunks-core.github.io/news/community/2025/03/24/Cypherpunks-Taiwan-%E9%87%8D%E5%95%9F-%E6%88%91%E5%80%91%E7%82%BA%E4%BD%95%E5%86%8D%E6%AC%A1%E8%81%9A%E9%9B%86/"><![CDATA[<p>å¾ 2019 åˆ°ç¾åœ¨ï¼Œä¸–ç•Œèˆ‡ç¶²è·¯éƒ½è®Šäº†å¾ˆå¤šï¼Œä½†<strong>æˆ‘å€‘å°éš±ç§çš„æ¸´æœ›æ²’æœ‰æ”¹è®Š</strong>ã€‚åœ¨æ•¸ä½èº«ä»½ã€éˆä¸Šè¶³è·¡èˆ‡ AI å¤§æ¨¡å‹å…¨é¢æ»²é€çš„æ™‚ä»£ï¼Œ<strong>Cypherpunks çš„æ ¸å¿ƒä¿¡å¿µâ€”â€”Privacy is necessary for an open society in the electronic age</strong>ï¼Œå¾æœªå¦‚æ­¤é‡è¦ã€‚é€™äº›å¹´ä¾†ï¼Œæˆ‘å€‘è¦‹è­‰äº†<a href="/tags/bitcoin">[æ¯”ç‰¹å¹£](/tags/bitcoin)</a>çš„ä¸»æµåŒ–ã€Web3 çš„çˆ†ç‚¸æˆé•·ï¼Œä¹Ÿè¦‹è­‰äº†éåº¦ä¸­å¿ƒåŒ–å¹³å°å°å€‹äººè‡ªç”±èˆ‡è³‡è¨ŠæŒæ§æ¬Šçš„åæ’²ã€‚æ˜¯æ™‚å€™é‡æ–°èšé›†äº†ã€‚</p>

<h2 id="ç‚ºä»€éº¼é‡å•Ÿ-cypherpunks-taiwan">ç‚ºä»€éº¼é‡å•Ÿ Cypherpunks Taiwanï¼Ÿ</h2>

<p>Cypherpunks Taiwan ä¸¦ä¸æ˜¯ç‚ºäº†ã€Œè¿½é€ç†±é»ã€ï¼Œæˆ‘å€‘æƒ³å»ºç«‹çš„ï¼Œæ˜¯ä¸€å€‹å±¬æ–¼å°ç£æŠ€è¡“ç¤¾ç¾¤çš„ç¯€é»â€”â€”ä¸€å€‹å¯ä»¥è¨è«–<a href="/tags/cryptography">[å¯†ç¢¼å­¸](/tags/cryptography)</a>ã€éš±ç§å·¥å…·ã€æŠ—å¯©æŸ¥æ©Ÿåˆ¶ã€å»ä¸­å¿ƒåŒ–å”è­°çš„åœ°æ–¹ï¼Œä¸€å€‹èƒ½å¸å¼•çœŸæ­£é—œå¿ƒè‡ªç”±èˆ‡æŠ€è¡“çš„ä½ åŠ å…¥çš„ç¤¾ç¾¤ã€‚</p>

<p>é€™ä¸€æ¬¡ï¼Œæˆ‘å€‘çš„ç›®æ¨™ä¸åªæ˜¯è¨è«–æŠ€è¡“ï¼Œæ›´å¸Œæœ›æ‹“å±•é‚Šç•Œã€<strong>å¸å¼•å°æŠ—ä¸­å¿ƒåŒ–å£“åŠ›çš„æ½›åœ¨åŒç›Ÿè€…</strong>ï¼Œä¸è«–ä½ æ˜¯å¦ä¾†è‡ª<a href="/tags/blockchain">[å€å¡Šéˆ](/tags/blockchain)</a>ç”¢æ¥­ï¼Œåªè¦ä½ åœ¨æ€è€ƒå¦‚ä½•ç”¨ç§‘æŠ€è§£æ±ºå•é¡Œã€ä¿è­·è‡ªç”±ï¼Œé‚£ä½ å°±æ˜¯æˆ‘å€‘æƒ³èªè­˜çš„å°è±¡ã€‚</p>

<h2 id="æˆ‘å€‘æƒ³è¨è«–çš„æ˜¯é€™äº›å•é¡Œ">æˆ‘å€‘æƒ³è¨è«–çš„ï¼Œæ˜¯é€™äº›å•é¡Œï¼š</h2>

<ul>
  <li>åœ¨ç¾ä»£ç¶²è·¯æ¶æ§‹ä¸‹ï¼Œ<strong>éš±ç§é‚„æœ‰å¤šå°‘é¸é …ï¼Ÿ</strong></li>
  <li>å»ä¸­å¿ƒåŒ–çš„ç†æƒ³ï¼Œ<strong>å¦‚ä½•èˆ‡ç¾å¯¦ä¸–ç•Œçš„é‹ç‡Ÿæ¨¡å¼å”ä½œï¼Ÿ</strong></li>
  <li>é¢å°éˆä¸Šæ°¸ä¹…ç´€éŒ„èˆ‡å¯¦ååˆ¶é¢¨æ½®ï¼Œ<strong>æˆ‘å€‘é‚„èƒ½æ€éº¼è¨­è¨ˆæ–°çš„æŠ€è¡“è§£æ³•ï¼Ÿ</strong></li>
  <li>ã€Œåšè‡ªç”±çš„å·¥å…·ã€èˆ‡ã€Œæˆç‚ºä¸»æµç”¢å“ã€ä¹‹é–“ï¼Œæœ‰æ²’æœ‰ç¬¬ä¸‰æ¢è·¯ï¼Ÿ</li>
</ul>

<h2 id="èˆ‡æˆ‘å€‘ä¸€èµ·åˆ†äº«é€™äº›å•é¡Œçš„è¬›è€…å€‘">èˆ‡æˆ‘å€‘ä¸€èµ·åˆ†äº«é€™äº›å•é¡Œçš„è¬›è€…å€‘</h2>

<h3 id="dr-awesome-doge--founder-cypherpunks-taiwan">Dr. Awesome Doge | Founder @Cypherpunks Taiwan</h3>

<p>Cypherpunks Taiwan å‰µè¾¦äººï¼Œè‡ª 2014 å¹´é–‹å§‹æŠ•èº«æ¯”ç‰¹å¹£èˆ‡åŠ å¯†è²¨å¹£é ˜åŸŸï¼Œæ—©æœŸå³æ·±åº¦åƒèˆ‡å»ä¸­å¿ƒåŒ–æŠ€è¡“çš„æ¨å»£èˆ‡ç¤¾ç¾¤å»ºè¨­ã€‚èº«ç‚ºå…¨çƒæœ€å¤§ä¸­æ–‡åŠ å¯†ç¤¾ç¾¤ã€Œæ¯”ç‰¹å¹£ä¸­æ–‡ç¤¾åœ˜ã€çš„å…±åŒå‰µè¾¦äººä¹‹ä¸€ï¼ŒæˆåŠŸå‡èšä¾†è‡ªå…¨çƒè¯èªåœˆçš„æ„›å¥½è€…èˆ‡é–‹ç™¼è€…ï¼Œæˆªè‡³ç›®å‰ç¤¾åœ˜æˆå“¡å·²è¶…é 16.9 è¬äººï¼Œæˆç‚ºè¯èªä¸–ç•Œæœ€å…·å½±éŸ¿åŠ›ã€æœ€æ´»èºçš„åŠ å¯†ç¤¾ç¾¤ä¹‹ä¸€</p>

<h3 id="max-wuco-founder--hackmd">Max Wuï½œCo-Founder @ HackMD</h3>

<p>HackMD å…±åŒå‰µè¾¦äººæš¨ CEOï¼Œåœ¨ç¶²è·¯ç”¢æ¥­èˆ‡é–‹æºç¤¾ç¾¤æ“æœ‰è±å¯Œç¶“é©—ã€‚HackMD æ˜¯ä¸€å€‹å”ä½œå¼ Markdown ç·¨è¼¯å™¨ï¼Œä¿ƒé€²åœ˜éšŠèˆ‡å€‹äººä¹‹é–“çš„çŸ¥è­˜å…±äº«ï¼Œæœ€è¿‘æ¨å‡ºçš„æ–‡ä»¶å¤¾åŠŸèƒ½æ›´é€²ä¸€æ­¥æå‡äº†ä½¿ç”¨è€…é«”é©—ã€‚</p>

<p>ğŸ”— <a href="https://hackmd.io/@MaxWu/HackMD-and-open-source">å»¶ä¼¸é–±è®€</a></p>

<h3 id="æ—æ—…å¼·richard-linco-founder--é–‹æºç¤¾">æ—æ—…å¼·ï¼ˆRichard Linï¼‰ï½œCo-Founder @ é–‹æºç¤¾</h3>

<p>è³‡æ·±é–‹æºæ¨å‹•è€…ï¼Œæ›¾ä»» COSCUP å¿—å·¥ï¼Œä¸¦æ–¼ä¸­ç ”é™¢è‡ªç”±è»Ÿé«”é‘„é€ å ´æ·±è€•å¤šå¹´ã€‚2014 å¹´è¯åˆå‰µè¾¦ä¸­åœ‹é–‹æºç¤¾ï¼Œå¾Œä»»è·è¯ç‚ºè¿‘å…«å¹´å°ˆæ³¨é–‹æºèˆ‡é–‹ç™¼è€…ç”Ÿæ…‹å»ºè¨­ï¼Œç¾ç‚º <a href="http://01.AI">01.AI</a>ï¼ˆå‰µè¾¦äººæé–‹å¾©ï¼‰é–‹æºæš¨é–‹ç™¼è€…é—œä¿‚è² è²¬äººã€‚</p>

<h3 id="æä½³æ†²neil-leeåŸ·è¡Œè‘£äº‹--echox">æä½³æ†²ï¼ˆNeil Leeï¼‰ï½œåŸ·è¡Œè‘£äº‹ @ EchoX</h3>

<p>LeadBest Consulting Group å…±åŒå‰µè¾¦äººèˆ‡å‰åŸ·è¡Œé•·ï¼Œé•·æœŸæ¨å‹•æ•¸ä½è½‰å‹ã€Web3 ç™¼å±•èˆ‡é–‹æºå‰µæ–°ã€‚éå»æ›¾å‰µè¾¦æ™‚é–“è»¸ç§‘æŠ€ã€å”åŠ©å»ºç«‹ friDay è³¼ç‰©ç­‰å¹³å°ï¼Œä¸¦æ´»èºæ–¼æ•æ·æ–‡åŒ–èˆ‡å»ä¸­å¿ƒåŒ–æ‡‰ç”¨çš„è½åœ°å¯¦è¸ã€‚</p>

<p>ğŸ”— <a href="https://www.facebook.com/chiahsienl">å»¶ä¼¸é–±è®€</a></p>

<h2 id="é‚€è«‹ä½ åŠ å…¥cypherpunks-å°èš--make-privacy-great-again">é‚€è«‹ä½ åŠ å…¥ï¼š#Cypherpunks å°èš â€” Make Privacy Great Again</h2>

<p>æˆ‘å€‘å°‡åœ¨ Tempo House è¾¦ä¸€å ´é–‹æ”¾çš„æŠ€è¡“å°èšï¼Œé‚€è«‹éå»åœ¨å°ç£æ¨å‹•é–‹æºã€å»ä¸­å¿ƒåŒ–èˆ‡éš±ç§æŠ€è¡“çš„è¬›è€…ç¾èº«åˆ†äº«ï¼Œä¹Ÿæœƒå®‰æ’è¶³å¤ çš„äº¤æµæ™‚é–“ï¼Œè®“æˆ‘å€‘å½¼æ­¤èªè­˜ã€é‡æ–°å»ºç«‹é€™å€‹ç¤¾ç¾¤çš„é€£çµã€‚</p>

<h3 id="æ´»å‹•è³‡è¨Š">æ´»å‹•è³‡è¨Š</h3>

<p>ğŸ“… <strong>æ™‚é–“</strong>ï¼š3 æœˆ 31 æ—¥ï¼ˆä¸€ï¼‰18:00 - 22:30<br />
ğŸ“ <strong>åœ°é»</strong>ï¼šTempo House äºŒæ¨“ï¼ˆå°åŒ—å¸‚ä¸­å±±å€å»ºåœ‹åŒ—è·¯äºŒæ®µ 12 è™Ÿï¼‰<br />
ğŸ”— <strong>å ±å</strong>ï¼š<a href="https://www.meetup.com/taipei-bitcoin-meetup-group/events/306823746/">æ´»å‹•å ±åé€£çµ</a></p>

<p>æˆ‘å€‘ç›¸ä¿¡ï¼Œ<strong>Cypherpunks write code</strong>â€”â€”ä½†æ›´é‡è¦çš„æ˜¯ï¼Œä»–å€‘ä¹Ÿèšåœ¨ä¸€èµ·ï¼Œäº’ç›¸èªè­˜ï¼Œäº’ç›¸æ”¯æŒã€‚</p>

<p>é€™å ´é‡å•Ÿï¼Œæœƒæ˜¯æˆ‘å€‘çš„ç¬¬ä¸€æ­¥ã€‚ç­‰ä½ ä¾†ã€‚</p>]]></content><author><name>Cypherpunks Taiwan</name></author><category term="news" /><category term="community" /><category term="cypherpunks" /><category term="privacy" /><category term="decentralization" /><category term="technology" /><category term="community" /><summary type="html"><![CDATA[Cypherpunks Taiwan é‡å•Ÿï¼Œæ¢è¨åœ¨æ•¸ä½èº«ä»½ã€éˆä¸Šè¶³è·¡èˆ‡ AI å¤§æ¨¡å‹å…¨é¢æ»²é€çš„æ™‚ä»£ï¼Œå¦‚ä½•ä¿è­·éš±ç§èˆ‡è‡ªç”±ã€‚]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://cypherpunks-core.github.io/img/150.jpg" /><media:content medium="image" url="https://cypherpunks-core.github.io/img/150.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Rust Bitcoin é–‹ç™¼å…¥é–€ï¼ˆä¸‰ï¼‰ï¼šè…³æœ¬èˆ‡ç°½å</title><link href="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/rust/2025/03/24/rust-bitcoin-tutorial-3-scripts-signatures/" rel="alternate" type="text/html" title="Rust Bitcoin é–‹ç™¼å…¥é–€ï¼ˆä¸‰ï¼‰ï¼šè…³æœ¬èˆ‡ç°½å" /><published>2025-03-24T00:00:00+00:00</published><updated>2025-03-24T00:00:00+00:00</updated><id>https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/rust/2025/03/24/rust-bitcoin-tutorial-3-scripts-signatures</id><content type="html" xml:base="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/rust/2025/03/24/rust-bitcoin-tutorial-3-scripts-signatures/"><![CDATA[<p>é€™æ˜¯ Rust Bitcoin é–‹ç™¼å…¥é–€ç³»åˆ—çš„ç¬¬ä¸‰ç¯‡ã€‚æœ¬ç¯‡æ·±å…¥æ¢è¨ Bitcoin Script ç·¨ç¨‹å’Œå„ç¨®ç°½åæ©Ÿåˆ¶çš„ Rust å¯¦ç¾ã€‚</p>

<p><strong>ç³»åˆ—æ–‡ç« å°èˆªï¼š</strong></p>
<ul>
  <li><a href="/2025/03/22/rust-bitcoin-tutorial-1-environment-basics/">ç¬¬ä¸€ç¯‡ï¼šç’°å¢ƒè¨­ç½®èˆ‡åŸºç¤æ¦‚å¿µ</a></li>
  <li><a href="/2025/03/23/rust-bitcoin-tutorial-2-addresses-transactions/">ç¬¬äºŒç¯‡ï¼šåœ°å€ç”Ÿæˆèˆ‡äº¤æ˜“æ§‹å»º</a></li>
  <li><strong>ç¬¬ä¸‰ç¯‡ï¼šè…³æœ¬èˆ‡ç°½å</strong>ï¼ˆæœ¬ç¯‡ï¼‰</li>
  <li><a href="/2025/03/25/rust-bitcoin-tutorial-4-advanced-applications/">ç¬¬å››ç¯‡ï¼šé€²éšæ‡‰ç”¨èˆ‡æ•´åˆ</a></li>
</ul>

<hr />

<h2 id="1-ç†è§£-bitcoin-script">1. ç†è§£ Bitcoin Script</h2>

<h3 id="11-ä»€éº¼æ˜¯-bitcoin-script">1.1 ä»€éº¼æ˜¯ Bitcoin Script</h3>

<p>Bitcoin Script æ˜¯ Bitcoin çš„ç¨‹å¼èªè¨€ï¼Œç”¨æ–¼å®šç¾©è³‡é‡‘çš„èŠ±è²»æ¢ä»¶ã€‚æ¯ä¸€ç­† Bitcoin è¼¸å‡ºéƒ½è¢«ä¸€å€‹è…³æœ¬ã€Œé–å®šã€ï¼Œè€ŒèŠ±è²»é€™ç­†è¼¸å‡ºéœ€è¦æä¾›ä¸€å€‹èƒ½å¤ ã€Œè§£é–ã€å®ƒçš„è…³æœ¬ã€‚</p>

<p>Script çš„è¨­è¨ˆæœ‰å¹¾å€‹é‡è¦ç‰¹é»ã€‚é¦–å…ˆï¼Œå®ƒæ˜¯åŸºæ–¼å †ç–Šï¼ˆstackï¼‰çš„èªè¨€ï¼Œé¡ä¼¼æ–¼ Forthã€‚æ“ä½œæ•¸è¢«æ¨å…¥å †ç–Šï¼Œæ“ä½œç¢¼å‰‡å¾å †ç–Šä¸­å–å‡ºæ“ä½œæ•¸ä¸¦å°‡çµæœæ¨å›ã€‚å…¶æ¬¡ï¼Œå®ƒæ•…æ„ä¸æ˜¯åœ–éˆå®Œå‚™çš„â€”â€”æ²’æœ‰å¾ªç’°çµæ§‹ï¼ŒåŸ·è¡Œæ™‚é–“æ˜¯å¯é æ¸¬çš„ã€‚é€™ç¢ºä¿äº†ç¯€é»å¯ä»¥å¿«é€Ÿé©—è­‰äº¤æ˜“ï¼Œä¸æœƒè¢«æƒ¡æ„çš„ç„¡é™å¾ªç’°æ”»æ“Šã€‚</p>

<p>ç†è§£ Script å°æ–¼ Bitcoin é–‹ç™¼å¾ˆé‡è¦ï¼Œå› ç‚ºå®ƒæ˜¯æ‰€æœ‰æ™ºèƒ½åˆç´„åŠŸèƒ½çš„åŸºç¤ã€‚å¾ç°¡å–®çš„å–®ç°½åæ”¯ä»˜åˆ°è¤‡é›œçš„å¤šé‡ç°½åã€æ™‚é–“é–å’Œæ¢ä»¶æ”¯ä»˜ï¼Œéƒ½æ˜¯é€é Script å¯¦ç¾çš„ã€‚</p>

<h3 id="12-è…³æœ¬åŸ·è¡Œæ¨¡å‹">1.2 è…³æœ¬åŸ·è¡Œæ¨¡å‹</h3>

<p>ç•¶é©—è­‰ä¸€ç­†äº¤æ˜“æ™‚ï¼Œç¯€é»æœƒåŸ·è¡Œä»¥ä¸‹éç¨‹ï¼š</p>

<ol>
  <li>å°‡èŠ±è²»è€…æä¾›çš„è§£é–è…³æœ¬ï¼ˆscriptSig æˆ– witnessï¼‰åŸ·è¡Œï¼Œçµæœç•™åœ¨å †ç–Šä¸Š</li>
  <li>ç„¶å¾ŒåŸ·è¡Œè¢«èŠ±è²»è¼¸å‡ºçš„é–å®šè…³æœ¬ï¼ˆscriptPubKeyï¼‰</li>
  <li>å¦‚æœåŸ·è¡Œå®Œæˆå¾Œå †ç–Šé ‚éƒ¨æ˜¯ã€ŒçœŸã€ï¼ˆéé›¶å€¼ï¼‰ï¼Œä¸”æ²’æœ‰ç™¼ç”ŸéŒ¯èª¤ï¼Œå‰‡é©—è­‰é€šé</li>
</ol>

<p>é€™ç¨®ã€Œå…ˆè§£é–ï¼Œå¾Œé©—è­‰ã€çš„æ¨¡å‹è®“èŠ±è²»è€…å¯ä»¥æä¾›æ»¿è¶³æ¢ä»¶çš„æ•¸æ“šï¼ˆå¦‚ç°½åï¼‰ï¼Œç„¶å¾Œç”±é–å®šè…³æœ¬é©—è­‰é€™äº›æ•¸æ“šæ˜¯å¦æ­£ç¢ºã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">script</span><span class="p">::{</span><span class="n">Script</span><span class="p">,</span> <span class="n">ScriptBuf</span><span class="p">,</span> <span class="n">Builder</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">opcodes</span><span class="p">::</span><span class="nn">all</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">script_execution_demo</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// P2PKH çš„é–å®šè…³æœ¬ï¼š</span>
    <span class="c1">// OP_DUP OP_HASH160 &lt;pubkey_hash&gt; OP_EQUALVERIFY OP_CHECKSIG</span>

    <span class="c1">// åŸ·è¡Œéç¨‹ï¼š</span>
    <span class="c1">// 1. è§£é–è…³æœ¬æ¨å…¥ï¼š&lt;signature&gt; &lt;pubkey&gt;</span>
    <span class="c1">// 2. OP_DUPï¼šè¤‡è£½å †ç–Šé ‚éƒ¨çš„ pubkey</span>
    <span class="c1">// 3. OP_HASH160ï¼šå°è¤‡è£½çš„ pubkey è¨ˆç®— hash</span>
    <span class="c1">// 4. æ¨å…¥ pubkey_hash</span>
    <span class="c1">// 5. OP_EQUALVERIFYï¼šæ¯”è¼ƒå…©å€‹ hashï¼Œä¸ç›¸ç­‰å‰‡å¤±æ•—</span>
    <span class="c1">// 6. OP_CHECKSIGï¼šä½¿ç”¨ signature å’Œ pubkey é©—è­‰ç°½å</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="13-ä½¿ç”¨-rust-æ§‹å»ºè…³æœ¬">1.3 ä½¿ç”¨ Rust æ§‹å»ºè…³æœ¬</h3>

<p>rust-bitcoin æä¾›äº†å¤šç¨®æ§‹å»ºè…³æœ¬çš„æ–¹å¼ã€‚<code class="language-plaintext highlighter-rouge">Builder</code> é¡å‹è®“ä½ å¯ä»¥é€æ­¥æ·»åŠ æ“ä½œç¢¼å’Œæ•¸æ“šï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">script</span><span class="p">::{</span><span class="n">Script</span><span class="p">,</span> <span class="n">ScriptBuf</span><span class="p">,</span> <span class="n">Builder</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">opcodes</span><span class="p">::</span><span class="nn">all</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">build_scripts</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// ä½¿ç”¨ Builder æ§‹å»º P2PKH è…³æœ¬</span>
    <span class="k">let</span> <span class="n">pubkey_hash</span> <span class="o">=</span> <span class="nn">hex</span><span class="p">::</span><span class="nf">decode</span><span class="p">(</span><span class="s">"89abcdefabbaabbaabbaabbaabbaabbaabbaabba"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="k">let</span> <span class="n">p2pkh_script</span> <span class="o">=</span> <span class="nn">Builder</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_DUP</span><span class="p">)</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_HASH160</span><span class="p">)</span>
        <span class="nf">.push_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pubkey_hash</span><span class="p">)</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_EQUALVERIFY</span><span class="p">)</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_CHECKSIG</span><span class="p">)</span>
        <span class="nf">.into_script</span><span class="p">();</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"Script: {}"</span><span class="p">,</span> <span class="n">p2pkh_script</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"ASM: {}"</span><span class="p">,</span> <span class="n">p2pkh_script</span><span class="nf">.to_asm_string</span><span class="p">());</span>

    <span class="c1">// ä¹Ÿå¯ä»¥ä½¿ç”¨ä¾¿æ·å‡½æ•¸</span>
    <span class="k">let</span> <span class="n">pubkey_hash</span> <span class="o">=</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">PubkeyHash</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span>
        <span class="s">"89abcdefabbaabbaabbaabbaabbaabbaabbaabba"</span>
    <span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">p2pkh_shortcut</span> <span class="o">=</span> <span class="nn">ScriptBuf</span><span class="p">::</span><span class="nf">new_p2pkh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pubkey_hash</span><span class="p">);</span>

    <span class="c1">// å…©ç¨®æ–¹å¼ç”¢ç”Ÿç›¸åŒçš„è…³æœ¬</span>
    <span class="nd">assert_eq!</span><span class="p">(</span><span class="n">p2pkh_script</span><span class="p">,</span> <span class="n">p2pkh_shortcut</span><span class="p">);</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½ ä¹Ÿå¯ä»¥è§£æè…³æœ¬ä¾†æª¢æŸ¥å…¶çµæ§‹ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">parse_script</span><span class="p">(</span><span class="n">script</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Script</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">instruction</span> <span class="k">in</span> <span class="n">script</span><span class="nf">.instructions</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">match</span> <span class="n">instruction</span> <span class="p">{</span>
            <span class="nf">Ok</span><span class="p">(</span><span class="nn">bitcoin</span><span class="p">::</span><span class="nn">script</span><span class="p">::</span><span class="nn">Instruction</span><span class="p">::</span><span class="nf">Op</span><span class="p">(</span><span class="n">op</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nd">println!</span><span class="p">(</span><span class="s">"æ“ä½œç¢¼: {:?}"</span><span class="p">,</span> <span class="n">op</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nf">Ok</span><span class="p">(</span><span class="nn">bitcoin</span><span class="p">::</span><span class="nn">script</span><span class="p">::</span><span class="nn">Instruction</span><span class="p">::</span><span class="nf">PushBytes</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nd">println!</span><span class="p">(</span><span class="s">"æ•¸æ“š: {}"</span><span class="p">,</span> <span class="nn">hex</span><span class="p">::</span><span class="nf">encode</span><span class="p">(</span><span class="n">data</span><span class="nf">.as_bytes</span><span class="p">()));</span>
            <span class="p">}</span>
            <span class="nf">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nd">println!</span><span class="p">(</span><span class="s">"è§£æéŒ¯èª¤: {}"</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="2-æ¨™æº–è…³æœ¬é¡å‹">2. æ¨™æº–è…³æœ¬é¡å‹</h2>

<h3 id="21-p2pk-å’Œ-p2pkh">2.1 P2PK å’Œ P2PKH</h3>

<p><strong>P2PKï¼ˆPay-to-Public-Keyï¼‰</strong>æ˜¯æœ€æ—©çš„è…³æœ¬é¡å‹ï¼Œç›´æ¥å°‡å…¬é‘°åµŒå…¥è…³æœ¬ä¸­ã€‚è§£é–åªéœ€è¦æä¾›ç°½åã€‚é€™ç¨®æ ¼å¼ç¾åœ¨å·²ç¶“ä¸å¸¸ç”¨ï¼Œå› ç‚ºå®ƒæš´éœ²äº†å…¬é‘°ï¼Œè€Œä¸”è…³æœ¬è¼ƒé•·ã€‚</p>

<p><strong>P2PKHï¼ˆPay-to-Public-Key-Hashï¼‰</strong>æ”¹é€²äº†é€™å€‹è¨­è¨ˆï¼Œåªåœ¨è…³æœ¬ä¸­å­˜å„²å…¬é‘°çš„é›œæ¹Šå€¼ã€‚è§£é–æ™‚éœ€è¦åŒæ™‚æä¾›å…¬é‘°å’Œç°½åã€‚é€™æœ‰å…©å€‹å¥½è™•ï¼šè…³æœ¬æ›´çŸ­ï¼Œè€Œä¸”åœ¨è³‡é‡‘è¢«èŠ±è²»ä¹‹å‰ï¼Œå…¬é‘°ä¸æœƒæš´éœ²ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">standard_scripts</span><span class="p">(</span><span class="n">pubkey</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">PublicKey</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// P2PKï¼š&lt;pubkey&gt; OP_CHECKSIG</span>
    <span class="k">let</span> <span class="n">p2pk</span> <span class="o">=</span> <span class="nn">Builder</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
        <span class="nf">.push_key</span><span class="p">(</span><span class="n">pubkey</span><span class="p">)</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_CHECKSIG</span><span class="p">)</span>
        <span class="nf">.into_script</span><span class="p">();</span>

    <span class="c1">// P2PKHï¼šOP_DUP OP_HASH160 &lt;pubkey_hash&gt; OP_EQUALVERIFY OP_CHECKSIG</span>
    <span class="k">let</span> <span class="n">p2pkh</span> <span class="o">=</span> <span class="nn">ScriptBuf</span><span class="p">::</span><span class="nf">new_p2pkh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pubkey</span><span class="nf">.pubkey_hash</span><span class="p">());</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"P2PK å¤§å°: {} bytes"</span><span class="p">,</span> <span class="n">p2pk</span><span class="nf">.len</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"P2PKH å¤§å°: {} bytes"</span><span class="p">,</span> <span class="n">p2pkh</span><span class="nf">.len</span><span class="p">());</span>
    <span class="c1">// P2PKH è¼ƒçŸ­ï¼Œå› ç‚º pubkey_hash åªæœ‰ 20 bytesï¼Œè€Œå…¬é‘°æœ‰ 33 bytes</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="22-p2sh">2.2 P2SH</h3>

<p><strong>P2SHï¼ˆPay-to-Script-Hashï¼‰</strong>æ˜¯ä¸€å€‹å¼·å¤§çš„æŠ½è±¡ï¼Œå…è¨±æ”¯ä»˜åˆ°ä»»æ„è…³æœ¬çš„é›œæ¹Šå€¼ã€‚ç™¼é€è€…ä¸éœ€è¦çŸ¥é“è…³æœ¬çš„å…§å®¹â€”â€”ä»–å€‘åªéœ€æ”¯ä»˜åˆ°ä¸€å€‹ä»¥ 3 é–‹é ­çš„åœ°å€ã€‚åªæœ‰åœ¨èŠ±è²»æ™‚ï¼Œå®Œæ•´çš„è…³æœ¬æ‰æœƒè¢«æ­ç¤ºã€‚</p>

<p>é€™ç¨®è¨­è¨ˆæœ‰å¹¾å€‹å„ªé»ã€‚é¦–å…ˆï¼Œè¤‡é›œçš„è…³æœ¬ï¼ˆå¦‚å¤šé‡ç°½åï¼‰å¯ä»¥ç”¨çŸ­å°çš„åœ°å€è¡¨ç¤ºï¼Œæ¸›å°‘ç™¼é€è€…çš„è² æ“”ã€‚å…¶æ¬¡ï¼Œè…³æœ¬çš„è¤‡é›œæ€§æˆæœ¬ç”±èŠ±è²»è€…æ‰¿æ“”ï¼Œè€Œä¸æ˜¯ç™¼é€è€…ã€‚ç¬¬ä¸‰ï¼Œå®ƒç‚ºè…³æœ¬å‡ç´šæä¾›äº†éˆæ´»æ€§â€”â€”åªè¦é›œæ¹Šå€¼ç›¸åŒï¼Œåº•å±¤è…³æœ¬å¯ä»¥æ”¹è®Šã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">p2sh_demo</span><span class="p">(</span><span class="n">inner_script</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Script</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// P2SHï¼šOP_HASH160 &lt;script_hash&gt; OP_EQUAL</span>
    <span class="k">let</span> <span class="n">p2sh</span> <span class="o">=</span> <span class="nn">ScriptBuf</span><span class="p">::</span><span class="nf">new_p2sh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inner_script</span><span class="nf">.script_hash</span><span class="p">());</span>

    <span class="c1">// è§£é– P2SH éœ€è¦ï¼š</span>
    <span class="c1">// 1. æ»¿è¶³å…§éƒ¨è…³æœ¬çš„æ•¸æ“š</span>
    <span class="c1">// 2. å…§éƒ¨è…³æœ¬æœ¬èº«</span>

    <span class="c1">// ä¾‹å¦‚ï¼Œå°æ–¼åŒ…è£çš„ P2PKHï¼š</span>
    <span class="c1">// scriptSig: &lt;sig&gt; &lt;pubkey&gt; &lt;serialized_p2pkh_script&gt;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="23-segwit-è…³æœ¬p2wpkh-å’Œ-p2wsh">2.3 SegWit è…³æœ¬ï¼ˆP2WPKH å’Œ P2WSHï¼‰</h3>

<p>SegWitï¼ˆSegregated Witnessï¼‰å‡ç´šå¼•å…¥äº†æ–°çš„è…³æœ¬é¡å‹ï¼Œå°‡ç°½åæ•¸æ“šç§»åˆ°äº¤æ˜“çš„ã€Œè¦‹è­‰ã€éƒ¨åˆ†ã€‚é€™è§£æ±ºäº†äº¤æ˜“å¯å»¶å±•æ€§å•é¡Œï¼Œä¸¦é™ä½äº†è²»ç”¨ã€‚</p>

<p><strong>P2WPKH</strong> æ˜¯ P2PKH çš„ SegWit ç‰ˆæœ¬ã€‚é–å®šè…³æœ¬éå¸¸ç°¡çŸ­ï¼š<code class="language-plaintext highlighter-rouge">OP_0 &lt;20-byte-pubkey-hash&gt;</code>ã€‚<code class="language-plaintext highlighter-rouge">OP_0</code> è¡¨ç¤ºè¦‹è­‰ç‰ˆæœ¬ 0ã€‚è§£é–æ•¸æ“šï¼ˆç°½åå’Œå…¬é‘°ï¼‰æ”¾åœ¨ witness æ¬„ä½ä¸­ã€‚</p>

<p><strong>P2WSH</strong> æ˜¯ P2SH çš„ SegWit ç‰ˆæœ¬ï¼Œä½¿ç”¨ 32-byte çš„è…³æœ¬é›œæ¹Šï¼š<code class="language-plaintext highlighter-rouge">OP_0 &lt;32-byte-script-hash&gt;</code>ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">segwit_scripts</span><span class="p">(</span><span class="n">pubkey</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">PublicKey</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// P2WPKH</span>
    <span class="k">let</span> <span class="n">wpkh</span> <span class="o">=</span> <span class="n">pubkey</span><span class="nf">.wpubkey_hash</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">p2wpkh</span> <span class="o">=</span> <span class="nn">ScriptBuf</span><span class="p">::</span><span class="nf">new_p2wpkh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wpkh</span><span class="p">);</span>

    <span class="c1">// P2WSHï¼ˆåŒ…è£å¤šç°½è…³æœ¬ï¼‰</span>
    <span class="k">let</span> <span class="n">multisig_script</span> <span class="o">=</span> <span class="nf">create_multisig_script</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">pubkey1</span><span class="p">,</span> <span class="n">pubkey2</span><span class="p">,</span> <span class="n">pubkey3</span><span class="p">]);</span>
    <span class="k">let</span> <span class="n">wsh</span> <span class="o">=</span> <span class="n">multisig_script</span><span class="nf">.wscript_hash</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">p2wsh</span> <span class="o">=</span> <span class="nn">ScriptBuf</span><span class="p">::</span><span class="nf">new_p2wsh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wsh</span><span class="p">);</span>

    <span class="c1">// SegWit è…³æœ¬çš„ç‰¹é»æ˜¯éå¸¸ç°¡çŸ­</span>
    <span class="c1">// è¤‡é›œåº¦åœ¨ witness ä¸­ï¼Œè²»ç”¨è¼ƒä½</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="24-taprootp2tr">2.4 Taprootï¼ˆP2TRï¼‰</h3>

<p>Taproot æ˜¯ Bitcoin è…³æœ¬èƒ½åŠ›çš„æœ€æ–°é‡å¤§å‡ç´šã€‚P2TR è…³æœ¬çš„æ ¼å¼æ˜¯ <code class="language-plaintext highlighter-rouge">OP_1 &lt;32-byte-tweaked-pubkey&gt;</code>ï¼Œå…¶ä¸­ <code class="language-plaintext highlighter-rouge">OP_1</code> è¡¨ç¤ºè¦‹è­‰ç‰ˆæœ¬ 1ã€‚</p>

<p>Taproot çš„æ ¸å¿ƒå‰µæ–°æ˜¯ã€Œtweaked keyã€ã€‚è¼¸å‡ºå…¬é‘°æ˜¯å…§éƒ¨å…¬é‘°åŠ ä¸Šä¸€å€‹èª¿æ•´å€¼ï¼ˆtweakï¼‰ï¼Œé€™å€‹èª¿æ•´å€¼å¯ä»¥æ‰¿è«¾ï¼ˆcommitï¼‰åˆ°ä¸€æ£µè…³æœ¬æ¨¹ã€‚é€™æ„å‘³è‘—ï¼š</p>

<ul>
  <li>å¦‚æœæ‰€æœ‰åƒèˆ‡è€…åŒæ„ï¼Œå¯ä»¥ä½¿ç”¨å¯†é‘°è·¯å¾‘ï¼ˆkey pathï¼‰èŠ±è²»â€”â€”åªéœ€ä¸€å€‹ç°½å</li>
  <li>å¦‚æœéœ€è¦ä½¿ç”¨ç‰¹å®šæ¢ä»¶ï¼Œå¯ä»¥ä½¿ç”¨è…³æœ¬è·¯å¾‘ï¼ˆscript pathï¼‰â€”â€”æ­ç¤ºä¸¦åŸ·è¡Œè©²è…³æœ¬</li>
  <li>æœªä½¿ç”¨çš„è…³æœ¬æ°¸é ä¸æœƒæš´éœ²ï¼Œä¿è­·äº†éš±ç§</li>
</ul>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">taproot_scripts</span><span class="p">(</span><span class="n">secp</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Secp256k1</span><span class="o">&lt;</span><span class="nn">secp256k1</span><span class="p">::</span><span class="n">All</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">internal_key</span> <span class="o">=</span> <span class="nn">XOnlyPublicKey</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="s">"..."</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// ç°¡å–®çš„ P2TRï¼ˆç„¡è…³æœ¬æ¨¹ï¼‰</span>
    <span class="k">let</span> <span class="n">p2tr</span> <span class="o">=</span> <span class="nn">ScriptBuf</span><span class="p">::</span><span class="nf">new_p2tr</span><span class="p">(</span><span class="n">secp</span><span class="p">,</span> <span class="n">internal_key</span><span class="p">,</span> <span class="nb">None</span><span class="p">);</span>

    <span class="c1">// å¸¶è…³æœ¬æ¨¹çš„ P2TR</span>
    <span class="k">let</span> <span class="n">script_a</span> <span class="o">=</span> <span class="nn">Builder</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
        <span class="nf">.push_x_only_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">internal_key</span><span class="p">)</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_CHECKSIG</span><span class="p">)</span>
        <span class="nf">.into_script</span><span class="p">();</span>

    <span class="k">let</span> <span class="n">taproot</span> <span class="o">=</span> <span class="nn">TaprootBuilder</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
        <span class="nf">.add_leaf</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">script_a</span><span class="p">)</span><span class="o">?</span>
        <span class="nf">.finalize</span><span class="p">(</span><span class="n">secp</span><span class="p">,</span> <span class="n">internal_key</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="k">let</span> <span class="n">tweaked_key</span> <span class="o">=</span> <span class="n">taproot</span><span class="nf">.output_key</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">p2tr_with_scripts</span> <span class="o">=</span> <span class="nn">ScriptBuf</span><span class="p">::</span><span class="nf">new_p2tr_tweaked</span><span class="p">(</span><span class="n">tweaked_key</span><span class="p">);</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="3-å¤šé‡ç°½å">3. å¤šé‡ç°½å</h2>

<h3 id="31-ç†è§£å¤šé‡ç°½å">3.1 ç†è§£å¤šé‡ç°½å</h3>

<p>å¤šé‡ç°½åï¼ˆmultisigï¼‰æ˜¯ Bitcoin æœ€é‡è¦çš„è…³æœ¬åŠŸèƒ½ä¹‹ä¸€ï¼Œè¦æ±‚å¤šå€‹å¯†é‘°ä¸­çš„ä¸€éƒ¨åˆ†ä¾†æˆæ¬Šäº¤æ˜“ã€‚å¸¸è¦‹çš„é…ç½®åŒ…æ‹¬ 2-of-3ï¼ˆä¸‰å€‹å¯†é‘°ä¸­ä»»æ„å…©å€‹ï¼‰å’Œ 3-of-5ã€‚</p>

<p>å¤šé‡ç°½åæœ‰è¨±å¤šæ‡‰ç”¨å ´æ™¯ã€‚å°æ–¼å€‹äººç”¨æˆ¶ï¼Œå®ƒæä¾›äº†å‚™ä»½å’Œå®‰å…¨æ€§â€”â€”å³ä½¿ä¸Ÿå¤±ä¸€å€‹å¯†é‘°ï¼Œè³‡é‡‘ä»ç„¶å¯ä»¥å–å›ï¼›å³ä½¿ä¸€å€‹å¯†é‘°è¢«ç›œï¼Œæ”»æ“Šè€…ä¹Ÿç„¡æ³•å–®ç¨èŠ±è²»è³‡é‡‘ã€‚å°æ–¼çµ„ç¹”ï¼Œå®ƒå¯¦ç¾äº†å…±åŒæ§åˆ¶â€”â€”éœ€è¦å¤šäººåŒæ„æ‰èƒ½ç§»å‹•è³‡é‡‘ã€‚</p>

<p>å‚³çµ±çš„å¤šç°½ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">OP_CHECKMULTISIG</code> æ“ä½œç¢¼ï¼Œä½†é€™æœ‰ä¸€äº›ç¼ºé»ï¼šå…¬é‘°æ•¸é‡å’Œé–€æª»åœ¨è…³æœ¬ä¸­å¯è¦‹ï¼Œè²»ç”¨éš¨å…¬é‘°æ•¸é‡ç·šæ€§å¢åŠ ã€‚Taproot æ™‚ä»£çš„å¤šç°½æœ‰æ›´å¥½çš„é¸æ“‡ï¼Œæˆ‘å€‘ç¨å¾Œæœƒè¨è«–ã€‚</p>

<h3 id="32-æ§‹å»ºå‚³çµ±å¤šç°½è…³æœ¬">3.2 æ§‹å»ºå‚³çµ±å¤šç°½è…³æœ¬</h3>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">create_multisig_script</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">pubkeys</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">PublicKey</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="n">ScriptBuf</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="n">pubkeys</span><span class="nf">.len</span><span class="p">()</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">;</span>
    <span class="nd">assert!</span><span class="p">(</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">,</span> <span class="s">"ç„¡æ•ˆçš„ M-of-N åƒæ•¸"</span><span class="p">);</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">builder</span> <span class="o">=</span> <span class="nn">Builder</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span><span class="nf">.push_int</span><span class="p">(</span><span class="n">m</span> <span class="k">as</span> <span class="nb">i64</span><span class="p">);</span>

    <span class="k">for</span> <span class="n">pubkey</span> <span class="k">in</span> <span class="n">pubkeys</span> <span class="p">{</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="nf">.push_key</span><span class="p">(</span><span class="n">pubkey</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">builder</span>
        <span class="nf">.push_int</span><span class="p">(</span><span class="n">n</span> <span class="k">as</span> <span class="nb">i64</span><span class="p">)</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_CHECKMULTISIG</span><span class="p">)</span>
        <span class="nf">.into_script</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">multisig_demo</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// å‰µå»ºä¸‰å€‹å…¬é‘°</span>
    <span class="k">let</span> <span class="n">pubkeys</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">PublicKey</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span>
        <span class="nn">PublicKey</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="s">"02..."</span><span class="p">)</span><span class="o">?</span><span class="p">,</span>
        <span class="nn">PublicKey</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="s">"02..."</span><span class="p">)</span><span class="o">?</span><span class="p">,</span>
        <span class="nn">PublicKey</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="s">"02..."</span><span class="p">)</span><span class="o">?</span><span class="p">,</span>
    <span class="p">];</span>

    <span class="c1">// 2-of-3 å¤šç°½</span>
    <span class="k">let</span> <span class="n">multisig</span> <span class="o">=</span> <span class="nf">create_multisig_script</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pubkeys</span><span class="p">);</span>

    <span class="c1">// é€šå¸¸åŒ…è£åœ¨ P2WSH ä¸­ä»¥ç¯€çœè²»ç”¨</span>
    <span class="k">let</span> <span class="n">p2wsh</span> <span class="o">=</span> <span class="nn">ScriptBuf</span><span class="p">::</span><span class="nf">new_p2wsh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">multisig</span><span class="nf">.wscript_hash</span><span class="p">());</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"å¤šç°½è…³æœ¬: {}"</span><span class="p">,</span> <span class="n">multisig</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"P2WSH è…³æœ¬: {}"</span><span class="p">,</span> <span class="n">p2wsh</span><span class="p">);</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="33-èŠ±è²»å¤šç°½">3.3 èŠ±è²»å¤šç°½</h3>

<p>èŠ±è²»å¤šç°½äº¤æ˜“éœ€è¦æä¾›è¶³å¤ æ•¸é‡çš„æœ‰æ•ˆç°½åã€‚å°æ–¼å‚³çµ±çš„ <code class="language-plaintext highlighter-rouge">OP_CHECKMULTISIG</code>ï¼Œé‚„éœ€è¦æ³¨æ„ä¸€å€‹è‘—åçš„ bugï¼šæ“ä½œç¢¼æœƒé¡å¤–æ¶ˆè€—ä¸€å€‹å †ç–Šå…ƒç´ ï¼ˆé€šå¸¸ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">OP_0</code> ä½”ä½ï¼‰ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">spend_multisig</span><span class="p">(</span>
    <span class="n">tx</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Transaction</span><span class="p">,</span>
    <span class="n">input_index</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">multisig_script</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Script</span><span class="p">,</span>
    <span class="n">signatures</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="c1">// å‚³çµ±å¤šç°½çš„è§£é–è…³æœ¬ï¼š</span>
    <span class="c1">// OP_0 &lt;sig1&gt; &lt;sig2&gt; ... &lt;redeemScript&gt;</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">witness</span> <span class="o">=</span> <span class="nn">Witness</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>

    <span class="c1">// OP_0ï¼ˆCHECKMULTISIG bug çš„ä½”ä½ç¬¦ï¼‰</span>
    <span class="n">witness</span><span class="nf">.push</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[]);</span>

    <span class="c1">// æ·»åŠ ç°½å</span>
    <span class="k">for</span> <span class="n">sig</span> <span class="k">in</span> <span class="n">signatures</span> <span class="p">{</span>
        <span class="n">witness</span><span class="nf">.push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sig</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// å°æ–¼ P2WSHï¼Œéœ€è¦æ·»åŠ è…³æœ¬</span>
    <span class="n">witness</span><span class="nf">.push</span><span class="p">(</span><span class="n">multisig_script</span><span class="nf">.as_bytes</span><span class="p">());</span>

    <span class="n">tx</span><span class="py">.input</span><span class="p">[</span><span class="n">input_index</span><span class="p">]</span><span class="py">.witness</span> <span class="o">=</span> <span class="n">witness</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="4-ç°½åæ©Ÿåˆ¶è©³è§£">4. ç°½åæ©Ÿåˆ¶è©³è§£</h2>

<h3 id="41-ecdsa-ç°½å">4.1 ECDSA ç°½å</h3>

<p>ECDSAï¼ˆElliptic Curve Digital Signature Algorithmï¼‰æ˜¯ Bitcoin æœ€åˆä½¿ç”¨çš„ç°½åæ¼”ç®—æ³•ã€‚ç°½åéç¨‹åŒ…æ‹¬ï¼š</p>

<ol>
  <li>è¨ˆç®—è¦ç°½åçš„æ¶ˆæ¯ï¼ˆäº¤æ˜“æ•¸æ“šçš„ç‰¹å®šå“ˆå¸Œï¼‰</li>
  <li>ä½¿ç”¨ç§é‘°å’Œéš¨æ©Ÿæ•¸ç”Ÿæˆç°½å</li>
  <li>ç°½åç”±å…©å€‹æ•¸å€¼ (r, s) çµ„æˆï¼Œä»¥ DER æ ¼å¼ç·¨ç¢¼</li>
</ol>

<p>ç°½åå“ˆå¸Œï¼ˆsighashï¼‰çš„è¨ˆç®—æ–¹å¼å–æ±ºæ–¼è…³æœ¬é¡å‹ã€‚å‚³çµ±è…³æœ¬ä½¿ç”¨åŸå§‹çš„ sighash æ¼”ç®—æ³•ï¼Œè€Œ SegWit ä½¿ç”¨ BIP143 å®šç¾©çš„æ–°æ¼”ç®—æ³•ï¼Œå¾Œè€…åŒ…å«äº†è¢«èŠ±è²» UTXO çš„é‡‘é¡ï¼Œé˜²æ­¢äº†æŸäº›é¡å‹çš„æ”»æ“Šã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">sighash</span><span class="p">::{</span><span class="n">SighashCache</span><span class="p">,</span> <span class="n">EcdsaSighashType</span><span class="p">};</span>

<span class="k">fn</span> <span class="nf">ecdsa_signing</span><span class="p">(</span>
    <span class="n">tx</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Transaction</span><span class="p">,</span>
    <span class="n">input_index</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">utxo_script</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Script</span><span class="p">,</span>
    <span class="n">utxo_amount</span><span class="p">:</span> <span class="n">Amount</span><span class="p">,</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">PrivateKey</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">secp</span> <span class="o">=</span> <span class="nn">Secp256k1</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">public_key</span> <span class="o">=</span> <span class="n">private_key</span><span class="nf">.public_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">);</span>

    <span class="c1">// å°æ–¼ P2WPKHï¼ŒscriptCode æ˜¯å°æ‡‰çš„ P2PKH è…³æœ¬</span>
    <span class="k">let</span> <span class="n">script_code</span> <span class="o">=</span> <span class="nn">ScriptBuf</span><span class="p">::</span><span class="nf">new_p2pkh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">public_key</span><span class="nf">.pubkey_hash</span><span class="p">());</span>

    <span class="c1">// è¨ˆç®— BIP143 sighash</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">sighash_cache</span> <span class="o">=</span> <span class="nn">SighashCache</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">sighash</span> <span class="o">=</span> <span class="n">sighash_cache</span><span class="nf">.p2wpkh_signature_hash</span><span class="p">(</span>
        <span class="n">input_index</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">script_code</span><span class="p">,</span>
        <span class="n">utxo_amount</span><span class="p">,</span>
        <span class="nn">EcdsaSighashType</span><span class="p">::</span><span class="n">All</span><span class="p">,</span>
    <span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// å‰µå»ºç°½å</span>
    <span class="k">let</span> <span class="n">message</span> <span class="o">=</span> <span class="nn">Message</span><span class="p">::</span><span class="nf">from_digest_slice</span><span class="p">(</span><span class="n">sighash</span><span class="nf">.as_byte_array</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">secp</span><span class="nf">.sign_ecdsa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">private_key</span><span class="py">.inner</span><span class="p">);</span>

    <span class="c1">// DER ç·¨ç¢¼ + sighash type</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">sig_bytes</span> <span class="o">=</span> <span class="n">signature</span><span class="nf">.serialize_der</span><span class="p">()</span><span class="nf">.to_vec</span><span class="p">();</span>
    <span class="n">sig_bytes</span><span class="nf">.push</span><span class="p">(</span><span class="nn">EcdsaSighashType</span><span class="p">::</span><span class="n">All</span><span class="nf">.to_u32</span><span class="p">()</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">);</span>

    <span class="nf">Ok</span><span class="p">(</span><span class="n">sig_bytes</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="42-sighash-é¡å‹">4.2 Sighash é¡å‹</h3>

<p>Sighash é¡å‹æ§åˆ¶ç°½åæ¶µè“‹äº¤æ˜“çš„å“ªäº›éƒ¨åˆ†ï¼Œæä¾›äº†éˆæ´»çš„ç°½åé¸é …ï¼š</p>

<p><strong>SIGHASH_ALLï¼ˆ0x01ï¼‰</strong>ï¼šæœ€å¸¸è¦‹ï¼Œç°½åæ¶µè“‹æ‰€æœ‰è¼¸å…¥å’Œè¼¸å‡ºã€‚ä»»ä½•æ”¹è®Šéƒ½æœƒä½¿ç°½åç„¡æ•ˆã€‚</p>

<p><strong>SIGHASH_NONEï¼ˆ0x02ï¼‰</strong>ï¼šåªç°½åè¼¸å…¥ï¼Œä¸ç°½è¼¸å‡ºã€‚ç°½åè€…åŒæ„èŠ±è²»é€™äº›è¼¸å…¥ï¼Œä½†ä¸é—œå¿ƒè³‡é‡‘å»å‘ã€‚é€™å¾ˆå±éšªï¼Œå› ç‚ºä»»ä½•äººéƒ½å¯ä»¥ä¿®æ”¹è¼¸å‡ºã€‚</p>

<p><strong>SIGHASH_SINGLEï¼ˆ0x03ï¼‰</strong>ï¼šç°½åæ‰€æœ‰è¼¸å…¥å’ŒåŒä¸€ç´¢å¼•çš„è¼¸å‡ºã€‚ç”¨æ–¼æŸäº›ç‰¹æ®Šçš„å¤šæ–¹å”è­°ã€‚</p>

<p><strong>ANYONECANPAYï¼ˆ0x80ï¼‰</strong>ï¼šå¯ä»¥èˆ‡ä¸Šè¿°ä»»ä½•é¡å‹çµ„åˆã€‚åªç°½åç•¶å‰è¼¸å…¥ï¼Œå…è¨±å…¶ä»–äººæ·»åŠ æ›´å¤šè¼¸å…¥ã€‚é€™å¯ä»¥ç”¨æ–¼çœ¾ç±Œâ€”â€”å¤šäººå¯ä»¥å„è‡ªæ·»åŠ è¼¸å…¥åˆ°åŒä¸€ç­†äº¤æ˜“ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">sighash_types_demo</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ä¸åŒ sighash é¡å‹çš„ç”¨ä¾‹</span>

    <span class="c1">// ALLï¼šæ¨™æº–æ”¯ä»˜</span>
    <span class="c1">// "æˆ‘åŒæ„èŠ±è²»é€™äº›è¼¸å…¥ï¼Œå°‡è³‡é‡‘ç™¼é€åˆ°é€™äº›è¼¸å‡º"</span>

    <span class="c1">// NONEï¼šç°½åæˆæ¬Š</span>
    <span class="c1">// "æˆ‘æˆæ¬ŠèŠ±è²»é€™äº›è¼¸å…¥ï¼Œä»»ä½•äººå¯ä»¥æ±ºå®šå»å‘"</span>

    <span class="c1">// SINGLEï¼šäº¤æ›</span>
    <span class="c1">// "æˆ‘é¡˜æ„ç”¨æˆ‘çš„è¼¸å…¥æ›å–é€™å€‹ç‰¹å®šçš„è¼¸å‡º"</span>

    <span class="c1">// ALL|ANYONECANPAYï¼šçœ¾ç±Œ</span>
    <span class="c1">// "å¦‚æœé”æˆé€™å€‹è¼¸å‡ºï¼Œæˆ‘é¡˜æ„è²¢ç»æˆ‘çš„è¼¸å…¥"</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="43-schnorr-ç°½å">4.3 Schnorr ç°½å</h3>

<p>Taproot å¼•å…¥äº† Schnorr ç°½åï¼ˆBIP340ï¼‰ï¼Œå®ƒæ¯” ECDSA æœ‰å¤šå€‹å„ªé»ï¼š</p>

<p><strong>æ›´å°çš„ç°½å</strong>ï¼š64 bytesï¼Œè€Œ ECDSA æ˜¯ 71-72 bytesã€‚</p>

<p><strong>ç·šæ€§æ€§</strong>ï¼šå¤šå€‹ç°½åå¯ä»¥èšåˆæˆä¸€å€‹ã€‚é€™æ„å‘³è‘— n-of-n å¤šç°½å¯ä»¥è¡¨ç¾å¾—åƒå–®ç°½ï¼Œå¤§å¤§æé«˜éš±ç§å’Œæ•ˆç‡ã€‚</p>

<p><strong>æ‰¹é‡é©—è­‰</strong>ï¼šå¤šå€‹ç°½åå¯ä»¥åŒæ™‚é©—è­‰ï¼Œæ¯”é€å€‹é©—è­‰æ›´å¿«ã€‚</p>

<p><strong>æ›´ç°¡å–®çš„å®‰å…¨è­‰æ˜</strong>ï¼šSchnorr çš„æ•¸å­¸çµæ§‹æ›´ç°¡æ½”ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">secp256k1</span><span class="p">::{</span><span class="n">Keypair</span><span class="p">,</span> <span class="n">XOnlyPublicKey</span><span class="p">};</span>

<span class="k">fn</span> <span class="nf">schnorr_signing</span><span class="p">(</span>
    <span class="n">tx</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Transaction</span><span class="p">,</span>
    <span class="n">input_index</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">prevouts</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">TxOut</span><span class="p">],</span>
    <span class="n">keypair</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Keypair</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">secp</span> <span class="o">=</span> <span class="nn">Secp256k1</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>

    <span class="c1">// è¨ˆç®— Taproot sighash</span>
    <span class="k">let</span> <span class="n">prevouts</span> <span class="o">=</span> <span class="nn">Prevouts</span><span class="p">::</span><span class="nf">All</span><span class="p">(</span><span class="n">prevouts</span><span class="p">);</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">sighash_cache</span> <span class="o">=</span> <span class="nn">SighashCache</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">sighash</span> <span class="o">=</span> <span class="n">sighash_cache</span><span class="nf">.taproot_key_spend_signature_hash</span><span class="p">(</span>
        <span class="n">input_index</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">prevouts</span><span class="p">,</span>
        <span class="nn">TapSighashType</span><span class="p">::</span><span class="nb">Default</span><span class="p">,</span>
    <span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// Schnorr ç°½å</span>
    <span class="k">let</span> <span class="n">msg</span> <span class="o">=</span> <span class="nn">Message</span><span class="p">::</span><span class="nf">from_digest_slice</span><span class="p">(</span><span class="n">sighash</span><span class="nf">.as_byte_array</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">secp</span><span class="nf">.sign_schnorr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">keypair</span><span class="p">);</span>

    <span class="c1">// Schnorr ç°½åå›ºå®š 64 bytes</span>
    <span class="nf">Ok</span><span class="p">(</span><span class="n">signature</span><span class="nf">.as_ref</span><span class="p">()</span><span class="nf">.to_vec</span><span class="p">())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="44-taproot-ç°½åçš„å…©ç¨®è·¯å¾‘">4.4 Taproot ç°½åçš„å…©ç¨®è·¯å¾‘</h3>

<p>Taproot äº¤æ˜“å¯ä»¥é€šéå…©ç¨®æ–¹å¼èŠ±è²»ï¼š</p>

<p><strong>å¯†é‘°è·¯å¾‘ï¼ˆKey Pathï¼‰</strong>ï¼šå¦‚æœä½ æ§åˆ¶å…§éƒ¨å¯†é‘°ï¼ˆæˆ–èšåˆå¯†é‘°ï¼‰ï¼Œåªéœ€æä¾›ä¸€å€‹ Schnorr ç°½åã€‚é€™æ˜¯æœ€æœ‰æ•ˆç‡çš„æ–¹å¼ï¼Œwitness åªåŒ…å«ä¸€å€‹ 64-byte ç°½åã€‚</p>

<p><strong>è…³æœ¬è·¯å¾‘ï¼ˆScript Pathï¼‰</strong>ï¼šæ­ç¤ºä¸¦åŸ·è¡Œè…³æœ¬æ¨¹ä¸­çš„ä¸€å€‹è…³æœ¬ã€‚witness åŒ…å«ï¼š</p>
<ol>
  <li>æ»¿è¶³è…³æœ¬çš„æ•¸æ“šï¼ˆå¦‚ç°½åï¼‰</li>
  <li>è…³æœ¬æœ¬èº«</li>
  <li>Control blockï¼ˆåŒ…å«å…§éƒ¨å…¬é‘°å’Œ Merkle è­‰æ˜ï¼‰</li>
</ol>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">taproot_spending_demo</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Key path spending</span>
    <span class="c1">// witness: [schnorr_signature]</span>
    <span class="c1">// æœ€ç°¡æ½”ï¼Œ64 bytes</span>

    <span class="c1">// Script path spending</span>
    <span class="c1">// witness: [script_args...] [script] [control_block]</span>
    <span class="c1">// è¼ƒå¤§ï¼Œä½†å…è¨±è¤‡é›œæ¢ä»¶</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="5-miniscript">5. Miniscript</h2>

<h3 id="51-ç‚ºä»€éº¼éœ€è¦-miniscript">5.1 ç‚ºä»€éº¼éœ€è¦ Miniscript</h3>

<p>ç›´æ¥ç·¨å¯« Bitcoin Script æ˜¯å®¹æ˜“å‡ºéŒ¯çš„ã€‚è…³æœ¬å¯èƒ½çœ‹èµ·ä¾†æ­£ç¢ºä½†æœ‰å¾®å¦™çš„ bugâ€”â€”ä¾‹å¦‚ï¼Œå¿˜è¨˜äº† <code class="language-plaintext highlighter-rouge">OP_CHECKMULTISIG</code> çš„ä½”ä½ bugï¼Œæˆ–è€…æ¢ä»¶åˆ†æ”¯ä¸å®Œæ•´ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå¾ˆé›£åˆ†æä¸€å€‹è…³æœ¬çš„æ‰€æœ‰å¯èƒ½èŠ±è²»æ–¹å¼ã€‚</p>

<p>Miniscript è§£æ±ºäº†é€™äº›å•é¡Œã€‚å®ƒæ˜¯ Bitcoin Script çš„ä¸€å€‹å­é›†ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹é»ï¼š</p>

<p><strong>å¯çµ„åˆæ€§</strong>ï¼šä½ å¯ä»¥å®‰å…¨åœ°çµ„åˆä¸åŒçš„æ¢ä»¶ï¼Œè€Œä¸ç”¨æ“”å¿ƒå®ƒå€‘ä¹‹é–“çš„äº¤äº’ã€‚</p>

<p><strong>å¯åˆ†ææ€§</strong>ï¼šçµ¦å®šä¸€å€‹ Miniscriptï¼Œä½ å¯ä»¥è‡ªå‹•åˆ†æï¼šæ‰€æœ‰å¯èƒ½çš„èŠ±è²»æ–¹å¼ã€æ¯ç¨®æ–¹å¼çš„ witness å¤§å°ã€æ¶‰åŠçš„å…¬é‘°å’Œæ™‚é–“é–ã€‚</p>

<p><strong>ç·¨è­¯å„ªåŒ–</strong>ï¼šå¾é«˜éšç­–ç•¥èªè¨€ç·¨è­¯ç‚ºæœ€å„ªçš„ Scriptã€‚</p>

<h3 id="52-ç­–ç•¥èªè¨€">5.2 ç­–ç•¥èªè¨€</h3>

<p>Miniscript ä½¿ç”¨ä¸€ç¨®ç°¡æ½”çš„ç­–ç•¥èªè¨€ä¾†æè¿°èŠ±è²»æ¢ä»¶ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pk(KEY)</code> - éœ€è¦ KEY çš„ç°½å</li>
  <li><code class="language-plaintext highlighter-rouge">older(N)</code> - ç›¸å°æ™‚é–“é–ï¼ŒN å€‹å€å¡Šå¾Œ</li>
  <li><code class="language-plaintext highlighter-rouge">after(N)</code> - çµ•å°æ™‚é–“é–</li>
  <li><code class="language-plaintext highlighter-rouge">sha256(H)</code> - éœ€è¦ SHA256 åŸåƒ</li>
  <li><code class="language-plaintext highlighter-rouge">and(A, B)</code> - éœ€è¦ A å’Œ B åŒæ™‚æ»¿è¶³</li>
  <li><code class="language-plaintext highlighter-rouge">or(A, B)</code> - A æˆ– B å…¶ä¸­ä¹‹ä¸€</li>
  <li><code class="language-plaintext highlighter-rouge">thresh(k, A, B, C...)</code> - k-of-n æ¢ä»¶</li>
</ul>

<p>ä¾‹å¦‚ï¼Œ<code class="language-plaintext highlighter-rouge">or(pk(Alice), and(pk(Bob), older(144)))</code> è¡¨ç¤ºï¼šAlice å¯ä»¥ç«‹å³èŠ±è²»ï¼Œæˆ–è€… Bob åœ¨ 144 å€‹å€å¡Šï¼ˆç´„ 1 å¤©ï¼‰å¾Œå¯ä»¥èŠ±è²»ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">miniscript</span><span class="p">::</span><span class="nn">policy</span><span class="p">::</span><span class="n">Concrete</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">miniscript</span><span class="p">::</span><span class="n">Segwitv0</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">miniscript_demo</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">alice</span> <span class="o">=</span> <span class="s">"02alice..."</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">bob</span> <span class="o">=</span> <span class="s">"02bob..."</span><span class="p">;</span>

    <span class="c1">// å®šç¾©ç­–ç•¥</span>
    <span class="k">let</span> <span class="n">policy_str</span> <span class="o">=</span> <span class="nd">format!</span><span class="p">(</span>
        <span class="s">"or(pk({}),and(pk({}),older(144)))"</span><span class="p">,</span>
        <span class="n">alice</span><span class="p">,</span> <span class="n">bob</span>
    <span class="p">);</span>

    <span class="c1">// è§£æç­–ç•¥</span>
    <span class="k">let</span> <span class="n">policy</span> <span class="o">=</span> <span class="nn">Concrete</span><span class="p">::</span><span class="o">&lt;</span><span class="n">PublicKey</span><span class="o">&gt;</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy_str</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// ç·¨è­¯ç‚º Miniscript</span>
    <span class="k">let</span> <span class="n">miniscript</span> <span class="o">=</span> <span class="n">policy</span><span class="py">.compile</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Segwitv0</span><span class="o">&gt;</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// ç²å– Script</span>
    <span class="k">let</span> <span class="n">script</span> <span class="o">=</span> <span class="n">miniscript</span><span class="nf">.encode</span><span class="p">();</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"ç­–ç•¥: {}"</span><span class="p">,</span> <span class="n">policy</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Miniscript: {}"</span><span class="p">,</span> <span class="n">miniscript</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Script å¤§å°: {} bytes"</span><span class="p">,</span> <span class="n">script</span><span class="nf">.len</span><span class="p">());</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="53-æè¿°ç¬¦descriptors">5.3 æè¿°ç¬¦ï¼ˆDescriptorsï¼‰</h3>

<p>æè¿°ç¬¦æ˜¯éŒ¢åŒ…è»Ÿé«”ç”¨ä¾†æè¿°åœ°å€ç”Ÿæˆæ–¹å¼çš„æ¨™æº–æ ¼å¼ã€‚å®ƒå€‘çµåˆäº†è…³æœ¬é¡å‹å’Œå¯†é‘°è³‡è¨Šï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pkh(KEY)</code> - P2PKH åœ°å€</li>
  <li><code class="language-plaintext highlighter-rouge">wpkh(KEY)</code> - P2WPKH åœ°å€</li>
  <li><code class="language-plaintext highlighter-rouge">sh(wpkh(KEY))</code> - P2SH-P2WPKH</li>
  <li><code class="language-plaintext highlighter-rouge">tr(KEY)</code> - ç°¡å–® P2TR</li>
  <li><code class="language-plaintext highlighter-rouge">wsh(multi(2,KEY1,KEY2,KEY3))</code> - 2-of-3 P2WSH å¤šç°½</li>
</ul>

<p>æè¿°ç¬¦å¯ä»¥åŒ…å« HD æ´¾ç”Ÿè·¯å¾‘ï¼Œå…è¨±éŒ¢åŒ…æ‰¹é‡ç”Ÿæˆåœ°å€ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>wpkh([fingerprint/84'/0'/0']xpub.../0/*)
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€™è¡¨ç¤ºï¼šä½¿ç”¨ BIP84 è·¯å¾‘æ´¾ç”Ÿçš„æ“´å±•å…¬é‘°ï¼Œç”Ÿæˆæ¥æ”¶åœ°å€ï¼ˆ/0/*ï¼‰ã€‚</p>

<hr />

<h2 id="6-é€²éšè…³æœ¬æŠ€å·§">6. é€²éšè…³æœ¬æŠ€å·§</h2>

<h3 id="61-æ™‚é–“é–">6.1 æ™‚é–“é–</h3>

<p>æ™‚é–“é–æ˜¯ Bitcoin è…³æœ¬çš„é‡è¦åŠŸèƒ½ï¼Œå…è¨±è³‡é‡‘åªèƒ½åœ¨ç‰¹å®šæ™‚é–“å¾Œè¢«èŠ±è²»ã€‚</p>

<p><strong>CHECKLOCKTIMEVERIFYï¼ˆCLTVï¼‰</strong>å¯¦ç¾çµ•å°æ™‚é–“é–ã€‚å€¼å°æ–¼ 5 å„„è¢«è§£é‡‹ç‚ºå€å¡Šé«˜åº¦ï¼Œå¤§æ–¼ç­‰æ–¼ 5 å„„è¢«è§£é‡‹ç‚º Unix æ™‚é–“æˆ³ã€‚</p>

<p><strong>CHECKSEQUENCEVERIFYï¼ˆCSVï¼‰</strong>å¯¦ç¾ç›¸å°æ™‚é–“é–ï¼Œå¾ UTXO è¢«å‰µå»ºé–‹å§‹è¨ˆç®—ã€‚é€™å°æ–¼é–ƒé›»ç¶²è·¯ç­‰å”è­°è‡³é—œé‡è¦ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">timelock_script</span><span class="p">(</span><span class="n">pubkey</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">PublicKey</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="nb">i64</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">ScriptBuf</span> <span class="p">{</span>
    <span class="c1">// &lt;blocks&gt; OP_CSV OP_DROP &lt;pubkey&gt; OP_CHECKSIG</span>
    <span class="nn">Builder</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
        <span class="nf">.push_int</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_CSV</span><span class="p">)</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_DROP</span><span class="p">)</span>
        <span class="nf">.push_key</span><span class="p">(</span><span class="n">pubkey</span><span class="p">)</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_CHECKSIG</span><span class="p">)</span>
        <span class="nf">.into_script</span><span class="p">()</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="62-htlcå“ˆå¸Œæ™‚é–“é–åˆç´„">6.2 HTLCï¼ˆå“ˆå¸Œæ™‚é–“é–åˆç´„ï¼‰</h3>

<p>HTLC æ˜¯é–ƒé›»ç¶²è·¯å’ŒåŸå­äº¤æ›çš„åŸºç¤ã€‚å®ƒå…è¨±æœ‰æ¢ä»¶çš„æ”¯ä»˜ï¼šå¦‚æœæ¥æ”¶è€…åœ¨æ™‚é™å…§æ­ç¤ºåŸåƒï¼ˆpreimageï¼‰ï¼Œå¯ä»¥é ˜å–è³‡é‡‘ï¼›å¦å‰‡ç™¼é€è€…å¯ä»¥å–å›ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">htlc_script</span><span class="p">(</span>
    <span class="n">recipient_pubkey</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">XOnlyPublicKey</span><span class="p">,</span>
    <span class="n">sender_pubkey</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">XOnlyPublicKey</span><span class="p">,</span>
    <span class="n">payment_hash</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">],</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="nb">i64</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="n">ScriptBuf</span> <span class="p">{</span>
    <span class="c1">// IF</span>
    <span class="c1">//   OP_SHA256 &lt;hash&gt; OP_EQUALVERIFY &lt;recipient&gt; OP_CHECKSIG</span>
    <span class="c1">// ELSE</span>
    <span class="c1">//   &lt;timeout&gt; OP_CLTV OP_DROP &lt;sender&gt; OP_CHECKSIG</span>
    <span class="c1">// ENDIF</span>

    <span class="nn">Builder</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_IF</span><span class="p">)</span>
            <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_SHA256</span><span class="p">)</span>
            <span class="nf">.push_slice</span><span class="p">(</span><span class="n">payment_hash</span><span class="p">)</span>
            <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_EQUALVERIFY</span><span class="p">)</span>
            <span class="nf">.push_x_only_key</span><span class="p">(</span><span class="n">recipient_pubkey</span><span class="p">)</span>
            <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_CHECKSIG</span><span class="p">)</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_ELSE</span><span class="p">)</span>
            <span class="nf">.push_int</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_CLTV</span><span class="p">)</span>
            <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_DROP</span><span class="p">)</span>
            <span class="nf">.push_x_only_key</span><span class="p">(</span><span class="n">sender_pubkey</span><span class="p">)</span>
            <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_CHECKSIG</span><span class="p">)</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_ENDIF</span><span class="p">)</span>
        <span class="nf">.into_script</span><span class="p">()</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="63-taproot-è…³æœ¬æ¨¹">6.3 Taproot è…³æœ¬æ¨¹</h3>

<p>Taproot å…è¨±å°‡å¤šå€‹è…³æœ¬çµ„ç¹”æˆ Merkle æ¨¹ã€‚æ¯å€‹è‘‰å­æ˜¯ä¸€å€‹ç¨ç«‹çš„èŠ±è²»æ¢ä»¶ã€‚ç•¶ä½¿ç”¨æŸå€‹è…³æœ¬èŠ±è²»æ™‚ï¼Œåªéœ€æ­ç¤ºè©²è…³æœ¬å’Œ Merkle è­‰æ˜ï¼Œå…¶ä»–è…³æœ¬ä¿æŒéš±è—ã€‚</p>

<p>é€™ç¨®è¨­è¨ˆç‰¹åˆ¥é©åˆæœ‰å¤šå€‹å‚™ç”¨èŠ±è²»æ–¹å¼çš„å ´æ™¯ã€‚ä¾‹å¦‚ï¼Œä¸€å€‹ã€Œé‡‘åº«ã€å¯èƒ½æœ‰ï¼š</p>
<ul>
  <li>å¯†é‘°è·¯å¾‘ï¼šæ“æœ‰è€…çš„æ­£å¸¸èŠ±è²»</li>
  <li>è…³æœ¬ Aï¼šç·Šæ€¥æ¢å¾©å¯†é‘°</li>
  <li>è…³æœ¬ Bï¼šå»¶é²å¾Œçš„ç¹¼æ‰¿äºº</li>
</ul>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">taproot_tree_demo</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">secp</span> <span class="o">=</span> <span class="nn">Secp256k1</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">internal_key</span> <span class="o">=</span> <span class="nn">XOnlyPublicKey</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="s">"..."</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// å‰µå»ºè…³æœ¬</span>
    <span class="k">let</span> <span class="n">emergency_script</span> <span class="o">=</span> <span class="nf">create_emergency_script</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emergency_key</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">inheritance_script</span> <span class="o">=</span> <span class="nf">create_inheritance_script</span><span class="p">(</span><span class="o">&amp;</span><span class="n">heir_key</span><span class="p">,</span> <span class="mi">52560</span><span class="p">);</span> <span class="c1">// ~1å¹´</span>

    <span class="c1">// æ§‹å»ºæ¨¹</span>
    <span class="k">let</span> <span class="n">taproot</span> <span class="o">=</span> <span class="nn">TaprootBuilder</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
        <span class="nf">.add_leaf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">emergency_script</span><span class="p">)</span><span class="o">?</span>
        <span class="nf">.add_leaf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">inheritance_script</span><span class="p">)</span><span class="o">?</span>
        <span class="nf">.finalize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">,</span> <span class="n">internal_key</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// æ­£å¸¸ä½¿ç”¨ï¼škey pathï¼ˆå–®ç°½åï¼‰</span>
    <span class="c1">// ç·Šæ€¥æƒ…æ³ï¼šscript path A</span>
    <span class="c1">// ç¹¼æ‰¿ï¼šscript path Bï¼ˆéœ€è¦ç­‰å¾…ï¼‰</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="7-å¯¦æˆ°å®Œæ•´çš„-htlc-äº¤æ˜“">7. å¯¦æˆ°ï¼šå®Œæ•´çš„ HTLC äº¤æ˜“</h2>

<p>è®“æˆ‘å€‘å°‡æ‰€æœ‰æ¦‚å¿µçµåˆèµ·ä¾†ï¼Œå¯¦ç¾ä¸€å€‹å®Œæ•´çš„ HTLC äº¤æ˜“æµç¨‹ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">htlc_transaction_flow</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">secp</span> <span class="o">=</span> <span class="nn">Secp256k1</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>

    <span class="c1">// åƒèˆ‡è€…</span>
    <span class="k">let</span> <span class="n">sender</span> <span class="o">=</span> <span class="nn">Keypair</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nn">rand</span><span class="p">::</span><span class="nf">thread_rng</span><span class="p">());</span>
    <span class="k">let</span> <span class="n">recipient</span> <span class="o">=</span> <span class="nn">Keypair</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nn">rand</span><span class="p">::</span><span class="nf">thread_rng</span><span class="p">());</span>

    <span class="c1">// å‰µå»º preimage å’Œ hash</span>
    <span class="k">let</span> <span class="n">preimage</span> <span class="o">=</span> <span class="s">b"this is the secret"</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">payment_hash</span> <span class="o">=</span> <span class="nn">sha256</span><span class="p">::</span><span class="nn">Hash</span><span class="p">::</span><span class="nf">hash</span><span class="p">(</span><span class="n">preimage</span><span class="p">);</span>

    <span class="c1">// æ§‹å»º HTLC Taproot</span>

    <span class="c1">// æˆåŠŸè·¯å¾‘</span>
    <span class="k">let</span> <span class="n">success_script</span> <span class="o">=</span> <span class="nn">Builder</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_SHA256</span><span class="p">)</span>
        <span class="nf">.push_slice</span><span class="p">(</span><span class="n">payment_hash</span><span class="nf">.as_byte_array</span><span class="p">())</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_EQUALVERIFY</span><span class="p">)</span>
        <span class="nf">.push_x_only_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recipient</span><span class="nf">.x_only_public_key</span><span class="p">()</span><span class="na">.0</span><span class="p">)</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_CHECKSIG</span><span class="p">)</span>
        <span class="nf">.into_script</span><span class="p">();</span>

    <span class="c1">// é€€æ¬¾è·¯å¾‘ï¼ˆ100 å€å¡Šå¾Œï¼‰</span>
    <span class="k">let</span> <span class="n">refund_script</span> <span class="o">=</span> <span class="nn">Builder</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
        <span class="nf">.push_int</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_CSV</span><span class="p">)</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_DROP</span><span class="p">)</span>
        <span class="nf">.push_x_only_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sender</span><span class="nf">.x_only_public_key</span><span class="p">()</span><span class="na">.0</span><span class="p">)</span>
        <span class="nf">.push_opcode</span><span class="p">(</span><span class="n">OP_CHECKSIG</span><span class="p">)</span>
        <span class="nf">.into_script</span><span class="p">();</span>

    <span class="c1">// æ§‹å»º Taprootï¼ˆsender ä½œç‚ºå…§éƒ¨å¯†é‘°ï¼‰</span>
    <span class="k">let</span> <span class="n">taproot</span> <span class="o">=</span> <span class="nn">TaprootBuilder</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span>
        <span class="nf">.add_leaf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">success_script</span><span class="nf">.clone</span><span class="p">())</span><span class="o">?</span>
        <span class="nf">.add_leaf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">refund_script</span><span class="nf">.clone</span><span class="p">())</span><span class="o">?</span>
        <span class="nf">.finalize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">,</span> <span class="n">sender</span><span class="nf">.x_only_public_key</span><span class="p">()</span><span class="na">.0</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="k">let</span> <span class="n">htlc_address</span> <span class="o">=</span> <span class="nn">Address</span><span class="p">::</span><span class="nf">p2tr_tweaked</span><span class="p">(</span>
        <span class="n">taproot</span><span class="nf">.output_key</span><span class="p">(),</span>
        <span class="nn">Network</span><span class="p">::</span><span class="n">Testnet</span>
    <span class="p">);</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"HTLC åœ°å€: {}"</span><span class="p">,</span> <span class="n">htlc_address</span><span class="p">);</span>

    <span class="c1">// ... å‰µå»ºè³‡é‡‘äº¤æ˜“ ...</span>

    <span class="c1">// æˆåŠŸèŠ±è²»ï¼ˆçŸ¥é“ preimageï¼‰</span>
    <span class="c1">// witness: [signature] [preimage] [script] [control_block]</span>

    <span class="c1">// é€€æ¬¾èŠ±è²»ï¼ˆè¶…æ™‚å¾Œï¼‰</span>
    <span class="c1">// witness: [signature] [script] [control_block]</span>
    <span class="c1">// ä¸¦ä¸” nSequence &gt;= 100</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="8-ç¸½çµ">8. ç¸½çµ</h2>

<p>æœ¬ç¯‡æ·±å…¥æ¢è¨äº† Bitcoin Script å’Œç°½åæ©Ÿåˆ¶ã€‚æˆ‘å€‘å­¸ç¿’äº†ï¼š</p>

<ul>
  <li><strong>Script åŸºç¤</strong>ï¼šå †ç–ŠåŸ·è¡Œæ¨¡å‹ã€æ“ä½œç¢¼ã€è…³æœ¬æ§‹å»º</li>
  <li><strong>æ¨™æº–è…³æœ¬é¡å‹</strong>ï¼šå¾ P2PKH åˆ° Taproot çš„æ¼”é€²</li>
  <li><strong>å¤šé‡ç°½å</strong>ï¼šå‚³çµ±å¤šç°½å’Œ Taproot æ™‚ä»£çš„é¸æ“‡</li>
  <li><strong>ç°½åæ©Ÿåˆ¶</strong>ï¼šECDSAã€Schnorr å’Œå„ç¨® sighash é¡å‹</li>
  <li><strong>Miniscript</strong>ï¼šå®‰å…¨ã€å¯åˆ†æçš„è…³æœ¬é–‹ç™¼</li>
  <li><strong>é€²éšæŠ€å·§</strong>ï¼šæ™‚é–“é–ã€HTLCã€Taproot è…³æœ¬æ¨¹</li>
</ul>

<p>é—œéµè¦é»ï¼š</p>
<ul>
  <li>Script å®šç¾©äº†è³‡é‡‘çš„èŠ±è²»æ¢ä»¶</li>
  <li>Schnorr ç°½åæä¾›äº†æ›´å°çš„ç°½åå’Œèšåˆèƒ½åŠ›</li>
  <li>Taproot çµåˆäº†æ•ˆç‡å’Œéˆæ´»æ€§</li>
  <li>Miniscript ä½¿è…³æœ¬é–‹ç™¼æ›´å®‰å…¨</li>
</ul>

<p>ä¸‹ä¸€ç¯‡å°‡æ¢è¨é€²éšæ‡‰ç”¨ï¼ŒåŒ…æ‹¬èˆ‡ Bitcoin ç¯€é»äº’å‹•ã€å®Œæ•´çš„éŒ¢åŒ…é–‹ç™¼å’Œå¯¦éš›éƒ¨ç½²è€ƒé‡ã€‚</p>

<hr />

<h2 id="åƒè€ƒè³‡æº">åƒè€ƒè³‡æº</h2>

<h3 id="bip-æ–‡æª”">BIP æ–‡æª”</h3>
<ul>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki">BIP 340: Schnorr Signatures</a></li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki">BIP 341: Taproot</a></li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0342.mediawiki">BIP 342: Tapscript</a></li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0380.mediawiki">BIP 380-386: Descriptors</a></li>
</ul>

<h3 id="miniscript-è³‡æº">Miniscript è³‡æº</h3>
<ul>
  <li><a href="https://bitcoin.sipa.be/miniscript/">Miniscript å®˜ç¶²</a></li>
  <li><a href="https://github.com/rust-bitcoin/rust-miniscript">rust-miniscript</a></li>
</ul>]]></content><author><name>Cypherpunks Taiwan</name></author><category term="æŠ€è¡“æ•™å­¸" /><category term="Bitcoin" /><category term="Rust" /><category term="Rust" /><category term="Bitcoin" /><category term="Script" /><category term="ç°½å" /><category term="ECDSA" /><category term="Schnorr" /><category term="Taproot" /><category term="Miniscript" /><summary type="html"><![CDATA[é€™æ˜¯ Rust Bitcoin é–‹ç™¼å…¥é–€ç³»åˆ—çš„ç¬¬ä¸‰ç¯‡ã€‚æœ¬ç¯‡æ·±å…¥æ¢è¨ Bitcoin Script ç·¨ç¨‹å’Œå„ç¨®ç°½åæ©Ÿåˆ¶çš„ Rust å¯¦ç¾ã€‚]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" /><media:content medium="image" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Rust Bitcoin é–‹ç™¼å…¥é–€ï¼ˆäºŒï¼‰ï¼šåœ°å€ç”Ÿæˆèˆ‡äº¤æ˜“æ§‹å»º</title><link href="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/rust/2025/03/23/rust-bitcoin-tutorial-2-addresses-transactions/" rel="alternate" type="text/html" title="Rust Bitcoin é–‹ç™¼å…¥é–€ï¼ˆäºŒï¼‰ï¼šåœ°å€ç”Ÿæˆèˆ‡äº¤æ˜“æ§‹å»º" /><published>2025-03-23T00:00:00+00:00</published><updated>2025-03-23T00:00:00+00:00</updated><id>https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/rust/2025/03/23/rust-bitcoin-tutorial-2-addresses-transactions</id><content type="html" xml:base="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/rust/2025/03/23/rust-bitcoin-tutorial-2-addresses-transactions/"><![CDATA[<p>é€™æ˜¯ Rust Bitcoin é–‹ç™¼å…¥é–€ç³»åˆ—çš„ç¬¬äºŒç¯‡ã€‚æœ¬ç¯‡æ·±å…¥æ¢è¨ Bitcoin åœ°å€çš„ç”Ÿæˆæ©Ÿåˆ¶å’Œäº¤æ˜“çš„æ§‹å»ºéç¨‹ã€‚</p>

<p><strong>ç³»åˆ—æ–‡ç« å°èˆªï¼š</strong></p>
<ul>
  <li><a href="/2025/03/22/rust-bitcoin-tutorial-1-environment-basics/">ç¬¬ä¸€ç¯‡ï¼šç’°å¢ƒè¨­ç½®èˆ‡åŸºç¤æ¦‚å¿µ</a></li>
  <li><strong>ç¬¬äºŒç¯‡ï¼šåœ°å€ç”Ÿæˆèˆ‡äº¤æ˜“æ§‹å»º</strong>ï¼ˆæœ¬ç¯‡ï¼‰</li>
  <li><a href="/2025/03/24/rust-bitcoin-tutorial-3-scripts-signatures/">ç¬¬ä¸‰ç¯‡ï¼šè…³æœ¬èˆ‡ç°½å</a></li>
  <li><a href="/2025/03/25/rust-bitcoin-tutorial-4-advanced-applications/">ç¬¬å››ç¯‡ï¼šé€²éšæ‡‰ç”¨èˆ‡æ•´åˆ</a></li>
</ul>

<hr />

<h2 id="1-hd-éŒ¢åŒ…æ·±å…¥ç†è§£">1. HD éŒ¢åŒ…æ·±å…¥ç†è§£</h2>

<h3 id="11-ç‚ºä»€éº¼éœ€è¦-hd-éŒ¢åŒ…">1.1 ç‚ºä»€éº¼éœ€è¦ HD éŒ¢åŒ…</h3>

<p>åœ¨ Bitcoin æ—©æœŸï¼Œç”¨æˆ¶éœ€è¦ç‚ºæ¯ç­†äº¤æ˜“æ‰‹å‹•ç”Ÿæˆæ–°çš„ç§é‘°ï¼Œä¸¦åˆ†åˆ¥å‚™ä»½æ¯ä¸€å€‹ç§é‘°ã€‚é€™ç¨®æ–¹å¼æœ‰æ˜é¡¯çš„å•é¡Œï¼šå‚™ä»½ç¹ç‘£ã€å®¹æ˜“ä¸Ÿå¤±ï¼Œè€Œä¸”å¦‚æœä½¿ç”¨èˆŠå‚™ä»½æ¢å¾©éŒ¢åŒ…ï¼Œå¯èƒ½æœƒéºæ¼æ–°ç”Ÿæˆçš„åœ°å€ä¸­çš„è³‡é‡‘ã€‚</p>

<p>BIP32 æå‡ºäº†å±¤ç´šç¢ºå®šæ€§ï¼ˆHierarchical Deterministicï¼ŒHDï¼‰éŒ¢åŒ…çš„æ¦‚å¿µï¼Œå¾¹åº•æ”¹è®Šäº†é€™å€‹æƒ…æ³ã€‚HD éŒ¢åŒ…å¾ä¸€å€‹ã€Œç¨®å­ã€è¡ç”Ÿå‡ºæ‰€æœ‰çš„ç§é‘°ï¼Œé€™æ„å‘³è‘—ä½ åªéœ€è¦å‚™ä»½ä¸€æ¬¡ç¨®å­ï¼Œå°±èƒ½æ¢å¾©æ•´å€‹éŒ¢åŒ…çš„æ‰€æœ‰åœ°å€â€”â€”åŒ…æ‹¬æœªä¾†å‰µå»ºçš„åœ°å€ã€‚</p>

<p>é€™å€‹è¨­è¨ˆçš„æ•¸å­¸åŸºç¤æ˜¯å–®å‘å‡½æ•¸å’Œå“ˆå¸Œå‡½æ•¸çš„ç‰¹æ€§ï¼šå¾ç¨®å­å¯ä»¥ç¢ºå®šæ€§åœ°è¨ˆç®—å‡ºç„¡é™å¤šå€‹å­å¯†é‘°ï¼Œä½†å¾å­å¯†é‘°ç„¡æ³•åæ¨ç¨®å­ã€‚é€™æä¾›äº†å®‰å…¨æ€§å’Œä¾¿åˆ©æ€§çš„å®Œç¾å¹³è¡¡ã€‚</p>

<h3 id="12-bip32-å±¤ç´šæ´¾ç”Ÿ">1.2 BIP32 å±¤ç´šæ´¾ç”Ÿ</h3>

<p>BIP32 å®šç¾©äº†å¯†é‘°æ´¾ç”Ÿçš„å…·é«”æ–¹æ³•ã€‚æ¯å€‹å¯†é‘°éƒ½å¯ä»¥æ´¾ç”Ÿå‡ºå­å¯†é‘°ï¼Œå½¢æˆä¸€å€‹æ¨¹ç‹€çµæ§‹ã€‚æ´¾ç”Ÿè·¯å¾‘ç”¨æ–œç·šåˆ†éš”çš„æ•¸å­—è¡¨ç¤ºï¼Œä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">m/44'/0'/0'/0/0</code>ã€‚</p>

<p>è·¯å¾‘ä¸­çš„æ¯å€‹æ•¸å­—ä»£è¡¨ä¸€å±¤æ´¾ç”Ÿï¼š</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">m</code> æ˜¯ä¸»å¯†é‘°ï¼ˆmaster keyï¼‰ï¼Œå¾ç¨®å­ç›´æ¥ç”Ÿæˆ</li>
  <li>æ•¸å­—å¾Œé¢çš„æ’‡è™Ÿï¼ˆâ€™ï¼‰è¡¨ç¤ºã€Œç¡¬åŒ–æ´¾ç”Ÿã€ï¼ˆhardened derivationï¼‰</li>
  <li>æ²’æœ‰æ’‡è™Ÿçš„æ•¸å­—è¡¨ç¤ºã€Œæ™®é€šæ´¾ç”Ÿã€ï¼ˆnormal derivationï¼‰</li>
</ul>

<p>ç¡¬åŒ–æ´¾ç”Ÿå’Œæ™®é€šæ´¾ç”Ÿçš„å€åˆ¥è‡³é—œé‡è¦ã€‚æ™®é€šæ´¾ç”Ÿå…è¨±å¾çˆ¶å…¬é‘°æ´¾ç”Ÿå­å…¬é‘°ï¼Œé€™æ„å‘³è‘—å¦‚æœæ”»æ“Šè€…ç²å¾—äº†æ“´å±•å…¬é‘°ï¼ˆxpubï¼‰ï¼Œä»–å¯ä»¥è¨ˆç®—å‡ºæ‰€æœ‰éç¡¬åŒ–è·¯å¾‘ä¸‹çš„å­å…¬é‘°ã€‚æ›´å±éšªçš„æ˜¯ï¼Œå¦‚æœæ”»æ“Šè€…åŒæ™‚ç²å¾—äº†ä»»ä½•ä¸€å€‹å­ç§é‘°å’Œçˆ¶å…¬é‘°ï¼Œä»–å°±èƒ½æ¨ç®—å‡ºçˆ¶ç§é‘°ã€‚</p>

<p>ç¡¬åŒ–æ´¾ç”Ÿè§£æ±ºäº†é€™å€‹å•é¡Œã€‚å®ƒçš„æ´¾ç”Ÿéç¨‹éœ€è¦çˆ¶ç§é‘°åƒèˆ‡ï¼Œå› æ­¤å³ä½¿æ”»æ“Šè€…ç²å¾—äº†æ“´å±•å…¬é‘°ï¼Œä¹Ÿç„¡æ³•æ¨å°å‡ºç¡¬åŒ–è·¯å¾‘ä¸‹çš„å­å¯†é‘°ã€‚é€™å°±æ˜¯ç‚ºä»€éº¼ purposeã€coin type å’Œ account å±¤ç´šç¸½æ˜¯ä½¿ç”¨ç¡¬åŒ–æ´¾ç”Ÿã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">bip32</span><span class="p">::{</span><span class="n">Xpriv</span><span class="p">,</span> <span class="n">Xpub</span><span class="p">,</span> <span class="n">DerivationPath</span><span class="p">,</span> <span class="n">ChildNumber</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="n">Network</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">secp256k1</span><span class="p">::</span><span class="n">Secp256k1</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">hd_derivation_demo</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">secp</span> <span class="o">=</span> <span class="nn">Secp256k1</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>

    <span class="c1">// å¾ç¨®å­å‰µå»ºä¸»ç§é‘°</span>
    <span class="k">let</span> <span class="n">seed</span> <span class="o">=</span> <span class="nn">hex</span><span class="p">::</span><span class="nf">decode</span><span class="p">(</span>
        <span class="s">"000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f"</span>
    <span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="k">let</span> <span class="n">master_xpriv</span> <span class="o">=</span> <span class="nn">Xpriv</span><span class="p">::</span><span class="nf">new_master</span><span class="p">(</span><span class="nn">Network</span><span class="p">::</span><span class="n">Bitcoin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seed</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">master_xpub</span> <span class="o">=</span> <span class="nn">Xpub</span><span class="p">::</span><span class="nf">from_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">master_xpriv</span><span class="p">);</span>

    <span class="c1">// ç¡¬åŒ–æ´¾ç”Ÿï¼šm/0'</span>
    <span class="c1">// æ³¨æ„ index ä½¿ç”¨ 0ï¼Œä½†æŒ‡å®šç‚º Hardened</span>
    <span class="k">let</span> <span class="n">child_hardened</span> <span class="o">=</span> <span class="n">master_xpriv</span><span class="nf">.derive_priv</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="n">secp</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">[</span><span class="nn">ChildNumber</span><span class="p">::</span><span class="n">Hardened</span> <span class="p">{</span> <span class="n">index</span><span class="p">:</span> <span class="mi">0</span> <span class="p">}]</span>
    <span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// æ™®é€šæ´¾ç”Ÿï¼šm/0</span>
    <span class="k">let</span> <span class="n">child_normal</span> <span class="o">=</span> <span class="n">master_xpriv</span><span class="nf">.derive_priv</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="n">secp</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">[</span><span class="nn">ChildNumber</span><span class="p">::</span><span class="n">Normal</span> <span class="p">{</span> <span class="n">index</span><span class="p">:</span> <span class="mi">0</span> <span class="p">}]</span>
    <span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// ä½¿ç”¨æ´¾ç”Ÿè·¯å¾‘å­—ä¸²</span>
    <span class="k">let</span> <span class="n">path</span> <span class="o">=</span> <span class="nn">DerivationPath</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="s">"m/84'/0'/0'/0/0"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">derived</span> <span class="o">=</span> <span class="n">master_xpriv</span><span class="nf">.derive_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="13-bip39-åŠ©è¨˜è©">1.3 BIP39 åŠ©è¨˜è©</h3>

<p>é›–ç„¶ç¨®å­æ˜¯ä¸€ä¸²éš¨æ©Ÿçš„ä½å…ƒçµ„ï¼Œä½†äººé¡å¾ˆé›£è¨˜æ†¶æˆ–æŠ„å¯«é€™æ¨£çš„æ•¸æ“šã€‚BIP39 æå‡ºäº†åŠ©è¨˜è©ï¼ˆmnemonicï¼‰çš„æ¦‚å¿µï¼Œå°‡ç¨®å­ç·¨ç¢¼ç‚ºä¸€çµ„è‹±æ–‡å–®è©ã€‚</p>

<p>åŠ©è¨˜è©çš„ç”Ÿæˆéç¨‹æ˜¯é€™æ¨£çš„ï¼šé¦–å…ˆç”Ÿæˆä¸€å®šé•·åº¦çš„éš¨æ©Ÿç†µï¼ˆ128 åˆ° 256 ä½ï¼‰ï¼Œç„¶å¾Œè¨ˆç®—ç†µçš„ SHA256 æ ¡é©—å’Œï¼Œå–æ ¡é©—å’Œçš„å‰å¹¾ä½é™„åŠ åˆ°ç†µçš„æœ«å°¾ã€‚æœ€å¾Œå°‡é€™å€‹çµ„åˆæ•¸æ“šåˆ†å‰²æˆ 11 ä½ä¸€çµ„ï¼Œæ¯çµ„å°æ‡‰ BIP39 å­—å…¸ä¸­çš„ä¸€å€‹å–®è©ã€‚</p>

<p>ç†µçš„é•·åº¦æ±ºå®šäº†åŠ©è¨˜è©çš„æ•¸é‡ã€‚128 ä½ç†µç”¢ç”Ÿ 12 å€‹å–®è©ï¼Œ256 ä½ç†µç”¢ç”Ÿ 24 å€‹å–®è©ã€‚æ›´é•·çš„åŠ©è¨˜è©æä¾›æ›´é«˜çš„å®‰å…¨æ€§ï¼Œä½† 12 å€‹å–®è©ï¼ˆ128 ä½ç†µï¼‰åœ¨å¯¦éš›ä½¿ç”¨ä¸­å·²ç¶“è¶³å¤ å®‰å…¨ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bip39</span><span class="p">::{</span><span class="n">Mnemonic</span><span class="p">,</span> <span class="n">Language</span><span class="p">};</span>

<span class="k">fn</span> <span class="nf">mnemonic_demo</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// ç”Ÿæˆ 12 å­—åŠ©è¨˜è©</span>
    <span class="k">let</span> <span class="n">mnemonic</span> <span class="o">=</span> <span class="nn">Mnemonic</span><span class="p">::</span><span class="nf">generate_in</span><span class="p">(</span><span class="nn">Language</span><span class="p">::</span><span class="n">English</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"åŠ©è¨˜è©: {}"</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">);</span>

    <span class="c1">// å¾åŠ©è¨˜è©ç”Ÿæˆç¨®å­</span>
    <span class="c1">// å¯ä»¥ä½¿ç”¨å¯é¸çš„å¯†ç¢¼çŸ­èªå¢åŠ å®‰å…¨æ€§</span>
    <span class="k">let</span> <span class="n">passphrase</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">seed</span> <span class="o">=</span> <span class="n">mnemonic</span><span class="nf">.to_seed</span><span class="p">(</span><span class="n">passphrase</span><span class="p">);</span>

    <span class="c1">// ç¨®å­æ˜¯ 512 ä½ï¼ˆ64 bytesï¼‰</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"ç¨®å­é•·åº¦: {} bytes"</span><span class="p">,</span> <span class="n">seed</span><span class="nf">.len</span><span class="p">());</span>

    <span class="c1">// é©—è­‰ç¾æœ‰åŠ©è¨˜è©</span>
    <span class="k">let</span> <span class="n">phrase</span> <span class="o">=</span> <span class="s">"abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about"</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">parsed</span> <span class="o">=</span> <span class="nn">Mnemonic</span><span class="p">::</span><span class="nf">parse_in</span><span class="p">(</span><span class="nn">Language</span><span class="p">::</span><span class="n">English</span><span class="p">,</span> <span class="n">phrase</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// ç²å–åŸå§‹ç†µ</span>
    <span class="k">let</span> <span class="n">entropy</span> <span class="o">=</span> <span class="n">parsed</span><span class="nf">.to_entropy</span><span class="p">();</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"ç†µ: {}"</span><span class="p">,</span> <span class="nn">hex</span><span class="p">::</span><span class="nf">encode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entropy</span><span class="p">));</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯†ç¢¼çŸ­èªï¼ˆpassphraseï¼‰æ˜¯ä¸€å€‹é‡è¦ä½†ç¶“å¸¸è¢«å¿½è¦–çš„åŠŸèƒ½ã€‚å®ƒåœ¨å¾åŠ©è¨˜è©ç”Ÿæˆç¨®å­æ™‚ä½œç‚ºé¡å¤–çš„è¼¸å…¥ã€‚ä¸åŒçš„å¯†ç¢¼çŸ­èªæœƒç”Ÿæˆå®Œå…¨ä¸åŒçš„ç¨®å­ï¼Œå¾è€Œç”¢ç”Ÿå®Œå…¨ä¸åŒçš„éŒ¢åŒ…ã€‚é€™æä¾›äº†é¡å¤–çš„å®‰å…¨å±¤ï¼šå³ä½¿æ”»æ“Šè€…ç²å¾—äº†ä½ çš„åŠ©è¨˜è©ï¼Œæ²’æœ‰å¯†ç¢¼çŸ­èªä»–ä¹Ÿç„¡æ³•å­˜å–ä½ çš„è³‡é‡‘ã€‚é€™ä¹Ÿå¯ä»¥ç”¨ä¾†å‰µå»ºã€Œèª˜é¤ŒéŒ¢åŒ…ã€â€”â€”ä½¿ç”¨ç©ºå¯†ç¢¼çŸ­èªçš„éŒ¢åŒ…æ”¾å°‘é‡è³‡é‡‘ï¼ŒçœŸæ­£çš„è³‡é‡‘å­˜æ”¾åœ¨æœ‰å¯†ç¢¼çŸ­èªçš„éŒ¢åŒ…ä¸­ã€‚</p>

<h3 id="14-æ¨™æº–æ´¾ç”Ÿè·¯å¾‘">1.4 æ¨™æº–æ´¾ç”Ÿè·¯å¾‘</h3>

<p>éš¨è‘—æ™‚é–“æ¨ç§»ï¼Œç¤¾å€åˆ¶å®šäº†å¤šå€‹ BIP ä¾†æ¨™æº–åŒ–æ´¾ç”Ÿè·¯å¾‘ï¼Œç¢ºä¿ä¸åŒéŒ¢åŒ…è»Ÿé«”ä¹‹é–“çš„äº’æ“ä½œæ€§ã€‚</p>

<p><strong>BIP44</strong> å®šç¾©äº†å‚³çµ±åœ°å€ï¼ˆP2PKHï¼‰çš„è·¯å¾‘æ ¼å¼ï¼š<code class="language-plaintext highlighter-rouge">m/44'/coin'/account'/change/index</code>ã€‚é€™è£¡ 44 æ˜¯ purposeï¼Œè¡¨ç¤ºéµå¾ª BIP44 æ¨™æº–ã€‚coin æ˜¯å¹£ç¨®ä»£ç¢¼ï¼ˆBitcoin æ˜¯ 0ï¼ŒTestnet æ˜¯ 1ï¼‰ã€‚account å…è¨±ç”¨æˆ¶åœ¨åŒä¸€å€‹éŒ¢åŒ…ä¸­ç¶­è­·å¤šå€‹ç¨ç«‹çš„å¸³æˆ¶ã€‚change ç‚º 0 è¡¨ç¤ºå¤–éƒ¨éˆï¼ˆç”¨æ–¼æ¥æ”¶ä»˜æ¬¾ï¼‰ï¼Œç‚º 1 è¡¨ç¤ºå…§éƒ¨éˆï¼ˆç”¨æ–¼æ‰¾é›¶ï¼‰ã€‚index æ˜¯åœ°å€çš„åºè™Ÿã€‚</p>

<p><strong>BIP49</strong> ç‚º P2SH-P2WPKHï¼ˆå…¼å®¹ SegWitï¼‰åœ°å€å®šç¾©äº† purpose 49ã€‚</p>

<p><strong>BIP84</strong> ç‚ºåŸç”Ÿ SegWitï¼ˆP2WPKHï¼‰åœ°å€å®šç¾©äº† purpose 84ã€‚</p>

<p><strong>BIP86</strong> ç‚º Taprootï¼ˆP2TRï¼‰åœ°å€å®šç¾©äº† purpose 86ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">bip32</span><span class="p">::{</span><span class="n">Xpriv</span><span class="p">,</span> <span class="n">DerivationPath</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::{</span><span class="n">Network</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="n">PublicKey</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">secp256k1</span><span class="p">::</span><span class="n">Secp256k1</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">HDWallet</span> <span class="p">{</span>
    <span class="n">master_xpriv</span><span class="p">:</span> <span class="n">Xpriv</span><span class="p">,</span>
    <span class="n">network</span><span class="p">:</span> <span class="n">Network</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">HDWallet</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">derive_address</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">purpose</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span> <span class="n">account</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span> <span class="n">is_change</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">u32</span><span class="p">)</span>
        <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span>
    <span class="p">{</span>
        <span class="k">let</span> <span class="n">secp</span> <span class="o">=</span> <span class="nn">Secp256k1</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">coin</span> <span class="o">=</span> <span class="k">if</span> <span class="k">self</span><span class="py">.network</span> <span class="o">==</span> <span class="nn">Network</span><span class="p">::</span><span class="n">Bitcoin</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="mi">1</span> <span class="p">};</span>
        <span class="k">let</span> <span class="n">change</span> <span class="o">=</span> <span class="k">if</span> <span class="n">is_change</span> <span class="p">{</span> <span class="mi">1</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

        <span class="k">let</span> <span class="n">path</span> <span class="o">=</span> <span class="nn">DerivationPath</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="o">&amp;</span><span class="nd">format!</span><span class="p">(</span>
            <span class="s">"m/{}'/{}'/{}'/{}'/{}"</span><span class="p">,</span>
            <span class="n">purpose</span><span class="p">,</span> <span class="n">coin</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">change</span><span class="p">,</span> <span class="n">index</span>
        <span class="p">))</span><span class="o">?</span><span class="p">;</span>

        <span class="k">let</span> <span class="n">derived_xpriv</span> <span class="o">=</span> <span class="k">self</span><span class="py">.master_xpriv</span><span class="nf">.derive_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">public_key</span> <span class="o">=</span> <span class="nn">PublicKey</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span>
            <span class="n">derived_xpriv</span><span class="nf">.to_priv</span><span class="p">()</span><span class="nf">.public_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">)</span>
        <span class="p">);</span>

        <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="k">match</span> <span class="n">purpose</span> <span class="p">{</span>
            <span class="mi">44</span> <span class="k">=&gt;</span> <span class="nn">Address</span><span class="p">::</span><span class="nf">p2pkh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">public_key</span><span class="p">,</span> <span class="k">self</span><span class="py">.network</span><span class="p">),</span>
            <span class="mi">49</span> <span class="k">=&gt;</span> <span class="nn">Address</span><span class="p">::</span><span class="nf">p2shwpkh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">public_key</span><span class="p">,</span> <span class="k">self</span><span class="py">.network</span><span class="p">),</span>
            <span class="mi">84</span> <span class="k">=&gt;</span> <span class="nn">Address</span><span class="p">::</span><span class="nf">p2wpkh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">public_key</span><span class="p">,</span> <span class="k">self</span><span class="py">.network</span><span class="p">),</span>
            <span class="mi">86</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">let</span> <span class="n">internal_key</span> <span class="o">=</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">key</span><span class="p">::</span><span class="nn">UntweakedPublicKey</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span>
                    <span class="n">derived_xpriv</span><span class="nf">.to_priv</span><span class="p">()</span><span class="nf">.public_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">)</span>
                <span class="p">);</span>
                <span class="nn">Address</span><span class="p">::</span><span class="nf">p2tr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">,</span> <span class="n">internal_key</span><span class="p">,</span> <span class="nb">None</span><span class="p">,</span> <span class="k">self</span><span class="py">.network</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">_</span> <span class="k">=&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nd">bail!</span><span class="p">(</span><span class="s">"ä¸æ”¯æ´çš„ purpose: {}"</span><span class="p">,</span> <span class="n">purpose</span><span class="p">),</span>
        <span class="p">};</span>

        <span class="nf">Ok</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="2-åœ°å€é¡å‹è©³è§£">2. åœ°å€é¡å‹è©³è§£</h2>

<h3 id="21-åœ°å€çš„æœ¬è³ª">2.1 åœ°å€çš„æœ¬è³ª</h3>

<p>Bitcoin åœ°å€ä¸æ˜¯å­˜å„²è³‡é‡‘çš„ã€Œå¸³æˆ¶ã€ï¼Œè€Œæ˜¯æŒ‡å®šèª°å¯ä»¥èŠ±è²»è³‡é‡‘çš„ã€Œæ¢ä»¶ã€çš„ç·¨ç¢¼å½¢å¼ã€‚ç•¶ä½ ç™¼é€ Bitcoin åˆ°ä¸€å€‹åœ°å€æ™‚ï¼Œå¯¦éš›ä¸Šæ˜¯åœ¨å‰µå»ºä¸€å€‹è¼¸å‡ºï¼Œé€™å€‹è¼¸å‡ºè¢«ä¸€å€‹ç‰¹å®šçš„è…³æœ¬é–å®šã€‚åœ°å€æ˜¯é€™å€‹é–å®šè…³æœ¬çš„ä¾¿æ–¼äººé¡é–±è®€çš„è¡¨ç¤ºã€‚</p>

<p>ä¸åŒçš„åœ°å€é¡å‹å°æ‡‰ä¸åŒçš„è…³æœ¬æ¨¡å¼ã€‚ç†è§£é€™äº›å·®ç•°å°æ–¼é–‹ç™¼è€…ä¾†èªªå¾ˆé‡è¦ï¼Œå› ç‚ºå®ƒå€‘å½±éŸ¿äº¤æ˜“å¤§å°ã€è²»ç”¨å’ŒåŠŸèƒ½ã€‚</p>

<h3 id="22-p2pkhpay-to-public-key-hash">2.2 P2PKHï¼ˆPay-to-Public-Key-Hashï¼‰</h3>

<p>P2PKH æ˜¯æœ€åŸå§‹çš„åœ°å€é¡å‹ï¼Œä»¥æ•¸å­— 1 é–‹é ­ã€‚å®ƒçš„é–å®šè…³æœ¬è¦æ±‚æä¾›ä¸€å€‹å…¬é‘°å’Œå°æ‡‰çš„ç°½åï¼Œä¸”å…¬é‘°çš„é›œæ¹Šå€¼å¿…é ˆåŒ¹é…åœ°å€ä¸­ç·¨ç¢¼çš„å€¼ã€‚</p>

<p>é€™ç¨®è¨­è¨ˆæœ‰ä¸€å€‹éš±ç§å„ªé»ï¼šåœ¨è³‡é‡‘è¢«èŠ±è²»ä¹‹å‰ï¼Œå…¬é‘°ä¸æœƒå‡ºç¾åœ¨å€å¡Šéˆä¸Šï¼Œåªæœ‰å…¬é‘°çš„é›œæ¹Šå€¼æ˜¯å¯è¦‹çš„ã€‚é€™ç‚ºæŠµç¦¦æŸäº›ç†è«–ä¸Šçš„é‡å­è¨ˆç®—æ”»æ“Šæä¾›äº†ä¸€å®šä¿è­·â€”â€”å³ä½¿é‡å­é›»è…¦èƒ½å¾å…¬é‘°æ¨å°ç§é‘°ï¼Œåœ¨å…¬é‘°æš´éœ²ä¹‹å‰ï¼Œè³‡é‡‘ä»ç„¶æ˜¯å®‰å…¨çš„ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::{</span><span class="n">Address</span><span class="p">,</span> <span class="n">PublicKey</span><span class="p">,</span> <span class="n">Network</span><span class="p">};</span>

<span class="k">fn</span> <span class="nf">p2pkh_demo</span><span class="p">(</span><span class="n">public_key</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">PublicKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="nn">Address</span><span class="p">::</span><span class="nf">p2pkh</span><span class="p">(</span><span class="n">public_key</span><span class="p">,</span> <span class="nn">Network</span><span class="p">::</span><span class="n">Bitcoin</span><span class="p">);</span>
    <span class="c1">// æ ¼å¼ï¼š1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2</span>

    <span class="c1">// å°æ‡‰çš„ scriptPubKeyï¼š</span>
    <span class="c1">// OP_DUP OP_HASH160 &lt;pubkey_hash&gt; OP_EQUALVERIFY OP_CHECKSIG</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="23-p2shpay-to-script-hash">2.3 P2SHï¼ˆPay-to-Script-Hashï¼‰</h3>

<p>P2SH ä»¥æ•¸å­— 3 é–‹é ­ï¼Œå…è¨±æ”¯ä»˜åˆ°ä»»æ„è…³æœ¬çš„é›œæ¹Šå€¼ï¼Œè€Œä¸æ˜¯ç‰¹å®šçš„å…¬é‘°é›œæ¹Šã€‚é€™ç¨®éˆæ´»æ€§ä½¿å¾—è¤‡é›œçš„è…³æœ¬ï¼ˆå¦‚å¤šé‡ç°½åï¼‰å¯ä»¥ä½¿ç”¨ç°¡çŸ­çš„åœ°å€è¡¨ç¤ºã€‚</p>

<p>P2SH çš„ä¸€å€‹å¸¸è¦‹ç”¨é€”æ˜¯åŒ…è£ SegWit è…³æœ¬ï¼ˆP2SH-P2WPKH å’Œ P2SH-P2WSHï¼‰ï¼Œç‚ºä¸æ”¯æ´åŸç”Ÿ SegWit åœ°å€çš„èˆŠéŒ¢åŒ…æä¾›å…¼å®¹æ€§ã€‚ç™¼é€è€…ä¸éœ€è¦çŸ¥é“åº•å±¤ä½¿ç”¨çš„æ˜¯ä»€éº¼è…³æœ¬â€”â€”ä»–å€‘åªéœ€æ”¯ä»˜åˆ°é€™å€‹ä»¥ 3 é–‹é ­çš„åœ°å€å³å¯ã€‚</p>

<h3 id="24-p2wpkhåŸç”Ÿ-segwit">2.4 P2WPKHï¼ˆåŸç”Ÿ SegWitï¼‰</h3>

<p>P2WPKH æ˜¯ SegWit å‡ç´šå¼•å…¥çš„åŸç”Ÿè¦‹è­‰åœ°å€é¡å‹ï¼Œä»¥ bc1q é–‹é ­ã€‚å®ƒçš„åŠŸèƒ½èˆ‡ P2PKH é¡ä¼¼ï¼Œä½†ç°½åæ•¸æ“šè¢«ç§»åˆ°äº†äº¤æ˜“çš„ã€Œè¦‹è­‰ã€éƒ¨åˆ†ï¼Œä¸è¨ˆå…¥å‚³çµ±çš„å€å¡Šå¤§å°é™åˆ¶ã€‚</p>

<p>é€™å¸¶ä¾†äº†å¤šå€‹å¥½è™•ã€‚é¦–å…ˆæ˜¯è²»ç”¨ç¯€çœï¼šè¦‹è­‰æ•¸æ“šçš„è²»ç”¨æ¬Šé‡åªæœ‰éè¦‹è­‰æ•¸æ“šçš„å››åˆ†ä¹‹ä¸€ï¼Œå…¸å‹çš„ P2WPKH äº¤æ˜“æ¯” P2PKH äº¤æ˜“ä¾¿å®œç´„ 38%ã€‚å…¶æ¬¡æ˜¯è§£æ±ºäº†äº¤æ˜“å¯å»¶å±•æ€§ï¼ˆmalleabilityï¼‰å•é¡Œï¼Œé€™å°æ–¼é–ƒé›»ç¶²è·¯ç­‰äºŒå±¤å”è­°è‡³é—œé‡è¦ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">p2wpkh_demo</span><span class="p">(</span><span class="n">public_key</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">PublicKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="nn">Address</span><span class="p">::</span><span class="nf">p2wpkh</span><span class="p">(</span><span class="n">public_key</span><span class="p">,</span> <span class="nn">Network</span><span class="p">::</span><span class="n">Bitcoin</span><span class="p">);</span>
    <span class="c1">// æ ¼å¼ï¼šbc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4</span>

    <span class="c1">// scriptPubKey å¾ˆç°¡çŸ­ï¼š</span>
    <span class="c1">// OP_0 &lt;20-byte-pubkey-hash&gt;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="25-p2trtaproot">2.5 P2TRï¼ˆTaprootï¼‰</h3>

<p>P2TR æ˜¯ 2021 å¹´å•Ÿç”¨çš„ Taproot å‡ç´šå¼•å…¥çš„åœ°å€é¡å‹ï¼Œä»¥ bc1p é–‹é ­ã€‚å®ƒä»£è¡¨äº† Bitcoin è…³æœ¬èƒ½åŠ›çš„é‡å¤§é€²æ­¥ã€‚</p>

<p>Taproot åœ°å€å¯ä»¥é€šéå…©ç¨®æ–¹å¼èŠ±è²»ï¼šå¯†é‘°è·¯å¾‘ï¼ˆkey pathï¼‰å’Œè…³æœ¬è·¯å¾‘ï¼ˆscript pathï¼‰ã€‚å¯†é‘°è·¯å¾‘æ˜¯æœ€ç°¡å–®çš„æƒ…æ³â€”â€”åªéœ€æä¾›ä¸€å€‹ Schnorr ç°½åã€‚è…³æœ¬è·¯å¾‘å…è¨±ä½¿ç”¨è¤‡é›œçš„æ¢ä»¶ï¼Œä½†é€™äº›æ¢ä»¶è¢«éš±è—åœ¨ Merkle æ¨¹ä¸­ï¼Œåªæœ‰åœ¨ä½¿ç”¨ç‰¹å®šæ¢ä»¶æ™‚æ‰æœƒæ­ç¤ºã€‚</p>

<p>é€™ç¨®è¨­è¨ˆçš„éš±ç§å„ªå‹¢æ˜¯å·¨å¤§çš„ã€‚ç„¡è«–åº•å±¤è…³æœ¬å¤šè¤‡é›œï¼Œå¦‚æœæ‰€æœ‰åƒèˆ‡è€…åŒæ„ï¼ˆä½¿ç”¨å¯†é‘°è·¯å¾‘ï¼‰ï¼Œäº¤æ˜“çœ‹èµ·ä¾†å°±åƒä¸€å€‹æ™®é€šçš„å–®ç°½åäº¤æ˜“ã€‚è§€å¯Ÿè€…ç„¡æ³•å€åˆ†ç°¡å–®æ”¯ä»˜å’Œè¤‡é›œçš„å¤šæ–¹å”è­°ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">p2tr_demo</span><span class="p">(</span><span class="n">secp</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Secp256k1</span><span class="o">&lt;</span><span class="nn">secp256k1</span><span class="p">::</span><span class="n">All</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">private_key</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">PrivateKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">internal_key</span> <span class="o">=</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">key</span><span class="p">::</span><span class="nn">UntweakedPublicKey</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span>
        <span class="n">private_key</span><span class="nf">.public_key</span><span class="p">(</span><span class="n">secp</span><span class="p">)</span>
    <span class="p">);</span>

    <span class="c1">// åªæœ‰å¯†é‘°è·¯å¾‘ï¼Œæ²’æœ‰è…³æœ¬æ¨¹</span>
    <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="nn">Address</span><span class="p">::</span><span class="nf">p2tr</span><span class="p">(</span><span class="n">secp</span><span class="p">,</span> <span class="n">internal_key</span><span class="p">,</span> <span class="nb">None</span><span class="p">,</span> <span class="nn">Network</span><span class="p">::</span><span class="n">Bitcoin</span><span class="p">);</span>
    <span class="c1">// æ ¼å¼ï¼šbc1p5cyxnuxmeuwuvkwfem96lqzszd02n6xdcjrs20cac6yqjjwudpxqkedrcr</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="26-åœ°å€è§£æèˆ‡é©—è­‰">2.6 åœ°å€è§£æèˆ‡é©—è­‰</h3>

<p>åœ¨è™•ç†ç”¨æˆ¶è¼¸å…¥çš„åœ°å€æ™‚ï¼Œé©—è­‰éå¸¸é‡è¦ã€‚ç„¡æ•ˆçš„åœ°å€æœƒå°è‡´è³‡é‡‘æ°¸ä¹…ä¸Ÿå¤±ã€‚rust-bitcoin æä¾›äº†å®Œæ•´çš„åœ°å€è§£æå’Œé©—è­‰åŠŸèƒ½ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::{</span><span class="n">Address</span><span class="p">,</span> <span class="n">Network</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">str</span><span class="p">::</span><span class="n">FromStr</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">validate_address</span><span class="p">(</span><span class="n">addr_str</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">,</span> <span class="n">expected_network</span><span class="p">:</span> <span class="n">Network</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// è§£æåœ°å€ï¼ˆé€™æœƒé©—è­‰æ ¼å¼å’Œæ ¡é©—å’Œï¼‰</span>
    <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="nn">Address</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="n">addr_str</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// é©—è­‰ç¶²è·¯</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">address</span><span class="nf">.is_valid_for_network</span><span class="p">(</span><span class="n">expected_network</span><span class="p">)</span> <span class="p">{</span>
        <span class="nn">anyhow</span><span class="p">::</span><span class="nd">bail!</span><span class="p">(</span><span class="s">"åœ°å€ç¶²è·¯ä¸åŒ¹é…"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// assume_checked è¡¨ç¤ºæˆ‘å€‘å·²ç¶“é©—è­‰éäº†</span>
    <span class="nf">Ok</span><span class="p">(</span><span class="n">address</span><span class="nf">.assume_checked</span><span class="p">())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="3-ç†è§£-utxo-æ¨¡å‹">3. ç†è§£ UTXO æ¨¡å‹</h2>

<h3 id="31-utxo-vs-å¸³æˆ¶æ¨¡å‹">3.1 UTXO vs å¸³æˆ¶æ¨¡å‹</h3>

<p>Bitcoin ä½¿ç”¨ UTXOï¼ˆUnspent Transaction Outputï¼ŒæœªèŠ±è²»äº¤æ˜“è¼¸å‡ºï¼‰æ¨¡å‹ï¼Œé€™èˆ‡ä»¥å¤ªåŠä½¿ç”¨çš„å¸³æˆ¶æ¨¡å‹æœ‰æœ¬è³ªå€åˆ¥ã€‚</p>

<p>åœ¨å¸³æˆ¶æ¨¡å‹ä¸­ï¼Œæ¯å€‹åœ°å€æœ‰ä¸€å€‹é¤˜é¡ï¼Œäº¤æ˜“å°±æ˜¯å¾ä¸€å€‹å¸³æˆ¶æ¸›å°‘é¤˜é¡ã€å‘å¦ä¸€å€‹å¸³æˆ¶å¢åŠ é¤˜é¡ã€‚é€™é¡ä¼¼æ–¼å‚³çµ±éŠ€è¡Œå¸³æˆ¶çš„é‹ä½œæ–¹å¼ã€‚</p>

<p>åœ¨ UTXO æ¨¡å‹ä¸­ï¼Œæ²’æœ‰ã€Œé¤˜é¡ã€çš„æ¦‚å¿µã€‚å–è€Œä»£ä¹‹çš„æ˜¯ä¸€çµ„ç¨ç«‹çš„ã€Œç¡¬å¹£ã€â€”â€”æ¯å€‹ UTXO æ˜¯ä¹‹å‰æŸç­†äº¤æ˜“å‰µå»ºçš„ä¸€å€‹è¼¸å‡ºï¼Œå®ƒæœ‰ç‰¹å®šçš„é‡‘é¡å’ŒèŠ±è²»æ¢ä»¶ã€‚ä½ çš„ã€Œé¤˜é¡ã€æ˜¯æ‰€æœ‰å±¬æ–¼ä½ çš„ UTXO çš„é‡‘é¡ç¸½å’Œã€‚</p>

<p>ç•¶ä½ ç™¼é€ Bitcoin æ™‚ï¼Œä½ å¿…é ˆé¸æ“‡ä¸€å€‹æˆ–å¤šå€‹ UTXO ä½œç‚ºè¼¸å…¥ï¼Œå®Œå…¨æ¶ˆè€—å®ƒå€‘ï¼Œç„¶å¾Œå‰µå»ºæ–°çš„è¼¸å‡ºã€‚å¦‚æœè¼¸å…¥ç¸½é¡è¶…éä½ æƒ³ç™¼é€çš„é‡‘é¡ï¼Œä½ éœ€è¦å‰µå»ºä¸€å€‹ã€Œæ‰¾é›¶ã€è¼¸å‡ºï¼Œå°‡å¤šé¤˜çš„è³‡é‡‘ç™¼å›çµ¦è‡ªå·±ã€‚</p>

<p>é€™å€‹æ¨¡å‹æœ‰å¹¾å€‹é‡è¦çš„å«ç¾©ã€‚é¦–å…ˆï¼Œæ¯å€‹ UTXO åªèƒ½è¢«èŠ±è²»ä¸€æ¬¡â€”â€”é€™æ˜¯ Bitcoin å¦‚ä½•é˜²æ­¢é›™é‡æ”¯ä»˜çš„ã€‚å…¶æ¬¡ï¼Œäº¤æ˜“çš„éš±ç§æ€§å—åˆ° UTXO é¸æ“‡çš„å½±éŸ¿â€”â€”å¦‚æœä½ åˆä½µå¤šå€‹ UTXOï¼Œè§€å¯Ÿè€…å¯ä»¥æ¨æ–·å®ƒå€‘å¯èƒ½å±¬æ–¼åŒä¸€å€‹äººã€‚ç¬¬ä¸‰ï¼ŒUTXO çš„æ•¸é‡æœƒå½±éŸ¿æœªä¾†äº¤æ˜“çš„è²»ç”¨â€”â€”æ›´å¤šçš„è¼¸å…¥æ„å‘³è‘—æ›´å¤§çš„äº¤æ˜“å’Œæ›´é«˜çš„è²»ç”¨ã€‚</p>

<h3 id="32-é¸å¹£ç­–ç•¥">3.2 é¸å¹£ç­–ç•¥</h3>

<p>ç•¶æ§‹å»ºäº¤æ˜“æ™‚ï¼Œé¸æ“‡ä½¿ç”¨å“ªäº› UTXO æ˜¯ä¸€å€‹é‡è¦çš„æ±ºç­–ã€‚ä¸åŒçš„é¸å¹£ç­–ç•¥æœ‰ä¸åŒçš„æ¬Šè¡¡ã€‚</p>

<p>æœ€ç°¡å–®çš„ç­–ç•¥æ˜¯ã€Œæœ€å¤§å„ªå…ˆã€â€”â€”å„ªå…ˆé¸æ“‡é‡‘é¡æœ€å¤§çš„ UTXOã€‚é€™é€šå¸¸èƒ½æœ€å°åŒ–æ‰€éœ€çš„è¼¸å…¥æ•¸é‡ï¼Œå¾è€Œæ¸›å°‘äº¤æ˜“è²»ç”¨ã€‚ä½†å®ƒä¹Ÿæœ‰ç¼ºé»ï¼šå°é¡ UTXO å¯èƒ½æ°¸é ä¸æœƒè¢«ä½¿ç”¨ï¼Œéš¨è‘—æ™‚é–“æ¨ç§»ï¼Œä½ æœƒç´¯ç©å¤§é‡ã€Œç²‰å¡µã€ã€‚</p>

<p>ã€Œå…ˆé€²å…ˆå‡ºã€ï¼ˆFIFOï¼‰ç­–ç•¥æŒ‰ UTXO çš„å¹´é½¡æ’åºï¼Œå„ªå…ˆä½¿ç”¨æœ€è€çš„ã€‚é€™æœ‰åŠ©æ–¼ç¶­æŒ UTXO é›†çš„ã€Œå¥åº·ã€ï¼Œé¿å…ç¢ç‰‡åŒ–ã€‚</p>

<p>æ›´è¤‡é›œçš„ç­–ç•¥æœƒè€ƒæ…®éš±ç§å› ç´ ï¼Œé¿å…åˆä½µä¾†è‡ªä¸åŒä¾†æºçš„ UTXOï¼Œæˆ–è€…ä½¿ç”¨ã€Œéš¨æ©Ÿã€é¸æ“‡ä¾†å¢åŠ è§€å¯Ÿè€…çš„åˆ†æé›£åº¦ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">UTXOSelector</span><span class="p">;</span>

<span class="k">impl</span> <span class="n">UTXOSelector</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">select_largest_first</span><span class="p">(</span>
        <span class="n">utxos</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">UTXO</span><span class="p">],</span>
        <span class="n">target</span><span class="p">:</span> <span class="nb">u64</span><span class="p">,</span>
        <span class="n">fee_rate</span><span class="p">:</span> <span class="nb">u64</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">UTXO</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">sorted</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">utxos</span><span class="nf">.to_vec</span><span class="p">();</span>
        <span class="n">sorted</span><span class="nf">.sort_by</span><span class="p">(|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">|</span> <span class="n">b</span><span class="py">.amount</span><span class="nf">.cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="py">.amount</span><span class="p">));</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">selected</span> <span class="o">=</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0u64</span><span class="p">;</span>

        <span class="k">for</span> <span class="n">utxo</span> <span class="k">in</span> <span class="n">sorted</span> <span class="p">{</span>
            <span class="c1">// ä¼°ç®—é€™å€‹è¼¸å…¥çš„è²»ç”¨</span>
            <span class="k">let</span> <span class="n">input_fee</span> <span class="o">=</span> <span class="k">Self</span><span class="p">::</span><span class="nf">estimate_input_fee</span><span class="p">(</span><span class="n">fee_rate</span><span class="p">);</span>

            <span class="c1">// è·³éç²‰å¡µ UTXO</span>
            <span class="k">if</span> <span class="n">utxo</span><span class="py">.amount</span> <span class="o">&lt;</span> <span class="n">input_fee</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">selected</span><span class="nf">.push</span><span class="p">(</span><span class="n">utxo</span><span class="p">);</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">utxo</span><span class="py">.amount</span><span class="p">;</span>

            <span class="c1">// æª¢æŸ¥æ˜¯å¦å·²ç¶“å¤ äº†</span>
            <span class="k">let</span> <span class="n">required</span> <span class="o">=</span> <span class="n">target</span> <span class="o">+</span> <span class="k">Self</span><span class="p">::</span><span class="nf">estimate_total_fee</span><span class="p">(</span><span class="o">&amp;</span><span class="n">selected</span><span class="p">,</span> <span class="n">fee_rate</span><span class="p">);</span>
            <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;=</span> <span class="n">required</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nf">Some</span><span class="p">(</span><span class="n">selected</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nb">None</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">estimate_input_fee</span><span class="p">(</span><span class="n">fee_rate</span><span class="p">:</span> <span class="nb">u64</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u64</span> <span class="p">{</span>
        <span class="mi">68</span> <span class="o">*</span> <span class="n">fee_rate</span>  <span class="c1">// P2WPKH è¼¸å…¥ç´„ 68 vbytes</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">estimate_total_fee</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">UTXO</span><span class="p">],</span> <span class="n">fee_rate</span><span class="p">:</span> <span class="nb">u64</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u64</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">base</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">fee_rate</span><span class="p">;</span>  <span class="c1">// åŸºç¤é–‹éŠ·</span>
        <span class="k">let</span> <span class="n">outputs</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">fee_rate</span><span class="p">;</span>  <span class="c1">// å…©å€‹è¼¸å‡º</span>
        <span class="k">let</span> <span class="n">inputs_fee</span> <span class="o">=</span> <span class="n">inputs</span><span class="nf">.len</span><span class="p">()</span> <span class="k">as</span> <span class="nb">u64</span> <span class="o">*</span> <span class="mi">68</span> <span class="o">*</span> <span class="n">fee_rate</span><span class="p">;</span>
        <span class="n">base</span> <span class="o">+</span> <span class="n">outputs</span> <span class="o">+</span> <span class="n">inputs_fee</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="4-äº¤æ˜“çµæ§‹è©³è§£">4. äº¤æ˜“çµæ§‹è©³è§£</h2>

<h3 id="41-äº¤æ˜“çš„çµ„æˆ">4.1 äº¤æ˜“çš„çµ„æˆ</h3>

<p>ä¸€ç­† Bitcoin äº¤æ˜“ç”±å¹¾å€‹éƒ¨åˆ†çµ„æˆï¼š</p>

<p><strong>ç‰ˆæœ¬è™Ÿï¼ˆVersionï¼‰</strong>æŒ‡ç¤ºäº¤æ˜“éµå¾ªçš„è¦å‰‡ã€‚ç‰ˆæœ¬ 2 å•Ÿç”¨äº† BIP68 å®šç¾©çš„ç›¸å°æ™‚é–“é–åŠŸèƒ½ã€‚</p>

<p><strong>è¼¸å…¥ï¼ˆInputsï¼‰</strong>æ˜¯é€™ç­†äº¤æ˜“èŠ±è²»çš„ UTXO åˆ—è¡¨ã€‚æ¯å€‹è¼¸å…¥åŒ…å«ï¼š</p>
<ul>
  <li>å‰ä¸€ç­†äº¤æ˜“çš„ IDï¼ˆtxidï¼‰å’Œè¼¸å‡ºç´¢å¼•ï¼ˆvoutï¼‰ï¼Œç”¨æ–¼è­˜åˆ¥è¢«èŠ±è²»çš„ UTXO</li>
  <li>ç°½åè…³æœ¬ï¼ˆscriptSigï¼‰ï¼Œå°æ–¼ SegWit äº¤æ˜“é€™è£¡é€šå¸¸æ˜¯ç©ºçš„</li>
  <li>åºåˆ—è™Ÿï¼ˆsequenceï¼‰ï¼Œç”¨æ–¼ç›¸å°æ™‚é–“é–å’Œ RBFï¼ˆReplace-By-Feeï¼‰ä¿¡è™Ÿ</li>
</ul>

<p><strong>è¼¸å‡ºï¼ˆOutputsï¼‰</strong>æ˜¯é€™ç­†äº¤æ˜“å‰µå»ºçš„æ–° UTXOã€‚æ¯å€‹è¼¸å‡ºåŒ…å«ï¼š</p>
<ul>
  <li>é‡‘é¡ï¼ˆä»¥ satoshi ç‚ºå–®ä½ï¼‰</li>
  <li>é–å®šè…³æœ¬ï¼ˆscriptPubKeyï¼‰ï¼Œå®šç¾©èª°å¯ä»¥èŠ±è²»é€™å€‹è¼¸å‡º</li>
</ul>

<p><strong>è¦‹è­‰ï¼ˆWitnessï¼‰</strong>æ˜¯ SegWit å¼•å…¥çš„æ–°æ¬„ä½ï¼ŒåŒ…å«æ¯å€‹è¼¸å…¥çš„ç°½åå’Œå…¶ä»–é©—è­‰æ•¸æ“šã€‚</p>

<p><strong>é–å®šæ™‚é–“ï¼ˆLockTimeï¼‰</strong>æŒ‡å®šé€™ç­†äº¤æ˜“å¯ä»¥è¢«åŒ…å«åˆ°å€å¡Šçš„æœ€æ—©æ™‚é–“ï¼ˆå€å¡Šé«˜åº¦æˆ–æ™‚é–“æˆ³ï¼‰ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::{</span>
    <span class="n">Transaction</span><span class="p">,</span> <span class="n">TxIn</span><span class="p">,</span> <span class="n">TxOut</span><span class="p">,</span> <span class="n">OutPoint</span><span class="p">,</span> <span class="n">Txid</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Witness</span><span class="p">,</span>
    <span class="n">ScriptBuf</span><span class="p">,</span> <span class="n">Amount</span><span class="p">,</span> <span class="nn">transaction</span><span class="p">::</span><span class="n">Version</span><span class="p">,</span> <span class="nn">absolute</span><span class="p">::</span><span class="n">LockTime</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">fn</span> <span class="nf">create_transaction_structure</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="n">Transaction</span> <span class="p">{</span>
    <span class="c1">// å‰µå»ºè¼¸å…¥</span>
    <span class="k">let</span> <span class="n">input</span> <span class="o">=</span> <span class="n">TxIn</span> <span class="p">{</span>
        <span class="n">previous_output</span><span class="p">:</span> <span class="n">OutPoint</span> <span class="p">{</span>
            <span class="n">txid</span><span class="p">:</span> <span class="nn">Txid</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="s">"..."</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">(),</span>
            <span class="n">vout</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">script_sig</span><span class="p">:</span> <span class="nn">ScriptBuf</span><span class="p">::</span><span class="nf">new</span><span class="p">(),</span>  <span class="c1">// SegWit äº¤æ˜“ç‚ºç©º</span>
        <span class="n">sequence</span><span class="p">:</span> <span class="nn">Sequence</span><span class="p">::</span><span class="n">ENABLE_RBF_NO_LOCKTIME</span><span class="p">,</span>
        <span class="n">witness</span><span class="p">:</span> <span class="nn">Witness</span><span class="p">::</span><span class="nf">new</span><span class="p">(),</span>
    <span class="p">};</span>

    <span class="c1">// å‰µå»ºè¼¸å‡º</span>
    <span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">TxOut</span> <span class="p">{</span>
        <span class="n">value</span><span class="p">:</span> <span class="nn">Amount</span><span class="p">::</span><span class="nf">from_sat</span><span class="p">(</span><span class="mi">50_000</span><span class="p">),</span>
        <span class="n">script_pubkey</span><span class="p">:</span> <span class="nn">ScriptBuf</span><span class="p">::</span><span class="nf">new_p2wpkh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wpkh</span><span class="p">),</span>
    <span class="p">};</span>

    <span class="n">Transaction</span> <span class="p">{</span>
        <span class="n">version</span><span class="p">:</span> <span class="nn">Version</span><span class="p">::</span><span class="n">TWO</span><span class="p">,</span>
        <span class="n">lock_time</span><span class="p">:</span> <span class="nn">LockTime</span><span class="p">::</span><span class="n">ZERO</span><span class="p">,</span>
        <span class="n">input</span><span class="p">:</span> <span class="nd">vec!</span><span class="p">[</span><span class="n">input</span><span class="p">],</span>
        <span class="n">output</span><span class="p">:</span> <span class="nd">vec!</span><span class="p">[</span><span class="n">output</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="42-äº¤æ˜“å¤§å°èˆ‡è²»ç”¨">4.2 äº¤æ˜“å¤§å°èˆ‡è²»ç”¨</h3>

<p>Bitcoin çš„äº¤æ˜“è²»ç”¨æ˜¯æŒ‰äº¤æ˜“å¤§å°è¨ˆç®—çš„ï¼Œä½† SegWit å¼•å…¥äº†ã€Œæ¬Šé‡ã€çš„æ¦‚å¿µä¾†æ›´ç²¾ç¢ºåœ°è¡¡é‡äº¤æ˜“å°å€å¡Šç©ºé–“çš„æ¶ˆè€—ã€‚</p>

<p>äº¤æ˜“æ¬Šé‡çš„è¨ˆç®—æ–¹å¼æ˜¯ï¼šéè¦‹è­‰æ•¸æ“šçš„ä½å…ƒçµ„æ•¸ä¹˜ä»¥ 4ï¼ŒåŠ ä¸Šè¦‹è­‰æ•¸æ“šçš„ä½å…ƒçµ„æ•¸ã€‚ç„¶å¾Œå°‡æ¬Šé‡é™¤ä»¥ 4 å¾—åˆ°ã€Œè™›æ“¬å¤§å°ã€ï¼ˆvsizeï¼‰ï¼Œé€™æ˜¯è¨ˆç®—è²»ç”¨æ™‚ä½¿ç”¨çš„å–®ä½ã€‚</p>

<p>é€™å€‹è¨­è¨ˆçµ¦äº†è¦‹è­‰æ•¸æ“š 75% çš„ã€ŒæŠ˜æ‰£ã€ï¼Œé¼“å‹µä½¿ç”¨ SegWitï¼Œå› ç‚ºè¦‹è­‰æ•¸æ“šä¸æœƒæ°¸ä¹…å­˜å„²åœ¨æ¯å€‹ç¯€é»çš„ UTXO é›†ä¸­ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">FeeCalculator</span><span class="p">;</span>

<span class="k">impl</span> <span class="n">FeeCalculator</span> <span class="p">{</span>
    <span class="c1">// P2WPKH è¼¸å…¥çš„é‡é‡ï¼šç´„ 271 WUï¼ˆ68 vbytesï¼‰</span>
    <span class="c1">// P2TR è¼¸å…¥çš„é‡é‡ï¼šç´„ 229 WUï¼ˆ58 vbytesï¼‰</span>
    <span class="c1">// P2WPKH è¼¸å‡ºçš„é‡é‡ï¼š124 WUï¼ˆ31 vbytesï¼‰</span>
    <span class="c1">// P2TR è¼¸å‡ºçš„é‡é‡ï¼š172 WUï¼ˆ43 vbytesï¼‰</span>

    <span class="k">fn</span> <span class="nf">calculate_fee</span><span class="p">(</span><span class="n">tx</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Transaction</span><span class="p">,</span> <span class="n">fee_rate</span><span class="p">:</span> <span class="nb">u64</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u64</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">weight</span> <span class="o">=</span> <span class="n">tx</span><span class="nf">.weight</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">vsize</span> <span class="o">=</span> <span class="n">weight</span><span class="nf">.to_vbytes_ceil</span><span class="p">();</span>
        <span class="n">vsize</span> <span class="o">*</span> <span class="n">fee_rate</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="43-rbfreplace-by-fee">4.3 RBFï¼ˆReplace-By-Feeï¼‰</h3>

<p>RBF æ˜¯ä¸€ç¨®å…è¨±æœªç¢ºèªäº¤æ˜“è¢«æ›¿æ›çš„æ©Ÿåˆ¶ã€‚ç•¶ä¸€ç­†äº¤æ˜“çš„ç¢ºèªæ™‚é–“æ¯”é æœŸé•·ï¼ˆå› ç‚ºè²»ç”¨è¨­å¾—å¤ªä½ï¼‰ï¼Œç™¼é€è€…å¯ä»¥å»£æ’­ä¸€å€‹æ–°ç‰ˆæœ¬ï¼Œæ”¯ä»˜æ›´é«˜çš„è²»ç”¨ã€‚</p>

<p>è¦å•Ÿç”¨ RBFï¼Œè‡³å°‘ä¸€å€‹è¼¸å…¥çš„åºåˆ—è™Ÿå¿…é ˆå°æ–¼ 0xFFFFFFFEã€‚rust-bitcoin æä¾›äº†ä¾¿åˆ©çš„å¸¸é‡ä¾†è¨­ç½®é€™å€‹å€¼ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="n">Sequence</span><span class="p">;</span>

<span class="c1">// å•Ÿç”¨ RBFï¼Œä¸ä½¿ç”¨é–å®šæ™‚é–“</span>
<span class="k">let</span> <span class="n">sequence</span> <span class="o">=</span> <span class="nn">Sequence</span><span class="p">::</span><span class="n">ENABLE_RBF_NO_LOCKTIME</span><span class="p">;</span>

<span class="c1">// æœ€å¤§åºåˆ—è™Ÿï¼ˆç¦ç”¨ RBFï¼‰</span>
<span class="k">let</span> <span class="n">no_rbf</span> <span class="o">=</span> <span class="nn">Sequence</span><span class="p">::</span><span class="n">MAX</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="5-æ§‹å»ºä¸¦ç°½åäº¤æ˜“">5. æ§‹å»ºä¸¦ç°½åäº¤æ˜“</h2>

<h3 id="51-ç°½åéç¨‹">5.1 ç°½åéç¨‹</h3>

<p>ç°½åä¸€ç­† Bitcoin äº¤æ˜“æ¶‰åŠå¤šå€‹æ­¥é©Ÿã€‚é¦–å…ˆéœ€è¦è¨ˆç®—ã€Œç°½åå“ˆå¸Œã€ï¼ˆsighashï¼‰ï¼Œé€™æ˜¯å°äº¤æ˜“æ•¸æ“šçš„ä¸€å€‹ç‰¹å®šæ‘˜è¦ï¼Œç°½åè€…éœ€è¦å°é€™å€‹æ‘˜è¦ç°½åã€‚</p>

<p>å°æ–¼ SegWit äº¤æ˜“ï¼Œç°½åå“ˆå¸Œçš„è¨ˆç®—éµå¾ª BIP143 çš„è¦å®šï¼Œé€™èˆ‡å‚³çµ±äº¤æ˜“ä¸åŒã€‚ä¸»è¦å€åˆ¥æ˜¯ BIP143 çš„ sighash åŒ…å«æ¯å€‹è¼¸å…¥è¢«èŠ±è²»çš„ UTXO çš„é‡‘é¡ï¼Œé€™æ¶ˆé™¤äº†æŸäº›é¡å‹çš„æ”»æ“Šã€‚</p>

<p>ç°½åé¡å‹ï¼ˆsighash typeï¼‰æŒ‡å®šäº†ç°½åæ¶µè“‹äº¤æ˜“çš„å“ªäº›éƒ¨åˆ†ï¼š</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">SIGHASH_ALL</code>ï¼ˆæœ€å¸¸è¦‹ï¼‰ï¼šç°½åæ¶µè“‹æ‰€æœ‰è¼¸å…¥å’Œè¼¸å‡º</li>
  <li><code class="language-plaintext highlighter-rouge">SIGHASH_NONE</code>ï¼šåªç°½åè¼¸å…¥ï¼Œå…è¨±ä»»ä½•äººä¿®æ”¹è¼¸å‡º</li>
  <li><code class="language-plaintext highlighter-rouge">SIGHASH_SINGLE</code>ï¼šç°½åä¸€å€‹è¼¸å…¥å’Œå°æ‡‰çš„è¼¸å‡º</li>
  <li>å¯ä»¥èˆ‡ <code class="language-plaintext highlighter-rouge">ANYONECANPAY</code> çµ„åˆï¼Œåªç°½åç•¶å‰è¼¸å…¥ï¼Œå…è¨±æ·»åŠ æ›´å¤šè¼¸å…¥</li>
</ul>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">sighash</span><span class="p">::{</span><span class="n">SighashCache</span><span class="p">,</span> <span class="n">EcdsaSighashType</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">secp256k1</span><span class="p">::{</span><span class="n">Secp256k1</span><span class="p">,</span> <span class="n">Message</span><span class="p">};</span>

<span class="k">fn</span> <span class="nf">sign_p2wpkh_input</span><span class="p">(</span>
    <span class="n">tx</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Transaction</span><span class="p">,</span>
    <span class="n">input_index</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="n">utxo_amount</span><span class="p">:</span> <span class="n">Amount</span><span class="p">,</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">PrivateKey</span><span class="p">,</span>
<span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">secp</span> <span class="o">=</span> <span class="nn">Secp256k1</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">public_key</span> <span class="o">=</span> <span class="n">private_key</span><span class="nf">.public_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">);</span>

    <span class="c1">// P2WPKH çš„ scriptCode æ˜¯å°æ‡‰ P2PKH çš„ scriptPubKey</span>
    <span class="k">let</span> <span class="n">script_code</span> <span class="o">=</span> <span class="nn">ScriptBuf</span><span class="p">::</span><span class="nf">new_p2pkh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">public_key</span><span class="nf">.pubkey_hash</span><span class="p">());</span>

    <span class="c1">// è¨ˆç®—ç°½åå“ˆå¸Œ</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">sighash_cache</span> <span class="o">=</span> <span class="nn">SighashCache</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">tx</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">sighash</span> <span class="o">=</span> <span class="n">sighash_cache</span><span class="nf">.p2wpkh_signature_hash</span><span class="p">(</span>
        <span class="n">input_index</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">script_code</span><span class="p">,</span>
        <span class="n">utxo_amount</span><span class="p">,</span>
        <span class="nn">EcdsaSighashType</span><span class="p">::</span><span class="n">All</span><span class="p">,</span>
    <span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// å‰µå»ºç°½å</span>
    <span class="k">let</span> <span class="n">message</span> <span class="o">=</span> <span class="nn">Message</span><span class="p">::</span><span class="nf">from_digest_slice</span><span class="p">(</span><span class="n">sighash</span><span class="nf">.as_byte_array</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">secp</span><span class="nf">.sign_ecdsa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">private_key</span><span class="py">.inner</span><span class="p">);</span>

    <span class="c1">// çµ„è£ witnessï¼š[signature, pubkey]</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">sig_bytes</span> <span class="o">=</span> <span class="n">signature</span><span class="nf">.serialize_der</span><span class="p">()</span><span class="nf">.to_vec</span><span class="p">();</span>
    <span class="n">sig_bytes</span><span class="nf">.push</span><span class="p">(</span><span class="nn">EcdsaSighashType</span><span class="p">::</span><span class="n">All</span><span class="nf">.to_u32</span><span class="p">()</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">);</span>

    <span class="n">tx</span><span class="py">.input</span><span class="p">[</span><span class="n">input_index</span><span class="p">]</span><span class="py">.witness</span><span class="nf">.push</span><span class="p">(</span><span class="n">sig_bytes</span><span class="p">);</span>
    <span class="n">tx</span><span class="py">.input</span><span class="p">[</span><span class="n">input_index</span><span class="p">]</span><span class="py">.witness</span><span class="nf">.push</span><span class="p">(</span><span class="n">public_key</span><span class="nf">.to_bytes</span><span class="p">());</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="52-psbtéƒ¨åˆ†ç°½åäº¤æ˜“">5.2 PSBTï¼ˆéƒ¨åˆ†ç°½åäº¤æ˜“ï¼‰</h3>

<p>PSBTï¼ˆPartially Signed Bitcoin Transactionï¼‰æ˜¯ BIP174 å®šç¾©çš„æ¨™æº–æ ¼å¼ï¼Œç”¨æ–¼åœ¨å¤šæ–¹ä¹‹é–“å‚³éå¾…ç°½åçš„äº¤æ˜“ã€‚å®ƒå°æ–¼å¤šé‡ç°½åã€ç¡¬é«”éŒ¢åŒ…å’Œå…¶ä»–éœ€è¦å¤šæ­¥é©Ÿç°½åçš„å ´æ™¯éå¸¸æœ‰ç”¨ã€‚</p>

<p>PSBT åŒ…å«äº†ç°½åè€…éœ€è¦çš„æ‰€æœ‰è³‡è¨Šï¼šæœªç°½åçš„äº¤æ˜“ã€æ¯å€‹è¼¸å…¥è¢«èŠ±è²»çš„ UTXO è³‡è¨Šã€æ´¾ç”Ÿè·¯å¾‘ç­‰ã€‚ç°½åè€…å¯ä»¥æ·»åŠ è‡ªå·±çš„ç°½åï¼Œç„¶å¾Œå°‡ PSBT å‚³éçµ¦ä¸‹ä¸€å€‹ç°½åè€…æˆ–çµ„åˆè€…ã€‚</p>

<p>ä¸€å€‹å…¸å‹çš„ PSBT å·¥ä½œæµç¨‹æ˜¯ï¼š</p>
<ol>
  <li><strong>å‰µå»ºè€…</strong>å‰µå»ºä¸€å€‹åŸºç¤çš„ PSBTï¼ŒåŒ…å«æœªç°½åäº¤æ˜“</li>
  <li><strong>æ›´æ–°è€…</strong>æ·»åŠ  UTXO è³‡è¨Šã€æ´¾ç”Ÿè·¯å¾‘ç­‰å…ƒæ•¸æ“š</li>
  <li><strong>ç°½åè€…</strong>ç‚ºä»–å€‘æ§åˆ¶çš„è¼¸å…¥æ·»åŠ ç°½å</li>
  <li><strong>çµ„åˆè€…</strong>å°‡å¤šå€‹éƒ¨åˆ†ç°½åçš„ PSBT åˆä½µ</li>
  <li><strong>æœ€çµ‚åŒ–è€…</strong>å®Œæˆæ‰€æœ‰è¼¸å…¥çš„è…³æœ¬ï¼Œç”Ÿæˆå¯å»£æ’­çš„äº¤æ˜“</li>
  <li><strong>å»£æ’­è€…</strong>å°‡äº¤æ˜“å»£æ’­åˆ°ç¶²è·¯</li>
</ol>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">psbt</span><span class="p">::</span><span class="n">Psbt</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">psbt_workflow</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// å‰µå»ºæœªç°½åäº¤æ˜“</span>
    <span class="k">let</span> <span class="n">unsigned_tx</span> <span class="o">=</span> <span class="nf">create_unsigned_transaction</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// å‰µå»º PSBT</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">psbt</span> <span class="o">=</span> <span class="nn">Psbt</span><span class="p">::</span><span class="nf">from_unsigned_tx</span><span class="p">(</span><span class="n">unsigned_tx</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// æ·»åŠ  UTXO è³‡è¨Šï¼ˆç°½åè€…éœ€è¦é€™äº›ï¼‰</span>
    <span class="n">psbt</span><span class="py">.inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="py">.witness_utxo</span> <span class="o">=</span> <span class="nf">Some</span><span class="p">(</span><span class="n">TxOut</span> <span class="p">{</span>
        <span class="n">value</span><span class="p">:</span> <span class="nn">Amount</span><span class="p">::</span><span class="nf">from_sat</span><span class="p">(</span><span class="mi">100_000</span><span class="p">),</span>
        <span class="n">script_pubkey</span><span class="p">:</span> <span class="n">sender_script</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="c1">// åºåˆ—åŒ–ç‚º Base64ï¼ˆç”¨æ–¼å‚³è¼¸ï¼‰</span>
    <span class="k">let</span> <span class="n">psbt_base64</span> <span class="o">=</span> <span class="n">psbt</span><span class="nf">.to_string</span><span class="p">();</span>

    <span class="c1">// ç°½åè€…è§£æä¸¦ç°½å</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">psbt</span> <span class="o">=</span> <span class="nn">Psbt</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psbt_base64</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="c1">// ... æ·»åŠ ç°½å ...</span>

    <span class="c1">// æœ€çµ‚åŒ–ä¸¦æå–äº¤æ˜“</span>
    <span class="n">psbt</span><span class="nf">.finalize_mut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">)</span><span class="nf">.expect</span><span class="p">(</span><span class="s">"æœ€çµ‚åŒ–å¤±æ•—"</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">signed_tx</span> <span class="o">=</span> <span class="n">psbt</span><span class="nf">.extract_tx</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="6-å¯¦æˆ°å®Œæ•´çš„éŒ¢åŒ…å¯¦ç¾">6. å¯¦æˆ°ï¼šå®Œæ•´çš„éŒ¢åŒ…å¯¦ç¾</h2>

<p>ä¸‹é¢æ˜¯ä¸€å€‹ç°¡å–®ä½†å®Œæ•´çš„éŒ¢åŒ…å¯¦ç¾ï¼Œå±•ç¤ºäº†å¾åœ°å€ç”Ÿæˆåˆ°äº¤æ˜“å»£æ’­çš„æ•´å€‹æµç¨‹ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::{</span>
    <span class="n">Network</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="n">PrivateKey</span><span class="p">,</span> <span class="n">PublicKey</span><span class="p">,</span>
    <span class="n">Transaction</span><span class="p">,</span> <span class="n">TxIn</span><span class="p">,</span> <span class="n">TxOut</span><span class="p">,</span> <span class="n">OutPoint</span><span class="p">,</span> <span class="n">Txid</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Witness</span><span class="p">,</span>
    <span class="n">ScriptBuf</span><span class="p">,</span> <span class="n">Amount</span><span class="p">,</span>
    <span class="nn">sighash</span><span class="p">::{</span><span class="n">SighashCache</span><span class="p">,</span> <span class="n">EcdsaSighashType</span><span class="p">},</span>
    <span class="nn">transaction</span><span class="p">::</span><span class="n">Version</span><span class="p">,</span>
    <span class="nn">absolute</span><span class="p">::</span><span class="n">LockTime</span><span class="p">,</span>
    <span class="nn">secp256k1</span><span class="p">::</span><span class="n">Secp256k1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">Wallet</span> <span class="p">{</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="n">PrivateKey</span><span class="p">,</span>
    <span class="n">public_key</span><span class="p">:</span> <span class="n">PublicKey</span><span class="p">,</span>
    <span class="n">address</span><span class="p">:</span> <span class="n">Address</span><span class="p">,</span>
    <span class="n">network</span><span class="p">:</span> <span class="n">Network</span><span class="p">,</span>
    <span class="n">secp</span><span class="p">:</span> <span class="n">Secp256k1</span><span class="o">&lt;</span><span class="nn">secp256k1</span><span class="p">::</span><span class="n">All</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">UTXO</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">txid</span><span class="p">:</span> <span class="n">Txid</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">vout</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">amount</span><span class="p">:</span> <span class="n">Amount</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">Wallet</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">wif</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="k">Self</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">secp</span> <span class="o">=</span> <span class="nn">Secp256k1</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">private_key</span> <span class="o">=</span> <span class="nn">PrivateKey</span><span class="p">::</span><span class="nf">from_wif</span><span class="p">(</span><span class="n">wif</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">public_key</span> <span class="o">=</span> <span class="n">private_key</span><span class="nf">.public_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">);</span>
        <span class="k">let</span> <span class="n">network</span> <span class="o">=</span> <span class="n">private_key</span><span class="py">.network</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="nn">Address</span><span class="p">::</span><span class="nf">p2wpkh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">public_key</span><span class="p">,</span> <span class="n">network</span><span class="p">);</span>

        <span class="nf">Ok</span><span class="p">(</span><span class="k">Self</span> <span class="p">{</span>
            <span class="n">private_key</span><span class="p">,</span>
            <span class="n">public_key</span><span class="p">,</span>
            <span class="n">address</span><span class="p">,</span>
            <span class="n">network</span><span class="p">,</span>
            <span class="n">secp</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">create_and_sign_transaction</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="k">self</span><span class="p">,</span>
        <span class="n">utxos</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">UTXO</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">recipient</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Address</span><span class="p">,</span>
        <span class="n">amount</span><span class="p">:</span> <span class="n">Amount</span><span class="p">,</span>
        <span class="n">fee_rate</span><span class="p">:</span> <span class="nb">u64</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Transaction</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">// è¨ˆç®—ç¸½è¼¸å…¥é‡‘é¡</span>
        <span class="k">let</span> <span class="n">total_input</span><span class="p">:</span> <span class="n">Amount</span> <span class="o">=</span> <span class="n">utxos</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.map</span><span class="p">(|</span><span class="n">u</span><span class="p">|</span> <span class="n">u</span><span class="py">.amount</span><span class="p">)</span><span class="nf">.sum</span><span class="p">();</span>

        <span class="c1">// ä¼°ç®—è²»ç”¨</span>
        <span class="k">let</span> <span class="n">estimated_size</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">68</span> <span class="o">*</span> <span class="n">utxos</span><span class="nf">.len</span><span class="p">()</span> <span class="o">+</span> <span class="mi">31</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">fee</span> <span class="o">=</span> <span class="nn">Amount</span><span class="p">::</span><span class="nf">from_sat</span><span class="p">(</span><span class="n">estimated_size</span> <span class="k">as</span> <span class="nb">u64</span> <span class="o">*</span> <span class="n">fee_rate</span><span class="p">);</span>

        <span class="c1">// è¨ˆç®—æ‰¾é›¶</span>
        <span class="k">let</span> <span class="n">change</span> <span class="o">=</span> <span class="n">total_input</span><span class="nf">.checked_sub</span><span class="p">(</span><span class="n">amount</span> <span class="o">+</span> <span class="n">fee</span><span class="p">)</span>
            <span class="nf">.ok_or_else</span><span class="p">(||</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nd">anyhow!</span><span class="p">(</span><span class="s">"é¤˜é¡ä¸è¶³"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>

        <span class="c1">// æ§‹å»ºè¼¸å…¥</span>
        <span class="k">let</span> <span class="n">inputs</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">TxIn</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">utxos</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.map</span><span class="p">(|</span><span class="n">utxo</span><span class="p">|</span> <span class="n">TxIn</span> <span class="p">{</span>
            <span class="n">previous_output</span><span class="p">:</span> <span class="n">OutPoint</span> <span class="p">{</span>
                <span class="n">txid</span><span class="p">:</span> <span class="n">utxo</span><span class="py">.txid</span><span class="p">,</span>
                <span class="n">vout</span><span class="p">:</span> <span class="n">utxo</span><span class="py">.vout</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">script_sig</span><span class="p">:</span> <span class="nn">ScriptBuf</span><span class="p">::</span><span class="nf">new</span><span class="p">(),</span>
            <span class="n">sequence</span><span class="p">:</span> <span class="nn">Sequence</span><span class="p">::</span><span class="n">ENABLE_RBF_NO_LOCKTIME</span><span class="p">,</span>
            <span class="n">witness</span><span class="p">:</span> <span class="nn">Witness</span><span class="p">::</span><span class="nf">new</span><span class="p">(),</span>
        <span class="p">})</span><span class="nf">.collect</span><span class="p">();</span>

        <span class="c1">// æ§‹å»ºè¼¸å‡º</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">outputs</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="n">TxOut</span> <span class="p">{</span>
            <span class="n">value</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="n">script_pubkey</span><span class="p">:</span> <span class="n">recipient</span><span class="nf">.script_pubkey</span><span class="p">(),</span>
        <span class="p">}];</span>

        <span class="c1">// åªæœ‰ç•¶æ‰¾é›¶è¶…éç²‰å¡µé™åˆ¶æ™‚æ‰æ·»åŠ æ‰¾é›¶è¼¸å‡º</span>
        <span class="k">if</span> <span class="n">change</span> <span class="o">&gt;</span> <span class="nn">Amount</span><span class="p">::</span><span class="nf">from_sat</span><span class="p">(</span><span class="mi">546</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">outputs</span><span class="nf">.push</span><span class="p">(</span><span class="n">TxOut</span> <span class="p">{</span>
                <span class="n">value</span><span class="p">:</span> <span class="n">change</span><span class="p">,</span>
                <span class="n">script_pubkey</span><span class="p">:</span> <span class="k">self</span><span class="py">.address</span><span class="nf">.script_pubkey</span><span class="p">(),</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="c1">// å‰µå»ºäº¤æ˜“</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">Transaction</span> <span class="p">{</span>
            <span class="n">version</span><span class="p">:</span> <span class="nn">Version</span><span class="p">::</span><span class="n">TWO</span><span class="p">,</span>
            <span class="n">lock_time</span><span class="p">:</span> <span class="nn">LockTime</span><span class="p">::</span><span class="n">ZERO</span><span class="p">,</span>
            <span class="n">input</span><span class="p">:</span> <span class="n">inputs</span><span class="p">,</span>
            <span class="n">output</span><span class="p">:</span> <span class="n">outputs</span><span class="p">,</span>
        <span class="p">};</span>

        <span class="c1">// ç°½åæ¯å€‹è¼¸å…¥</span>
        <span class="k">let</span> <span class="n">script_code</span> <span class="o">=</span> <span class="nn">ScriptBuf</span><span class="p">::</span><span class="nf">new_p2pkh</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="py">.public_key</span><span class="nf">.pubkey_hash</span><span class="p">());</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">utxo</span><span class="p">)</span> <span class="k">in</span> <span class="n">utxos</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.enumerate</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">let</span> <span class="k">mut</span> <span class="n">sighash_cache</span> <span class="o">=</span> <span class="nn">SighashCache</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="p">);</span>
            <span class="k">let</span> <span class="n">sighash</span> <span class="o">=</span> <span class="n">sighash_cache</span><span class="nf">.p2wpkh_signature_hash</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="n">script_code</span><span class="p">,</span>
                <span class="n">utxo</span><span class="py">.amount</span><span class="p">,</span>
                <span class="nn">EcdsaSighashType</span><span class="p">::</span><span class="n">All</span><span class="p">,</span>
            <span class="p">)</span><span class="o">?</span><span class="p">;</span>

            <span class="k">let</span> <span class="n">message</span> <span class="o">=</span> <span class="nn">secp256k1</span><span class="p">::</span><span class="nn">Message</span><span class="p">::</span><span class="nf">from_digest_slice</span><span class="p">(</span>
                <span class="n">sighash</span><span class="nf">.as_byte_array</span><span class="p">()</span>
            <span class="p">)</span><span class="o">?</span><span class="p">;</span>
            <span class="k">let</span> <span class="n">signature</span> <span class="o">=</span> <span class="k">self</span><span class="py">.secp</span><span class="nf">.sign_ecdsa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.private_key.inner</span><span class="p">);</span>

            <span class="k">let</span> <span class="k">mut</span> <span class="n">sig_bytes</span> <span class="o">=</span> <span class="n">signature</span><span class="nf">.serialize_der</span><span class="p">()</span><span class="nf">.to_vec</span><span class="p">();</span>
            <span class="n">sig_bytes</span><span class="nf">.push</span><span class="p">(</span><span class="nn">EcdsaSighashType</span><span class="p">::</span><span class="n">All</span><span class="nf">.to_u32</span><span class="p">()</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">);</span>

            <span class="n">tx</span><span class="py">.input</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="py">.witness</span><span class="nf">.push</span><span class="p">(</span><span class="n">sig_bytes</span><span class="p">);</span>
            <span class="n">tx</span><span class="py">.input</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="py">.witness</span><span class="nf">.push</span><span class="p">(</span><span class="k">self</span><span class="py">.public_key</span><span class="nf">.to_bytes</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="nf">Ok</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€™å€‹å¯¦ç¾å±•ç¤ºäº† Bitcoin äº¤æ˜“çš„æ ¸å¿ƒæ¦‚å¿µï¼šUTXO é¸æ“‡ã€è²»ç”¨è¨ˆç®—ã€è¼¸å‡ºå‰µå»ºå’Œç°½åç”Ÿæˆã€‚åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œä½ é‚„éœ€è¦æ·»åŠ éŒ¯èª¤è™•ç†ã€UTXO æŸ¥è©¢ï¼ˆé€šéç¯€é» RPC æˆ–å€å¡Šç€è¦½å™¨ APIï¼‰ã€ä»¥åŠäº¤æ˜“å»£æ’­åŠŸèƒ½ã€‚</p>

<hr />

<h2 id="7-ç·´ç¿’é¡Œ">7. ç·´ç¿’é¡Œ</h2>

<h3 id="ç·´ç¿’-1å¯¦ç¾åœ°å€é–“éš”æƒæ">ç·´ç¿’ 1ï¼šå¯¦ç¾åœ°å€é–“éš”æƒæ</h3>

<p>å‰µå»ºä¸€å€‹å‡½æ•¸ï¼Œä½¿ç”¨ã€Œåœ°å€é–“éš”ã€ç­–ç•¥ç”Ÿæˆ HD éŒ¢åŒ…åœ°å€ã€‚é€™æ˜¯éŒ¢åŒ…æ¢å¾©çš„æ¨™æº–æ–¹æ³•ï¼šé€£çºŒæª¢æŸ¥åœ°å€ç›´åˆ°é‡åˆ°ä¸€å®šæ•¸é‡çš„æœªä½¿ç”¨åœ°å€ã€‚</p>

<h3 id="ç·´ç¿’-2äº¤æ˜“è§£æå™¨">ç·´ç¿’ 2ï¼šäº¤æ˜“è§£æå™¨</h3>

<p>å¯¦ç¾ä¸€å€‹å‡½æ•¸ï¼Œè§£æåŸå§‹äº¤æ˜“çš„åå…­é€²åˆ¶è¡¨ç¤ºï¼Œæå–ä¸¦é¡¯ç¤ºæ‰€æœ‰æ¬„ä½ï¼šç‰ˆæœ¬ã€è¼¸å…¥ã€è¼¸å‡ºã€è¦‹è­‰æ•¸æ“šå’Œé–å®šæ™‚é–“ã€‚</p>

<h3 id="ç·´ç¿’-3utxo-åˆä½µ">ç·´ç¿’ 3ï¼šUTXO åˆä½µ</h3>

<p>å‰µå»ºä¸€å€‹å‡½æ•¸ï¼Œå°‡å¤šå€‹å°é¡ UTXO åˆä½µæˆä¸€å€‹å¤§é¡ UTXOã€‚é€™åœ¨è²»ç‡ä½çš„æ™‚å€™åšå¯ä»¥ç¯€çœæœªä¾†äº¤æ˜“çš„è²»ç”¨ã€‚è€ƒæ…®ä½•æ™‚åˆä½µæ˜¯ç¶“æ¿Ÿçš„ï¼ˆè²»ç”¨ç¯€çœè¶…éåˆä½µæˆæœ¬ï¼‰ã€‚</p>

<hr />

<h2 id="8-ç¸½çµ">8. ç¸½çµ</h2>

<p>æœ¬ç¯‡æ·±å…¥æ¢è¨äº† Bitcoin åœ°å€å’Œäº¤æ˜“çš„æŠ€è¡“ç´°ç¯€ã€‚æˆ‘å€‘äº†è§£äº† HD éŒ¢åŒ…å¦‚ä½•è®“å–®ä¸€ç¨®å­è¡ç”Ÿå‡ºç„¡é™åœ°å€ï¼Œä¸åŒåœ°å€é¡å‹çš„ç‰¹æ€§å’Œç”¨é€”ï¼ŒUTXO æ¨¡å‹å¦‚ä½•é‹ä½œï¼Œä»¥åŠå¦‚ä½•æ§‹å»ºå’Œç°½åçœŸå¯¦çš„äº¤æ˜“ã€‚</p>

<p>é—œéµè¦é»ï¼š</p>
<ul>
  <li>HD éŒ¢åŒ…ï¼ˆBIP32/39/44/84ï¼‰æ˜¯ç¾ä»£éŒ¢åŒ…çš„æ¨™æº–</li>
  <li>ä¸åŒåœ°å€é¡å‹æœ‰ä¸åŒçš„è²»ç”¨å’ŒåŠŸèƒ½ç‰¹æ€§</li>
  <li>UTXO é¸æ“‡ç­–ç•¥å½±éŸ¿äº¤æ˜“è²»ç”¨å’Œéš±ç§</li>
  <li>SegWit å’Œ Taproot æä¾›æ›´ä½çš„è²»ç”¨å’Œæ›´å¥½çš„éš±ç§</li>
  <li>PSBT æ˜¯å¤šæ–¹ç°½åå·¥ä½œæµç¨‹çš„æ¨™æº–æ ¼å¼</li>
</ul>

<p>ä¸‹ä¸€ç¯‡å°‡æ·±å…¥æ¢è¨ Bitcoin Script ç·¨ç¨‹å’Œå„ç¨®ç°½åæ©Ÿåˆ¶ã€‚</p>

<hr />

<h2 id="åƒè€ƒè³‡æº">åƒè€ƒè³‡æº</h2>

<h3 id="bip-æ–‡æª”">BIP æ–‡æª”</h3>
<ul>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki">BIP 32: HD Wallets</a></li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki">BIP 39: Mnemonic Code</a></li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki">BIP 44: Multi-Account Hierarchy</a></li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0084.mediawiki">BIP 84: Native SegWit</a></li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki">BIP 174: PSBT</a></li>
</ul>

<h3 id="å·¥å…·">å·¥å…·</h3>
<ul>
  <li><a href="https://iancoleman.io/bip39/">Ian Coleman BIP39 Tool</a></li>
  <li><a href="https://coinb.in/">Bitcoin Transaction Builder</a></li>
</ul>]]></content><author><name>Cypherpunks Taiwan</name></author><category term="æŠ€è¡“æ•™å­¸" /><category term="Bitcoin" /><category term="Rust" /><category term="Rust" /><category term="Bitcoin" /><category term="åœ°å€" /><category term="äº¤æ˜“" /><category term="HDéŒ¢åŒ…" /><category term="BIP32" /><category term="BIP39" /><category term="BIP44" /><summary type="html"><![CDATA[é€™æ˜¯ Rust Bitcoin é–‹ç™¼å…¥é–€ç³»åˆ—çš„ç¬¬äºŒç¯‡ã€‚æœ¬ç¯‡æ·±å…¥æ¢è¨ Bitcoin åœ°å€çš„ç”Ÿæˆæ©Ÿåˆ¶å’Œäº¤æ˜“çš„æ§‹å»ºéç¨‹ã€‚]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" /><media:content medium="image" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Rust Bitcoin é–‹ç™¼å…¥é–€ï¼ˆä¸€ï¼‰ï¼šç’°å¢ƒè¨­ç½®èˆ‡åŸºç¤æ¦‚å¿µ</title><link href="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/rust/2025/03/22/rust-bitcoin-tutorial-1-environment-basics/" rel="alternate" type="text/html" title="Rust Bitcoin é–‹ç™¼å…¥é–€ï¼ˆä¸€ï¼‰ï¼šç’°å¢ƒè¨­ç½®èˆ‡åŸºç¤æ¦‚å¿µ" /><published>2025-03-22T00:00:00+00:00</published><updated>2025-03-22T00:00:00+00:00</updated><id>https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/rust/2025/03/22/rust-bitcoin-tutorial-1-environment-basics</id><content type="html" xml:base="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/rust/2025/03/22/rust-bitcoin-tutorial-1-environment-basics/"><![CDATA[<p>é€™æ˜¯ Rust Bitcoin é–‹ç™¼å…¥é–€ç³»åˆ—çš„ç¬¬ä¸€ç¯‡ã€‚æœ¬ç³»åˆ—å°‡å¸¶ä½ å¾é›¶é–‹å§‹ä½¿ç”¨ Rust èªè¨€é–‹ç™¼ Bitcoin æ‡‰ç”¨ï¼Œå¾åŸºç¤è¨­ç½®åˆ°é€²éšæ‡‰ç”¨ã€‚</p>

<p><strong>ç³»åˆ—æ–‡ç« å°èˆªï¼š</strong></p>
<ul>
  <li><strong>ç¬¬ä¸€ç¯‡ï¼šç’°å¢ƒè¨­ç½®èˆ‡åŸºç¤æ¦‚å¿µ</strong>ï¼ˆæœ¬ç¯‡ï¼‰</li>
  <li><a href="/2025/03/23/rust-bitcoin-tutorial-2-addresses-transactions/">ç¬¬äºŒç¯‡ï¼šåœ°å€ç”Ÿæˆèˆ‡äº¤æ˜“æ§‹å»º</a></li>
  <li><a href="/2025/03/24/rust-bitcoin-tutorial-3-scripts-signatures/">ç¬¬ä¸‰ç¯‡ï¼šè…³æœ¬èˆ‡ç°½å</a></li>
  <li><a href="/2025/03/25/rust-bitcoin-tutorial-4-advanced-applications/">ç¬¬å››ç¯‡ï¼šé€²éšæ‡‰ç”¨èˆ‡æ•´åˆ</a></li>
</ul>

<hr />

<h2 id="1-ç‚ºä»€éº¼é¸æ“‡-rust">1. ç‚ºä»€éº¼é¸æ“‡ Rustï¼Ÿ</h2>

<h3 id="11-rust-åœ¨-bitcoin-é–‹ç™¼ä¸­çš„å„ªå‹¢">1.1 Rust åœ¨ Bitcoin é–‹ç™¼ä¸­çš„å„ªå‹¢</h3>

<p>ç•¶æˆ‘å€‘æ€è€ƒ Bitcoin é–‹ç™¼çš„èªè¨€é¸æ“‡æ™‚ï¼Œå¿…é ˆè€ƒæ…®é€™å€‹é ˜åŸŸçš„ç‰¹æ®Šéœ€æ±‚ã€‚Bitcoin æ˜¯ä¸€å€‹è™•ç†çœŸå¯¦åƒ¹å€¼çš„ç³»çµ±ï¼Œä»»ä½•ç¨‹å¼éŒ¯èª¤éƒ½å¯èƒ½å°è‡´ä¸å¯é€†çš„è²¡å‹™æå¤±ã€‚èˆ‡æ™®é€šçš„ç¶²é æ‡‰ç”¨ä¸åŒï¼ŒBitcoin ç¨‹å¼ç¢¼æ²’æœ‰ã€Œä¿®å¾©å¾Œé‡æ–°éƒ¨ç½²ã€çš„å¥¢ä¾ˆâ€”â€”ä¸€æ—¦äº¤æ˜“å»£æ’­åˆ°ç¶²è·¯ä¸¦è¢«ç¢ºèªï¼Œå°±æ°¸é ç„¡æ³•æ’¤éŠ·ã€‚</p>

<p>Rust èªè¨€çš„è¨­è¨ˆç†å¿µèˆ‡ Bitcoin é–‹ç™¼çš„éœ€æ±‚é«˜åº¦å¥‘åˆã€‚é¦–å…ˆæ˜¯è¨˜æ†¶é«”å®‰å…¨ã€‚å‚³çµ±çš„ C/C++ ç¨‹å¼ç¶“å¸¸é­å—ç·©è¡å€æº¢ä½ï¼ˆbuffer overflowï¼‰ã€ä½¿ç”¨å¾Œé‡‹æ”¾ï¼ˆuse-after-freeï¼‰ç­‰æ¼æ´çš„å›°æ“¾ã€‚é€™äº›æ¼æ´åœ¨é‡‘èè»Ÿé«”ä¸­å¯èƒ½æ˜¯ç½é›£æ€§çš„ã€‚Rust çš„æ‰€æœ‰æ¬Šç³»çµ±åœ¨ç·¨è­¯æ™‚å°±èƒ½æ•æ‰é€™äº›å•é¡Œï¼Œè€Œä¸æ˜¯ç­‰åˆ°ç¨‹å¼åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­å´©æ½°ã€‚</p>

<p>å…¶æ¬¡æ˜¯åŸ·è¡Œç·’å®‰å…¨ã€‚ç¾ä»£ Bitcoin æ‡‰ç”¨å¸¸å¸¸éœ€è¦åŒæ™‚è™•ç†å¤šå€‹æ“ä½œâ€”â€”ç›£è½æ–°å€å¡Šã€è™•ç†ç”¨æˆ¶è«‹æ±‚ã€ç°½ç½²äº¤æ˜“ç­‰ã€‚Rust çš„å€Ÿç”¨æª¢æŸ¥å™¨èƒ½åœ¨ç·¨è­¯æ™‚é˜²æ­¢è³‡æ–™ç«¶çˆ­ï¼ˆdata racesï¼‰ï¼Œé€™æ„å‘³è‘—å¤šåŸ·è¡Œç·’ç¨‹å¼çš„æ­£ç¢ºæ€§æœ‰ç·¨è­¯å™¨çš„ä¿è­‰ã€‚</p>

<p>æ•ˆèƒ½æ–¹é¢ï¼ŒRust æä¾›äº†ã€Œé›¶æˆæœ¬æŠ½è±¡ã€ã€‚ä½ å¯ä»¥ä½¿ç”¨é«˜éšçš„ç¨‹å¼è¨­è¨ˆæ¦‚å¿µï¼ˆæ³›å‹ã€è¿­ä»£å™¨ã€é–‰åŒ…ç­‰ï¼‰ï¼Œè€Œç·¨è­¯å™¨æœƒå°‡å…¶å„ªåŒ–æˆèˆ‡æ‰‹å¯«åº•å±¤ç¨‹å¼ç¢¼ç›¸ç•¶çš„æ©Ÿå™¨ç¢¼ã€‚é€™å°æ–¼éœ€è¦è™•ç†å¤§é‡å¯†ç¢¼å­¸é‹ç®—çš„ Bitcoin æ‡‰ç”¨éå¸¸é‡è¦ã€‚</p>

<p>æœ€å¾Œï¼ŒRust æ²’æœ‰åƒåœ¾æ”¶é›†å™¨ï¼ˆGCï¼‰ã€‚é€™æ„å‘³è‘—ç¨‹å¼çš„åŸ·è¡Œæ™‚æ©Ÿæ˜¯å¯é æ¸¬çš„ï¼Œä¸æœƒçªç„¶æš«åœä¾†å›æ”¶è¨˜æ†¶é«”ã€‚å°æ–¼éœ€è¦å¿«é€Ÿå›æ‡‰çš„äº¤æ˜“ç°½ç½²æˆ–å€å¡Šè™•ç†ä¾†èªªï¼Œé€™ç¨®å¯é æ¸¬æ€§æ˜¯å¿…è¦çš„ã€‚</p>

<h3 id="12-rust-bitcoin-ç”Ÿæ…‹ç³»çµ±">1.2 Rust Bitcoin ç”Ÿæ…‹ç³»çµ±</h3>

<p>Rust çš„ Bitcoin ç”Ÿæ…‹ç³»çµ±å·²ç¶“ç›¸ç•¶æˆç†Ÿï¼Œå½¢æˆäº†å±¤æ¬¡åˆ†æ˜çš„å‡½å¼åº«æ¶æ§‹ã€‚</p>

<p>åœ¨æœ€åº•å±¤ï¼Œæˆ‘å€‘æœ‰ <code class="language-plaintext highlighter-rouge">bitcoin_hashes</code> å’Œ <code class="language-plaintext highlighter-rouge">secp256k1</code>ã€‚<code class="language-plaintext highlighter-rouge">bitcoin_hashes</code> æä¾›äº† Bitcoin ä½¿ç”¨çš„æ‰€æœ‰å“ˆå¸Œå‡½æ•¸â€”â€”SHA256ã€RIPEMD160ã€HASH160 ç­‰ã€‚<code class="language-plaintext highlighter-rouge">secp256k1</code> å‰‡æ˜¯ Bitcoin ä½¿ç”¨çš„æ©¢åœ“æ›²ç·šå¯†ç¢¼å­¸å‡½å¼åº«çš„ Rust ç¶å®šï¼Œç”¨æ–¼ç§é‘°/å…¬é‘°é‹ç®—å’Œæ•¸ä½ç°½åã€‚</p>

<p>åœ¨å…¶ä¸Šæ˜¯ <code class="language-plaintext highlighter-rouge">rust-bitcoin</code>ï¼Œé€™æ˜¯æ ¸å¿ƒçš„å”è­°å‡½å¼åº«ã€‚å®ƒå®šç¾©äº† Bitcoin çš„æ‰€æœ‰è³‡æ–™çµæ§‹â€”â€”äº¤æ˜“ã€å€å¡Šã€åœ°å€ã€è…³æœ¬ç­‰â€”â€”ä»¥åŠå®ƒå€‘çš„åºåˆ—åŒ–å’Œè§£æé‚è¼¯ã€‚å¹¾ä¹æ‰€æœ‰ Rust Bitcoin å°ˆæ¡ˆéƒ½æœƒä¾è³´é€™å€‹å‡½å¼åº«ã€‚</p>

<p>æ›´é«˜å±¤æ¬¡çš„å‡½å¼åº«å»ºç«‹åœ¨ <code class="language-plaintext highlighter-rouge">rust-bitcoin</code> ä¹‹ä¸Šã€‚BDKï¼ˆBitcoin Development Kitï¼‰æ˜¯ä¸€å€‹å®Œæ•´çš„éŒ¢åŒ…é–‹ç™¼æ¡†æ¶ï¼Œè™•ç†äº† UTXO ç®¡ç†ã€äº¤æ˜“æ§‹å»ºã€ç¡¬é«”éŒ¢åŒ…æ•´åˆç­‰è¤‡é›œå•é¡Œã€‚LDKï¼ˆLightning Development Kitï¼‰å‰‡æä¾›äº† Lightning Network çš„å¯¦ç¾ï¼Œè®“é–‹ç™¼è€…å¯ä»¥å°‡é–ƒé›»ç¶²è·¯åŠŸèƒ½æ•´åˆåˆ°è‡ªå·±çš„æ‡‰ç”¨ä¸­ã€‚</p>

<p>é€™ç¨®åˆ†å±¤æ¶æ§‹çš„å¥½è™•æ˜¯ï¼Œä½ å¯ä»¥æ ¹æ“šéœ€æ±‚é¸æ“‡é©ç•¶çš„æŠ½è±¡å±¤æ¬¡ã€‚éœ€è¦å®Œå…¨æ§åˆ¶ï¼Ÿç›´æ¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">rust-bitcoin</code>ã€‚æƒ³è¦å¿«é€Ÿé–‹ç™¼éŒ¢åŒ…ï¼Ÿä½¿ç”¨ BDKã€‚</p>

<hr />

<h2 id="2-ç’°å¢ƒè¨­ç½®">2. ç’°å¢ƒè¨­ç½®</h2>

<h3 id="21-å®‰è£-rust">2.1 å®‰è£ Rust</h3>

<p>Rust çš„å®‰è£é€éå®˜æ–¹å·¥å…· <code class="language-plaintext highlighter-rouge">rustup</code> é€²è¡Œï¼Œé€™æ˜¯ä¸€å€‹ç‰ˆæœ¬ç®¡ç†å™¨ï¼Œå¯ä»¥è¼•é¬†åˆ‡æ› Rust ç‰ˆæœ¬å’Œå®‰è£é¡å¤–çµ„ä»¶ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c"># å®‰è£ Rustupï¼ˆRust ç‰ˆæœ¬ç®¡ç†å™¨ï¼‰</span>
curl <span class="nt">--proto</span> <span class="s1">'=https'</span> <span class="nt">--tlsv1</span>.2 <span class="nt">-sSf</span> https://sh.rustup.rs | sh

<span class="c"># æŒ‰ç…§æç¤ºå®Œæˆå®‰è£å¾Œï¼Œé‡æ–°è¼‰å…¥ç’°å¢ƒè®Šæ•¸</span>
<span class="nb">source</span> <span class="nv">$HOME</span>/.cargo/env

<span class="c"># é©—è­‰å®‰è£</span>
rustc <span class="nt">--version</span>
cargo <span class="nt">--version</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®‰è£å®Œæˆå¾Œï¼Œå»ºè­°å®‰è£å…©å€‹å¯¦ç”¨å·¥å…·ï¼š<code class="language-plaintext highlighter-rouge">clippy</code> æ˜¯ä¸€å€‹ lint å·¥å…·ï¼Œèƒ½æŒ‡å‡ºç¨‹å¼ç¢¼ä¸­çš„å¸¸è¦‹å•é¡Œå’Œæ”¹é€²å»ºè­°ï¼›<code class="language-plaintext highlighter-rouge">rustfmt</code> å‰‡è‡ªå‹•æ ¼å¼åŒ–ç¨‹å¼ç¢¼ï¼Œä¿æŒé¢¨æ ¼ä¸€è‡´ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>rustup component add clippy
rustup component add rustfmt
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="22-å‰µå»ºå°ˆæ¡ˆ">2.2 å‰µå»ºå°ˆæ¡ˆ</h3>

<p>Rust ä½¿ç”¨ Cargo ä½œç‚ºå»ºæ§‹å·¥å…·å’Œå¥—ä»¶ç®¡ç†å™¨ã€‚å‰µå»ºæ–°å°ˆæ¡ˆéå¸¸ç°¡å–®ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>cargo new bitcoin-tutorial
<span class="nb">cd </span>bitcoin-tutorial
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€™æœƒå‰µå»ºä¸€å€‹æ¨™æº–çš„ Rust å°ˆæ¡ˆçµæ§‹ã€‚<code class="language-plaintext highlighter-rouge">Cargo.toml</code> æ˜¯å°ˆæ¡ˆçš„è¨­å®šæª”ï¼Œå®šç¾©äº†å°ˆæ¡ˆåç¨±ã€ç‰ˆæœ¬å’Œä¾è³´é—œä¿‚ã€‚<code class="language-plaintext highlighter-rouge">src/main.rs</code> æ˜¯ä¸»ç¨‹å¼æª”æ¡ˆã€‚</p>

<h3 id="23-é…ç½®ä¾è³´">2.3 é…ç½®ä¾è³´</h3>

<p>åœ¨ <code class="language-plaintext highlighter-rouge">Cargo.toml</code> ä¸­æ·»åŠ  Bitcoin é–‹ç™¼æ‰€éœ€çš„ä¾è³´ã€‚æ¯å€‹ä¾è³´éƒ½æœ‰å…¶ç‰¹å®šç”¨é€”ï¼š</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="k">[</span><span class="n">package</span><span class="k">]</span>
<span class="n">name</span> <span class="o">=</span><span class="w"> </span><span class="s">"bitcoin-tutorial"</span>
<span class="n">version</span> <span class="o">=</span><span class="w"> </span><span class="s">"0.1.0"</span>
<span class="n">edition</span> <span class="o">=</span><span class="w"> </span><span class="s">"2021"</span>

<span class="k">[</span><span class="n">dependencies</span><span class="k">]</span>
<span class="c"># Bitcoin æ ¸å¿ƒåº« - æä¾›æ‰€æœ‰ Bitcoin è³‡æ–™çµæ§‹å’Œå”è­°é‚è¼¯</span>
<span class="n">bitcoin</span> <span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">"0.32"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s">"serde"</span><span class="p">,</span> <span class="s">"rand-std"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>

<span class="c"># æ©¢åœ“æ›²ç·šå¯†ç¢¼å­¸ - ç”¨æ–¼ç°½åå’Œé‡‘é‘°æ“ä½œ</span>
<span class="n">secp256k1</span> <span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">"0.29"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s">"rand-std"</span><span class="p">,</span> <span class="s">"global-context"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>

<span class="c"># åºåˆ—åŒ–æ¡†æ¶ - ç”¨æ–¼ JSON è™•ç†</span>
<span class="n">serde</span> <span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">"1.0"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="s">"derive"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="n">serde_json</span> <span class="o">=</span><span class="w"> </span><span class="s">"1.0"</span>

<span class="c"># åå…­é€²åˆ¶ç·¨ç¢¼ - Bitcoin è³‡æ–™å¸¸ç”¨åå…­é€²åˆ¶è¡¨ç¤º</span>
<span class="n">hex</span> <span class="o">=</span><span class="w"> </span><span class="s">"0.4"</span>

<span class="c"># éŒ¯èª¤è™•ç† - ç°¡åŒ–éŒ¯èª¤å‚³æ’­</span>
<span class="n">anyhow</span> <span class="o">=</span><span class="w"> </span><span class="s">"1.0"</span>
<span class="n">thiserror</span> <span class="o">=</span><span class="w"> </span><span class="s">"1.0"</span>

<span class="c"># BIP39 åŠ©è¨˜è© - äººé¡å¯è®€çš„ç¨®å­æ ¼å¼</span>
<span class="n">bip39</span> <span class="o">=</span><span class="w"> </span><span class="s">"2.0"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">bitcoin</code> å‡½å¼åº«çš„ <code class="language-plaintext highlighter-rouge">serde</code> feature å•Ÿç”¨äº†åºåˆ—åŒ–æ”¯æ´ï¼Œ<code class="language-plaintext highlighter-rouge">rand-std</code> å‰‡å…è¨±ä½¿ç”¨æ¨™æº–å‡½å¼åº«çš„éš¨æ©Ÿæ•¸ç”Ÿæˆå™¨ã€‚<code class="language-plaintext highlighter-rouge">secp256k1</code> çš„ <code class="language-plaintext highlighter-rouge">global-context</code> feature æä¾›äº†ä¸€å€‹å…¨åŸŸçš„ä¸Šä¸‹æ–‡ç‰©ä»¶ï¼Œé¿å…åœ¨æ¯æ¬¡é‹ç®—æ™‚éƒ½å‰µå»ºæ–°çš„ä¸Šä¸‹æ–‡ã€‚</p>

<hr />

<h2 id="3-rust-bitcoin-åŸºç¤">3. rust-bitcoin åŸºç¤</h2>

<h3 id="31-ç†è§£é‡‘é¡amount">3.1 ç†è§£é‡‘é¡ï¼ˆAmountï¼‰</h3>

<p>åœ¨ Bitcoin å…§éƒ¨ï¼Œæ‰€æœ‰é‡‘é¡éƒ½ä»¥ã€Œè°ã€ï¼ˆsatoshiï¼‰è¨ˆç®—ã€‚ä¸€å€‹ Bitcoin ç­‰æ–¼ä¸€å„„è°ï¼ˆ100,000,000 satoshiï¼‰ã€‚é€™ç¨®è¨­è¨ˆé¿å…äº†æµ®é»æ•¸é‹ç®—çš„ç²¾åº¦å•é¡Œâ€”â€”åœ¨è™•ç†é‡‘éŒ¢æ™‚ï¼Œé€™ç¨®ç²¾åº¦è‡³é—œé‡è¦ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="n">Amount</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">amount_examples</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// å¾è°å‰µå»ºé‡‘é¡</span>
    <span class="k">let</span> <span class="n">amount_sat</span> <span class="o">=</span> <span class="nn">Amount</span><span class="p">::</span><span class="nf">from_sat</span><span class="p">(</span><span class="mi">100_000_000</span><span class="p">);</span>  <span class="c1">// 1 BTC</span>

    <span class="c1">// å¾ BTC å‰µå»ºé‡‘é¡ï¼ˆæ³¨æ„ï¼šå¯èƒ½å¤±æ•—ï¼Œå› æ­¤è¿”å› Resultï¼‰</span>
    <span class="k">let</span> <span class="n">amount_btc</span> <span class="o">=</span> <span class="nn">Amount</span><span class="p">::</span><span class="nf">from_btc</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">();</span>

    <span class="c1">// å…©è€…ç›¸ç­‰</span>
    <span class="nd">assert_eq!</span><span class="p">(</span><span class="n">amount_sat</span><span class="p">,</span> <span class="n">amount_btc</span><span class="p">);</span>

    <span class="c1">// é‡‘é¡é‹ç®—</span>
    <span class="k">let</span> <span class="n">fee</span> <span class="o">=</span> <span class="nn">Amount</span><span class="p">::</span><span class="nf">from_sat</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">total</span> <span class="o">=</span> <span class="n">amount_btc</span> <span class="o">+</span> <span class="n">fee</span><span class="p">;</span>

    <span class="c1">// ä½¿ç”¨ checked_sub é¿å…æº¢ä½ï¼ˆé‡‘é¡ä¸èƒ½ç‚ºè² ï¼‰</span>
    <span class="k">let</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">amount_btc</span><span class="nf">.checked_sub</span><span class="p">(</span><span class="n">fee</span><span class="p">)</span>
        <span class="nf">.expect</span><span class="p">(</span><span class="s">"é‡‘é¡ä¸è¶³"</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Amount</code> é¡å‹é˜²æ­¢äº†ä¸€å€‹å¸¸è¦‹éŒ¯èª¤ï¼šæ··æ·† BTC å’Œ satoshi å–®ä½ã€‚ç·¨è­¯å™¨æœƒç¢ºä¿ä½ åœ¨é‹ç®—æ™‚ä½¿ç”¨ç›¸åŒçš„å–®ä½ã€‚</p>

<h3 id="32-ç¶²è·¯é¡å‹network">3.2 ç¶²è·¯é¡å‹ï¼ˆNetworkï¼‰</h3>

<p>Bitcoin æœ‰å¤šå€‹ç¶²è·¯ï¼Œæ¯å€‹ç¶²è·¯ä½¿ç”¨ä¸åŒçš„åœ°å€å‰ç¶´å’Œå”è­°åƒæ•¸ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="n">Network</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">network_examples</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">mainnet</span> <span class="o">=</span> <span class="nn">Network</span><span class="p">::</span><span class="n">Bitcoin</span><span class="p">;</span>   <span class="c1">// æ­£å¼ç¶²è·¯ï¼Œä½¿ç”¨çœŸå¯¦çš„ BTC</span>
    <span class="k">let</span> <span class="n">testnet</span> <span class="o">=</span> <span class="nn">Network</span><span class="p">::</span><span class="n">Testnet</span><span class="p">;</span>   <span class="c1">// æ¸¬è©¦ç¶²è·¯ï¼Œä½¿ç”¨ç„¡åƒ¹å€¼çš„æ¸¬è©¦å¹£</span>
    <span class="k">let</span> <span class="n">signet</span> <span class="o">=</span> <span class="nn">Network</span><span class="p">::</span><span class="n">Signet</span><span class="p">;</span>     <span class="c1">// ç°½åæ¸¬è©¦ç¶²è·¯ï¼Œæ›´ç©©å®šçš„æ¸¬è©¦ç’°å¢ƒ</span>
    <span class="k">let</span> <span class="n">regtest</span> <span class="o">=</span> <span class="nn">Network</span><span class="p">::</span><span class="n">Regtest</span><span class="p">;</span>   <span class="c1">// æœ¬åœ°å›æ­¸æ¸¬è©¦ç¶²è·¯</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨é–‹ç™¼éç¨‹ä¸­ï¼Œæ‡‰è©²å§‹çµ‚ä½¿ç”¨æ¸¬è©¦ç¶²è·¯ï¼ˆtestnet æˆ– signetï¼‰ï¼Œç›´åˆ°ç¨‹å¼ç¢¼ç¶“éå……åˆ†æ¸¬è©¦ã€‚åœ¨æ¸¬è©¦ç¶²è·¯ä¸ŠçŠ¯éŒ¯ä¸æœƒæœ‰ä»»ä½•è²¡å‹™æå¤±ï¼Œä½†åœ¨ä¸»ç¶²ä¸Šçš„éŒ¯èª¤å¯èƒ½æ˜¯ç½é›£æ€§çš„ã€‚</p>

<h3 id="33-å“ˆå¸Œå‡½æ•¸">3.3 å“ˆå¸Œå‡½æ•¸</h3>

<p>Bitcoin å¤§é‡ä½¿ç”¨å“ˆå¸Œå‡½æ•¸ï¼Œæ¯ç¨®å‡½æ•¸éƒ½æœ‰ç‰¹å®šç”¨é€”ï¼š</p>

<p><strong>SHA256</strong> æ˜¯åŸºç¤çš„å“ˆå¸Œå‡½æ•¸ï¼Œè¼¸å‡º 32 bytesã€‚</p>

<p><strong>Double SHA256ï¼ˆSHA256dï¼‰</strong> æ˜¯å°è³‡æ–™é€²è¡Œå…©æ¬¡ SHA256ã€‚Bitcoin åœ¨è¨±å¤šåœ°æ–¹ä½¿ç”¨é€™ç¨®é›™é‡å“ˆå¸Œï¼ŒåŒ…æ‹¬äº¤æ˜“ IDã€å€å¡Šé›œæ¹Šç­‰ã€‚é€™å¯èƒ½æ˜¯ç‚ºäº†é˜²æ­¢æŸäº›ç†è«–ä¸Šçš„æ”»æ“Šï¼ˆé•·åº¦æ“´å±•æ”»æ“Šï¼‰ï¼Œé›–ç„¶å° SHA256 ä¾†èªªé€™å¯èƒ½æ˜¯éåº¦è¬¹æ…ã€‚</p>

<p><strong>RIPEMD160</strong> æ˜¯ä¸€å€‹è¼¸å‡º 20 bytes çš„å“ˆå¸Œå‡½æ•¸ã€‚</p>

<p><strong>HASH160</strong> æ˜¯ SHA256 å¾Œæ¥ RIPEMD160ï¼Œç”¨æ–¼ç”Ÿæˆå…¬é‘°çš„é›œæ¹Šå€¼ï¼Œé€²è€Œç”Ÿæˆåœ°å€ã€‚ä½¿ç”¨é€™å€‹çµ„åˆè€Œä¸æ˜¯å–®ç´”çš„ SHA256 æ˜¯ç‚ºäº†å¾—åˆ°æ›´çŸ­çš„è¼¸å‡ºï¼ˆ20 bytes vs 32 bytesï¼‰ï¼Œæ¸›å°‘åœ°å€é•·åº¦ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">hashes</span><span class="p">::{</span><span class="n">sha256</span><span class="p">,</span> <span class="n">sha256d</span><span class="p">,</span> <span class="n">ripemd160</span><span class="p">,</span> <span class="n">hash160</span><span class="p">,</span> <span class="n">Hash</span><span class="p">};</span>

<span class="k">fn</span> <span class="nf">hash_examples</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="s">b"Hello, Bitcoin!"</span><span class="p">;</span>

    <span class="c1">// SHA256</span>
    <span class="k">let</span> <span class="n">sha256_hash</span> <span class="o">=</span> <span class="nn">sha256</span><span class="p">::</span><span class="nn">Hash</span><span class="p">::</span><span class="nf">hash</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

    <span class="c1">// Double SHA256ï¼ˆBitcoin æ¨™æº–ï¼‰</span>
    <span class="k">let</span> <span class="n">sha256d_hash</span> <span class="o">=</span> <span class="nn">sha256d</span><span class="p">::</span><span class="nn">Hash</span><span class="p">::</span><span class="nf">hash</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

    <span class="c1">// HASH160ï¼ˆç”¨æ–¼åœ°å€ç”Ÿæˆï¼‰</span>
    <span class="k">let</span> <span class="n">hash160_result</span> <span class="o">=</span> <span class="nn">hash160</span><span class="p">::</span><span class="nn">Hash</span><span class="p">::</span><span class="nf">hash</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="34-secp256k1-æ©¢åœ“æ›²ç·š">3.4 secp256k1 æ©¢åœ“æ›²ç·š</h3>

<p>Bitcoin ä½¿ç”¨ secp256k1 æ©¢åœ“æ›²ç·šé€²è¡Œå…¬é‘°å¯†ç¢¼å­¸ã€‚ç†è§£é€™å€‹æ›²ç·šçš„åŸºæœ¬æ¦‚å¿µå°æ–¼ Bitcoin é–‹ç™¼å¾ˆé‡è¦ã€‚</p>

<p>ç§é‘°æœ¬è³ªä¸Šæ˜¯ä¸€å€‹ 256 ä½çš„éš¨æ©Ÿæ•¸ã€‚é€™å€‹æ•¸å­—å¿…é ˆåœ¨ 1 åˆ°æ›²ç·šçš„éšï¼ˆä¸€å€‹éå¸¸å¤§çš„è³ªæ•¸ï¼‰ä¹‹é–“ã€‚ä»»ä½•åœ¨é€™å€‹ç¯„åœå…§çš„æ•¸å­—éƒ½æ˜¯æœ‰æ•ˆçš„ç§é‘°ã€‚</p>

<p>å…¬é‘°æ˜¯æ©¢åœ“æ›²ç·šä¸Šçš„ä¸€å€‹é»ï¼Œç”±ç§é‘°ä¹˜ä»¥æ›²ç·šçš„ç”Ÿæˆé» G å¾—åˆ°ï¼š<code class="language-plaintext highlighter-rouge">P = k * G</code>ï¼Œå…¶ä¸­ k æ˜¯ç§é‘°ï¼ŒP æ˜¯å…¬é‘°ã€‚é€™å€‹é‹ç®—æ˜¯å–®å‘çš„â€”â€”å¾å…¬é‘°ç„¡æ³•æ¨å°å‡ºç§é‘°ï¼ˆé€™å°±æ˜¯æ©¢åœ“æ›²ç·šé›¢æ•£å°æ•¸å•é¡Œï¼‰ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">secp256k1</span><span class="p">::{</span><span class="n">Secp256k1</span><span class="p">,</span> <span class="n">SecretKey</span><span class="p">,</span> <span class="n">PublicKey</span><span class="p">};</span>

<span class="k">fn</span> <span class="nf">key_generation</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// å‰µå»º secp256k1 ä¸Šä¸‹æ–‡</span>
    <span class="k">let</span> <span class="n">secp</span> <span class="o">=</span> <span class="nn">Secp256k1</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>

    <span class="c1">// ç”Ÿæˆéš¨æ©Ÿç§é‘°</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">rng</span> <span class="o">=</span> <span class="nn">rand</span><span class="p">::</span><span class="nf">thread_rng</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">secret_key</span> <span class="o">=</span> <span class="nn">SecretKey</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">rng</span><span class="p">);</span>

    <span class="c1">// å¾ç§é‘°å°å‡ºå…¬é‘°</span>
    <span class="k">let</span> <span class="n">public_key</span> <span class="o">=</span> <span class="nn">PublicKey</span><span class="p">::</span><span class="nf">from_secret_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">secret_key</span><span class="p">);</span>

    <span class="c1">// å…¬é‘°æœ‰å…©ç¨®åºåˆ—åŒ–æ ¼å¼</span>
    <span class="k">let</span> <span class="n">compressed</span> <span class="o">=</span> <span class="n">public_key</span><span class="nf">.serialize</span><span class="p">();</span>      <span class="c1">// 33 bytes</span>
    <span class="k">let</span> <span class="n">uncompressed</span> <span class="o">=</span> <span class="n">public_key</span><span class="nf">.serialize_uncompressed</span><span class="p">();</span>  <span class="c1">// 65 bytes</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å£“ç¸®å…¬é‘°åªåŒ…å« x åº§æ¨™å’Œä¸€å€‹è¡¨ç¤º y åº§æ¨™æ­£è² çš„ä½å…ƒï¼ˆå› ç‚ºçµ¦å®š xï¼Œy åªæœ‰å…©å€‹å¯èƒ½å€¼ï¼‰ã€‚æœªå£“ç¸®å…¬é‘°åŒ…å«å®Œæ•´çš„ x å’Œ y åº§æ¨™ã€‚ç¾ä»£ Bitcoin å¹¾ä¹ç¸½æ˜¯ä½¿ç”¨å£“ç¸®å…¬é‘°ï¼Œå› ç‚ºå®ƒæ›´çŸ­ä¸”åŒæ¨£å®‰å…¨ã€‚</p>

<hr />

<h2 id="4-ç·¨ç¢¼èˆ‡åºåˆ—åŒ–">4. ç·¨ç¢¼èˆ‡åºåˆ—åŒ–</h2>

<h3 id="41-åå…­é€²åˆ¶ç·¨ç¢¼">4.1 åå…­é€²åˆ¶ç·¨ç¢¼</h3>

<p>Bitcoin è³‡æ–™åœ¨é¡¯ç¤ºæ™‚å¹¾ä¹ç¸½æ˜¯ä½¿ç”¨åå…­é€²åˆ¶ï¼ˆhexï¼‰æ ¼å¼ã€‚é€™æ˜¯å› ç‚ºäºŒé€²ä½è³‡æ–™ä¸æ–¹ä¾¿é–±è®€æˆ–è¤‡è£½ï¼Œè€Œåå…­é€²åˆ¶æä¾›äº†ä¸€å€‹ç·Šæ¹Šçš„æ–‡å­—è¡¨ç¤ºã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">hex_examples</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="mi">0xde</span><span class="p">,</span> <span class="mi">0xad</span><span class="p">,</span> <span class="mi">0xbe</span><span class="p">,</span> <span class="mi">0xef</span><span class="p">];</span>

    <span class="c1">// ç·¨ç¢¼ç‚ºåå…­é€²åˆ¶å­—ä¸²</span>
    <span class="k">let</span> <span class="n">hex_string</span> <span class="o">=</span> <span class="nn">hex</span><span class="p">::</span><span class="nf">encode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>  <span class="c1">// "deadbeef"</span>

    <span class="c1">// å¾åå…­é€²åˆ¶è§£ç¢¼</span>
    <span class="k">let</span> <span class="n">decoded</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nn">hex</span><span class="p">::</span><span class="nf">decode</span><span class="p">(</span><span class="s">"deadbeef"</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="42-base58check-ç·¨ç¢¼">4.2 Base58Check ç·¨ç¢¼</h3>

<p>å‚³çµ±çš„ Bitcoin åœ°å€ä½¿ç”¨ Base58Check ç·¨ç¢¼ã€‚Base58 æ˜¯ Base64 çš„è®Šé«”ï¼Œç§»é™¤äº†å®¹æ˜“æ··æ·†çš„å­—å…ƒï¼ˆ0ã€Oã€Iã€lï¼‰ï¼Œé¿å…äººå·¥æŠ„å¯«æ™‚çš„éŒ¯èª¤ã€‚</p>

<p>Base58Check åœ¨ Base58 çš„åŸºç¤ä¸Šå¢åŠ äº†ç‰ˆæœ¬å‰ç¶´å’Œæ ¡é©—å’Œã€‚ç‰ˆæœ¬å‰ç¶´æŒ‡ç¤ºåœ°å€é¡å‹ï¼ˆP2PKHã€P2SH ç­‰ï¼‰å’Œç¶²è·¯ï¼ˆmainnetã€testnetï¼‰ã€‚æ ¡é©—å’Œæ˜¯è³‡æ–™çš„ double SHA256 çš„å‰ 4 bytesï¼Œç”¨æ–¼æª¢æ¸¬è¼¸å…¥éŒ¯èª¤ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">hashes</span><span class="p">::{</span><span class="n">sha256d</span><span class="p">,</span> <span class="n">Hash</span><span class="p">};</span>
<span class="k">use</span> <span class="n">bs58</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">base58check_encode</span><span class="p">(</span><span class="n">version</span><span class="p">:</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="nb">u8</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">data</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="n">version</span><span class="p">];</span>
    <span class="n">data</span><span class="nf">.extend_from_slice</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>

    <span class="c1">// è¨ˆç®—æ ¡é©—å’Œ</span>
    <span class="k">let</span> <span class="n">checksum</span> <span class="o">=</span> <span class="nn">sha256d</span><span class="p">::</span><span class="nn">Hash</span><span class="p">::</span><span class="nf">hash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
    <span class="n">data</span><span class="nf">.extend_from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">checksum</span><span class="p">[</span><span class="o">..</span><span class="mi">4</span><span class="p">]);</span>

    <span class="nn">bs58</span><span class="p">::</span><span class="nf">encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="nf">.into_string</span><span class="p">()</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç‰ˆæœ¬ä½å…ƒçµ„æ±ºå®šäº†åœ°å€çš„å‰ç¶´ï¼šmainnet P2PKH åœ°å€ä»¥ â€˜1â€™ é–‹é ­ï¼ˆç‰ˆæœ¬ 0x00ï¼‰ï¼ŒP2SH åœ°å€ä»¥ â€˜3â€™ é–‹é ­ï¼ˆç‰ˆæœ¬ 0x05ï¼‰ã€‚</p>

<h3 id="43-bech32-ç·¨ç¢¼">4.3 Bech32 ç·¨ç¢¼</h3>

<p>SegWit å¼•å…¥äº†æ–°çš„åœ°å€æ ¼å¼ Bech32ï¼ˆBIP 173ï¼‰ï¼ŒTaproot å‰‡ä½¿ç”¨æ”¹é€²ç‰ˆçš„ Bech32mï¼ˆBIP 350ï¼‰ã€‚é€™äº›æ ¼å¼æœ‰å¹¾å€‹å„ªé»ï¼š</p>

<p>é¦–å…ˆï¼Œå®ƒå€‘åªä½¿ç”¨å°å¯«å­—æ¯å’Œæ•¸å­—ï¼Œé¿å…äº†å¤§å°å¯«æ··æ·†ã€‚å…¶æ¬¡ï¼ŒéŒ¯èª¤æª¢æ¸¬èƒ½åŠ›æ›´å¼·ï¼Œå¯ä»¥æª¢æ¸¬åˆ°æ›´å¤šé¡å‹çš„è¼¸å…¥éŒ¯èª¤ã€‚ç¬¬ä¸‰ï¼Œå®ƒå€‘è‡ªå¸¶äººé¡å¯è®€çš„å‰ç¶´ï¼ˆHRPï¼‰ï¼Œä½¿ç¶²è·¯è­˜åˆ¥æ›´å®¹æ˜“â€”â€”mainnet åœ°å€ä»¥ â€œbc1â€ é–‹é ­ï¼Œtestnet ä»¥ â€œtb1â€ é–‹é ­ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="n">Address</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">bech32_address_info</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// bc1q... æ˜¯ SegWit v0 åœ°å€ï¼ˆP2WPKH æˆ– P2WSHï¼‰</span>
    <span class="c1">// bc1p... æ˜¯ SegWit v1 åœ°å€ï¼ˆP2TRï¼ŒTaprootï¼‰</span>

    <span class="c1">// Bech32 ç”¨æ–¼ v0ï¼ŒBech32m ç”¨æ–¼ v1+</span>
    <span class="c1">// é€™å€‹æ”¹è®Šä¿®å¾©äº† Bech32 çš„ä¸€å€‹æ¥µç«¯æƒ…æ³å•é¡Œ</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="44-bitcoin-å…±è­˜ç·¨ç¢¼">4.4 Bitcoin å…±è­˜ç·¨ç¢¼</h3>

<p>Bitcoin å”è­°ä½¿ç”¨ç‰¹å®šçš„äºŒé€²ä½ç·¨ç¢¼æ ¼å¼ï¼Œç¨±ç‚ºã€Œå…±è­˜ç·¨ç¢¼ã€ã€‚ç†è§£é€™å€‹æ ¼å¼å°æ–¼è§£æå’Œå‰µå»ºåŸå§‹äº¤æ˜“å¾ˆé‡è¦ã€‚</p>

<p>Bitcoin ä½¿ç”¨å°ç«¯åºï¼ˆLittle Endianï¼‰ä¾†ç·¨ç¢¼å¤šä½å…ƒçµ„æ•´æ•¸ã€‚é€™èˆ‡ç¶²è·¯å”è­°å¸¸ç”¨çš„å¤§ç«¯åºä¸åŒã€‚</p>

<p>è®Šé•·æ•´æ•¸ï¼ˆVarIntï¼‰æ˜¯ä¸€ç¨®ç©ºé–“å„ªåŒ–çš„ç·¨ç¢¼æ–¹å¼ã€‚å°æ–¼ 253 çš„æ•¸å­—åªç”¨ 1 byteï¼Œè¼ƒå¤§çš„æ•¸å­—å‰‡æ ¹æ“šå¤§å°ä½¿ç”¨ 3ã€5 æˆ– 9 bytesã€‚é€™ç¨®ç·¨ç¢¼åœ¨äº¤æ˜“ä¸­å¤§é‡ä½¿ç”¨ï¼ˆä¾‹å¦‚è¡¨ç¤ºè¼¸å…¥/è¼¸å‡ºæ•¸é‡ï¼‰ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">encode_varint</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">u64</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">u8</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0xFD</span> <span class="p">{</span>
        <span class="nd">vec!</span><span class="p">[</span><span class="n">n</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">]</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0xFFFF</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">v</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="mi">0xFD</span><span class="p">];</span>
        <span class="n">v</span><span class="nf">.extend</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">n</span> <span class="k">as</span> <span class="nb">u16</span><span class="p">)</span><span class="nf">.to_le_bytes</span><span class="p">());</span>
        <span class="n">v</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0xFFFFFFFF</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">v</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="mi">0xFE</span><span class="p">];</span>
        <span class="n">v</span><span class="nf">.extend</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">n</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">)</span><span class="nf">.to_le_bytes</span><span class="p">());</span>
        <span class="n">v</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">v</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="mi">0xFF</span><span class="p">];</span>
        <span class="n">v</span><span class="nf">.extend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="nf">.to_le_bytes</span><span class="p">());</span>
        <span class="n">v</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h2 id="5-éŒ¯èª¤è™•ç†">5. éŒ¯èª¤è™•ç†</h2>

<h3 id="51-rust-çš„éŒ¯èª¤è™•ç†å“²å­¸">5.1 Rust çš„éŒ¯èª¤è™•ç†å“²å­¸</h3>

<p>Rust çš„éŒ¯èª¤è™•ç†èˆ‡è¨±å¤šèªè¨€ä¸åŒã€‚å®ƒä¸ä½¿ç”¨ä¾‹å¤–ï¼ˆexceptionsï¼‰ï¼Œè€Œæ˜¯é€éé¡å‹ç³»çµ±æ˜ç¢ºè¡¨ç¤ºå¯èƒ½å¤±æ•—çš„æ“ä½œã€‚é€™è¿«ä½¿ç¨‹å¼è¨­è¨ˆå¸«åœ¨ç·¨è­¯æ™‚å°±è€ƒæ…®éŒ¯èª¤æƒ…æ³ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">Result&lt;T, E&gt;</code> é¡å‹è¡¨ç¤ºä¸€å€‹å¯èƒ½æˆåŠŸï¼ˆè¿”å› <code class="language-plaintext highlighter-rouge">T</code>ï¼‰æˆ–å¤±æ•—ï¼ˆè¿”å› <code class="language-plaintext highlighter-rouge">E</code>ï¼‰çš„æ“ä½œã€‚<code class="language-plaintext highlighter-rouge">Option&lt;T&gt;</code> å‰‡è¡¨ç¤ºä¸€å€‹å¯èƒ½å­˜åœ¨ï¼ˆ<code class="language-plaintext highlighter-rouge">Some(T)</code>ï¼‰æˆ–ä¸å­˜åœ¨ï¼ˆ<code class="language-plaintext highlighter-rouge">None</code>ï¼‰çš„å€¼ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">anyhow</span><span class="p">::{</span><span class="n">Context</span><span class="p">,</span> <span class="nb">Result</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">thiserror</span><span class="p">::</span><span class="n">Error</span><span class="p">;</span>

<span class="c1">// ä½¿ç”¨ thiserror å®šç¾©è‡ªè¨‚éŒ¯èª¤é¡å‹</span>
<span class="nd">#[derive(Error,</span> <span class="nd">Debug)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">BitcoinError</span> <span class="p">{</span>
    <span class="nd">#[error(</span><span class="s">"ç„¡æ•ˆçš„ç§é‘°: {0}"</span><span class="nd">)]</span>
    <span class="nf">InvalidPrivateKey</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span>

    <span class="nd">#[error(</span><span class="s">"é‡‘é¡ä¸è¶³: éœ€è¦ {required} sat, åªæœ‰ {available} sat"</span><span class="nd">)]</span>
    <span class="n">InsufficientFunds</span> <span class="p">{</span> <span class="n">required</span><span class="p">:</span> <span class="nb">u64</span><span class="p">,</span> <span class="n">available</span><span class="p">:</span> <span class="nb">u64</span> <span class="p">},</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">thiserror</code> åº«å¹«åŠ©ä½ å®šç¾©çµæ§‹åŒ–çš„éŒ¯èª¤é¡å‹ï¼Œé©åˆå‡½å¼åº«ä½¿ç”¨ã€‚<code class="language-plaintext highlighter-rouge">anyhow</code> å‰‡æä¾›äº†ä¸€å€‹é€šç”¨çš„éŒ¯èª¤é¡å‹ï¼Œé©åˆæ‡‰ç”¨ç¨‹å¼â€”â€”å®ƒå¯ä»¥åŒ…è£ä»»ä½•éŒ¯èª¤ä¸¦é™„åŠ ä¸Šä¸‹æ–‡è³‡è¨Šã€‚</p>

<h3 id="52-å¯¦ç”¨çš„éŒ¯èª¤è™•ç†æ¨¡å¼">5.2 å¯¦ç”¨çš„éŒ¯èª¤è™•ç†æ¨¡å¼</h3>

<p>åœ¨ Bitcoin é–‹ç™¼ä¸­ï¼ŒéŒ¯èª¤è™•ç†ç‰¹åˆ¥é‡è¦ã€‚ä¸€å€‹å¸¸è¦‹çš„æ¨¡å¼æ˜¯ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">?</code> é‹ç®—ç¬¦å‚³æ’­éŒ¯èª¤ï¼Œä¸¦ç”¨ <code class="language-plaintext highlighter-rouge">context()</code> æ·»åŠ æœ‰æ„ç¾©çš„éŒ¯èª¤è¨Šæ¯ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">process_transaction</span><span class="p">(</span><span class="n">tx_hex</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">tx_bytes</span> <span class="o">=</span> <span class="nn">hex</span><span class="p">::</span><span class="nf">decode</span><span class="p">(</span><span class="n">tx_hex</span><span class="p">)</span>
        <span class="nf">.context</span><span class="p">(</span><span class="s">"ç„¡æ³•è§£æäº¤æ˜“åå…­é€²åˆ¶"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="k">let</span> <span class="n">tx</span><span class="p">:</span> <span class="n">Transaction</span> <span class="o">=</span> <span class="nn">consensus</span><span class="p">::</span><span class="nf">deserialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_bytes</span><span class="p">)</span>
        <span class="nf">.context</span><span class="p">(</span><span class="s">"ç„¡æ•ˆçš„äº¤æ˜“æ ¼å¼"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// è™•ç†äº¤æ˜“...</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç•¶é€™å€‹å‡½æ•¸å¤±æ•—æ™‚ï¼ŒéŒ¯èª¤è¨Šæ¯æœƒåŒ…å«å®Œæ•´çš„ä¸Šä¸‹æ–‡éˆï¼Œå¹«åŠ©è¨ºæ–·å•é¡Œï¼šã€Œç„¡æ³•è§£æäº¤æ˜“åå…­é€²åˆ¶: invalid character â€˜gâ€™ at position 10ã€ã€‚</p>

<hr />

<h2 id="6-ç¬¬ä¸€å€‹ç¨‹å¼ç”Ÿæˆåœ°å€">6. ç¬¬ä¸€å€‹ç¨‹å¼ï¼šç”Ÿæˆåœ°å€</h2>

<h3 id="61-å¾éš¨æ©Ÿæ•¸ç”Ÿæˆåœ°å€">6.1 å¾éš¨æ©Ÿæ•¸ç”Ÿæˆåœ°å€</h3>

<p>ç¾åœ¨è®“æˆ‘å€‘æŠŠæ‰€æœ‰æ¦‚å¿µçµåˆèµ·ä¾†ï¼Œå¯«ä¸€å€‹å®Œæ•´çš„åœ°å€ç”Ÿæˆç¨‹å¼ã€‚é€™å€‹ç¨‹å¼å±•ç¤ºäº†å¾éš¨æ©Ÿç§é‘°åˆ° Bitcoin åœ°å€çš„å®Œæ•´æµç¨‹ï¼š</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::{</span>
    <span class="n">Network</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="n">PublicKey</span><span class="p">,</span> <span class="n">PrivateKey</span><span class="p">,</span>
    <span class="nn">secp256k1</span><span class="p">::</span><span class="n">Secp256k1</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span> <span class="nn">rand</span><span class="p">::</span><span class="n">thread_rng</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">generate_random_address</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">secp</span> <span class="o">=</span> <span class="nn">Secp256k1</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">rng</span> <span class="o">=</span> <span class="nf">thread_rng</span><span class="p">();</span>

    <span class="c1">// ç”Ÿæˆéš¨æ©Ÿç§é‘°</span>
    <span class="k">let</span> <span class="n">secret_key</span> <span class="o">=</span> <span class="nn">secp256k1</span><span class="p">::</span><span class="nn">SecretKey</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">rng</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">private_key</span> <span class="o">=</span> <span class="nn">PrivateKey</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">secret_key</span><span class="p">,</span> <span class="nn">Network</span><span class="p">::</span><span class="n">Bitcoin</span><span class="p">);</span>

    <span class="c1">// å°å‡ºå…¬é‘°</span>
    <span class="k">let</span> <span class="n">public_key</span> <span class="o">=</span> <span class="n">private_key</span><span class="nf">.public_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">);</span>

    <span class="c1">// ç”Ÿæˆä¸åŒé¡å‹çš„åœ°å€</span>
    <span class="k">let</span> <span class="n">p2pkh</span> <span class="o">=</span> <span class="nn">Address</span><span class="p">::</span><span class="nf">p2pkh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">public_key</span><span class="p">,</span> <span class="nn">Network</span><span class="p">::</span><span class="n">Bitcoin</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">p2wpkh</span> <span class="o">=</span> <span class="nn">Address</span><span class="p">::</span><span class="nf">p2wpkh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">public_key</span><span class="p">,</span> <span class="nn">Network</span><span class="p">::</span><span class="n">Bitcoin</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">p2shwpkh</span> <span class="o">=</span> <span class="nn">Address</span><span class="p">::</span><span class="nf">p2shwpkh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">public_key</span><span class="p">,</span> <span class="nn">Network</span><span class="p">::</span><span class="n">Bitcoin</span><span class="p">);</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"ç§é‘° (WIF): {}"</span><span class="p">,</span> <span class="n">private_key</span><span class="nf">.to_wif</span><span class="p">());</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"P2PKH åœ°å€:    {}"</span><span class="p">,</span> <span class="n">p2pkh</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"P2WPKH åœ°å€:   {}"</span><span class="p">,</span> <span class="n">p2wpkh</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"P2SH-P2WPKH:   {}"</span><span class="p">,</span> <span class="n">p2shwpkh</span><span class="p">);</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€™è£¡å±•ç¤ºäº†ä¸‰ç¨®åœ°å€é¡å‹ï¼š</p>

<p><strong>P2PKHï¼ˆPay-to-Public-Key-Hashï¼‰</strong>æ˜¯æœ€å‚³çµ±çš„åœ°å€é¡å‹ï¼Œä»¥ â€˜1â€™ é–‹é ­ã€‚å®ƒç›´æ¥é–å®šåˆ°å…¬é‘°çš„é›œæ¹Šå€¼ã€‚</p>

<p><strong>P2WPKHï¼ˆPay-to-Witness-Public-Key-Hashï¼‰</strong>æ˜¯åŸç”Ÿ SegWit åœ°å€ï¼Œä»¥ â€˜bc1qâ€™ é–‹é ­ã€‚å®ƒæä¾›è¼ƒä½çš„äº¤æ˜“è²»ç”¨å’Œæ›´å¥½çš„å®‰å…¨æ€§ã€‚</p>

<p><strong>P2SH-P2WPKH</strong> æ˜¯åŒ…è£åœ¨ P2SH ä¸­çš„ SegWitï¼Œä»¥ â€˜3â€™ é–‹é ­ã€‚å®ƒæä¾›äº†èˆ‡èˆŠéŒ¢åŒ…çš„å…¼å®¹æ€§ã€‚</p>

<h3 id="62-å¾åŠ©è¨˜è©ç”Ÿæˆåœ°å€">6.2 å¾åŠ©è¨˜è©ç”Ÿæˆåœ°å€</h3>

<p>åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæˆ‘å€‘é€šå¸¸ä¸æœƒç›´æ¥ç”Ÿæˆéš¨æ©Ÿç§é‘°ï¼Œè€Œæ˜¯ä½¿ç”¨åŠ©è¨˜è©ï¼ˆBIP39ï¼‰å’Œåˆ†å±¤ç¢ºå®šæ€§æ´¾ç”Ÿï¼ˆBIP32ï¼‰ã€‚é€™ç¨®æ–¹æ³•æœ‰å¹¾å€‹å„ªé»ï¼šç”¨æˆ¶åªéœ€å‚™ä»½ä¸€çµ„åŠ©è¨˜è©å°±èƒ½æ¢å¾©æ‰€æœ‰åœ°å€ï¼›å¾åŒä¸€å€‹ç¨®å­å¯ä»¥æ´¾ç”Ÿå‡ºç„¡é™å¤šå€‹åœ°å€ï¼›ä¸åŒçš„æ´¾ç”Ÿè·¯å¾‘å¯ä»¥ç”¨æ–¼ä¸åŒç›®çš„ã€‚</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">bip39</span><span class="p">::{</span><span class="n">Mnemonic</span><span class="p">,</span> <span class="n">Language</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">bitcoin</span><span class="p">::</span><span class="nn">bip32</span><span class="p">::{</span><span class="n">Xpriv</span><span class="p">,</span> <span class="n">Xpub</span><span class="p">,</span> <span class="n">DerivationPath</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">str</span><span class="p">::</span><span class="n">FromStr</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">generate_from_mnemonic</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">secp</span> <span class="o">=</span> <span class="nn">Secp256k1</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>

    <span class="c1">// ç”Ÿæˆ 12 å­—åŠ©è¨˜è©</span>
    <span class="k">let</span> <span class="n">mnemonic</span> <span class="o">=</span> <span class="nn">Mnemonic</span><span class="p">::</span><span class="nf">generate_in</span><span class="p">(</span><span class="nn">Language</span><span class="p">::</span><span class="n">English</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"åŠ©è¨˜è©: {}"</span><span class="p">,</span> <span class="n">mnemonic</span><span class="p">);</span>

    <span class="c1">// å¾åŠ©è¨˜è©ç”Ÿæˆç¨®å­ï¼ˆå¯é¸çš„å¯†ç¢¼çŸ­èªï¼‰</span>
    <span class="k">let</span> <span class="n">seed</span> <span class="o">=</span> <span class="n">mnemonic</span><span class="nf">.to_seed</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>

    <span class="c1">// ç”Ÿæˆä¸»ç§é‘°</span>
    <span class="k">let</span> <span class="n">master_xpriv</span> <span class="o">=</span> <span class="nn">Xpriv</span><span class="p">::</span><span class="nf">new_master</span><span class="p">(</span><span class="nn">Network</span><span class="p">::</span><span class="n">Bitcoin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seed</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="c1">// ä½¿ç”¨ BIP84 è·¯å¾‘æ´¾ç”ŸåŸç”Ÿ SegWit åœ°å€</span>
    <span class="c1">// m/84'/0'/0'/0/0</span>
    <span class="k">let</span> <span class="n">path</span> <span class="o">=</span> <span class="nn">DerivationPath</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="s">"m/84'/0'/0'/0/0"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">derived_xpriv</span> <span class="o">=</span> <span class="n">master_xpriv</span><span class="nf">.derive_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">derived_xpub</span> <span class="o">=</span> <span class="nn">Xpub</span><span class="p">::</span><span class="nf">from_priv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">secp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">derived_xpriv</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">public_key</span> <span class="o">=</span> <span class="nn">PublicKey</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">derived_xpub</span><span class="py">.public_key</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="nn">Address</span><span class="p">::</span><span class="nf">p2wpkh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">public_key</span><span class="p">,</span> <span class="nn">Network</span><span class="p">::</span><span class="n">Bitcoin</span><span class="p">);</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"æ´¾ç”Ÿåœ°å€: {}"</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ´¾ç”Ÿè·¯å¾‘ <code class="language-plaintext highlighter-rouge">m/84'/0'/0'/0/0</code> éµå¾ª BIP84 æ¨™æº–ï¼š</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">84'</code> è¡¨ç¤ºé€™æ˜¯ BIP84ï¼ˆåŸç”Ÿ SegWitï¼‰è·¯å¾‘</li>
  <li>ç¬¬ä¸€å€‹ <code class="language-plaintext highlighter-rouge">0'</code> æ˜¯ coin typeï¼ˆBitcoinï¼‰</li>
  <li>ç¬¬äºŒå€‹ <code class="language-plaintext highlighter-rouge">0'</code> æ˜¯å¸³æˆ¶ç´¢å¼•</li>
  <li><code class="language-plaintext highlighter-rouge">0</code> æ˜¯å¤–éƒ¨éˆï¼ˆæ¥æ”¶åœ°å€ï¼Œvs 1 æ˜¯æ‰¾é›¶åœ°å€ï¼‰</li>
  <li>æœ€å¾Œçš„ <code class="language-plaintext highlighter-rouge">0</code> æ˜¯åœ°å€ç´¢å¼•</li>
</ul>

<p>æ’‡è™Ÿï¼ˆâ€™ï¼‰è¡¨ç¤ºã€Œç¡¬åŒ–ã€æ´¾ç”Ÿï¼Œé€™ç¨®æ´¾ç”Ÿæ–¹å¼å³ä½¿å…¬é–‹äº†å­å…¬é‘°ï¼Œä¹Ÿç„¡æ³•æ¨å°å‡ºçˆ¶ç§é‘°ã€‚</p>

<hr />

<h2 id="7-ç·´ç¿’é¡Œ">7. ç·´ç¿’é¡Œ</h2>

<h3 id="ç·´ç¿’-1æ‰¹é‡åœ°å€ç”Ÿæˆå™¨">ç·´ç¿’ 1ï¼šæ‰¹é‡åœ°å€ç”Ÿæˆå™¨</h3>

<p>å‰µå»ºä¸€å€‹ç¨‹å¼ï¼Œå¾åŒä¸€å€‹åŠ©è¨˜è©æ‰¹é‡ç”Ÿæˆ 10 å€‹åœ°å€ã€‚ä½¿ç”¨ BIP84 æ´¾ç”Ÿè·¯å¾‘ï¼ˆm/84â€™/0â€™/0â€™/0/iï¼‰ï¼Œå…¶ä¸­ i å¾ 0 åˆ° 9ã€‚é€™å€‹ç·´ç¿’å¹«åŠ©ä½ ç†è§£ HD éŒ¢åŒ…çš„å·¥ä½œåŸç†ã€‚</p>

<h3 id="ç·´ç¿’-2åœ°å€é©—è­‰å™¨">ç·´ç¿’ 2ï¼šåœ°å€é©—è­‰å™¨</h3>

<p>å‰µå»ºä¸€å€‹å‡½æ•¸ï¼Œæ¥å—ä¸€å€‹å­—ä¸²ä¸¦é©—è­‰å®ƒæ˜¯å¦æ˜¯æœ‰æ•ˆçš„ Bitcoin åœ°å€ã€‚ä½ çš„å‡½æ•¸æ‡‰è©²ï¼š</p>
<ul>
  <li>è­˜åˆ¥åœ°å€é¡å‹ï¼ˆP2PKHã€P2SHã€P2WPKHã€P2WSHã€P2TRï¼‰</li>
  <li>é©—è­‰æ ¡é©—å’Œï¼ˆå°æ–¼ Base58 å’Œ Bech32ï¼‰</li>
  <li>åˆ¤æ–·ç¶²è·¯ï¼ˆmainnet vs testnetï¼‰</li>
</ul>

<h3 id="ç·´ç¿’-3å“ˆå¸Œè¨ˆç®—å™¨">ç·´ç¿’ 3ï¼šå“ˆå¸Œè¨ˆç®—å™¨</h3>

<p>å‰µå»ºä¸€å€‹å‘½ä»¤åˆ—å·¥å…·ï¼Œè¨ˆç®—è¼¸å…¥çš„å„ç¨® Bitcoin ç›¸é—œé›œæ¹Šå€¼ã€‚æ”¯æ´ SHA256ã€SHA256dã€RIPEMD160 å’Œ HASH160ï¼Œä¸¦èƒ½è™•ç†åå…­é€²åˆ¶å’Œ UTF-8 è¼¸å…¥ã€‚</p>

<hr />

<h2 id="8-ç¸½çµ">8. ç¸½çµ</h2>

<p>æœ¬ç¯‡ä»‹ç´¹äº†ä½¿ç”¨ Rust é€²è¡Œ Bitcoin é–‹ç™¼çš„åŸºç¤çŸ¥è­˜ã€‚æˆ‘å€‘è¨è«–äº†ç‚ºä»€éº¼ Rust æ˜¯ Bitcoin é–‹ç™¼çš„ç†æƒ³é¸æ“‡â€”â€”å®ƒçš„è¨˜æ†¶é«”å®‰å…¨ã€æ•ˆèƒ½å’Œè±å¯Œçš„ç”Ÿæ…‹ç³»çµ±ã€‚æˆ‘å€‘è¨­ç½®äº†é–‹ç™¼ç’°å¢ƒï¼Œäº†è§£äº† rust-bitcoin å‡½å¼åº«çš„åŸºæœ¬é¡å‹ï¼Œå­¸ç¿’äº† Bitcoin ä½¿ç”¨çš„å„ç¨®ç·¨ç¢¼æ ¼å¼ï¼Œä¸¦å¯«å‡ºäº†ç¬¬ä¸€å€‹åœ°å€ç”Ÿæˆç¨‹å¼ã€‚</p>

<p>é—œéµè¦é»ï¼š</p>
<ul>
  <li>Bitcoin å…§éƒ¨ä½¿ç”¨ satoshi ä½œç‚ºé‡‘é¡å–®ä½</li>
  <li>secp256k1 æ©¢åœ“æ›²ç·šæ˜¯ Bitcoin å¯†ç¢¼å­¸çš„åŸºç¤</li>
  <li>ä¸åŒçš„åœ°å€é¡å‹æœ‰ä¸åŒçš„ç”¨é€”å’Œç‰¹æ€§</li>
  <li>HD éŒ¢åŒ…è®“ä¸€çµ„åŠ©è¨˜è©å¯ä»¥æ´¾ç”Ÿå‡ºç„¡é™åœ°å€</li>
</ul>

<p>ä¸‹ä¸€ç¯‡å°‡æ·±å…¥æ¢è¨åœ°å€ç”Ÿæˆçš„ç´°ç¯€å’Œäº¤æ˜“æ§‹å»ºçš„åŸºç¤ã€‚æˆ‘å€‘å°‡å­¸ç¿’å¦‚ä½•å‰µå»ºã€ç°½åå’Œå»£æ’­çœŸæ­£çš„ Bitcoin äº¤æ˜“ã€‚</p>

<hr />

<h2 id="åƒè€ƒè³‡æº">åƒè€ƒè³‡æº</h2>

<h3 id="å®˜æ–¹æ–‡æª”">å®˜æ–¹æ–‡æª”</h3>
<ul>
  <li><a href="https://docs.rs/bitcoin">rust-bitcoin æ–‡æª”</a></li>
  <li><a href="https://docs.rs/secp256k1">secp256k1 æ–‡æª”</a></li>
  <li><a href="https://docs.rs/bdk">BDK æ–‡æª”</a></li>
</ul>

<h3 id="å­¸ç¿’è³‡æº">å­¸ç¿’è³‡æº</h3>
<ul>
  <li><a href="https://doc.rust-lang.org/book/">Rust ç¨‹å¼è¨­è¨ˆèªè¨€</a></li>
  <li><a href="https://github.com/rust-bitcoin/rust-bitcoin">rust-bitcoin GitHub</a></li>
</ul>

<h3 id="bips">BIPs</h3>
<ul>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki">BIP 32: HD Wallets</a></li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki">BIP 39: Mnemonic Code</a></li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0084.mediawiki">BIP 84: Native SegWit</a></li>
</ul>]]></content><author><name>Cypherpunks Taiwan</name></author><category term="æŠ€è¡“æ•™å­¸" /><category term="Bitcoin" /><category term="Rust" /><category term="Rust" /><category term="Bitcoin" /><category term="rust-bitcoin" /><category term="é–‹ç™¼ç’°å¢ƒ" /><category term="å¯†ç¢¼å­¸" /><summary type="html"><![CDATA[é€™æ˜¯ Rust Bitcoin é–‹ç™¼å…¥é–€ç³»åˆ—çš„ç¬¬ä¸€ç¯‡ã€‚æœ¬ç³»åˆ—å°‡å¸¶ä½ å¾é›¶é–‹å§‹ä½¿ç”¨ Rust èªè¨€é–‹ç™¼ Bitcoin æ‡‰ç”¨ï¼Œå¾åŸºç¤è¨­ç½®åˆ°é€²éšæ‡‰ç”¨ã€‚]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" /><media:content medium="image" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Bitcoin Script å¯¦æˆ°æ•™å­¸ï¼ˆå…­ï¼‰ï¼šé€²éšæ‡‰ç”¨èˆ‡æœªä¾†å±•æœ›</title><link href="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/development/2025/03/20/bitcoin-script-tutorial-6-advanced-applications/" rel="alternate" type="text/html" title="Bitcoin Script å¯¦æˆ°æ•™å­¸ï¼ˆå…­ï¼‰ï¼šé€²éšæ‡‰ç”¨èˆ‡æœªä¾†å±•æœ›" /><published>2025-03-20T00:00:00+00:00</published><updated>2025-03-20T00:00:00+00:00</updated><id>https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/development/2025/03/20/bitcoin-script-tutorial-6-advanced-applications</id><content type="html" xml:base="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/development/2025/03/20/bitcoin-script-tutorial-6-advanced-applications/"><![CDATA[<h2 id="ç³»åˆ—å°è¨€">ç³»åˆ—å°è¨€</h2>

<p>é€™æ˜¯ã€ŒBitcoin Script å¯¦æˆ°æ•™å­¸ã€ç³»åˆ—çš„æœ€å¾Œä¸€ç¯‡ã€‚ç¶“éå‰äº”ç¯‡çš„å­¸ç¿’ï¼Œä½ å·²ç¶“æŒæ¡äº†æ¯”ç‰¹å¹£è…³æœ¬çš„åŸºç¤çŸ¥è­˜ã€å„ç¨®æ¨™æº–è…³æœ¬é¡å‹ã€SegWit å’Œ Taproot çš„æŠ€è¡“ç´°ç¯€ã€å¤šé‡ç°½åå¯¦ç¾ï¼Œä»¥åŠæ™‚é–“é–æ©Ÿåˆ¶ã€‚åœ¨é€™ä¸€ç¯‡ä¸­ï¼Œæˆ‘å€‘å°‡æ¢ç´¢æ¯”ç‰¹å¹£è…³æœ¬çš„å‰æ²¿æ‡‰ç”¨ï¼ŒåŒ…æ‹¬ DLCï¼ˆDiscreet Log Contractsï¼‰ã€Vault è¨­è¨ˆæ¨¡å¼ã€Covenant ææ¡ˆï¼Œä»¥åŠæœªä¾†å¯èƒ½çš„ç™¼å±•æ–¹å‘ã€‚</p>

<p><strong>ç³»åˆ—æ–‡ç« ï¼š</strong></p>
<ol>
  <li><a href="/bitcoin/development/2025/03/15/bitcoin-script-tutorial-1-fundamentals/">åŸºç¤æ¦‚å¿µèˆ‡æ“ä½œç¢¼</a></li>
  <li><a href="/bitcoin/development/2025/03/16/bitcoin-script-tutorial-2-standard-scripts/">æ¨™æº–è…³æœ¬é¡å‹è©³è§£</a></li>
  <li><a href="/bitcoin/development/2025/03/17/bitcoin-script-tutorial-3-segwit-taproot/">SegWit èˆ‡ Taproot</a></li>
  <li><a href="/bitcoin/development/2025/03/18/bitcoin-script-tutorial-4-multisig/">å¤šé‡ç°½åå®Œå…¨æŒ‡å—</a></li>
  <li><a href="/bitcoin/development/2025/03/19/bitcoin-script-tutorial-5-timelocks/">æ™‚é–“é–æ©Ÿåˆ¶å®Œå…¨æŒ‡å—</a></li>
  <li><strong>é€²éšæ‡‰ç”¨èˆ‡æœªä¾†å±•æœ›</strong>ï¼ˆæœ¬ç¯‡ï¼‰</li>
</ol>

<hr />

<h2 id="ä¸€discreet-log-contractsdlc">ä¸€ã€Discreet Log Contractsï¼ˆDLCï¼‰</h2>

<h3 id="11-ä»€éº¼æ˜¯-dlc">1.1 ä»€éº¼æ˜¯ DLCï¼Ÿ</h3>

<p>DLCï¼ˆè¬¹æ…æ—¥èªŒåˆç´„ï¼‰æ˜¯ä¸€ç¨®å‰µæ–°çš„æ¯”ç‰¹å¹£æ™ºèƒ½åˆç´„å½¢å¼ï¼Œå…è¨±å…©æ–¹åŸºæ–¼ç¾å¯¦ä¸–ç•Œçš„äº‹ä»¶çµæœé€²è¡Œæ¢ä»¶æ”¯ä»˜ã€‚å®ƒç”± Tadge Dryjaï¼ˆé–ƒé›»ç¶²è·¯çš„å…±åŒç™¼æ˜è€…ï¼‰åœ¨ 2018 å¹´æå‡ºï¼Œè§£æ±ºäº†ä¸€å€‹é•·æœŸå­˜åœ¨çš„å•é¡Œï¼šå¦‚ä½•åœ¨ä¸ä¿¡ä»»ä»»ä½•ä¸­å¿ƒåŒ–å¯¦é«”çš„æƒ…æ³ä¸‹ï¼Œåœ¨æ¯”ç‰¹å¹£ä¸ŠåŸ·è¡Œä¾è³´å¤–éƒ¨æ•¸æ“šçš„åˆç´„ã€‚</p>

<p>è€ƒæ…®é€™æ¨£çš„å ´æ™¯ï¼šAlice å’Œ Bob æƒ³è¦å° 2025 å¹´åº•æ¯”ç‰¹å¹£çš„åƒ¹æ ¼é€²è¡Œè³­æ³¨ã€‚Alice è³­åƒ¹æ ¼æœƒè¶…é 10 è¬ç¾å…ƒï¼ŒBob è³­ä¸æœƒã€‚åœ¨å‚³çµ±ç³»çµ±ä¸­ï¼Œä»–å€‘éœ€è¦ä¸€å€‹å¯ä¿¡çš„ç¬¬ä¸‰æ–¹ä¾†åˆ¤å®šçµæœä¸¦åŸ·è¡Œæ”¯ä»˜ã€‚DLC å‰‡å…è¨±ä»–å€‘å‰µå»ºä¸€å€‹åˆç´„ï¼Œç”±ä¸€å€‹ç¨ç«‹çš„ã€Œç¥è«­ã€ï¼ˆOracleï¼‰ä¾†è­‰æ˜çµæœï¼Œä½†é€™å€‹ç¥è«­ç”šè‡³ä¸éœ€è¦çŸ¥é“åˆç´„çš„å­˜åœ¨ã€‚</p>

<p>é€™è£¡çš„ã€Œè¬¹æ…ã€ï¼ˆDiscreetï¼‰æœ‰é›™é‡å«ç¾©ã€‚é¦–å…ˆï¼Œç¥è«­ç™¼å¸ƒçš„æ˜¯é€šç”¨æ•¸æ“šï¼ˆå¦‚ã€Œ2025-12-31 BTC/USD = 102,345ã€ï¼‰ï¼Œè€Œä¸æ˜¯é‡å°ç‰¹å®šåˆç´„çš„è£æ±ºï¼Œé€™æ„å‘³è‘—ç¥è«­ä¸çŸ¥é“èª°åœ¨ä½¿ç”¨å®ƒçš„æ•¸æ“šã€‚å…¶æ¬¡ï¼ŒDLC äº¤æ˜“åœ¨éˆä¸Šçœ‹èµ·ä¾†å°±åƒæ™®é€šçš„å¤šç°½åäº¤æ˜“ï¼Œè§€å¯Ÿè€…ç„¡æ³•åˆ¤æ–·é€™æ˜¯ä¸€å€‹ DLC çµç®—ã€‚</p>

<h3 id="12-adaptor-signaturesdlc-çš„å¯†ç¢¼å­¸åŸºç¤">1.2 Adaptor Signaturesï¼šDLC çš„å¯†ç¢¼å­¸åŸºç¤</h3>

<p>DLC çš„æ ¸å¿ƒæŠ€è¡“æ˜¯ Adaptor Signaturesï¼ˆé©é…å™¨ç°½åï¼‰ï¼Œé€™æ˜¯ä¸€ç¨®å¯†ç¢¼å­¸æ§‹é€ ï¼Œå…è¨±å‰µå»ºã€Œä¸å®Œæ•´ã€çš„ç°½åï¼Œåªæœ‰åœ¨ç²å¾—æŸå€‹ç§˜å¯†å€¼å¾Œæ‰èƒ½è®Šæˆæœ‰æ•ˆç°½åã€‚</p>

<p>åœ¨æ¨™æº–çš„ Schnorr ç°½åä¸­ï¼Œç°½åè€…ç”¨ç§é‘° dã€éš¨æ©Ÿæ•¸ kã€å’Œè¨Šæ¯ m è¨ˆç®—ç°½å (R, s)ï¼Œå…¶ä¸­ R = k Ã— Gï¼Œs = k + H(R, P, m) Ã— dã€‚é©—è­‰è€…å¯ä»¥ç”¨å…¬å¼ s Ã— G = R + H(R, P, m) Ã— P ä¾†é©—è­‰ã€‚</p>

<p>é©é…å™¨ç°½åå¼•å…¥äº†ä¸€å€‹ã€Œé©é…é»ã€T = t Ã— Gï¼Œå…¶ä¸­ t æ˜¯é©é…ç§˜å¯†ã€‚ç°½åè€…å‰µå»ºä¸€å€‹ã€Œä¸å®Œæ•´ã€ç°½å (Râ€™, sâ€™)ï¼Œå…¶ä¸­ Râ€™ = R + Tã€‚é€™å€‹ç°½åå–®ç¨ç„¡æ³•é€šéé©—è­‰ï¼Œä½†å¦‚æœæœ‰äººçŸ¥é“ tï¼Œä»–å€‘å¯ä»¥è¨ˆç®— s = sâ€™ + tï¼Œå¾—åˆ°ç›¸å°æ–¼ Râ€™ çš„æœ‰æ•ˆç°½åã€‚</p>

<p>é€™å€‹æ©Ÿåˆ¶çš„å¦™è™•åœ¨æ–¼ï¼šçµ¦å®š (Râ€™, sâ€™) å’Œå®Œæˆçš„ç°½å (Râ€™, s)ï¼Œä»»ä½•äººéƒ½å¯ä»¥è¨ˆç®—å‡º t = s - sâ€™ã€‚é€™æ„å‘³è‘—ä½¿ç”¨é©é…å™¨ç°½åæœƒã€Œæ­ç¤ºã€é©é…ç§˜å¯†ã€‚</p>

<h3 id="13-dlc-çš„å·¥ä½œæµç¨‹">1.3 DLC çš„å·¥ä½œæµç¨‹</h3>

<p>è®“æˆ‘å€‘è©³ç´°çœ‹çœ‹ DLC æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>

<p>é¦–å…ˆæ˜¯è¨­ç½®éšæ®µã€‚Alice å’Œ Bob å”å•†åˆç´„æ¢æ¬¾ï¼ŒåŒ…æ‹¬ï¼šäº‹ä»¶ï¼ˆå¦‚ã€Œ2025-12-31 çš„ BTC/USD åƒ¹æ ¼ã€ï¼‰ã€å¯èƒ½çš„çµæœï¼ˆå¦‚åƒ¹æ ¼å€é–“ï¼‰ã€æ¯ç¨®çµæœå°æ‡‰çš„æ”¯ä»˜åˆ†é…ã€‚ç„¶å¾Œä»–å€‘æ‰¾åˆ°ä¸€å€‹æˆ–å¤šå€‹å¯ä¿¡çš„ç¥è«­ï¼Œç²å–ç¥è«­çš„å…¬é‘°å’Œå°é€™å€‹äº‹ä»¶çš„ã€Œæ‰¿è«¾é»ã€ã€‚æ‰¿è«¾é»ä»£è¡¨ç¥è«­å°‡ç‚ºæ¯å€‹å¯èƒ½çµæœç™¼å¸ƒçš„ç°½åå°æ‡‰çš„å…¬é‘°ã€‚</p>

<p>æ¥ä¸‹ä¾†æ˜¯è³‡é‡‘é–å®šã€‚é›™æ–¹å‰µå»ºä¸€ç­†ã€ŒFunding Transactionã€ï¼Œå°‡å„è‡ªçš„è³‡é‡‘é–å®šåˆ°ä¸€å€‹ 2-of-2 å¤šç°½è¼¸å‡ºã€‚é€™ç­†äº¤æ˜“ä¸Šéˆå¾Œï¼Œè³‡é‡‘å°±ç„¡æ³•è¢«ä»»ä½•ä¸€æ–¹å–®ç¨ç§»å‹•ã€‚</p>

<p>ç„¶å¾Œæ˜¯é ç°½ CETï¼ˆContract Execution Transactionï¼‰ã€‚é€™æ˜¯ DLC çš„æ ¸å¿ƒã€‚å°æ–¼æ¯å€‹å¯èƒ½çš„çµæœï¼Œé›™æ–¹å‰µå»ºä¸€ç­† CETï¼Œè¡¨ç¤ºè©²çµæœç™¼ç”Ÿæ™‚çš„è³‡é‡‘åˆ†é…ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæœ‰ 100 å€‹å¯èƒ½çš„åƒ¹æ ¼å€é–“ï¼Œå°±æœƒæœ‰ 100 ç­†ä¸åŒçš„ CETã€‚</p>

<p>é—œéµåœ¨æ–¼ï¼šé€™äº› CET ä¸æ˜¯ç”¨æ™®é€šç°½åï¼Œè€Œæ˜¯ç”¨é©é…å™¨ç°½åã€‚æ¯ç­† CET çš„é©é…é»æ˜¯ç¥è«­å°è©²çµæœçš„ç°½åå°æ‡‰çš„å…¬é‘°ã€‚é€™æ„å‘³è‘—åªæœ‰ç•¶ç¥è«­ç™¼å¸ƒç‰¹å®šçµæœçš„ç°½åæ™‚ï¼Œå°æ‡‰çš„ CET æ‰èƒ½è¢«å®Œæˆä¸¦å»£æ’­ã€‚</p>

<p>æœ€å¾Œæ˜¯çµç®—ã€‚ç•¶äº‹ä»¶ç™¼ç”Ÿæ™‚ï¼Œç¥è«­ç™¼å¸ƒçµæœå’Œå°æ‡‰çš„ç°½å sã€‚ç²å‹æ–¹ä½¿ç”¨é€™å€‹ç°½åä½œç‚ºé©é…ç§˜å¯†ï¼Œå®Œæˆå°æ‡‰ CET çš„é©é…å™¨ç°½åï¼Œå¾—åˆ°æœ‰æ•ˆç°½åï¼Œç„¶å¾Œå»£æ’­ CET ç²å–è³‡é‡‘ã€‚</p>

<p>é€™å€‹æ©Ÿåˆ¶çš„å„ªç¾ä¹‹è™•åœ¨æ–¼ï¼šç¥è«­åªç™¼å¸ƒä¸€æ¬¡æ•¸æ“šï¼Œå®Œå…¨ä¸çŸ¥é“èª°åœ¨ä½¿ç”¨å®ƒï¼›é›™æ–¹åœ¨è¨­ç½®éšæ®µå°±äº¤æ›äº†æ‰€æœ‰éœ€è¦çš„ä¿¡æ¯ï¼Œçµç®—æ™‚ä¸éœ€è¦é¡å¤–äº’å‹•ï¼›æ•´å€‹éç¨‹åœ¨éˆä¸Šçœ‹èµ·ä¾†åªæ˜¯æ™®é€šçš„å¤šç°½åæ“ä½œã€‚</p>

<h3 id="14-dlc-çš„æ‡‰ç”¨å ´æ™¯">1.4 DLC çš„æ‡‰ç”¨å ´æ™¯</h3>

<p>DLC é–‹å•Ÿäº†æ¯”ç‰¹å¹£ä¸Šè¨±å¤šä¹‹å‰ä¸å¯èƒ½å¯¦ç¾çš„æ‡‰ç”¨ã€‚</p>

<p>é‡‘èè¡ç”Ÿå“æ˜¯æœ€ç›´æ¥çš„æ‡‰ç”¨ã€‚æœŸè²¨ã€æœŸæ¬Šã€å·®åƒ¹åˆç´„éƒ½å¯ä»¥ç”¨ DLC å¯¦ç¾ã€‚ä¾‹å¦‚ï¼Œä¸€å€‹æ¯”ç‰¹å¹£ç¤¦å·¥å¯ä»¥ä½¿ç”¨ DLC å°æ²–æœªä¾†çš„åƒ¹æ ¼é¢¨éšªï¼Œè€Œä¸éœ€è¦ä¾è³´ä»»ä½•ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ã€‚</p>

<p>åˆæˆè³‡ç”¢å…è¨±ç”¨æˆ¶ç²å¾—å°å…¶ä»–è³‡ç”¢ï¼ˆå¦‚è‚¡ç¥¨ã€é»ƒé‡‘ã€å…¶ä»–åŠ å¯†è²¨å¹£ï¼‰çš„åƒ¹æ ¼æ•å£ï¼Œè€Œåªä½¿ç”¨æ¯”ç‰¹å¹£ä½œç‚ºæŠµæŠ¼å“ã€‚é€™åœ¨å‚³çµ±é‡‘èå—é™æˆ–ä¸ä¿¡ä»»ä¸­å¿ƒåŒ–æœå‹™çš„åœ°å€ç‰¹åˆ¥æœ‰åƒ¹å€¼ã€‚</p>

<p>ä¿éšªåˆç´„ä¹Ÿå¯ä»¥ç”¨ DLC å¯¦ç¾ã€‚èˆªç­å»¶èª¤ä¿éšªå¯ä»¥åŸºæ–¼èˆªç­æ•¸æ“šç¥è«­è‡ªå‹•çµç®—ï¼›è¾²æ¥­ä¿éšªå¯ä»¥åŸºæ–¼å¤©æ°£æ•¸æ“šï¼›ç”šè‡³å¥åº·ä¿éšªçš„æŸäº›é¡å‹ä¹Ÿå¯ä»¥é€™æ¨£è¨­è¨ˆã€‚</p>

<p>é æ¸¬å¸‚å ´è®“ç”¨æˆ¶å¯ä»¥å°ä»»ä½•æœ‰æ˜ç¢ºçµæœçš„äº‹ä»¶é€²è¡Œé æ¸¬å’ŒæŠ•æ³¨ã€‚é«”è‚²è³½äº‹ã€é¸èˆ‰çµæœã€ç§‘å­¸ç™¼ç¾â€”â€”åªè¦æœ‰å¯é çš„ç¥è«­èƒ½è­‰æ˜çµæœï¼Œå°±å¯ä»¥å»ºç«‹ DLCã€‚</p>

<hr />

<h2 id="äºŒvault-è¨­è¨ˆæ¨¡å¼">äºŒã€Vault è¨­è¨ˆæ¨¡å¼</h2>

<h3 id="21-ç‚ºä»€éº¼éœ€è¦-vault">2.1 ç‚ºä»€éº¼éœ€è¦ Vaultï¼Ÿ</h3>

<p>æ¯”ç‰¹å¹£çš„å®‰å…¨æ¨¡å‹å»ºç«‹åœ¨ç§é‘°æ§åˆ¶ä¸Šï¼šèª°æ“æœ‰ç§é‘°ï¼Œèª°å°±èƒ½èŠ±è²»å°æ‡‰çš„æ¯”ç‰¹å¹£ã€‚é€™ç¨®æ¨¡å‹ç°¡å–®ç›´æ¥ï¼Œä½†ä¹Ÿæ„å‘³è‘—ä¸€æ—¦ç§é‘°æ´©éœ²ï¼Œè³‡é‡‘ç«‹å³é¢è‡¨é¢¨éšªï¼Œè€Œä¸”é€šå¸¸ç„¡æ³•è¿½å›ã€‚</p>

<p>Vaultï¼ˆé‡‘åº«ï¼‰æ˜¯ä¸€ç¨®è¨­è¨ˆæ¨¡å¼ï¼Œæ—¨åœ¨ç‚ºé€™å€‹å•é¡Œæä¾›ä¸€å±¤é¡å¤–çš„ä¿è­·ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå³ä½¿ç†±å¯†é‘°ï¼ˆç”¨æ–¼æ—¥å¸¸æ“ä½œçš„å¯†é‘°ï¼‰è¢«ç›œï¼Œæ”»æ“Šè€…ä¹Ÿç„¡æ³•ç«‹å³ç²å¾—è³‡é‡‘ã€‚ç›¸åï¼Œä»»ä½•ææ¬¾å˜—è©¦éƒ½éœ€è¦ç¶“éä¸€æ®µç­‰å¾…æœŸï¼Œåœ¨æ­¤æœŸé–“ï¼ŒçœŸæ­£çš„æ“æœ‰è€…å¯ä»¥ç™¼ç¾æ”»æ“Šä¸¦æ¡å–è¡Œå‹•â€”â€”ä½¿ç”¨ä¸€å€‹æ›´å®‰å…¨çš„ã€Œæ¢å¾©å¯†é‘°ã€å°‡è³‡é‡‘è½‰ç§»åˆ°å®‰å…¨åœ°å€ã€‚</p>

<p>é€™å€‹æ¦‚å¿µé¡ä¼¼æ–¼å‚³çµ±éŠ€è¡Œçš„å¤§é¡è½‰å¸³å»¶é²æˆ–ä¼æ¥­çš„å¤šç´šå¯©æ‰¹æµç¨‹ã€‚å®ƒå‰µé€ äº†ä¸€å€‹æ™‚é–“çª—å£ï¼Œè®“å®‰å…¨ç›£æ§å’Œäººç‚ºå¹²é æˆç‚ºå¯èƒ½ã€‚</p>

<h3 id="22-ä½¿ç”¨é ç°½äº¤æ˜“å¯¦ç¾-vault">2.2 ä½¿ç”¨é ç°½äº¤æ˜“å¯¦ç¾ Vault</h3>

<p>åœ¨ç›®å‰çš„æ¯”ç‰¹å¹£è…³æœ¬é™åˆ¶ä¸‹ï¼Œå¯¦ç¾ Vault çš„ä¸»è¦æ–¹æ³•æ˜¯ä½¿ç”¨é ç°½äº¤æ˜“ã€‚é€™ç¨®æ–¹æ³•æœ‰å…¶å±€é™æ€§ï¼Œä½†å·²ç¶“å¯ä»¥æä¾›æœ‰åƒ¹å€¼çš„ä¿è­·ã€‚</p>

<p>Vault çš„çµæ§‹åŒ…å«å…©ç¨®å¯†é‘°ã€‚ç†±å¯†é‘°ç”¨æ–¼ç™¼èµ·ææ¬¾ï¼Œå¯èƒ½å­˜å„²åœ¨é€£æ¥ç¶²è·¯çš„è¨­å‚™ä¸Šï¼Œé¢è‡¨è¢«ç›œçš„é¢¨éšªã€‚æ¢å¾©å¯†é‘°æ˜¯é«˜å®‰å…¨ç´šåˆ¥çš„å¯†é‘°ï¼Œå¯èƒ½æ˜¯å¤šç°½ã€åˆ†æ•£åœ¨å¤šå€‹åœ°ç†ä½ç½®ã€æˆ–å­˜å„²åœ¨ç¡¬é«”éŒ¢åŒ…ä¸­ï¼Œç”¨æ–¼åœ¨ç·Šæ€¥æƒ…æ³ä¸‹æ¢å¾©è³‡é‡‘ã€‚</p>

<p>Vault è¼¸å‡ºçš„è…³æœ¬è¨­è¨ˆæœ‰å…©æ¢è·¯å¾‘ã€‚ç¬¬ä¸€æ¢æ˜¯æ­£å¸¸ææ¬¾è·¯å¾‘ï¼šä½¿ç”¨ç†±å¯†é‘°ç°½åï¼Œå°‡è³‡é‡‘è½‰ç§»åˆ°ä¸€å€‹ã€ŒUnvaultã€ç‹€æ…‹ï¼Œé€™å€‹ç‹€æ…‹æœ‰ CSV æ™‚é–“é–ï¼ˆä¾‹å¦‚ä¸€é€±ï¼‰ã€‚ç¬¬äºŒæ¢æ˜¯ç·Šæ€¥æ¢å¾©è·¯å¾‘ï¼šä½¿ç”¨æ¢å¾©å¯†é‘°ç°½åï¼Œå¯ä»¥ç«‹å³å°‡è³‡é‡‘è½‰ç§»åˆ°é è¨­çš„å†·å­˜å„²åœ°å€ã€‚</p>

<p>Unvault ç‹€æ…‹åŒæ¨£æœ‰å…©æ¢è·¯å¾‘ã€‚ç¬¬ä¸€æ¢æ˜¯å®Œæˆææ¬¾ï¼šç­‰å¾… CSV å»¶é²æœŸçµæŸå¾Œï¼Œç”¨ç†±å¯†é‘°ç°½åæå–è³‡é‡‘åˆ°ç›®æ¨™åœ°å€ã€‚ç¬¬äºŒæ¢æ˜¯å–æ¶ˆææ¬¾ï¼šä½¿ç”¨æ¢å¾©å¯†é‘°ï¼Œç«‹å³å°‡è³‡é‡‘è½‰å›å†·å­˜å„²ã€‚</p>

<h3 id="23-é ç°½äº¤æ˜“çš„å·¥ä½œæµç¨‹">2.3 é ç°½äº¤æ˜“çš„å·¥ä½œæµç¨‹</h3>

<p>è¨­ç½® Vault æ™‚ï¼Œç”¨æˆ¶éœ€è¦é å…ˆç°½ç½²ä¸€ç³»åˆ—äº¤æ˜“ã€‚</p>

<p>é¦–å…ˆæ˜¯ Unvault äº¤æ˜“ï¼šå¾ Vault è¼¸å‡ºåˆ° Unvault ç‹€æ…‹çš„è½‰æ›ã€‚ç„¶å¾Œæ˜¯ Withdrawal äº¤æ˜“ï¼šå¾ Unvault ç‹€æ…‹åˆ°æœ€çµ‚ç›®çš„åœ°çš„è½‰æ›ï¼Œå¸¶æœ‰ CSV å»¶é²ã€‚æ¥è‘—æ˜¯ Recovery äº¤æ˜“ï¼šå¾ Vault ç›´æ¥åˆ°å†·å­˜å„²çš„ç·Šæ€¥è½‰ç§»ã€‚æœ€å¾Œæ˜¯ Cancel äº¤æ˜“ï¼šå¾ Unvault ç‹€æ…‹å›åˆ°å†·å­˜å„²çš„å–æ¶ˆæ“ä½œã€‚</p>

<p>é€™äº›äº¤æ˜“éœ€è¦åœ¨å­˜å…¥è³‡é‡‘ä¹‹å‰å°±ç°½ç½²å¥½ï¼Œè€Œä¸”å¿…é ˆå®‰å…¨å­˜å„²ã€‚ç‰¹åˆ¥æ˜¯ Withdrawal äº¤æ˜“éœ€è¦ç‚ºæ¯å€‹å¯èƒ½çš„ç›®çš„åœ°é å…ˆæº–å‚™ï¼Œé€™é™åˆ¶äº†éˆæ´»æ€§ã€‚</p>

<p>æ­£å¸¸ææ¬¾æµç¨‹æ˜¯ï¼šå»£æ’­ Unvault äº¤æ˜“ï¼Œç­‰å¾… CSV å»¶é²ï¼ˆä¾‹å¦‚ 1008 å€‹å€å¡Šï¼Œç´„ä¸€é€±ï¼‰ï¼Œç„¶å¾Œå»£æ’­ Withdrawal äº¤æ˜“ã€‚</p>

<p>ç·Šæ€¥æ¢å¾©æµç¨‹æ˜¯ï¼šç™¼ç¾ç•°å¸¸æ´»å‹•ï¼ˆä¾‹å¦‚æ”¶åˆ° Unvault äº¤æ˜“è¢«å»£æ’­çš„è­¦å ±ï¼‰ï¼Œåœ¨å»¶é²æœŸçµæŸä¹‹å‰ï¼Œä½¿ç”¨æ¢å¾©å¯†é‘°å»£æ’­ Cancel æˆ– Recovery äº¤æ˜“ã€‚</p>

<h3 id="24-ç•¶å‰-vault-çš„é™åˆ¶">2.4 ç•¶å‰ Vault çš„é™åˆ¶</h3>

<p>é ç°½äº¤æ˜“æ–¹å¼çš„ Vault æœ‰å¹¾å€‹é¡¯è‘—é™åˆ¶ã€‚</p>

<p>ç›®çš„åœ°å¿…é ˆé å…ˆç¢ºå®šï¼šç”±æ–¼éœ€è¦é å…ˆç°½ç½² Withdrawal äº¤æ˜“ï¼Œä½ å¿…é ˆåœ¨è¨­ç½®æ™‚å°±çŸ¥é“æ‰€æœ‰å¯èƒ½çš„ææ¬¾ç›®çš„åœ°ã€‚é€™å°æ–¼æƒ³è¦éˆæ´»ææ¬¾çš„ç”¨æˆ¶ä¾†èªªå¾ˆä¸æ–¹ä¾¿ã€‚</p>

<p>é‡‘é¡ä¸å¯åˆ†å‰²ï¼šé ç°½äº¤æ˜“é–å®šäº†æ•´å€‹ Vault çš„é‡‘é¡ï¼Œç„¡æ³•åªæå–éƒ¨åˆ†è³‡é‡‘ã€‚</p>

<p>å®‰å…¨åˆªé™¤å•é¡Œï¼šå¦‚æœæ”»æ“Šè€…ç²å¾—äº†é ç°½çš„äº¤æ˜“å‰¯æœ¬ï¼Œä»–å€‘å¯ä»¥å˜—è©¦ä½¿ç”¨å®ƒã€‚ç¢ºä¿èˆŠçš„é ç°½äº¤æ˜“è¢«å®Œå…¨éŠ·æ¯€æ˜¯å›°é›£çš„ã€‚</p>

<p>æ‰‹çºŒè²»å›ºå®šï¼šé ç°½äº¤æ˜“çš„æ‰‹çºŒè²»ç‡åœ¨ç°½ç½²æ™‚å°±ç¢ºå®šäº†ï¼Œç„¡æ³•é©æ‡‰æœªä¾†çš„ç¶²è·¯æ¢ä»¶ã€‚</p>

<p>é€™äº›é™åˆ¶çš„æ ¹æœ¬åŸå› æ˜¯æ¯”ç‰¹å¹£è…³æœ¬ç›®å‰ç„¡æ³•ã€Œå…§çœã€äº¤æ˜“æœ¬èº«â€”â€”è…³æœ¬ç„¡æ³•æª¢æŸ¥ã€Œé€™ç­†èŠ±è²»äº¤æ˜“å¿…é ˆç™¼é€åˆ°ç‰¹å®šåœ°å€ã€æˆ–ã€Œå¿…é ˆä¿æŒç‰¹å®šé‡‘é¡ã€ã€‚é€™æ­£æ˜¯ Covenant ææ¡ˆè©¦åœ–è§£æ±ºçš„å•é¡Œã€‚</p>

<hr />

<h2 id="ä¸‰covenanté™åˆ¶æœªä¾†çš„èŠ±è²»æ–¹å¼">ä¸‰ã€Covenantï¼šé™åˆ¶æœªä¾†çš„èŠ±è²»æ–¹å¼</h2>

<h3 id="31-ä»€éº¼æ˜¯-covenant">3.1 ä»€éº¼æ˜¯ Covenantï¼Ÿ</h3>

<p>Covenantï¼ˆå¥‘ç´„/å…¬ç´„ï¼‰æ˜¯ä¸€å€‹å¯†ç¢¼å­¸å’Œæ™ºèƒ½åˆç´„è¡“èªï¼ŒæŒ‡çš„æ˜¯å° UTXO æœªä¾†å¦‚ä½•è¢«èŠ±è²»çš„é™åˆ¶ã€‚åœ¨ç›®å‰çš„æ¯”ç‰¹å¹£è…³æœ¬ä¸­ï¼Œä½ å¯ä»¥é™åˆ¶ã€Œèª°ã€å¯ä»¥èŠ±è²»ï¼ˆé€éç°½åè¦æ±‚ï¼‰å’Œã€Œä½•æ™‚ã€å¯ä»¥èŠ±è²»ï¼ˆé€éæ™‚é–“é–ï¼‰ã€‚ä½†ä½ ç„¡æ³•é™åˆ¶èŠ±è²»äº¤æ˜“çš„å…¶ä»–å±¬æ€§ï¼Œå¦‚è¼¸å‡ºçš„ç›®çš„åœ°ã€é‡‘é¡ï¼Œæˆ–çµæ§‹ã€‚</p>

<p>Covenant å¡«è£œäº†é€™å€‹ç©ºç™½ã€‚æœ‰äº† Covenantï¼Œä½ å¯ä»¥å‰µå»ºé€™æ¨£çš„è…³æœ¬ï¼šã€Œé€™ç­†è³‡é‡‘åªèƒ½è¢«è½‰ç§»åˆ°ä»¥ä¸‹ä¸‰å€‹åœ°å€ä¹‹ä¸€ã€ï¼Œæˆ–ã€Œææ¬¾å¿…é ˆåˆ†æ‰¹é€²è¡Œï¼Œæ¯æ¬¡æœ€å¤š 10%ã€ï¼Œæˆ–ã€Œé€™ç­†äº¤æ˜“çš„æ‰¾é›¶å¿…é ˆå›åˆ°åŒæ¨£çš„ Covenant ä¿è­·ä¸‹ã€ã€‚</p>

<p>é€™å€‹èƒ½åŠ›çœ‹ä¼¼ç°¡å–®ï¼Œä½†å½±éŸ¿æ·±é ã€‚å®ƒä½¿å¾—è¨±å¤šç›®å‰ä¸å¯èƒ½æˆ–éœ€è¦ä¿¡ä»»çš„æ‡‰ç”¨æˆç‚ºå¯èƒ½ï¼ŒåŒæ™‚ä¹Ÿå¼•ç™¼äº†é—œæ–¼å¯©æŸ¥å’Œå¯æ›¿ä»£æ€§çš„æ“”æ†‚ã€‚</p>

<h3 id="32-ä¸»è¦çš„-covenant-ææ¡ˆ">3.2 ä¸»è¦çš„ Covenant ææ¡ˆ</h3>

<p>æ¯”ç‰¹å¹£ç¤¾å€æ­£åœ¨è¨è«–å¹¾å€‹ä¸åŒçš„ Covenant å¯¦ç¾æ–¹æ¡ˆï¼Œæ¯å€‹éƒ½æœ‰ä¸åŒçš„åŠŸèƒ½ç¯„åœå’Œæ¬Šè¡¡ã€‚</p>

<p>OP_CHECKTEMPLATEVERIFYï¼ˆCTVï¼ŒBIP 119ï¼‰æ˜¯æœ€ä¿å®ˆçš„ææ¡ˆã€‚å®ƒå…è¨±è…³æœ¬æ‰¿è«¾ä¸€å€‹ç²¾ç¢ºçš„æœªä¾†äº¤æ˜“ã€Œæ¨¡æ¿ã€â€”â€”åŒ…æ‹¬è¼¸å‡ºçš„æ•¸é‡ã€è…³æœ¬ã€é‡‘é¡ï¼Œä»¥åŠé–å®šæ™‚é–“ã€‚èŠ±è²»äº¤æ˜“å¿…é ˆç²¾ç¢ºåŒ¹é…é€™å€‹æ¨¡æ¿ã€‚CTV æ˜¯åŠŸèƒ½æœ€æœ‰é™çš„ Covenantï¼Œä½†ä¹Ÿå› æ­¤æœ€å®¹æ˜“åˆ†æå…¶å®‰å…¨æ€§å’Œå½±éŸ¿ã€‚å®ƒå·²ç¶“ç¶“éå¤šå¹´å¯©æŸ¥ï¼Œå¯èƒ½æ˜¯æœ€æ¥è¿‘è¢«æ¿€æ´»çš„ææ¡ˆã€‚</p>

<p>OP_VAULTï¼ˆBIP 345ï¼‰æ˜¯å°ˆé–€ç‚º Vault ç”¨ä¾‹è¨­è¨ˆçš„ã€‚å®ƒå¼•å…¥å…©å€‹æ–°æ“ä½œç¢¼ï¼šOP_VAULT å’Œ OP_VAULT_RECOVERã€‚OP_VAULT å‰µå»ºä¸€å€‹å¯ä»¥è¢«ã€Œè§¸ç™¼ã€é€²å…¥ç­‰å¾…ç‹€æ…‹çš„è¼¸å‡ºï¼Œç„¶å¾Œåœ¨å»¶é²å¾Œå®Œæˆææ¬¾ã€‚OP_VAULT_RECOVER å…è¨±åœ¨ç­‰å¾…æœŸé–“å°‡è³‡é‡‘æ¢å¾©åˆ°å®‰å…¨åœ°å€ã€‚é€™å€‹ææ¡ˆè§£æ±ºäº†é ç°½ Vault çš„è¨±å¤šé™åˆ¶ï¼Œå…è¨±éˆæ´»çš„ç›®çš„åœ°å’Œéƒ¨åˆ†ææ¬¾ã€‚</p>

<p>OP_CATï¼ˆBIP 347ï¼‰æ˜¯ä¸€å€‹è¢«ã€Œå¾©æ´»ã€çš„ææ¡ˆã€‚OP_CAT åœ¨æ¯”ç‰¹å¹£æ—©æœŸå­˜åœ¨ï¼Œä½†å› ç‚ºæ“”å¿ƒè¨˜æ†¶é«”æ”»æ“Šè€Œè¢«ç¦ç”¨ã€‚ç¾åœ¨æè­°åœ¨ Tapscript ä¸­é‡æ–°å•Ÿç”¨å®ƒï¼Œä¸¦è¨­ç½® 520 ä½å…ƒçµ„çš„è¼¸å‡ºé™åˆ¶ã€‚OP_CAT æœ¬èº«åªæ˜¯ä¸²æ¥å…©å€‹å †ç–Šå…ƒç´ ï¼Œä½†å®ƒå¯ä»¥èˆ‡å…¶ä»–ç¾æœ‰æ“ä½œç¢¼çµ„åˆï¼Œå¯¦ç¾ç›¸ç•¶å¼·å¤§çš„ Covenantã€‚é€éåœ¨è…³æœ¬ä¸­é‡å»ºäº¤æ˜“çµæ§‹ä¸¦é©—è­‰å…¶é›œæ¹Šï¼Œå¯ä»¥é–“æ¥æª¢æŸ¥äº¤æ˜“çš„å±¬æ€§ã€‚</p>

<p>æ›´æ¿€é€²çš„ææ¡ˆå¦‚ OP_TXHASH å…è¨±å°‡äº¤æ˜“çš„ä»»ä½•æ¬„ä½çš„é›œæ¹Šæ¨å…¥å †ç–Šï¼Œæä¾›å®Œå…¨çš„äº¤æ˜“å…§çœèƒ½åŠ›ã€‚é€™åŠŸèƒ½æœ€å¼·ä½†ä¹Ÿæœ€æœ‰çˆ­è­°ï¼Œå› ç‚ºå®ƒå¯èƒ½å°æ¯”ç‰¹å¹£çš„å¯©æŸ¥æŠµæŠ—æ€§å’Œå¯æ›¿ä»£æ€§ç”¢ç”Ÿå½±éŸ¿ã€‚</p>

<h3 id="33-ctv-çš„å…·é«”æ‡‰ç”¨">3.3 CTV çš„å…·é«”æ‡‰ç”¨</h3>

<p>è®“æˆ‘å€‘çœ‹çœ‹ CTV å¯ä»¥å¯¦ç¾çš„ä¸€äº›å…·é«”æ‡‰ç”¨ã€‚</p>

<p>æ“å¡æ§åˆ¶ï¼ˆCongestion Controlï¼‰æ˜¯ CTV æœ€å¼•äººæ³¨ç›®çš„ç”¨ä¾‹ã€‚æƒ³åƒä¸€å€‹äº¤æ˜“æ‰€éœ€è¦åŒæ™‚è™•ç† 10,000 å€‹ç”¨æˆ¶ææ¬¾ã€‚åœ¨ç›®å‰çš„ç³»çµ±ä¸­ï¼Œé€™éœ€è¦ä¸€ç­†å·¨å¤§çš„äº¤æ˜“ï¼ˆæˆ–å¤šç­†è¼ƒå¤§çš„äº¤æ˜“ï¼‰ï¼Œåœ¨ç¶²è·¯æ“å¡æ™‚æˆæœ¬æ¥µé«˜ã€‚</p>

<p>ä½¿ç”¨ CTVï¼Œäº¤æ˜“æ‰€å¯ä»¥å‰µå»ºä¸€æ£µã€Œå±•é–‹æ¨¹ã€ã€‚æ ¹äº¤æ˜“åªæœ‰ä¸€å€‹è¼¸å‡ºï¼Œæ‰¿è«¾åˆ°ç‰¹å®šçš„å±•é–‹çµæ§‹ã€‚é€™å€‹è¼¸å‡ºå¯ä»¥è¢«å±•é–‹æˆ 100 å€‹å­è¼¸å‡ºï¼Œæ¯å€‹å­è¼¸å‡ºåˆæ‰¿è«¾åˆ°é€²ä¸€æ­¥çš„å±•é–‹ã€‚æœ€çµ‚ï¼Œ10,000 å€‹ç”¨æˆ¶ä¸­çš„æ¯ä¸€å€‹éƒ½å¯ä»¥é ˜å–è‡ªå·±çš„è³‡é‡‘ã€‚</p>

<p>å„ªé›…çš„æ˜¯ï¼Œé€™å€‹å±•é–‹å¯ä»¥æ˜¯ã€Œæƒ°æ€§çš„ã€ã€‚æ ¹äº¤æ˜“å¯ä»¥åœ¨è²»ç”¨ä¾¿å®œæ™‚ä¸Šéˆï¼Œæ‰¿è«¾äº†æ‰€æœ‰ç”¨æˆ¶çš„é¤˜é¡ã€‚ä¹‹å¾Œï¼Œæ¯å€‹ç”¨æˆ¶å¯ä»¥åœ¨ä»»ä½•æ™‚å€™å±•é–‹è‡ªå·±çš„è·¯å¾‘ä¾†é ˜å–è³‡é‡‘ï¼Œè€Œä¸éœ€è¦å…¶ä»–ç”¨æˆ¶çš„é…åˆã€‚å¦‚æœè²»ç”¨é™ä½ï¼Œå¯ä»¥ä¸€æ¬¡å±•é–‹æ›´å¤§çš„éƒ¨åˆ†ï¼›å¦‚æœè²»ç”¨ä¸Šå‡ï¼Œå¯ä»¥åªå±•é–‹è‡ªå·±é—œå¿ƒçš„è·¯å¾‘ã€‚</p>

<p>å¦ä¸€å€‹æ‡‰ç”¨æ˜¯æ”¹é€²çš„ Vaultã€‚æœ‰äº† CTVï¼ŒVault å¯ä»¥ä¸éœ€è¦é ç°½æ‰€æœ‰å¯èƒ½çš„ææ¬¾äº¤æ˜“ã€‚ç›¸åï¼ŒVault è¼¸å‡ºå¯ä»¥æ‰¿è«¾ä¸€å€‹æ¨¡æ¿ï¼Œé€™å€‹æ¨¡æ¿æŒ‡å®šå¿…é ˆæœ‰ä¸€å€‹å›åˆ°åŒé¡å‹ Vault çš„æ‰¾é›¶è¼¸å‡ºï¼Œè€Œææ¬¾é‡‘é¡å¯ä»¥æ˜¯ä»»æ„çš„ã€‚é€™è§£æ±ºäº†é ç°½ Vault çš„é‡‘é¡ä¸å¯åˆ†å‰²å•é¡Œã€‚</p>

<h3 id="34-covenant-çš„æ“”æ†‚">3.4 Covenant çš„æ“”æ†‚</h3>

<p>Covenant çš„å¼•å…¥ä¸æ˜¯æ²’æœ‰çˆ­è­°çš„ã€‚ä¸»è¦æ“”æ†‚åŒ…æ‹¬ä»¥ä¸‹å¹¾å€‹æ–¹é¢ã€‚</p>

<p>å¯©æŸ¥å‘é‡ï¼šå¦‚æœå¯ä»¥å‰µå»ºã€Œåªèƒ½è½‰ç§»åˆ°ç‰¹å®šåœ°å€ã€çš„æ¯”ç‰¹å¹£ï¼Œç›£ç®¡æ©Ÿæ§‹å¯èƒ½æœƒè¦æ±‚äº¤æ˜“æ‰€åªæ¥å—ã€Œåˆè¦ã€çš„ Covenant ä»£å¹£ã€‚é€™å¯èƒ½å°è‡´ä¸åŒç­‰ç´šçš„æ¯”ç‰¹å¹£ï¼Œæå®³å¯æ›¿ä»£æ€§ã€‚</p>

<p>è¤‡é›œæ€§å¢åŠ ï¼šæ›´å¼·å¤§çš„è…³æœ¬åŠŸèƒ½æ„å‘³è‘—æ›´å¤šçš„æ”»æ“Šé¢å’Œæ›´é›£å¯©è¨ˆçš„åˆç´„ã€‚å·²ç¶“æœ‰ä¸€äº›ç°¡å–®çš„ bug å°è‡´äº†è³‡é‡‘æå¤±ï¼Œæ›´è¤‡é›œçš„ç³»çµ±å¯èƒ½æœƒæœ‰æ›´å¤šé€™é¡å•é¡Œã€‚</p>

<p>éè¿´ Covenantï¼šæŸäº› Covenant è¨­è¨ˆï¼ˆä¸åŒ…æ‹¬ CTVï¼‰å…è¨±å‰µå»ºã€Œæ°¸ä¹…ã€çš„é™åˆ¶ï¼Œè³‡é‡‘å¯èƒ½è¢«æ°¸ä¹…å›°åœ¨æŸç¨®çµæ§‹ä¸­ã€‚é€™å¼•ç™¼äº†é—œæ–¼æ¯”ç‰¹å¹£é•·æœŸå¯ç”¨æ€§çš„æ“”æ†‚ã€‚</p>

<p>æ”¯æŒè€…èªç‚ºé€™äº›æ“”æ†‚è¢«èª‡å¤§äº†ã€‚Covenant æ˜¯é¸æ“‡åŠ å…¥çš„â€”â€”å¦‚æœä½ ä¸æƒ³ä½¿ç”¨æœ‰é™åˆ¶çš„æ¯”ç‰¹å¹£ï¼Œä½ å¯ä»¥ä¸æ¥å—å®ƒå€‘ã€‚è€Œå…¶æä¾›çš„åŠŸèƒ½â€”â€”æ›´å¥½çš„è‡ªæˆ‘è¨—ç®¡å®‰å…¨ã€æ›´é«˜æ•ˆçš„äº¤æ˜“â€”â€”å°ç”Ÿæ…‹ç³»çµ±çš„åƒ¹å€¼è¶…éäº†å‡è¨­çš„é¢¨éšªã€‚é€™å€‹è¾¯è«–ä»åœ¨é€²è¡Œä¸­ã€‚</p>

<hr />

<h2 id="å››bitvmåœ¨æ¯”ç‰¹å¹£ä¸Šé©—è­‰ä»»æ„è¨ˆç®—">å››ã€BitVMï¼šåœ¨æ¯”ç‰¹å¹£ä¸Šé©—è­‰ä»»æ„è¨ˆç®—</h2>

<h3 id="41-çªç ´è…³æœ¬é™åˆ¶çš„æ€è·¯">4.1 çªç ´è…³æœ¬é™åˆ¶çš„æ€è·¯</h3>

<p>æ¯”ç‰¹å¹£è…³æœ¬æ˜¯æœ‰æ„è¨­è¨ˆç‚ºå—é™çš„â€”â€”å®ƒä¸æ˜¯åœ–éˆå®Œå‚™çš„ï¼Œæ²’æœ‰å¾ªç’°ï¼Œæ“ä½œç¢¼æœ‰é™ã€‚é€™æ˜¯ç‚ºäº†å®‰å…¨å’Œå¯é æ¸¬æ€§ã€‚ä½†å¦‚æœæˆ‘å€‘æƒ³åœ¨æ¯”ç‰¹å¹£ä¸ŠåŸ·è¡Œæ›´è¤‡é›œçš„é‚è¼¯æ€éº¼è¾¦ï¼Ÿ</p>

<p>BitVM æ˜¯ 2023 å¹´æå‡ºçš„ä¸€å€‹çªç ´æ€§æƒ³æ³•ï¼šä¸åœ¨éˆä¸ŠåŸ·è¡Œè¨ˆç®—ï¼Œè€Œæ˜¯åœ¨éˆä¸Šé©—è­‰è¨ˆç®—ã€‚é€™ç¨®æ¨¡å¼ç¨±ç‚ºã€Œæ¨‚è§€åŸ·è¡Œã€ï¼ˆOptimistic Executionï¼‰ï¼Œå€Ÿé‘‘äº†ä»¥å¤ªåŠ Optimistic Rollup çš„æ¦‚å¿µã€‚</p>

<p>æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå¦‚æœé›™æ–¹å°è¨ˆç®—çµæœæœ‰å…±è­˜ï¼Œå°±ä¸éœ€è¦ä»»ä½•éˆä¸Šé©—è­‰ã€‚åªæœ‰ç•¶æœ‰äººè²ç¨±éŒ¯èª¤çµæœæ™‚ï¼Œæ‰éœ€è¦åœ¨éˆä¸Šè­‰æ˜èª°å°èª°éŒ¯ã€‚è€Œä¸”é€™å€‹è­‰æ˜å¯ä»¥è¢«è¨­è¨ˆå¾—éå¸¸å°ï¼Œå³ä½¿åŸå§‹è¨ˆç®—éå¸¸è¤‡é›œã€‚</p>

<h3 id="42-æŒ‘æˆ°-å›æ‡‰å”è­°">4.2 æŒ‘æˆ°-å›æ‡‰å”è­°</h3>

<p>BitVM ä½¿ç”¨äºŒåˆ†æœå°‹çš„æŒ‘æˆ°-å›æ‡‰å”è­°ä¾†å®šä½éŒ¯èª¤ã€‚</p>

<p>å‡è¨­ Operator è²ç¨± f(x) = yï¼Œä½† Verifier èªç‚ºæ­£ç¢ºç­”æ¡ˆæ‡‰è©²æ˜¯ yâ€™ã€‚é›™æ–¹çš„è³‡é‡‘é–å®šåœ¨ä¸€å€‹éœ€è¦æ­£ç¢ºçµç®—çš„åˆç´„ä¸­ã€‚</p>

<p>å”è­°é–‹å§‹æ™‚ï¼ŒOperator ç™¼å¸ƒæ•´å€‹è¨ˆç®—è»Œè·¡çš„ Merkle æ¨¹æ ¹ã€‚é€™å€‹è»Œè·¡è¨˜éŒ„äº†å¾è¼¸å…¥ x åˆ°è¼¸å‡º y çš„æ¯ä¸€æ­¥ä¸­é–“ç‹€æ…‹ã€‚</p>

<p>ç„¶å¾Œé€²å…¥äºŒåˆ†æœå°‹ã€‚Verifier é¸æ“‡è»Œè·¡çš„å‰åŠéƒ¨åˆ†æˆ–å¾ŒåŠéƒ¨åˆ†ï¼Œè¦æ±‚ Operator æ‰“é–‹ã€‚Operator æä¾›æ‰€é¸éƒ¨åˆ†çš„ Merkle è­‰æ˜ã€‚å¦‚æœé€™éƒ¨åˆ†æ˜¯æ­£ç¢ºçš„ï¼ŒVerifier å°‡æœå°‹ç¯„åœç¸®å°åˆ°å¦ä¸€åŠï¼›å¦‚æœé€™éƒ¨åˆ†å·²ç¶“æœ‰éŒ¯èª¤ï¼Œç¹¼çºŒåœ¨é€™åŠéƒ¨åˆ†æœå°‹ã€‚</p>

<p>ç¶“é log(N) è¼ªäº’å‹•ï¼ˆN æ˜¯è¨ˆç®—æ­¥é©Ÿæ•¸ï¼‰ï¼Œé›™æ–¹å®šä½åˆ°å–®å€‹éŒ¯èª¤æ­¥é©Ÿã€‚é€™ä¸€æ­¥å¯ä»¥åœ¨éˆä¸Šé©—è­‰â€”â€”åŸ·è¡Œå–®å€‹ NAND é–€æˆ–é¡ä¼¼çš„åŸºæœ¬æ“ä½œæ˜¯æ¯”ç‰¹å¹£è…³æœ¬å¯ä»¥åšåˆ°çš„ã€‚</p>

<p>å¦‚æœ Operator åœ¨é€™ä¸€æ­¥ç„¡æ³•æä¾›æœ‰æ•ˆè­‰æ˜ï¼ŒVerifier ç²å¾— Operator çš„è³ªæŠ¼é‡‘ã€‚å¦‚æœ Operator æ˜¯èª å¯¦çš„ï¼ŒVerifier ç„¡æ³•æ‰¾åˆ°éŒ¯èª¤æ­¥é©Ÿï¼ŒOperator ä¿ç•™è³‡é‡‘ã€‚</p>

<h3 id="43-bitvm-çš„æ‡‰ç”¨">4.3 BitVM çš„æ‡‰ç”¨</h3>

<p>BitVM æœ€å¼•äººæ³¨ç›®çš„æ‡‰ç”¨æ˜¯å»ä¿¡ä»»çš„è·¨éˆæ©‹ã€‚</p>

<p>ç›®å‰çš„æ¯”ç‰¹å¹£è·¨éˆæ©‹å¤§å¤šä¾è³´è¯é‚¦å¤šç°½ï¼šä¸€çµ„æ“ä½œè€…æ§åˆ¶æ¯”ç‰¹å¹£ç«¯çš„è³‡é‡‘ï¼Œç”¨æˆ¶éœ€è¦ä¿¡ä»»ä»–å€‘ä¸æœƒå…±è¬€ç›œå–è³‡é‡‘ã€‚æ­·å²ä¸Šç¢ºå¯¦ç™¼ç”Ÿéå¤šèµ·æ©‹è¢«æ”»æ“Šæˆ–å…§éƒ¨ä½œå¼Šçš„äº‹ä»¶ã€‚</p>

<p>ä½¿ç”¨ BitVMï¼Œæ©‹å¯ä»¥é€™æ¨£é‹ä½œï¼šç”¨æˆ¶åœ¨æ¯”ç‰¹å¹£ä¸Šé–å®šè³‡é‡‘ï¼Œåœ¨ç›®æ¨™éˆï¼ˆå¦‚ä»¥å¤ªåŠï¼‰ä¸Šæ”¶åˆ°ç­‰å€¼ä»£å¹£ã€‚ç•¶ç”¨æˆ¶æƒ³è¦è´–å›æ™‚ï¼Œåœ¨ç›®æ¨™éˆä¸ŠéŠ·æ¯€ä»£å¹£ï¼Œç„¶å¾Œ Operator åœ¨æ¯”ç‰¹å¹£ä¸Šé‡‹æ”¾è³‡é‡‘çµ¦ç”¨æˆ¶ã€‚</p>

<p>å¦‚æœ Operator èª å¯¦ï¼Œæµç¨‹é †åˆ©é€²è¡Œã€‚å¦‚æœ Operator ä¸é‡‹æ”¾è³‡é‡‘æˆ–å˜—è©¦æ¬ºè©ï¼Œç”¨æˆ¶ï¼ˆæˆ–ä»»ä½•è§€å¯Ÿè€…ï¼‰å¯ä»¥ç™¼èµ· BitVM æŒ‘æˆ°ï¼Œè­‰æ˜ Operator çš„è²æ˜æ˜¯éŒ¯èª¤çš„ï¼Œå¾è€Œç²å¾— Operator çš„è³ªæŠ¼é‡‘ä¸¦æ¢å¾©è³‡é‡‘ã€‚</p>

<p>é€™å‰µé€ äº†ä¸€å€‹ã€Œ1-of-Nã€çš„ä¿¡ä»»æ¨¡å‹ï¼šåªè¦æœ‰ä¸€å€‹èª å¯¦çš„ Verifier åœ¨ç›£æ§ï¼Œæ¬ºè©å°±æœƒè¢«ç™¼ç¾å’Œæ‡²ç½°ã€‚é€™æ¯”ã€ŒM-of-Nã€çš„å¤šç°½æ¨¡å‹å®‰å…¨å¾—å¤šï¼Œå› ç‚ºå¾Œè€…éœ€è¦å¤§å¤šæ•¸åƒèˆ‡è€…èª å¯¦ã€‚</p>

<p>å…¶ä»–æ‡‰ç”¨åŒ…æ‹¬ ZK è­‰æ˜é©—è­‰ï¼ˆåœ¨æ¯”ç‰¹å¹£ä¸Šé©—è­‰é›¶çŸ¥è­˜è­‰æ˜çš„æ­£ç¢ºæ€§ï¼‰ã€è¤‡é›œçš„ DeFi é‚è¼¯ï¼ˆå€Ÿè²¸ã€è‡ªå‹•åšå¸‚å•†ç­‰ï¼Œé›–ç„¶äº’å‹•æ€§æœ‰é™åˆ¶ï¼‰ã€ä»¥åŠè¨ˆç®—å¯†é›†å‹çš„åˆç´„ï¼ˆä»»ä½•å¯ä»¥ç·¨è­¯æˆé›»è·¯çš„ç¨‹å¼ï¼‰ã€‚</p>

<h3 id="44-bitvm-çš„é™åˆ¶">4.4 BitVM çš„é™åˆ¶</h3>

<p>BitVM ä¸æ˜¯è¬èƒ½çš„ï¼Œå®ƒæœ‰é¡¯è‘—çš„é™åˆ¶ã€‚</p>

<p>äº’å‹•æ€§è¦æ±‚ï¼šæŒ‘æˆ°å”è­°éœ€è¦é›™æ–¹å¤šè¼ªäº’å‹•ã€‚å¦‚æœä¸€æ–¹é›¢ç·šï¼Œå”è­°å¯èƒ½è¶…æ™‚ã€‚é€™ä½¿å¾— BitVM æ›´é©åˆæœ‰æ˜ç¢ºäº¤æ˜“å°æ‰‹çš„å ´æ™¯ï¼Œè€Œä¸æ˜¯é–‹æ”¾å¼çš„æ™ºèƒ½åˆç´„ã€‚</p>

<p>å»¶é²ï¼šæŒ‘æˆ°æœŸï¼ˆé€šå¸¸ä¸€åˆ°å…©é€±ï¼‰æ˜¯å¿…è¦çš„ï¼Œä»¥ç¢ºä¿æœ‰è¶³å¤ æ™‚é–“ç™¼ç¾å’Œè­‰æ˜æ¬ºè©ã€‚é€™æ„å‘³è‘— BitVM ä¸é©åˆéœ€è¦å³æ™‚çµç®—çš„æ‡‰ç”¨ã€‚</p>

<p>è¤‡é›œæ€§ï¼šå¯¦ç¾ä¸€å€‹å®‰å…¨çš„ BitVM ç³»çµ±éœ€è¦å¤§é‡çš„å·¥ç¨‹åŠªåŠ›ã€‚é ç°½äº¤æ˜“çš„æ•¸é‡å¯èƒ½éå¸¸é¾å¤§ï¼Œå­˜å„²å’Œç®¡ç†æ˜¯æŒ‘æˆ°ã€‚</p>

<p>æœ‰é™çš„è¡¨é”èƒ½åŠ›ï¼šé›–ç„¶ç†è«–ä¸Šå¯ä»¥é©—è­‰ä»»æ„è¨ˆç®—ï¼Œä½†å¯¦éš›ä¸Šå—åˆ°é›»è·¯å¤§å°å’ŒæŒ‘æˆ°è¼ªæ•¸çš„é™åˆ¶ã€‚</p>

<p>å„˜ç®¡æœ‰é€™äº›é™åˆ¶ï¼ŒBitVM ä»£è¡¨äº†åœ¨æ¯”ç‰¹å¹£ä¸Šå¯¦ç¾æ›´è¤‡é›œé‚è¼¯çš„é‡è¦ä¸€æ­¥ï¼Œè€Œä¸”ä¸éœ€è¦ä»»ä½•å”è­°è®Šæ›´ã€‚</p>

<hr />

<h2 id="äº”è…³æœ¬å„ªåŒ–å¯¦è¸">äº”ã€è…³æœ¬å„ªåŒ–å¯¦è¸</h2>

<h3 id="51-å¤§å°èˆ‡è²»ç”¨çš„é—œä¿‚">5.1 å¤§å°èˆ‡è²»ç”¨çš„é—œä¿‚</h3>

<p>åœ¨æ¯”ç‰¹å¹£ä¸­ï¼Œäº¤æ˜“è²»ç”¨ä¸»è¦ç”±äº¤æ˜“çš„ã€Œè™›æ“¬å¤§å°ã€ï¼ˆvbytesï¼‰æ±ºå®šã€‚è™›æ“¬å¤§å°çš„è¨ˆç®—è€ƒæ…®äº† SegWit çš„æ¬Šé‡æŠ˜æ‰£ï¼šé witness æ•¸æ“šæ¯ä½å…ƒçµ„è¨ˆ 4 å€‹æ¬Šé‡å–®ä½ï¼Œwitness æ•¸æ“šæ¯ä½å…ƒçµ„è¨ˆ 1 å€‹æ¬Šé‡å–®ä½ã€‚è™›æ“¬å¤§å° = (ç¸½æ¬Šé‡ + 3) / 4ã€‚</p>

<p>é€™æ„å‘³è‘—å„ªåŒ–è…³æœ¬å¤§å°å¯ä»¥ç›´æ¥ç¯€çœè²»ç”¨ã€‚å°æ–¼å¤šç°½åã€è¤‡é›œæ¢ä»¶ç­‰å ´æ™¯ï¼Œç²¾å¿ƒè¨­è¨ˆçš„è…³æœ¬å¯èƒ½æ¯”æ¨¸ç´ å¯¦ç¾ç¯€çœ 20-30% çš„è²»ç”¨ã€‚</p>

<h3 id="52-å¯¦ç”¨å„ªåŒ–æŠ€å·§">5.2 å¯¦ç”¨å„ªåŒ–æŠ€å·§</h3>

<p>åˆ©ç”¨éš±å¼æ“ä½œç¢¼ã€‚OP_CHECKSIG åœ¨å¤±æ•—æ™‚æœƒä½¿æ•´å€‹è…³æœ¬å¤±æ•—ï¼Œæ‰€ä»¥ä¸éœ€è¦é¡å¤–çš„ OP_VERIFYã€‚é¡ä¼¼åœ°ï¼ŒOP_EQUALVERIFYã€OP_CHECKSIGVERIFY ç­‰åˆä½µæ“ä½œç¢¼æ¯”åˆ†é–‹çš„æ“ä½œæ›´ç·Šæ¹Šã€‚</p>

<p>é‡ç”¨å †ç–Šå…ƒç´ ã€‚å¦‚æœåŒä¸€å€‹å€¼éœ€è¦ä½¿ç”¨å¤šæ¬¡ï¼Œç”¨ OP_DUP è¤‡è£½æ¯”å†æ¬¡æ¨å…¥å †ç–Šæ›´ç¯€çœç©ºé–“ã€‚</p>

<p>ä½¿ç”¨æœ€çŸ­ç·¨ç¢¼ã€‚OP_1 åˆ° OP_16 å„åªéœ€ 1 å€‹ä½å…ƒçµ„ï¼Œè€Œæ¨å…¥å°æ‡‰çš„æ•¸å­—éœ€è¦ 2 å€‹ä½å…ƒçµ„ã€‚è² æ•¸å’Œå¤§æ•¸å­—çš„ç·¨ç¢¼ä¹Ÿè¦æ³¨æ„ä½¿ç”¨æœ€å°è¡¨ç¤ºã€‚</p>

<p>å„ªåŒ– Taproot è…³æœ¬æ¨¹ã€‚å°‡æœ€å¯èƒ½ä½¿ç”¨çš„è…³æœ¬æ”¾åœ¨æ¨¹çš„æ·ºå±¤ï¼ˆæ¥è¿‘æ ¹éƒ¨ï¼‰ï¼Œé€™æ¨£èŠ±è²»æ™‚éœ€è¦æ­ç¤ºçš„ Merkle è·¯å¾‘æ›´çŸ­ã€‚å°æ–¼å¤šæ¢ä»¶è…³æœ¬ï¼Œä»”ç´°åˆ†ææ¯æ¢è·¯å¾‘çš„ä½¿ç”¨æ¦‚ç‡ã€‚</p>

<p>è€ƒæ…®èšåˆã€‚å°æ–¼ n-of-n å¤šç°½ï¼Œä½¿ç”¨ MuSig2 å°‡æ‰€æœ‰ç°½åèšåˆæˆä¸€å€‹ï¼Œé€™æ¯” n å€‹ç¨ç«‹ç°½åç¯€çœå¤§é‡ç©ºé–“ã€‚å³ä½¿å°æ–¼ m-of-nï¼Œæœ‰æ™‚å€™ä¹Ÿå¯ä»¥è¨­è¨ˆå‚™ç”¨çš„èšåˆè·¯å¾‘ã€‚</p>

<h3 id="53-å®‰å…¨èˆ‡æ•ˆç‡çš„æ¬Šè¡¡">5.3 å®‰å…¨èˆ‡æ•ˆç‡çš„æ¬Šè¡¡</h3>

<p>å„ªåŒ–ä¸èƒ½ä»¥çŠ§ç‰²å®‰å…¨ç‚ºä»£åƒ¹ã€‚ä¸€äº›éœ€è¦æ³¨æ„çš„é™·é˜±åŒ…æ‹¬ä»¥ä¸‹å¹¾é»ã€‚</p>

<p>ä¸è¦è·³éå¿…è¦çš„é©—è­‰ã€‚ä¾‹å¦‚ï¼Œç¢ºä¿æ‰€æœ‰åˆ†æ”¯éƒ½æ­£ç¢ºçµ‚æ­¢ï¼Œå³ä½¿çœ‹èµ·ä¾†ã€Œä¸å¯é”ã€çš„åˆ†æ”¯ä¹Ÿå¯èƒ½å› ç‚ºæ„å¤–è¼¸å…¥è€Œè¢«åŸ·è¡Œã€‚</p>

<p>æ³¨æ„ç°½åé›œæ¹Šé¡å‹ã€‚SIGHASH_NONE å’Œ SIGHASH_SINGLE å¯èƒ½æ„å¤–åœ°å…è¨±ä¿®æ”¹è¼¸å‡ºï¼Œåªæœ‰åœ¨å®Œå…¨ç†è§£å…¶å½±éŸ¿æ™‚æ‰ä½¿ç”¨ã€‚</p>

<p>æ™‚é–“é–éœ€è¦å®‰å…¨é‚Šéš›ã€‚å€å¡Šæ™‚é–“æœ‰æ³¢å‹•ï¼ŒMTP èˆ‡å¯¦éš›æ™‚é–“å¯èƒ½æœ‰åå·®ã€‚è¨­è¨ˆæ™‚é–“é–æ™‚è¦ç•™æœ‰é¤˜è£•ã€‚</p>

<p>æ¸¬è©¦æ‰€æœ‰è·¯å¾‘ã€‚ä½¿ç”¨è…³æœ¬èª¿è©¦å·¥å…·ï¼ˆå¦‚ btcdebï¼‰æ¸¬è©¦è…³æœ¬çš„æ¯æ¢å¯èƒ½åŸ·è¡Œè·¯å¾‘ï¼ŒåŒ…æ‹¬å¤±æ•—æƒ…æ³ã€‚</p>

<hr />

<h2 id="å…­æœªä¾†å±•æœ›">å…­ã€æœªä¾†å±•æœ›</h2>

<h3 id="61-ç•¶å‰è…³æœ¬èƒ½åŠ›ç¸½çµ">6.1 ç•¶å‰è…³æœ¬èƒ½åŠ›ç¸½çµ</h3>

<p>è®“æˆ‘å€‘ç¸½çµä¸€ä¸‹æ¯”ç‰¹å¹£è…³æœ¬ç›®å‰èƒ½åšä»€éº¼å’Œä¸èƒ½åšä»€éº¼ã€‚</p>

<p>å¯ä»¥åšåˆ°çš„åŒ…æ‹¬ï¼šå„ç¨®ç°½åé©—è­‰ï¼ˆå–®ç°½ã€å¤šç°½ã€èšåˆç°½åï¼‰ã€çµ•å°å’Œç›¸å°æ™‚é–“é–ã€é›œæ¹Šé–å’Œ HTLCã€è¤‡é›œçš„æ¢ä»¶é‚è¼¯ã€Taproot çš„éš±è—è…³æœ¬æ¨¹ã€é ç°½äº¤æ˜“å¯¦ç¾çš„ Vaultã€ä¾è³´ç¥è«­çš„ DLCã€é€éæ¨‚è§€åŸ·è¡Œçš„ä»»æ„è¨ˆç®—é©—è­‰ï¼ˆBitVMï¼‰ã€‚</p>

<p>ç„¡æ³•ç›´æ¥åšåˆ°ï¼ˆéœ€è¦å”è­°å‡ç´šï¼‰çš„åŒ…æ‹¬ï¼šæª¢æŸ¥èŠ±è²»äº¤æ˜“çš„è¼¸å‡ºç›®çš„åœ°ã€æª¢æŸ¥èŠ±è²»äº¤æ˜“çš„è¼¸å‡ºé‡‘é¡ã€å¾ªç’°å’Œéè¿´è¨ˆç®—ã€åŸç”Ÿçš„é›¶çŸ¥è­˜è­‰æ˜é©—è­‰ã€å®Œå…¨éˆæ´»çš„ Covenantã€‚</p>

<h3 id="62-å¯èƒ½çš„å”è­°å‡ç´š">6.2 å¯èƒ½çš„å”è­°å‡ç´š</h3>

<p>æ¯”ç‰¹å¹£çš„å‡ç´šéç¨‹è¬¹æ…è€Œç·©æ…¢ï¼Œä½†ç¤¾å€æ­£åœ¨ç©æ¥µè¨è«–å¹¾å€‹å¯èƒ½çš„æ”¹é€²ã€‚</p>

<p>çŸ­æœŸå¯èƒ½å¯¦ç¾çš„åŒ…æ‹¬ï¼šOP_CTV å·²ç¶“éå¤šå¹´å¯©æŸ¥ï¼Œæœ‰å¯èƒ½åœ¨æœªä¾†å¹¾å¹´å…§é€éè»Ÿåˆ†å‰æ¿€æ´»ã€‚å®ƒå°‡å•Ÿç”¨æ“å¡æ§åˆ¶å’Œæ”¹é€²çš„ Vaultï¼ŒåŒæ™‚é¢¨éšªç›¸å°è¼ƒä½ã€‚</p>

<p>OP_CAT çš„å¾©æ´»ä¹Ÿåœ¨è¨è«–ä¸­ã€‚é›–ç„¶å®ƒå–®ç¨åŠŸèƒ½æœ‰é™ï¼Œä½†èˆ‡ç¾æœ‰æ“ä½œç¢¼çµ„åˆå¯ä»¥å¯¦ç¾è¨±å¤š Covenant ç”¨ä¾‹ã€‚ç”±æ–¼ Tapscript æœ‰å †ç–Šå…ƒç´ å¤§å°é™åˆ¶ï¼Œæ—©æœŸçš„å®‰å…¨æ“”æ†‚å·²å¤§å¤§æ¸›è¼•ã€‚</p>

<p>ä¸­æœŸå¯èƒ½æ¢ç´¢çš„åŒ…æ‹¬ï¼šOP_VAULT æä¾›äº†å°ˆé–€çš„ Vault åŠŸèƒ½ï¼Œæ¯”é€šç”¨ Covenant æ›´å®¹æ˜“åˆ†æå½±éŸ¿ã€‚SIGHASH_ANYPREVOUT å…è¨±æ›´å¥½çš„é–ƒé›»ç¶²è·¯å”è­°ï¼ˆå¦‚ Eltooï¼‰ï¼Œå¯èƒ½èˆ‡å…¶ä»–å‡ç´šä¸€èµ·æ‰“åŒ…ã€‚</p>

<p>é•·æœŸç ”ç©¶æ–¹å‘åŒ…æ‹¬ï¼šåŸç”Ÿ ZK é©—è­‰å°‡å…è¨±åœ¨æ¯”ç‰¹å¹£ä¸Šç›´æ¥é©—è­‰é›¶çŸ¥è­˜è­‰æ˜ï¼Œé€™å°å¯æ“´å±•æ€§å’Œéš±ç§æœ‰æ·±é å½±éŸ¿ã€‚æ›´å¼·å¤§çš„ Covenant å’Œè…³æœ¬èƒ½åŠ›ä¹Ÿåœ¨ç ”ç©¶ä¸­ï¼Œä½†éœ€è¦åœ¨åŠŸèƒ½å’Œé¢¨éšªä¹‹é–“æ‰¾åˆ°å¹³è¡¡ã€‚</p>

<h3 id="63-ç”Ÿæ…‹ç³»çµ±çš„ç™¼å±•">6.3 ç”Ÿæ…‹ç³»çµ±çš„ç™¼å±•</h3>

<p>é™¤äº†å”è­°å±¤é¢çš„è®ŠåŒ–ï¼Œæ¯”ç‰¹å¹£è…³æœ¬çš„æ‡‰ç”¨ç”Ÿæ…‹ä¹Ÿåœ¨å¿«é€Ÿç™¼å±•ã€‚</p>

<p>å·¥å…·éˆåœ¨æ”¹é€²ã€‚Miniscript æä¾›äº†ä¸€ç¨®æ›´å®‰å…¨çš„æ–¹å¼ä¾†ç·¨å¯«å’Œåˆ†æè…³æœ¬ï¼Œè¨±å¤šéŒ¢åŒ…å’Œæœå‹™æ­£åœ¨æ¡ç”¨ã€‚è…³æœ¬èª¿è©¦ã€å½¢å¼é©—è­‰ã€è‡ªå‹•æ¸¬è©¦å·¥å…·éƒ½åœ¨é€²æ­¥ã€‚</p>

<p>æ¨™æº–åŒ–åœ¨æ¨é€²ã€‚æè¿°ç¬¦ï¼ˆDescriptorsï¼‰æˆç‚ºéŒ¢åŒ…å‚™ä»½å’Œæ¢å¾©çš„æ¨™æº–æ ¼å¼ã€‚PSBT ä½¿å¤šæ–¹å”ä½œæ›´åŠ å®¹æ˜“ã€‚MuSig2 çš„å»£æ³›æ¡ç”¨æå‡äº†å¤šç°½çš„æ•ˆç‡å’Œéš±ç§ã€‚</p>

<p>æ‡‰ç”¨åœ¨æ“´å±•ã€‚é–ƒé›»ç¶²è·¯æŒçºŒå¢é•·ï¼ŒDLC å¹³å°é–‹å§‹ä¸Šç·šï¼ŒVault è§£æ±ºæ–¹æ¡ˆé€²å…¥ç”Ÿç”¢ç’°å¢ƒã€‚é€™äº›æ‡‰ç”¨é©—è­‰äº†æ¯”ç‰¹å¹£è…³æœ¬çš„å¯¦ç”¨æ€§ï¼Œä¹Ÿæ¨å‹•äº†é€²ä¸€æ­¥çš„å‰µæ–°ã€‚</p>

<hr />

<h2 id="ä¸ƒå¯¦ä½œç·´ç¿’">ä¸ƒã€å¯¦ä½œç·´ç¿’</h2>

<h3 id="ç·´ç¿’-1è¨­è¨ˆ-dlc-çµæ§‹">ç·´ç¿’ 1ï¼šè¨­è¨ˆ DLC çµæ§‹</h3>

<p>é¸æ“‡ä¸€å€‹ç°¡å–®çš„äºŒå…ƒäº‹ä»¶ï¼ˆå¦‚ã€Œæ˜å¤©æœƒä¸‹é›¨å—ï¼Ÿã€ï¼‰ï¼Œè¨­è¨ˆå®Œæ•´çš„ DLC çµæ§‹ã€‚è€ƒæ…®ï¼šå¦‚ä½•æ‰¾åˆ°å¯é çš„ç¥è«­ï¼Ÿå¦‚ä½•è™•ç†ç¥è«­ä¸ç™¼å¸ƒçµæœçš„æƒ…æ³ï¼Ÿè¨ˆç®—éœ€è¦å¤šå°‘å€‹ CETã€‚</p>

<h3 id="ç·´ç¿’-2é ç°½-vault-å¯¦ç¾">ç·´ç¿’ 2ï¼šé ç°½ Vault å¯¦ç¾</h3>

<p>ä½¿ç”¨ä½ ç†Ÿæ‚‰çš„æ¯”ç‰¹å¹£ç¨‹å¼åº«ï¼Œå¯¦ç¾ä¸€å€‹ç°¡åŒ–çš„é ç°½ Vaultã€‚åŒ…æ‹¬ï¼šå‰µå»º Vault è¼¸å‡ºã€é ç°½ Unvault å’Œ Withdrawal äº¤æ˜“ã€æ¨¡æ“¬æ­£å¸¸ææ¬¾å’Œç·Šæ€¥æ¢å¾©æµç¨‹ã€‚æ€è€ƒåœ¨ç”Ÿç”¢ç’°å¢ƒä¸­éœ€è¦è§£æ±ºçš„é¡å¤–å•é¡Œã€‚</p>

<h3 id="ç·´ç¿’-3ctv-æ“å¡æ§åˆ¶æ¨¡æ“¬">ç·´ç¿’ 3ï¼šCTV æ“å¡æ§åˆ¶æ¨¡æ“¬</h3>

<p>å‡è¨­ CTV å·²ç¶“æ¿€æ´»ï¼Œè¨­è¨ˆä¸€å€‹æ“å¡æ§åˆ¶æ¨¹ä¾†è™•ç† 1000 å€‹æ¥æ”¶è€…çš„æ‰¹é‡æ”¯ä»˜ã€‚è¨ˆç®—ä¸åŒæ¨¹çµæ§‹ï¼ˆæ·±åº¦ã€åˆ†æ”¯å› å­ï¼‰çš„æ¬Šè¡¡ï¼Œæ¯”è¼ƒèˆ‡å‚³çµ±å¤§äº¤æ˜“çš„è²»ç”¨å·®ç•°ã€‚</p>

<hr />

<h2 id="å…«ç¸½çµ">å…«ã€ç¸½çµ</h2>

<p>é€™ä¸€ç³»åˆ—æ–‡ç« å¸¶ä½ å¾æ¯”ç‰¹å¹£è…³æœ¬çš„åŸºç¤èµ°åˆ°äº†æœ€å‰æ²¿çš„æ‡‰ç”¨ã€‚è®“æˆ‘å€‘å›é¡§é—œéµè¦é»ã€‚</p>

<p>æ¯”ç‰¹å¹£è…³æœ¬æ˜¯ä¸€å€‹æœ‰æ„è¨­è¨ˆç‚ºå—é™çš„ç³»çµ±ï¼Œå®ƒä¸æ˜¯ç‚ºäº†èˆ‡ä»¥å¤ªåŠç«¶çˆ­ã€Œæ™ºèƒ½åˆç´„å¹³å°ã€çš„åœ°ä½ï¼Œè€Œæ˜¯ç‚ºäº†æä¾›å®‰å…¨ã€å¯é©—è­‰ã€å¯é æ¸¬çš„åƒ¹å€¼è½‰ç§»èƒ½åŠ›ã€‚åœ¨é€™å€‹è¨­è¨ˆç©ºé–“å…§ï¼Œæˆ‘å€‘ä»ç„¶å¯ä»¥æ§‹å»ºä»¤äººå°è±¡æ·±åˆ»çš„æ‡‰ç”¨ã€‚</p>

<p>å¤šç°½å’Œæ™‚é–“é–æ˜¯å…©å€‹æœ€åŸºæœ¬çš„æ§‹å»ºå¡Šã€‚å¤šç°½å°‡æ§åˆ¶æ¬Šå¾å–®é»åˆ†æ•£åˆ°å¤šé»ï¼Œæ™‚é–“é–åœ¨æ™‚é–“ç¶­åº¦ä¸Šå¢åŠ æ¢ä»¶ã€‚é€™å…©è€…çš„çµ„åˆï¼ˆåŠ ä¸Šå“ˆå¸Œé–ï¼‰ä½¿å¾— HTLC æˆç‚ºå¯èƒ½ï¼Œè€Œ HTLC æ˜¯é–ƒé›»ç¶²è·¯å’ŒåŸå­äº¤æ›çš„åŸºç¤ã€‚</p>

<p>Taproot æ˜¯è…³æœ¬èƒ½åŠ›çš„ä¸€æ¬¡é‡å¤§é£›èºã€‚é€é MAST çµæ§‹ï¼Œè¤‡é›œçš„æ¢ä»¶é‚è¼¯å¯ä»¥ä¿æŒéš±è—ï¼›é€é Schnorr ç°½åï¼Œå¤šæ–¹å”ä½œå¯ä»¥çœ‹èµ·ä¾†åƒå–®æ–¹æ“ä½œã€‚é€™å°éš±ç§å’Œæ•ˆç‡éƒ½æœ‰æ·±é å½±éŸ¿ã€‚</p>

<p>DLCã€Vaultã€BitVM ä»£è¡¨äº†åœ¨ç¾æœ‰èƒ½åŠ›ä¸‹çš„æ¥µé™æ¢ç´¢ã€‚å®ƒå€‘å±•ç¤ºäº†å‰µæ„å’Œå¯†ç¢¼å­¸å¦‚ä½•çªç ´è¡¨é¢çš„é™åˆ¶ï¼Œå¯¦ç¾ä¹‹å‰èªç‚ºä¸å¯èƒ½çš„åŠŸèƒ½ã€‚</p>

<p>Covenant çš„è¨è«–åæ˜ äº†æ¯”ç‰¹å¹£ç¤¾å€åœ¨åŠŸèƒ½æ“´å±•å’Œé¢¨éšªæ§åˆ¶ä¹‹é–“çš„æŒçºŒæ¬Šè¡¡ã€‚é€™ä¸æ˜¯ä¸€å€‹ç°¡å–®çš„æŠ€è¡“å•é¡Œï¼Œè€Œæ˜¯æ¶‰åŠç¶“æ¿Ÿæ¿€å‹µã€å¯©æŸ¥æŠµæŠ—ã€é•·æœŸå¯æŒçºŒæ€§çš„è¤‡é›œè€ƒé‡ã€‚</p>

<p>ç„¡è«–æœªä¾†å¦‚ä½•ç™¼å±•ï¼Œç†è§£æ¯”ç‰¹å¹£è…³æœ¬çš„ç•¶å‰èƒ½åŠ›å’Œé™åˆ¶å°æ–¼ä»»ä½•æ¯”ç‰¹å¹£é–‹ç™¼è€…éƒ½æ˜¯å¿…è¦çš„ã€‚å¸Œæœ›é€™å€‹ç³»åˆ—çµ¦ä½ æä¾›äº†ä¸€å€‹å …å¯¦çš„åŸºç¤ã€‚</p>

<hr />

<h2 id="åƒè€ƒè³‡æ–™">åƒè€ƒè³‡æ–™</h2>

<ul>
  <li><a href="https://github.com/discreetlogcontracts/dlcspecs">DLC è¦ç¯„</a> - DLC çš„æ­£å¼è¦æ ¼</li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0119.mediawiki">BIP 119: OP_CHECKTEMPLATEVERIFY</a> - CTV ææ¡ˆ</li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0345.mediawiki">BIP 345: OP_VAULT</a> - Vault å°ˆç”¨æ“ä½œç¢¼ææ¡ˆ</li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0347.mediawiki">BIP 347: OP_CAT</a> - OP_CAT å¾©æ´»ææ¡ˆ</li>
  <li><a href="https://bitvm.org/bitvm.pdf">BitVM ç™½çš®æ›¸</a> - BitVM çš„åŸå§‹è«–æ–‡</li>
  <li><a href="https://covenants.info/">Covenant è³‡è¨Šé›†åˆ</a> - å„ç¨® Covenant ææ¡ˆçš„æ¯”è¼ƒ</li>
  <li><a href="https://bitcoinops.org/">Bitcoin Optech</a> - æ¯”ç‰¹å¹£æŠ€è¡“çš„æœ€æ–°ç™¼å±•</li>
  <li><a href="https://bitcoin.sipa.be/miniscript/">Miniscript</a> - æ›´å®‰å…¨çš„è…³æœ¬ç·¨å¯«æ–¹å¼</li>
</ul>]]></content><author><name>Cypherpunks Taiwan</name></author><category term="æŠ€è¡“æ•™å­¸" /><category term="bitcoin" /><category term="development" /><category term="bitcoin" /><category term="script" /><category term="dlc" /><category term="vault" /><category term="covenant" /><summary type="html"><![CDATA[Bitcoin Script ç³»åˆ—æœ€çµ‚ç¯‡ï¼Œæ¢è¨ DLCã€Vaultã€Covenant ç­‰é€²éšæ‡‰ç”¨ï¼Œä»¥åŠæ¯”ç‰¹å¹£è…³æœ¬æœªä¾†å¯èƒ½çš„ç™¼å±•æ–¹å‘ã€‚]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" /><media:content medium="image" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Bitcoin Script å¯¦æˆ°æ•™å­¸ï¼ˆäº”ï¼‰ï¼šæ™‚é–“é–æ©Ÿåˆ¶å®Œå…¨æŒ‡å—</title><link href="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/development/2025/03/19/bitcoin-script-tutorial-5-timelocks/" rel="alternate" type="text/html" title="Bitcoin Script å¯¦æˆ°æ•™å­¸ï¼ˆäº”ï¼‰ï¼šæ™‚é–“é–æ©Ÿåˆ¶å®Œå…¨æŒ‡å—" /><published>2025-03-19T00:00:00+00:00</published><updated>2025-03-19T00:00:00+00:00</updated><id>https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/development/2025/03/19/bitcoin-script-tutorial-5-timelocks</id><content type="html" xml:base="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/development/2025/03/19/bitcoin-script-tutorial-5-timelocks/"><![CDATA[<h2 id="ç³»åˆ—å°è¨€">ç³»åˆ—å°è¨€</h2>

<p>é€™æ˜¯ã€ŒBitcoin Script å¯¦æˆ°æ•™å­¸ã€ç³»åˆ—çš„ç¬¬äº”ç¯‡ã€‚æœ¬ç¯‡å°‡æ·±å…¥æ¢è¨æ™‚é–“é–æ©Ÿåˆ¶â€”â€”æ¯”ç‰¹å¹£è…³æœ¬ä¸­æ§åˆ¶ã€Œä½•æ™‚ã€å¯ä»¥èŠ±è²»è³‡é‡‘çš„å¼·å¤§å·¥å…·ã€‚æ™‚é–“é–æ˜¯æ§‹å»ºæ”¯ä»˜é€šé“ã€é–ƒé›»ç¶²è·¯ã€åŸå­äº¤æ›ç­‰é€²éšæ‡‰ç”¨çš„åŸºç¤æŠ€è¡“ï¼Œç†è§£å®ƒå°æ–¼æŒæ¡æ¯”ç‰¹å¹£æ™ºèƒ½åˆç´„è‡³é—œé‡è¦ã€‚</p>

<p><strong>ç³»åˆ—æ–‡ç« ï¼š</strong></p>
<ol>
  <li><a href="/bitcoin/development/2025/03/15/bitcoin-script-tutorial-1-fundamentals/">åŸºç¤æ¦‚å¿µèˆ‡æ“ä½œç¢¼</a></li>
  <li><a href="/bitcoin/development/2025/03/16/bitcoin-script-tutorial-2-standard-scripts/">æ¨™æº–è…³æœ¬é¡å‹è©³è§£</a></li>
  <li><a href="/bitcoin/development/2025/03/17/bitcoin-script-tutorial-3-segwit-taproot/">SegWit èˆ‡ Taproot</a></li>
  <li><a href="/bitcoin/development/2025/03/18/bitcoin-script-tutorial-4-multisig/">å¤šé‡ç°½åå®Œå…¨æŒ‡å—</a></li>
  <li><strong>æ™‚é–“é–æ©Ÿåˆ¶å®Œå…¨æŒ‡å—</strong>ï¼ˆæœ¬ç¯‡ï¼‰</li>
  <li>é€²éšæ‡‰ç”¨èˆ‡æ™ºèƒ½åˆç´„</li>
</ol>

<hr />

<h2 id="ä¸€ç†è§£æ™‚é–“é–">ä¸€ã€ç†è§£æ™‚é–“é–</h2>

<h3 id="11-ä»€éº¼æ˜¯æ™‚é–“é–">1.1 ä»€éº¼æ˜¯æ™‚é–“é–ï¼Ÿ</h3>

<p>åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæˆ‘å€‘ç¶“å¸¸é‡åˆ°æ™‚é–“ç›¸é—œçš„é™åˆ¶ï¼šéŠ€è¡Œå®šå­˜æœ‰åˆ°æœŸæ—¥ã€æ”¯ç¥¨å¯ä»¥é–‹ç«‹é æœŸæ”¯ç¥¨ã€éºå›‘åœ¨ç•¶äº‹äººå»ä¸–å‰ç„¡æ•ˆã€‚æ™‚é–“é–ï¼ˆTimelockï¼‰åœ¨æ¯”ç‰¹å¹£ä¸­å¯¦ç¾äº†é¡ä¼¼çš„æ¦‚å¿µï¼šå®ƒå…è¨±æˆ‘å€‘è¨­å®šæ¢ä»¶ï¼Œä½¿å¾—è³‡é‡‘åªèƒ½åœ¨ç‰¹å®šæ™‚é–“ä¹‹å¾Œæ‰èƒ½è¢«èŠ±è²»ã€‚</p>

<p>é€™å€‹çœ‹ä¼¼ç°¡å–®çš„åŠŸèƒ½ï¼Œå¯¦éš›ä¸Šæ˜¯æ§‹å»ºè¤‡é›œé‡‘èæ‡‰ç”¨çš„åŸºçŸ³ã€‚æƒ³åƒä¸€ä¸‹ï¼šå¦‚æœæ²’æœ‰æ™‚é–“é–ï¼Œå°±ç„¡æ³•å¯¦ç¾ã€Œå¦‚æœä¸‰å¤©å…§äº¤æ˜“æ²’æœ‰å®Œæˆï¼Œè³‡é‡‘è‡ªå‹•é€€å›ã€é€™æ¨£çš„æ¢ä»¶ã€‚è€Œé€™æ°æ°æ˜¯è·¨éˆåŸå­äº¤æ›å’Œé–ƒé›»ç¶²è·¯çš„æ ¸å¿ƒéœ€æ±‚ã€‚</p>

<p>æ¯”ç‰¹å¹£æ”¯æ´å…©ç¨®åŸºæœ¬é¡å‹çš„æ™‚é–“é–ï¼šçµ•å°æ™‚é–“é–æŒ‡å®šä¸€å€‹å…·é«”çš„æ™‚é–“é»æˆ–å€å¡Šé«˜åº¦ï¼Œè³‡é‡‘åœ¨æ­¤ä¹‹å‰ç„¡æ³•èŠ±è²»ï¼›ç›¸å°æ™‚é–“é–å‰‡æŒ‡å®šä¸€å€‹æ™‚é–“é•·åº¦ï¼Œå¾ UTXO è¢«å‰µå»ºï¼ˆç¢ºèªï¼‰å¾Œé–‹å§‹è¨ˆç®—ï¼Œç¶“éé€™æ®µæ™‚é–“å¾Œè³‡é‡‘æ‰èƒ½èŠ±è²»ã€‚</p>

<h3 id="12-æ™‚é–“çš„è¡¨ç¤ºæ–¹å¼">1.2 æ™‚é–“çš„è¡¨ç¤ºæ–¹å¼</h3>

<p>æ¯”ç‰¹å¹£çš„æ™‚é–“é–ä½¿ç”¨ä¸€å€‹å·§å¦™çš„æ©Ÿåˆ¶ä¾†å€åˆ†å€å¡Šé«˜åº¦å’Œ Unix æ™‚é–“æˆ³ï¼šå¦‚æœæ•¸å€¼å°æ–¼ 5 å„„ï¼ˆ500,000,000ï¼‰ï¼Œå®ƒè¢«è§£é‡‹ç‚ºå€å¡Šé«˜åº¦ï¼›å¦‚æœå¤§æ–¼æˆ–ç­‰æ–¼ 5 å„„ï¼Œå®ƒè¢«è§£é‡‹ç‚º Unix æ™‚é–“æˆ³ã€‚</p>

<p>é¸æ“‡ 5 å„„ä½œç‚ºåˆ†ç•Œé»æ˜¯ç¶“éæ·±æ€ç†Ÿæ…®çš„ã€‚æ¯”ç‰¹å¹£å¤§ç´„æ¯ 10 åˆ†é˜ç”¢ç”Ÿä¸€å€‹å€å¡Šï¼ŒæŒ‰æ­¤é€Ÿåº¦è¨ˆç®—ï¼Œé”åˆ° 5 å„„å€å¡Šéœ€è¦å¤§ç´„ 9,500 å¹´ã€‚è€Œ 5 å„„ç§’ä½œç‚º Unix æ™‚é–“æˆ³ï¼Œå°æ‡‰çš„æ˜¯ 1985 å¹´ 11 æœˆâ€”â€”é€™é¡¯ç„¶å·²ç¶“éå»äº†ã€‚å› æ­¤ï¼Œé€™å€‹åˆ†ç•Œé»åœ¨å¯é è¦‹çš„æœªä¾†éƒ½ä¸æœƒé€ æˆæ­§ç¾©ã€‚</p>

<p>å€å¡Šé«˜åº¦ä½œç‚ºæ™‚é–“åº¦é‡æœ‰å…¶ç¨ç‰¹å„ªå‹¢ï¼šå®ƒä¸å—æ™‚å€å½±éŸ¿ï¼Œä¸”èˆ‡æ¯”ç‰¹å¹£ç¶²è·¯çš„å¯¦éš›é€²å±•ç›´æ¥ç›¸é—œã€‚ä½†å€å¡Šç”¢ç”Ÿæ™‚é–“æœ‰æ³¢å‹•ï¼ˆå¯èƒ½ 5 åˆ†é˜ä¹Ÿå¯èƒ½ 20 åˆ†é˜ï¼‰ï¼Œæ‰€ä»¥å°æ–¼éœ€è¦ç²¾ç¢ºæ™‚é–“çš„å ´æ™¯ï¼Œæ™‚é–“æˆ³å¯èƒ½æ›´åˆé©ã€‚</p>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ¯”ç‰¹å¹£çš„æ™‚é–“æˆ³é©—è­‰ä¸ä½¿ç”¨ç•¶å‰æ™‚é–“ï¼Œè€Œæ˜¯ä½¿ç”¨ã€Œä¸­ä½æ™‚é–“éå»ã€ï¼ˆMedian Time Pastï¼ŒMTPï¼‰â€”â€”éå» 11 å€‹å€å¡Šæ™‚é–“æˆ³çš„ä¸­ä½æ•¸ã€‚é€™å€‹è¨­è¨ˆé˜²æ­¢äº†ç¤¦å·¥é€šéæ“ç¸±å–®å€‹å€å¡Šçš„æ™‚é–“æˆ³ä¾†å½±éŸ¿æ™‚é–“é–ã€‚</p>

<h3 id="13-å››ç¨®æ™‚é–“é–æ©Ÿåˆ¶">1.3 å››ç¨®æ™‚é–“é–æ©Ÿåˆ¶</h3>

<p>æ¯”ç‰¹å¹£å¯¦ç¾äº†å››ç¨®ä¸åŒå±¤ç´šçš„æ™‚é–“é–æ©Ÿåˆ¶ï¼Œå¯ä»¥æŒ‰ç…§å…©å€‹ç¶­åº¦é€²è¡Œåˆ†é¡ã€‚</p>

<p>æŒ‰æ™‚é–“é¡å‹åˆ†ï¼šnLocktime å’Œ CLTV æ˜¯çµ•å°æ™‚é–“é–ï¼ŒæŒ‡å®šå…·é«”çš„æ™‚é–“é»æˆ–å€å¡Šé«˜åº¦ï¼›nSequence å’Œ CSV æ˜¯ç›¸å°æ™‚é–“é–ï¼ŒæŒ‡å®šå¾ UTXO ç¢ºèªå¾Œç¶“éçš„æ™‚é–“ã€‚</p>

<p>æŒ‰å¯¦ç¾å±¤ç´šåˆ†ï¼šnLocktime å’Œ nSequence æ˜¯äº¤æ˜“å±¤ç´šçš„æ©Ÿåˆ¶ï¼Œå®ƒå€‘å½±éŸ¿æ•´å€‹äº¤æ˜“ä½•æ™‚å¯ä»¥è¢«æ‰“åŒ…é€²å€å¡Šï¼›CLTV å’Œ CSV æ˜¯è…³æœ¬å±¤ç´šçš„æ©Ÿåˆ¶ï¼Œå®ƒå€‘ä½œç‚ºè…³æœ¬ä¸­çš„æ“ä½œç¢¼ï¼Œåœ¨èŠ±è²»æ™‚é©—è­‰æ™‚é–“æ¢ä»¶ã€‚</p>

<p>é€™å››ç¨®æ©Ÿåˆ¶å„æœ‰å…¶è¨­è¨ˆç›®çš„å’Œé©ç”¨å ´æ™¯ï¼Œæ¥ä¸‹ä¾†æˆ‘å€‘å°‡é€ä¸€æ·±å…¥æ¢è¨ã€‚</p>

<hr />

<h2 id="äºŒnlocktimeäº¤æ˜“å±¤ç´šçµ•å°æ™‚é–“é–">äºŒã€nLocktimeï¼šäº¤æ˜“å±¤ç´šçµ•å°æ™‚é–“é–</h2>

<h3 id="21-è¨­è¨ˆèˆ‡æ­·å²">2.1 è¨­è¨ˆèˆ‡æ­·å²</h3>

<p>nLocktime æ˜¯æ¯”ç‰¹å¹£æœ€æ—©çš„æ™‚é–“é–æ©Ÿåˆ¶ï¼Œå¾å‰µä¸–å€å¡Šå°±å­˜åœ¨ã€‚å®ƒæ˜¯äº¤æ˜“çµæ§‹çš„ä¸€éƒ¨åˆ†ï¼Œä½”æ“šäº¤æ˜“æœ«å°¾çš„ 4 å€‹ä½å…ƒçµ„ã€‚é€™å€‹æ¬„ä½çš„è¨­è¨ˆåˆè¡·æ˜¯å¯¦ç¾ä¸€ç¨®ç¨±ç‚ºã€Œé«˜é »äº¤æ˜“é€šé“ã€çš„åŠŸèƒ½â€”â€”å…è¨±é›™æ–¹åœ¨éˆä¸‹å¿«é€Ÿæ›´æ–°äº¤æ˜“ï¼Œä½†é€™å€‹æ©Ÿåˆ¶å¾æœªå®Œæ•´å¯¦ç¾ã€‚</p>

<p>nLocktime çš„å·¥ä½œåŸç†ç›¸ç•¶ç›´æ¥ï¼šå¦‚æœè¨­ç½®äº†ä¸€å€‹éé›¶çš„ nLocktime å€¼ï¼Œé€™ç­†äº¤æ˜“åœ¨æŒ‡å®šçš„æ™‚é–“æˆ–å€å¡Šé«˜åº¦ä¹‹å‰ï¼Œä¸æœƒè¢«ç¤¦å·¥æ‰“åŒ…é€²å€å¡Šï¼Œä¹Ÿä¸æœƒè¢«ç¯€é»æ¥å—é€²è¨˜æ†¶æ± ã€‚</p>

<h3 id="22-å•Ÿç”¨æ¢ä»¶">2.2 å•Ÿç”¨æ¢ä»¶</h3>

<p>nLocktime çš„å•Ÿç”¨éœ€è¦ä¸€å€‹é¡å¤–æ¢ä»¶ï¼šäº¤æ˜“ä¸­è‡³å°‘æœ‰ä¸€å€‹è¼¸å…¥çš„ sequence æ¬„ä½ä¸ç­‰æ–¼ 0xFFFFFFFFï¼ˆæœ€å¤§å€¼ï¼‰ã€‚é€™å€‹è¨­è¨ˆæºæ–¼ sequence æ¬„ä½çš„åŸå§‹ç”¨é€”â€”â€”å…è¨±é€ééå¢ sequence ä¾†æ›´æ–°æœªç¢ºèªäº¤æ˜“ã€‚ç•¶æ‰€æœ‰è¼¸å…¥çš„ sequence éƒ½æ˜¯æœ€å¤§å€¼æ™‚ï¼Œè¡¨ç¤ºäº¤æ˜“æ˜¯ã€Œæœ€çµ‚çš„ã€ï¼ŒnLocktime å°‡è¢«å¿½ç•¥ã€‚</p>

<p>é€™å€‹æ©Ÿåˆ¶åœ¨å¯¦è¸ä¸­é€ æˆäº†ä¸€äº›æ··æ·†ã€‚è¨±å¤šéŒ¢åŒ…è»Ÿé«”åœ¨ä¸éœ€è¦æ™‚é–“é–æ™‚æœƒå°‡ sequence è¨­ç‚º 0xFFFFFFFFï¼Œæ­¤æ™‚å³ä½¿è¨­ç½®äº† nLocktime ä¹Ÿä¸æœƒç”Ÿæ•ˆã€‚å¦‚æœä½ è¦ä½¿ç”¨ nLocktimeï¼Œç¢ºä¿è‡³å°‘ä¸€å€‹è¼¸å…¥çš„ sequence å°æ–¼æœ€å¤§å€¼â€”â€”é€šå¸¸ä½¿ç”¨ 0xFFFFFFFEã€‚</p>

<h3 id="23-å¯¦éš›æ‡‰ç”¨èˆ‡é™åˆ¶">2.3 å¯¦éš›æ‡‰ç”¨èˆ‡é™åˆ¶</h3>

<p>nLocktime æœ€å¸¸è¦‹çš„æ‡‰ç”¨æ˜¯å‰µå»ºã€Œå»¶é²æ”¯ä»˜ã€â€”â€”ä¸€ç­†åœ¨æœªä¾†æŸå€‹æ™‚é–“é»æ‰ç”Ÿæ•ˆçš„äº¤æ˜“ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥å‰µå»ºä¸€ç­† nLocktime è¨­ç‚ºä¸€é€±å¾Œçš„äº¤æ˜“ï¼Œä½œç‚ºå°æŸäººçš„æ‰¿è«¾ï¼Œä½†ä¿ç•™åœ¨æ­¤ä¹‹å‰å–æ¶ˆçš„èƒ½åŠ›ã€‚</p>

<p>ç„¶è€Œï¼ŒnLocktime æœ‰ä¸€å€‹æ ¹æœ¬æ€§çš„é™åˆ¶ï¼šå®ƒåªæ˜¯ã€Œç´³å£«å”å®šã€ã€‚æŒæœ‰ç§é‘°çš„äººå¯ä»¥éš¨æ™‚å‰µå»ºä¸€ç­†æ–°äº¤æ˜“ï¼ˆæ²’æœ‰æ™‚é–“é–ï¼‰ï¼ŒèŠ±è²»ç›¸åŒçš„è¼¸å…¥ã€‚nLocktime äº¤æ˜“è¦ç­‰åˆ°è§£é–æ™‚é–“æ‰èƒ½å»£æ’­ï¼Œè€Œåœ¨æ­¤ä¹‹å‰ï¼Œç™¼é€è€…å®Œå…¨å¯ä»¥åæ‚”ã€‚</p>

<p>é€™å€‹é™åˆ¶æ„å‘³è‘— nLocktime ä¸é©åˆéœ€è¦å¼·åˆ¶åŸ·è¡Œçš„å ´æ™¯ã€‚æ¥æ”¶è€…ç„¡æ³•ç¢ºä¿¡è³‡é‡‘çœŸçš„æœƒåœ¨æœªä¾†åˆ°é”â€”â€”ç™¼é€è€…å¯èƒ½åœ¨åˆ°æœŸå‰èŠ±æ‰é€™äº›å¹£ã€‚å°æ–¼é€™äº›å ´æ™¯ï¼Œæˆ‘å€‘éœ€è¦è…³æœ¬å±¤ç´šçš„æ™‚é–“é–ã€‚</p>

<h3 id="24-è¨˜æ†¶æ± è¡Œç‚º">2.4 è¨˜æ†¶æ± è¡Œç‚º</h3>

<p>å¦ä¸€å€‹å¯¦ç”¨æ€§å•é¡Œæ˜¯è¨˜æ†¶æ± çš„è™•ç†æ–¹å¼ã€‚ç›®å‰çš„æ¯”ç‰¹å¹£ç¯€é»ä¸æœƒæ¥å— nLocktime å°šæœªè§£é–çš„äº¤æ˜“é€²å…¥è¨˜æ†¶æ± ã€‚é€™æ„å‘³è‘—ä½ ä¸èƒ½æå‰å°‡äº¤æ˜“ç™¼é€åˆ°ç¶²è·¯ä¸Šã€Œç­‰å¾…ã€â€”â€”ä½ éœ€è¦è‡ªå·±ä¿ç®¡é€™ç­†äº¤æ˜“ï¼Œç›´åˆ°æ™‚é–“åˆ°äº†å†å»£æ’­ã€‚</p>

<p>é€™å°ç”¨æˆ¶é«”é©—æœ‰æ˜é¡¯å½±éŸ¿ï¼šä½ å¿…é ˆç¢ºä¿åœ¨æ­£ç¢ºçš„æ™‚é–“ä¸Šç·šä¸¦å»£æ’­äº¤æ˜“ï¼Œæˆ–è€…ä¾è³´ç¬¬ä¸‰æ–¹æœå‹™ä¾†ä»£ç‚ºåŸ·è¡Œã€‚</p>

<hr />

<h2 id="ä¸‰op_checklocktimeverifycltv">ä¸‰ã€OP_CHECKLOCKTIMEVERIFYï¼ˆCLTVï¼‰</h2>

<h3 id="31-å¾äº¤æ˜“å±¤ç´šåˆ°è…³æœ¬å±¤ç´š">3.1 å¾äº¤æ˜“å±¤ç´šåˆ°è…³æœ¬å±¤ç´š</h3>

<p>CLTVï¼ˆCheck Lock Time Verifyï¼‰é€é BIP 65 åœ¨ 2015 å¹´åº•å¼•å…¥ï¼Œå¡«è£œäº† nLocktime ç•™ä¸‹çš„ç©ºç™½ã€‚èˆ‡ nLocktime ä¸åŒï¼ŒCLTV æ˜¯ä¸€å€‹è…³æœ¬æ“ä½œç¢¼ï¼Œåœ¨è…³æœ¬åŸ·è¡Œæ™‚å¼·åˆ¶æª¢æŸ¥æ™‚é–“æ¢ä»¶ã€‚</p>

<p>CLTV çš„è¨­è¨ˆéå¸¸ç²¾å·§ï¼šå®ƒè®€å–å †ç–Šé ‚ç«¯çš„å€¼ä½œç‚ºæ™‚é–“é–ï¼Œç„¶å¾Œé©—è­‰èŠ±è²»é€™ç­†è¼¸å‡ºçš„äº¤æ˜“çš„ nLocktime æ˜¯å¦æ»¿è¶³æ¢ä»¶ã€‚æ³¨æ„ï¼ŒCLTV æœ¬èº«ä¸æ¶ˆè€—å †ç–Šä¸Šçš„å€¼â€”â€”é€™æ˜¯ç‚ºäº†å…¼å®¹æ€§è€ƒæ…®ã€‚å› æ­¤ï¼Œä½¿ç”¨ CLTV å¾Œé€šå¸¸éœ€è¦ OP_DROP ä¾†æ¸…ç†å †ç–Šã€‚</p>

<h3 id="32-åŸ·è¡Œè¦å‰‡">3.2 åŸ·è¡Œè¦å‰‡</h3>

<p>CLTV çš„é©—è­‰é‚è¼¯æª¢æŸ¥å¹¾å€‹æ¢ä»¶ã€‚é¦–å…ˆï¼Œå †ç–Šé ‚ç«¯çš„å€¼å¿…é ˆæ˜¯éè² æ•¸ã€‚å…¶æ¬¡ï¼Œå †ç–Šé ‚ç«¯çš„å€¼å’Œäº¤æ˜“çš„ nLocktime å¿…é ˆä½¿ç”¨ç›¸åŒçš„æ™‚é–“é¡å‹â€”â€”å…©è€…éƒ½å°æ–¼ 5 å„„ï¼ˆå€å¡Šé«˜åº¦ï¼‰æˆ–éƒ½å¤§æ–¼ç­‰æ–¼ 5 å„„ï¼ˆæ™‚é–“æˆ³ï¼‰ã€‚æ··åˆä½¿ç”¨æœƒå°è‡´è…³æœ¬å¤±æ•—ã€‚</p>

<p>æœ€é—œéµçš„æª¢æŸ¥æ˜¯ï¼šäº¤æ˜“çš„ nLocktime å¿…é ˆå¤§æ–¼æˆ–ç­‰æ–¼è…³æœ¬ä¸­æŒ‡å®šçš„å€¼ã€‚é€™ç¢ºä¿äº†äº¤æ˜“è‡³å°‘è¦ç­‰åˆ°è…³æœ¬è¦å®šçš„æ™‚é–“æ‰èƒ½è¢«ç¢ºèªã€‚</p>

<p>æ­¤å¤–ï¼ŒCLTV é‚„è¦æ±‚èŠ±è²»é€™å€‹è¼¸å‡ºçš„è¼¸å…¥çš„ sequence ä¸èƒ½æ˜¯ 0xFFFFFFFFï¼Œå› ç‚ºé‚£æœƒç¦ç”¨ nLocktime æ©Ÿåˆ¶ã€‚</p>

<h3 id="33-ç‚ºä»€éº¼-cltv-ç„¡æ³•ç¹é">3.3 ç‚ºä»€éº¼ CLTV ç„¡æ³•ç¹é</h3>

<p>CLTV è§£æ±ºäº† nLocktime çš„ã€Œå¯ç¹éã€å•é¡Œã€‚ä¸€æ—¦è³‡é‡‘è¢«ç™¼é€åˆ°åŒ…å« CLTV çš„è…³æœ¬åœ°å€ï¼Œå°±æ²’æœ‰ä»»ä½•æ–¹æ³•å¯ä»¥åœ¨æŒ‡å®šæ™‚é–“ä¹‹å‰èŠ±è²»å®ƒâ€”â€”å³ä½¿æ‰€æœ‰ç›¸é—œç§é‘°çš„æŒæœ‰è€…éƒ½åŒæ„ä¹Ÿä¸è¡Œã€‚</p>

<p>é€™æ˜¯å› ç‚º CLTV æ¢ä»¶è¢«ç·¨ç¢¼åœ¨è…³æœ¬ä¸­ï¼Œè€Œè…³æœ¬æ˜¯è¼¸å‡ºçš„ä¸€éƒ¨åˆ†ã€‚èŠ±è²»é€™å€‹è¼¸å‡ºçš„ä»»ä½•äº¤æ˜“éƒ½å¿…é ˆæ»¿è¶³è…³æœ¬æ¢ä»¶ï¼Œæ²’æœ‰ä¾‹å¤–ã€‚å”¯ä¸€çš„æ–¹æ³•æ˜¯ç­‰å¾…æ™‚é–“åˆ°æœŸã€‚</p>

<h3 id="34-æ‡‰ç”¨å ´æ™¯éºç”¢è¦åŠƒ">3.4 æ‡‰ç”¨å ´æ™¯ï¼šéºç”¢è¦åŠƒ</h3>

<p>CLTV çš„ç¶“å…¸æ‡‰ç”¨ä¹‹ä¸€æ˜¯éºç”¢è¦åŠƒã€‚è€ƒæ…®é€™æ¨£çš„å ´æ™¯ï¼šAlice æƒ³è¦ç¢ºä¿å¦‚æœå¥¹ç™¼ç”Ÿæ„å¤–ï¼Œå¥¹çš„æ¯”ç‰¹å¹£å¯ä»¥è¢«å¥¹çš„å¥³å…’ Carol ç¹¼æ‰¿ã€‚ä½†å¥¹ä¸æƒ³ç¾åœ¨å°±æŠŠæ§åˆ¶æ¬Šäº¤çµ¦ Carolã€‚</p>

<p>ä½¿ç”¨ CLTVï¼ŒAlice å¯ä»¥å‰µå»ºä¸€å€‹é€™æ¨£çš„è…³æœ¬ï¼šæ­£å¸¸æƒ…æ³ä¸‹ Alice å¯ä»¥ç”¨è‡ªå·±çš„ç°½åèŠ±è²»ï¼›ä½†å¦‚æœè…³æœ¬ä¸­çš„æ™‚é–“æ¢ä»¶æ»¿è¶³ï¼ˆæ¯”å¦‚äº”å¹´å¾Œï¼‰ï¼ŒCarol ä¹Ÿå¯ä»¥ç”¨å¥¹çš„ç°½åèŠ±è²»ã€‚Alice å¯ä»¥æ¯éš”å¹¾å¹´å°‡è³‡é‡‘è½‰ç§»åˆ°æ–°çš„è…³æœ¬ï¼ˆæ›´æ–°æ™‚é–“é–ï¼‰ï¼Œåªè¦å¥¹ä»ç„¶å¥åœ¨ã€‚</p>

<p>é€™å€‹æ–¹æ¡ˆä¸éœ€è¦ä»»ä½•ä¿¡ä»»çš„ç¬¬ä¸‰æ–¹ï¼Œä¸éœ€è¦å¾‹å¸«æˆ–è¨—ç®¡æœå‹™ã€‚æ™‚é–“é–ç”±æ¯”ç‰¹å¹£å”è­°æœ¬èº«å¼·åˆ¶åŸ·è¡Œã€‚</p>

<h3 id="35-æ‡‰ç”¨å ´æ™¯åˆ†æœŸè§£é–">3.5 æ‡‰ç”¨å ´æ™¯ï¼šåˆ†æœŸè§£é–</h3>

<p>å¦ä¸€å€‹å¸¸è¦‹æ‡‰ç”¨æ˜¯åˆ†æœŸè§£é–ï¼Œç”¨æ–¼å“¡å·¥è‚¡æ¬Šæ¿€å‹µæˆ–æŠ•è³‡è€…é–å€‰ã€‚å‡è¨­å…¬å¸æ‰¿è«¾çµ¦å“¡å·¥åˆ†å››å¹´ç™¼æ”¾æ¯”ç‰¹å¹£çå‹µï¼Œæ¯å¹´è§£é– 25%ã€‚</p>

<p>å…¬å¸å¯ä»¥å‰µå»ºå››å€‹ç¨ç«‹çš„ UTXOï¼Œæ¯å€‹åŒ…å«ç¸½çå‹µçš„ 25%ï¼Œä¸¦è¨­ç½®ä¸åŒçš„ CLTV æ™‚é–“é–ï¼šç¬¬ä¸€å€‹ä¸€å¹´å¾Œè§£é–ï¼Œç¬¬äºŒå€‹å…©å¹´å¾Œï¼Œä¾æ­¤é¡æ¨ã€‚é€™æ¨£å“¡å·¥å¯ä»¥ç¢ºä¿¡å…¬å¸ç„¡æ³•æ’¤éŠ·æ‰¿è«¾ï¼ˆé™¤éå“¡å·¥æŠŠç§é‘°çµ¦äº†å…¬å¸ï¼‰ï¼Œè€Œå…¬å¸ä¹ŸçŸ¥é“å“¡å·¥ä¸èƒ½æå‰å–èµ°è³‡é‡‘ã€‚</p>

<hr />

<h2 id="å››nsequenceç›¸å°æ™‚é–“é–åŸºç¤">å››ã€nSequenceï¼šç›¸å°æ™‚é–“é–åŸºç¤</h2>

<h3 id="41-å¾å¤±æ•—çš„è¨­è¨ˆåˆ°é‡ç²æ–°ç”Ÿ">4.1 å¾å¤±æ•—çš„è¨­è¨ˆåˆ°é‡ç²æ–°ç”Ÿ</h3>

<p>nSequence æ¬„ä½çš„æ­·å²é —ç‚ºæ›²æŠ˜ã€‚åœ¨æ¯”ç‰¹å¹£æœ€åˆçš„è¨­è¨ˆä¸­ï¼Œä¸­æœ¬è°æ§‹æƒ³äº†ä¸€ç¨®æ©Ÿåˆ¶ï¼šæœªç¢ºèªäº¤æ˜“å¯ä»¥é€éæé«˜ sequence æ•¸å­—ä¾†ã€Œæ›´æ–°ã€ã€‚è¼ƒé«˜ sequence çš„äº¤æ˜“æœƒå–ä»£è¼ƒä½çš„ç‰ˆæœ¬ï¼Œè€Œç¤¦å·¥æœƒå„ªå…ˆæ‰“åŒ… sequence æœ€å¤§çš„äº¤æ˜“ã€‚</p>

<p>é€™å€‹è¨­è¨ˆå¾æœªæ­£ç¢ºå¯¦ç¾ï¼ŒåŸå› æ˜¯å®ƒå­˜åœ¨åš´é‡çš„æ¿€å‹µå•é¡Œã€‚ç¤¦å·¥æ²’æœ‰ç¾©å‹™éµå®ˆé€™å€‹è¦å‰‡â€”â€”ä»–å€‘å¯ä»¥æ‰“åŒ…ä»»ä½•æœ‰æ•ˆäº¤æ˜“ï¼ŒåŒ…æ‹¬ä½ sequence ä½†é«˜æ‰‹çºŒè²»çš„ç‰ˆæœ¬ã€‚é€™è®“æ•´å€‹æ©Ÿåˆ¶è®Šå¾—ä¸å¯é ã€‚</p>

<p>å¤šå¹´ä¾†ï¼Œsequence æ¬„ä½åŸºæœ¬ä¸Šè¢«å¿½ç•¥ï¼Œå¤§å¤šæ•¸éŒ¢åŒ…å°‡å…¶è¨­ç‚ºæœ€å¤§å€¼ã€‚ç›´åˆ° 2016 å¹´ï¼ŒBIP 68 é‡æ–°å®šç¾©äº†é€™å€‹æ¬„ä½çš„èªç¾©ï¼Œè³¦äºˆå®ƒç›¸å°æ™‚é–“é–çš„æ–°åŠŸèƒ½ã€‚</p>

<h3 id="42-bip-68-çš„èªç¾©å®šç¾©">4.2 BIP 68 çš„èªç¾©å®šç¾©</h3>

<p>BIP 68 å° sequence æ¬„ä½é€²è¡Œäº†ç²¾ç¢ºçš„ä½å…ƒå®šç¾©ã€‚æœ€é«˜ä½ï¼ˆbit 31ï¼‰æ˜¯ç¦ç”¨æ¨™èªŒï¼šå¦‚æœè¨­ç½®ï¼Œé€™å€‹è¼¸å…¥ä¸å—ç›¸å°æ™‚é–“é–é™åˆ¶ã€‚ç¬¬ 22 ä½æ˜¯é¡å‹æ¨™èªŒï¼šå¦‚æœè¨­ç½®ï¼Œæ™‚é–“é–ä»¥ 512 ç§’ç‚ºå–®ä½è¨ˆç®—ï¼›å¦å‰‡ä»¥å€å¡Šæ•¸è¨ˆç®—ã€‚æœ€ä½ 16 ä½ï¼ˆbits 0-15ï¼‰æ˜¯å¯¦éš›çš„é–å®šå€¼ã€‚</p>

<p>é€™å€‹è¨­è¨ˆå…è¨±çš„æœ€å¤§ç›¸å°æ™‚é–“é–æ˜¯ 65,535 å€‹å€å¡Šï¼ˆç´„ 455 å¤©ï¼‰æˆ– 65,535 Ã— 512 ç§’ï¼ˆç´„ 388 å¤©ï¼‰ã€‚å°æ–¼å¤§å¤šæ•¸æ‡‰ç”¨å ´æ™¯ï¼Œé€™å·²ç¶“è¶³å¤ äº†ã€‚</p>

<p>é¸æ“‡ 512 ç§’ï¼ˆç´„ 8.5 åˆ†é˜ï¼‰ä½œç‚ºæ™‚é–“å–®ä½è€Œä¸æ˜¯ç§’ï¼Œæ˜¯ç‚ºäº†åŒ¹é…æ¯”ç‰¹å¹£çš„å€å¡Šæ™‚é–“ç²’åº¦ã€‚é€™ä¹Ÿæ„å‘³è‘—æ™‚é–“é–çš„ç²¾åº¦å¤§ç´„æ˜¯ 8 åˆ†é˜ï¼Œå°æ–¼å¤§å¤šæ•¸å ´æ™¯ä¾†èªªè¶³å¤ ç²¾ç¢ºã€‚</p>

<h3 id="43-ç›¸å°æ™‚é–“é–çš„å«ç¾©">4.3 ç›¸å°æ™‚é–“é–çš„å«ç¾©</h3>

<p>èˆ‡çµ•å°æ™‚é–“é–ä¸åŒï¼Œç›¸å°æ™‚é–“é–çš„èµ·é»æ˜¯ UTXO è¢«ç¢ºèªçš„æ™‚é–“ï¼Œè€Œä¸æ˜¯æŸå€‹å›ºå®šæ™‚é–“é»ã€‚é€™æœ‰é‡è¦çš„å¯¦éš›æ„ç¾©ï¼šä½ ä¸éœ€è¦é å…ˆçŸ¥é“ UTXO ä½•æ™‚æœƒè¢«å‰µå»ºï¼Œåªéœ€è¦æŒ‡å®šã€Œå‰µå»ºå¾Œéœ€è¦ç­‰å¾…å¤šä¹…ã€ã€‚</p>

<p>è€ƒæ…®ä¸€å€‹æ”¯ä»˜é€šé“çš„é—œé–‰å ´æ™¯ï¼šç•¶ä¸€æ–¹å–®æ–¹é¢å»£æ’­é—œé–‰äº¤æ˜“æ™‚ï¼Œå¦ä¸€æ–¹éœ€è¦æ™‚é–“ä¾†æª¢æ¸¬å’Œå›æ‡‰ã€‚ç›¸å°æ™‚é–“é–ç¢ºä¿ç„¡è«–é€šé“ä½•æ™‚é—œé–‰ï¼Œéƒ½æœ‰å›ºå®šçš„ã€ŒæŒ‘æˆ°æœŸã€ã€‚å¦‚æœä½¿ç”¨çµ•å°æ™‚é–“é–ï¼Œä½ éœ€è¦åœ¨é€šé“é–‹è¨­æ™‚å°±é æ¸¬å¯èƒ½çš„é—œé–‰æ™‚é–“ï¼Œé€™æ˜¯ä¸åˆ‡å¯¦éš›çš„ã€‚</p>

<h3 id="44-èˆ‡-nlocktime-çš„äº¤äº’">4.4 èˆ‡ nLocktime çš„äº¤äº’</h3>

<p>nSequence çš„ç›¸å°æ™‚é–“é–èˆ‡ nLocktime çš„çµ•å°æ™‚é–“é–å¯ä»¥åŒæ™‚ä½¿ç”¨ã€‚è¦å‰‡æ˜¯ï¼šä¸€å€‹äº¤æ˜“è¦è¢«æ¥å—ï¼Œå¿…é ˆåŒæ™‚æ»¿è¶³ nLocktime æ¢ä»¶å’Œæ‰€æœ‰è¼¸å…¥çš„ nSequence æ¢ä»¶ã€‚</p>

<p>é€™å‰µé€ äº†ä¸€äº›æœ‰è¶£çš„å¯èƒ½æ€§ã€‚ä¾‹å¦‚ï¼Œä¸€å€‹äº¤æ˜“å¯ä»¥è¢«è¨­è¨ˆæˆã€Œåœ¨ 2025 å¹´ 1 æœˆ 1 æ—¥ä¹‹å¾Œï¼Œä¸”åœ¨è¼¸å…¥è¢«å‰µå»ºä¸€é€±å¾Œã€æ‰èƒ½è¢«ç¢ºèªã€‚å…©å€‹æ¢ä»¶éƒ½å¿…é ˆæ»¿è¶³ã€‚</p>

<hr />

<h2 id="äº”op_checksequenceverifycsv">äº”ã€OP_CHECKSEQUENCEVERIFYï¼ˆCSVï¼‰</h2>

<h3 id="51-å°‡ç›¸å°æ™‚é–“é–å¸¶å…¥è…³æœ¬">5.1 å°‡ç›¸å°æ™‚é–“é–å¸¶å…¥è…³æœ¬</h3>

<p>CSVï¼ˆCheck Sequence Verifyï¼‰é€é BIP 112 å¼•å…¥ï¼Œæ˜¯ç›¸å°æ™‚é–“é–åœ¨è…³æœ¬å±¤ç´šçš„å¯¦ç¾ã€‚èˆ‡ CLTV é¡ä¼¼ï¼ŒCSV è®€å–å †ç–Šé ‚ç«¯çš„å€¼ï¼Œä¸¦é©—è­‰èŠ±è²»äº¤æ˜“çš„å°æ‡‰è¼¸å…¥çš„ sequence æ˜¯å¦æ»¿è¶³æ¢ä»¶ã€‚</p>

<p>CSV éœ€è¦äº¤æ˜“ç‰ˆæœ¬è‡³å°‘ç‚º 2ã€‚é€™æ˜¯å› ç‚º BIP 68 çš„ sequence èªç¾©åªé©ç”¨æ–¼ç‰ˆæœ¬ 2 åŠä»¥ä¸Šçš„äº¤æ˜“ï¼ŒèˆŠç‰ˆæœ¬äº¤æ˜“çš„ sequence æ¬„ä½æ²’æœ‰æ™‚é–“é–å«ç¾©ã€‚</p>

<h3 id="52-åŸ·è¡Œè¦å‰‡">5.2 åŸ·è¡Œè¦å‰‡</h3>

<p>CSV çš„é©—è­‰é‚è¼¯é¦–å…ˆæª¢æŸ¥å †ç–Šå€¼çš„ç¦ç”¨ä½ï¼ˆbit 31ï¼‰ã€‚å¦‚æœè¨­ç½®äº†ç¦ç”¨ä½ï¼ŒCSV æˆç‚ºç„¡æ“ä½œâ€”â€”ç›´æ¥æˆåŠŸï¼Œä¸åšä»»ä½•æª¢æŸ¥ã€‚é€™å…è¨±è…³æœ¬åœ¨æŸäº›æ¢ä»¶ä¸‹ã€Œè·³éã€æ™‚é–“é–ã€‚</p>

<p>å¦‚æœç¦ç”¨ä½æœªè¨­ç½®ï¼ŒCSV é©—è­‰ï¼šäº¤æ˜“ç‰ˆæœ¬è‡³å°‘ç‚º 2ï¼›è¼¸å…¥çš„ sequence ç¦ç”¨ä½æœªè¨­ç½®ï¼›å †ç–Šå€¼å’Œ sequence ä½¿ç”¨ç›¸åŒçš„æ™‚é–“é¡å‹ï¼ˆéƒ½æ˜¯å€å¡Šæˆ–éƒ½æ˜¯æ™‚é–“ï¼‰ï¼›sequence çš„é–å®šå€¼å¤§æ–¼æˆ–ç­‰æ–¼å †ç–Šå€¼çš„é–å®šå€¼ã€‚</p>

<h3 id="53-æ”¯ä»˜é€šé“ä¸­çš„æ ¸å¿ƒä½œç”¨">5.3 æ”¯ä»˜é€šé“ä¸­çš„æ ¸å¿ƒä½œç”¨</h3>

<p>CSV åœ¨æ”¯ä»˜é€šé“å’Œé–ƒé›»ç¶²è·¯ä¸­æ‰®æ¼”è‘—æ ¸å¿ƒè§’è‰²ã€‚è®“æˆ‘å€‘çœ‹çœ‹ç‚ºä»€éº¼ã€‚</p>

<p>åœ¨é›™å‘æ”¯ä»˜é€šé“ä¸­ï¼Œé›™æ–¹å¯ä»¥é›¢ç·šæ›´æ–°é€šé“ç‹€æ…‹ï¼ˆé¤˜é¡åˆ†é…ï¼‰ã€‚ä½†é€™å‰µé€ äº†ä¸€å€‹å•é¡Œï¼šä»»ä½•ä¸€æ–¹éƒ½å¯ä»¥å»£æ’­èˆŠçš„ç‹€æ…‹ï¼Œè©¦åœ–ç²å–æ¯”æ‡‰å¾—æ›´å¤šçš„è³‡é‡‘ã€‚é€™è¢«ç¨±ç‚ºã€Œé€šé“é—œé–‰æ¬ºè©ã€ã€‚</p>

<p>è§£æ±ºæ–¹æ¡ˆæ˜¯ä½¿ç”¨ CSV å‰µå»ºã€ŒæŒ‘æˆ°æœŸã€ã€‚ç•¶ä¸€æ–¹å»£æ’­é—œé–‰äº¤æ˜“æ™‚ï¼Œä»–å€‘çš„è³‡é‡‘ä¸èƒ½ç«‹å³æå–ï¼Œå¿…é ˆç­‰å¾…ä¸€æ®µæ™‚é–“ï¼ˆä¾‹å¦‚ä¸€é€±ï¼‰ã€‚åœ¨é€™æ®µæ™‚é–“å…§ï¼Œå¦ä¸€æ–¹å¯ä»¥æäº¤è­‰æ“šè­‰æ˜é€™æ˜¯èˆŠç‹€æ…‹ï¼Œä¸¦å–èµ°æ‰€æœ‰è³‡é‡‘ä½œç‚ºæ‡²ç½°ã€‚</p>

<p>é€™å€‹ã€Œæ’¤éŠ·ã€æ©Ÿåˆ¶çš„é—œéµåœ¨æ–¼ç›¸å°æ™‚é–“é–ï¼šç„¡è«–ä½•æ™‚é—œé–‰é€šé“ï¼Œéƒ½æœ‰å›ºå®šçš„æŒ‘æˆ°æœŸã€‚å¦‚æœä½¿ç”¨çµ•å°æ™‚é–“é–ï¼Œé•·æœŸé‹è¡Œçš„é€šé“å°‡é¢è‡¨æ™‚é–“é–éæœŸçš„å•é¡Œã€‚</p>

<h3 id="54-å¯æ’¤éŠ·è¼¸å‡ºè…³æœ¬">5.4 å¯æ’¤éŠ·è¼¸å‡ºè…³æœ¬</h3>

<p>é–ƒé›»ç¶²è·¯çš„æ‰¿è«¾äº¤æ˜“ä½¿ç”¨ä¸€ç¨®ç¨±ç‚ºã€Œå¯æ’¤éŠ·è¼¸å‡ºã€çš„æ¨¡å¼ã€‚ç•¶é€šé“æ›´æ–°æ™‚ï¼Œé›™æ–¹äº¤æ›å‰ä¸€ç‹€æ…‹çš„ã€Œæ’¤éŠ·å¯†é‘°ã€ã€‚å¦‚æœä»»ä½•ä¸€æ–¹å»£æ’­èˆŠç‹€æ…‹ï¼Œå°æ–¹å¯ä»¥ä½¿ç”¨æ’¤éŠ·å¯†é‘°ç«‹å³å–èµ°æ‰€æœ‰è³‡é‡‘ã€‚</p>

<p>é€™å€‹è…³æœ¬é€šå¸¸é€™æ¨£è¨­è¨ˆï¼šæœ‰å…©æ¢èŠ±è²»è·¯å¾‘ã€‚ç¬¬ä¸€æ¢æ˜¯æ’¤éŠ·è·¯å¾‘â€”â€”å°æ–¹å¯ä»¥ç”¨æ’¤éŠ·å¯†é‘°ç°½åï¼Œç«‹å³èŠ±è²»ã€‚ç¬¬äºŒæ¢æ˜¯å»¶é²è·¯å¾‘â€”â€”æ“æœ‰è€…éœ€è¦ç­‰å¾… CSV å»¶é²æœŸï¼Œç„¶å¾Œç”¨è‡ªå·±çš„ç°½åèŠ±è²»ã€‚</p>

<p>å¦‚æœå»£æ’­çš„æ˜¯æœ€æ–°ç‹€æ…‹ï¼Œå°æ–¹æ²’æœ‰æ’¤éŠ·å¯†é‘°ï¼Œåªèƒ½ç­‰å¾…å»¶é²æœŸçµæŸå¾Œè³‡é‡‘è¢«æ­£ç•¶é ˜å–ã€‚å¦‚æœå»£æ’­çš„æ˜¯èˆŠç‹€æ…‹ï¼Œå°æ–¹æŒæœ‰æ’¤éŠ·å¯†é‘°ï¼Œå¯ä»¥åœ¨å»¶é²æœŸå…§å–èµ°æ‰€æœ‰è³‡é‡‘ã€‚é€™å‰µé€ äº†å¼·å¤§çš„ä¸ä½œå¼Šæ¿€å‹µã€‚</p>

<hr />

<h2 id="å…­htlcæ™‚é–“é–èˆ‡å“ˆå¸Œé–çš„çµåˆ">å…­ã€HTLCï¼šæ™‚é–“é–èˆ‡å“ˆå¸Œé–çš„çµåˆ</h2>

<h3 id="61-æ ¸å¿ƒæ¦‚å¿µ">6.1 æ ¸å¿ƒæ¦‚å¿µ</h3>

<p>HTLCï¼ˆHash Time Locked Contractï¼Œå“ˆå¸Œæ™‚é–“é–å®šåˆç´„ï¼‰æ˜¯æ™‚é–“é–æœ€é‡è¦çš„æ‡‰ç”¨ä¹‹ä¸€ï¼Œçµåˆäº†å“ˆå¸Œé–å’Œæ™‚é–“é–ï¼Œå‰µé€ å‡ºä¸€ç¨®æ¢ä»¶æ”¯ä»˜æ©Ÿåˆ¶ï¼šæ”¶æ¬¾äººå¿…é ˆåœ¨é™å®šæ™‚é–“å…§æä¾›ä¸€å€‹ç§˜å¯†ï¼ˆåŸåƒï¼‰ï¼Œå¦å‰‡è³‡é‡‘æœƒé€€å›çµ¦ä»˜æ¬¾äººã€‚</p>

<p>HTLC çš„çµæ§‹åŒ…å«å…©æ¢è·¯å¾‘ã€‚æˆåŠŸè·¯å¾‘è¦æ±‚æ”¶æ¬¾äººæä¾›ä¸€å€‹å€¼ preimageï¼Œä½¿å¾— HASH160(preimage) ç­‰æ–¼é è¨­çš„ payment_hashï¼ŒåŒæ™‚æä¾›æœ‰æ•ˆç°½åã€‚é€€æ¬¾è·¯å¾‘å…è¨±ä»˜æ¬¾äººåœ¨æ™‚é–“é–éæœŸå¾Œï¼Œç”¨è‡ªå·±çš„ç°½åå–å›è³‡é‡‘ã€‚</p>

<p>é€™å€‹æ©Ÿåˆ¶çš„ç²¾å¦™ä¹‹è™•åœ¨æ–¼ï¼šä»˜æ¬¾äººå‰µå»º HTLC æ™‚ä¸¦ä¸çŸ¥é“åŸåƒï¼Œåªæœ‰æ”¶æ¬¾äººçŸ¥é“ã€‚æ”¶æ¬¾äººé€éæ­ç¤ºåŸåƒä¾†ã€Œé ˜å–ã€æ”¯ä»˜ï¼Œè€Œé€™å€‹æ­ç¤ºå‹•ä½œæ˜¯å…¬é–‹çš„â€”â€”ä»»ä½•çœ‹åˆ°åŸåƒçš„äººéƒ½å¯ä»¥ç”¨å®ƒä¾†è§£é–å…¶ä»–ä½¿ç”¨ç›¸åŒ payment_hash çš„ HTLCã€‚</p>

<h3 id="62-åŸå­äº¤æ›">6.2 åŸå­äº¤æ›</h3>

<p>HTLC æœ€æ—©çš„æ‡‰ç”¨ä¹‹ä¸€æ˜¯è·¨éˆåŸå­äº¤æ›ã€‚å‡è¨­ Alice æœ‰ BTC æƒ³è¦æ›å– Bob çš„ LTCã€‚å‚³çµ±æ–¹æ³•éœ€è¦ä¿¡ä»»ï¼šèª°å…ˆç™¼é€èª°å°±é¢è‡¨å°æ–¹ä¸å±¥ç´„çš„é¢¨éšªã€‚HTLC æ¶ˆé™¤äº†é€™ç¨®ä¿¡ä»»éœ€æ±‚ã€‚</p>

<p>æµç¨‹å¦‚ä¸‹ï¼šAlice é¦–å…ˆç”Ÿæˆä¸€å€‹éš¨æ©Ÿçš„ preimage ä¸¦è¨ˆç®— payment_hashã€‚å¥¹åœ¨æ¯”ç‰¹å¹£éˆä¸Šå‰µå»ºä¸€å€‹ HTLCï¼Œå°‡ BTC é–å®šçµ¦ Bobï¼Œæ¢ä»¶æ˜¯ Bob éœ€è¦æä¾›é€™å€‹ preimageã€‚Alice è¨­ç½®è¼ƒé•·çš„è¶…æ™‚æ™‚é–“ï¼Œæ¯”å¦‚ 48 å°æ™‚ã€‚</p>

<p>Bob çœ‹åˆ° Alice çš„ HTLC å¾Œï¼Œåœ¨èŠç‰¹å¹£éˆä¸Šå‰µå»ºå°æ‡‰çš„ HTLCï¼Œå°‡ LTC é–å®šçµ¦ Aliceï¼Œä½¿ç”¨ç›¸åŒçš„ payment_hashã€‚Bob è¨­ç½®è¼ƒçŸ­çš„è¶…æ™‚æ™‚é–“ï¼Œæ¯”å¦‚ 24 å°æ™‚ã€‚</p>

<p>ç¾åœ¨ Alice å¯ä»¥å®‰å…¨åœ°é ˜å– LTCï¼šå¥¹ç”¨ preimage è§£é– Bob åœ¨èŠç‰¹å¹£éˆä¸Šçš„ HTLCã€‚é€™å€‹å‹•ä½œæœƒå°‡ preimage å…¬é–‹åœ¨èŠç‰¹å¹£éˆä¸Šã€‚</p>

<p>Bob å¾èŠç‰¹å¹£éˆä¸Šçœ‹åˆ° preimageï¼Œç”¨å®ƒä¾†è§£é– Alice åœ¨æ¯”ç‰¹å¹£éˆä¸Šçš„ HTLCï¼Œç²å– BTCã€‚</p>

<p>å¦‚æœ Alice ä¸é ˜å– LTCï¼ˆå¯èƒ½å¥¹æ”¹è®Šä¸»æ„äº†ï¼‰ï¼Œå…©å€‹ HTLC éƒ½æœƒè¶…æ™‚ï¼šBob å–å› LTCï¼ŒAlice å–å› BTCã€‚æ²’æœ‰äººæå¤±è³‡é‡‘ã€‚</p>

<p>è¶…æ™‚æ™‚é–“çš„å·®ç•°å¾ˆé‡è¦ï¼šAlice å¿…é ˆæœ‰è¶³å¤ æ™‚é–“åœ¨ Bob å–å› LTC ä¹‹å‰é ˜å–å®ƒã€‚å¦‚æœå…©å€‹è¶…æ™‚ç›¸åŒï¼ŒBob å¯èƒ½åœ¨ Alice é ˜å– LTC çš„åŒæ™‚å–å›å®ƒï¼Œé€ æˆ Alice æ­ç¤ºäº† preimage å»æ²’æœ‰æ‹¿åˆ° LTCï¼Œè€Œ Bob ç”¨é€™å€‹ preimage æ‹¿èµ° BTCã€‚</p>

<h3 id="63-é–ƒé›»ç¶²è·¯æ”¯ä»˜">6.3 é–ƒé›»ç¶²è·¯æ”¯ä»˜</h3>

<p>é–ƒé›»ç¶²è·¯å°‡ HTLC çš„åŸç†ç™¼æ®åˆ°æ¥µè‡´ã€‚åœ¨é–ƒé›»ç¶²è·¯ä¸­ï¼Œæ”¯ä»˜å¯ä»¥é€éå¤šå€‹ç¯€é»ä¸­ç¹¼ï¼Œæ¯ä¸€è·³éƒ½ä½¿ç”¨ HTLC ä¾†ä¿è­‰åŸå­æ€§â€”â€”è¦éº¼æ•´æ¢è·¯å¾‘ä¸Šçš„æ‰€æœ‰ HTLC éƒ½è¢«è§£é–ï¼Œè¦éº¼éƒ½è¶…æ™‚é€€å›ã€‚</p>

<p>å‡è¨­ Alice è¦é€é Bobï¼ˆè·¯ç”±ç¯€é»ï¼‰æ”¯ä»˜çµ¦ Carolã€‚é¦–å…ˆï¼ŒCarol ç”Ÿæˆ preimage å’Œ payment_hashï¼Œå°‡ payment_hash å‘Šè¨´ Aliceã€‚Alice åœ¨å¥¹å’Œ Bob çš„é€šé“ä¸­å‰µå»ºä¸€å€‹ HTLCï¼ˆæ”¯ä»˜çµ¦ Bobï¼Œæ¢ä»¶æ˜¯ Bob æä¾› preimageï¼‰ã€‚Bob åœ¨ä»–å’Œ Carol çš„é€šé“ä¸­å‰µå»ºå°æ‡‰çš„ HTLCï¼ˆæ”¯ä»˜çµ¦ Carolï¼ŒåŒæ¨£çš„ payment_hashï¼‰ã€‚Carol ç”¨ preimage é ˜å– Bob çš„ HTLCã€‚Bob å¾ Carol é‚£è£¡ç²å¾— preimageï¼Œç”¨å®ƒé ˜å– Alice çš„ HTLCã€‚</p>

<p>æ•´å€‹éç¨‹ä¸­ï¼Œåªæœ‰æœ€çµ‚æ”¶æ¬¾äºº Carol çŸ¥é“ preimageã€‚ç•¶å¥¹æ­ç¤ºå®ƒæ™‚ï¼Œæ”¯ä»˜æ²¿è‘—è·¯å¾‘å›æº¯çµç®—ã€‚æ¯å€‹ç¯€é»éƒ½æœ‰è¶³å¤ çš„æ™‚é–“å®Œæˆè‡ªå·±çš„éƒ¨åˆ†ï¼Œå› ç‚ºè¶…æ™‚æ™‚é–“æ²¿è‘—è·¯å¾‘éæ¸›ã€‚</p>

<h3 id="64-è¶…æ™‚å·®èˆ‡å®‰å…¨æ€§">6.4 è¶…æ™‚å·®èˆ‡å®‰å…¨æ€§</h3>

<p>HTLC è·¯ç”±ä¸­çš„è¶…æ™‚å·®ï¼ˆcltv_expiry_deltaï¼‰æ˜¯é—œéµçš„å®‰å…¨åƒæ•¸ã€‚æ¯å€‹è·¯ç”±ç¯€é»éœ€è¦ç¢ºä¿è‡ªå·±æœ‰è¶³å¤ æ™‚é–“ï¼šåœ¨ä¸Šæ¸¸ HTLC è¶…æ™‚ä¹‹å‰ï¼Œæœ‰æ™‚é–“ç™¼ç¾ä¸‹æ¸¸ HTLC è¢«é ˜å–ï¼ˆæˆ–è¶…æ™‚ï¼‰ï¼Œä¸¦ç›¸æ‡‰åœ°è™•ç†ä¸Šæ¸¸ HTLCã€‚</p>

<p>å¦‚æœè¶…æ™‚å·®å¤ªå°ï¼Œå¯èƒ½ç™¼ç”Ÿé€™æ¨£çš„æƒ…æ³ï¼šä¸Šæ¸¸ HTLC å³å°‡è¶…æ™‚ï¼Œä»˜æ¬¾äººå»£æ’­é€€æ¬¾äº¤æ˜“ã€‚åŒæ™‚ï¼Œä¸‹æ¸¸æ”¶æ¬¾äººå»£æ’­é ˜å–äº¤æ˜“ã€‚ä¸­é–“ç¯€é»å¯èƒ½æ—¢ç„¡æ³•é ˜å–ä¸Šæ¸¸ï¼ˆå› ç‚ºè¶…æ™‚äº†ï¼‰ä¹Ÿç„¡æ³•é˜»æ­¢ä¸‹æ¸¸ï¼ˆå› ç‚ºå·²ç¶“æˆåŠŸï¼‰ï¼Œå°è‡´æå¤±ã€‚</p>

<p>é–ƒé›»ç¶²è·¯çš„ BOLT è¦ç¯„å»ºè­°æ¯è·³è‡³å°‘ 40 å€‹å€å¡Šï¼ˆç´„ 6.7 å°æ™‚ï¼‰çš„è¶…æ™‚å·®ï¼Œä»¥ç¢ºä¿åœ¨å„ç¨®ç¶²è·¯å»¶é²å’Œå€å¡Šé‡çµ„æƒ…æ³ä¸‹çš„å®‰å…¨æ€§ã€‚</p>

<hr />

<h2 id="ä¸ƒæ™‚é–“é–çš„å®‰å…¨è€ƒé‡">ä¸ƒã€æ™‚é–“é–çš„å®‰å…¨è€ƒé‡</h2>

<h3 id="71-æ™‚é–“æˆ³æ“ç¸±">7.1 æ™‚é–“æˆ³æ“ç¸±</h3>

<p>ç¤¦å·¥å°å€å¡Šæ™‚é–“æˆ³æœ‰ä¸€å®šçš„èª¿æ•´ç©ºé–“ã€‚è¦å‰‡å…è¨±æ™‚é–“æˆ³æ¯”å‰ä¸€å€å¡Šå‘å‰æœ€å¤š 2 å°æ™‚ï¼Œä¸”å¿…é ˆå¤§æ–¼ MTPã€‚é€™æ„å‘³è‘—å–®å€‹ç¤¦å·¥å¯ä»¥å°‡æ™‚é–“æˆ³è¨­å¾—æ¯”çœŸå¯¦æ™‚é–“ç•¥æ—©æˆ–ç•¥æ™šã€‚</p>

<p>å°æ–¼ä½¿ç”¨æ™‚é–“æˆ³çš„æ™‚é–“é–ä¾†èªªï¼Œé€™å‰µé€ äº†ä¸€äº›ä¸ç¢ºå®šæ€§ã€‚ä¸€å€‹è¨­å®šåœ¨ç‰¹å®šæ™‚é–“è§£é–çš„ HTLCï¼Œå¯¦éš›è§£é–æ™‚é–“å¯èƒ½æ¯”é æœŸæ—©æˆ–æ™šå¹¾å€‹å°æ™‚ã€‚å°æ–¼é«˜åƒ¹å€¼æˆ–æ™‚é–“æ•æ„Ÿçš„æ‡‰ç”¨ï¼Œä½¿ç”¨å€å¡Šé«˜åº¦é€šå¸¸æ›´å¯é æ¸¬ã€‚</p>

<p>MTP æ©Ÿåˆ¶æ¸›è¼•äº†é€™å€‹å•é¡Œçš„åš´é‡æ€§ã€‚æ“ç¸± MTP éœ€è¦æ§åˆ¶é€£çºŒå¤šå€‹å€å¡Šçš„æ™‚é–“æˆ³ï¼Œé€™å°æ–¼æ²’æœ‰å¤§é‡ç®—åŠ›çš„æ”»æ“Šè€…ä¾†èªªæ˜¯ä¸åˆ‡å¯¦éš›çš„ã€‚</p>

<h3 id="72-è²»ç”¨ç‚’ä½œæ”»æ“Š">7.2 è²»ç”¨ç‚’ä½œæ”»æ“Š</h3>

<p>åœ¨æ™‚é–“é–å³å°‡åˆ°æœŸæ™‚ï¼Œå¯èƒ½å‡ºç¾è²»ç”¨ç«¶çˆ­çš„æƒ…æ³ã€‚è€ƒæ…®ä¸€å€‹ HTLCï¼šæ”¶æ¬¾äººæƒ³è¦é ˜å–ï¼Œè€Œä»˜æ¬¾äººæƒ³è¦é€€æ¬¾ã€‚å¦‚æœå…©å€‹äº¤æ˜“åœ¨æ¥è¿‘è¶…æ™‚æ™‚åŒæ™‚å»£æ’­ï¼Œèª°çš„äº¤æ˜“è¢«æ‰“åŒ…å–æ±ºæ–¼æ‰‹çºŒè²»ã€‚</p>

<p>é€™å¯èƒ½å°è‡´ã€Œè²»ç”¨ç‚’ä½œã€â€”â€”é›™æ–¹ä¸æ–·æé«˜æ‰‹çºŒè²»è©¦åœ–è®“è‡ªå·±çš„äº¤æ˜“è¢«å„ªå…ˆæ‰“åŒ…ã€‚åœ¨æ¥µç«¯æƒ…æ³ä¸‹ï¼Œæ‰‹çºŒè²»å¯èƒ½æ¥è¿‘ç”šè‡³è¶…é HTLC çš„åƒ¹å€¼ã€‚</p>

<p>è§£æ±ºæ–¹æ¡ˆæ˜¯è¨­è¨ˆåˆç†çš„è¶…æ™‚å·®ï¼Œç¢ºä¿ä¸€æ–¹æœ‰æ˜ç¢ºçš„æ™‚é–“çª—å£ä¾†è¡Œå‹•ã€‚æ­¤å¤–ï¼Œä¸€äº›å”è­°ä½¿ç”¨ã€Œé ç°½åã€äº¤æ˜“ï¼Œåœ¨ HTLC å‰µå»ºæ™‚å°±é–å®šæ‰‹çºŒè²»ç‡ï¼Œé¿å…å¾ŒçºŒç«¶åƒ¹ã€‚</p>

<h3 id="73-å€å¡Šéˆé‡çµ„é¢¨éšª">7.3 å€å¡Šéˆé‡çµ„é¢¨éšª</h3>

<p>å€å¡Šéˆé‡çµ„å¯èƒ½å½±éŸ¿æ™‚é–“é–çš„è¡Œç‚ºã€‚å¦‚æœä¸€å€‹ HTLC è¢«é ˜å–çš„äº¤æ˜“æ‰€åœ¨å€å¡Šè¢«é‡çµ„æ‰ï¼Œpreimage çš„æ­ç¤ºå¯èƒ½è¢«ã€Œé€†è½‰ã€ã€‚å°æ–¼è·¨éˆåŸå­äº¤æ›ï¼Œé€™å‰µé€ äº†é¢¨éšªï¼šä¸€æ¢éˆä¸Šçš„æ”¯ä»˜è¢«ç¢ºèªï¼ˆå¤šæ¬¡ï¼‰ï¼Œè€Œå¦ä¸€æ¢éˆç™¼ç”Ÿé‡çµ„ã€‚</p>

<p>ç·©è§£æªæ–½åŒ…æ‹¬ï¼šç­‰å¾…è¶³å¤ å¤šçš„ç¢ºèªï¼ˆç‰¹åˆ¥æ˜¯å°æ–¼é«˜åƒ¹å€¼äº¤æ˜“ï¼‰ï¼›è¨­è¨ˆè¶…æ™‚æ™‚é–“æ™‚è€ƒæ…®å¯èƒ½çš„é‡çµ„ï¼›åœ¨é—œéµæ“ä½œå‰æª¢æŸ¥å°æ‰‹æ–¹éˆçš„ç¢ºèªæ·±åº¦ã€‚</p>

<hr />

<h2 id="å…«taproot-æ™‚ä»£çš„æ™‚é–“é–">å…«ã€Taproot æ™‚ä»£çš„æ™‚é–“é–</h2>

<h3 id="81-éš±ç§æå‡">8.1 éš±ç§æå‡</h3>

<p>Taproot ç‚ºæ™‚é–“é–æ‡‰ç”¨å¸¶ä¾†äº†é¡¯è‘—çš„éš±ç§æ”¹é€²ã€‚å‚³çµ±çš„ HTLC åœ¨èŠ±è²»æ™‚æœƒæ­ç¤ºæ•´å€‹è…³æœ¬çµæ§‹ï¼Œè§€å¯Ÿè€…å¯ä»¥æ¸…æ¥šçœ‹åˆ°é€™æ˜¯ä¸€å€‹æ¢ä»¶æ”¯ä»˜ã€‚è€Œåœ¨ Taproot ä¸­ï¼Œæ™‚é–“é–æ¢ä»¶å¯ä»¥éš±è—åœ¨è…³æœ¬æ¨¹ä¸­ã€‚</p>

<p>å¦‚æœå¤§å¤šæ•¸æƒ…æ³ä¸‹é›™æ–¹åˆä½œï¼ˆä¾‹å¦‚é–ƒé›»ç¶²è·¯é€šé“æ­£å¸¸é—œé–‰ï¼‰ï¼Œä»–å€‘å¯ä»¥ä½¿ç”¨ key path èŠ±è²»â€”â€”åœ¨éˆä¸Šçœ‹èµ·ä¾†å°±åƒæ™®é€šçš„å–®ç°½åäº¤æ˜“ã€‚æ™‚é–“é–è·¯å¾‘åªæœ‰åœ¨éœ€è¦æ™‚æ‰æœƒæ­ç¤ºï¼Œè€Œä¸”åªæ­ç¤ºä½¿ç”¨çš„é‚£å€‹åˆ†æ”¯ï¼Œå…¶ä»–å‚™ç”¨è·¯å¾‘ä¿æŒå®Œå…¨éš±è—ã€‚</p>

<p>é€™æ„å‘³è‘—å¤§å¤šæ•¸é–ƒé›»ç¶²è·¯äº¤æ˜“åœ¨éˆä¸Šå°‡ç„¡æ³•èˆ‡æ™®é€šäº¤æ˜“å€åˆ†ï¼Œå¤§å¹…æå‡æ•´å€‹ç¶²è·¯çš„éš±ç§æ€§ã€‚</p>

<h3 id="82-æ•ˆç‡å„ªåŒ–">8.2 æ•ˆç‡å„ªåŒ–</h3>

<p>é™¤äº†éš±ç§ï¼ŒTaproot é‚„å¸¶ä¾†æ•ˆç‡æå‡ã€‚å‚³çµ± HTLC éœ€è¦åœ¨æ¯æ¬¡èŠ±è²»æ™‚æ­ç¤ºå®Œæ•´è…³æœ¬ï¼ŒåŒ…æ‹¬æ‰€æœ‰å…¬é‘°ã€å“ˆå¸Œå€¼ã€æ™‚é–“é–ç­‰ã€‚Taproot çš„ key path åªéœ€è¦ä¸€å€‹ 64 ä½å…ƒçµ„çš„ç°½åï¼Œæ˜¯å¯èƒ½çš„æœ€å°è¦‹è­‰å¤§å°ã€‚</p>

<p>å³ä½¿ä½¿ç”¨ script pathï¼Œä¹Ÿåªéœ€è¦æ­ç¤ºå¯¦éš›ä½¿ç”¨çš„è…³æœ¬åˆ†æ”¯å’Œ Merkle è­‰æ˜ï¼Œè€Œä¸æ˜¯æ•´å€‹è…³æœ¬ã€‚å°æ–¼æœ‰å¤šå€‹æ¢ä»¶åˆ†æ”¯çš„è¤‡é›œåˆç´„ï¼Œé€™å¯ä»¥ç¯€çœå¤§é‡ç©ºé–“ã€‚</p>

<h3 id="83-ptlcsè¶…è¶Š-htlc">8.3 PTLCsï¼šè¶…è¶Š HTLC</h3>

<p>Taproot é‚„ä½¿å¾— PTLCï¼ˆPoint Time Locked Contractï¼‰æˆç‚ºå¯èƒ½ï¼Œé€™æ˜¯ HTLC çš„é€²åŒ–ç‰ˆæœ¬ã€‚PTLC ä½¿ç”¨ã€Œadaptor signaturesã€ä»£æ›¿å“ˆå¸Œé–ï¼Œæä¾›äº†å¹¾å€‹é‡è¦å„ªå‹¢ã€‚</p>

<p>é¦–å…ˆæ˜¯éš±ç§ã€‚HTLC çš„ payment_hash åœ¨æ•´æ¢æ”¯ä»˜è·¯å¾‘ä¸Šæ˜¯ç›¸åŒçš„ï¼Œé€™å‰µé€ äº†é—œè¯æ€§â€”â€”çŸ¥é“å…¥å£å’Œå‡ºå£ payment_hash ç›¸åŒçš„è§€å¯Ÿè€…å¯ä»¥è¿½è¹¤æ”¯ä»˜ã€‚PTLC åœ¨æ¯ä¸€è·³ä½¿ç”¨ä¸åŒçš„å¯†ç¢¼å­¸ã€Œè¬é¡Œã€ï¼Œæ‰“æ–·äº†é€™ç¨®é—œè¯ã€‚</p>

<p>å…¶æ¬¡æ˜¯å¤šè·¯å¾‘æ”¯ä»˜çš„åŸå­æ€§ã€‚å°‡å¤§é¡æ”¯ä»˜åˆ†æˆå¤šæ¢è·¯å¾‘æ™‚ï¼ŒHTLC æ–¹æ¡ˆä¸­çš„ preimage ä¸€æ—¦åœ¨ä»»ä½•è·¯å¾‘ä¸Šæ­ç¤ºï¼Œå°±å¯èƒ½è¢«ç”¨ä¾†é ˜å–å…¶ä»–è·¯å¾‘ã€‚PTLC å¯ä»¥è¨­è¨ˆæˆçœŸæ­£åŸå­çš„å¤šè·¯å¾‘æ”¯ä»˜ã€‚</p>

<p>PTLC çš„å»£æ³›æ¡ç”¨éœ€è¦é–ƒé›»ç¶²è·¯ç”Ÿæ…‹çš„å‡ç´šï¼Œé€™æ­£åœ¨é€æ­¥é€²è¡Œä¸­ã€‚</p>

<hr />

<h2 id="ä¹å¯¦ä½œç·´ç¿’">ä¹ã€å¯¦ä½œç·´ç¿’</h2>

<h3 id="ç·´ç¿’-1cltv-éºç”¢è…³æœ¬">ç·´ç¿’ 1ï¼šCLTV éºç”¢è…³æœ¬</h3>

<p>è¨­è¨ˆä¸€å€‹éºç”¢è¦åŠƒè…³æœ¬ï¼šæ“æœ‰è€…å¯ä»¥éš¨æ™‚èŠ±è²»ï¼Œç¹¼æ‰¿äººåœ¨æŒ‡å®šæ—¥æœŸå¾Œå¯ä»¥èŠ±è²»ã€‚è¨ˆç®—æ­£ç¢ºçš„ CLTV å€¼ï¼ˆä½¿ç”¨ Unix æ™‚é–“æˆ³ï¼‰ï¼Œæ§‹å»ºå®Œæ•´çš„ witness scriptï¼Œç”Ÿæˆ P2WSH åœ°å€ã€‚</p>

<h3 id="ç·´ç¿’-2csv-æ”¯ä»˜é€šé“">ç·´ç¿’ 2ï¼šCSV æ”¯ä»˜é€šé“</h3>

<p>è¨­è¨ˆä¸€å€‹ç°¡åŒ–ç‰ˆçš„æ”¯ä»˜é€šé“é—œé–‰è…³æœ¬ï¼šé›™æ–¹å¯ä»¥åˆä½œå³æ™‚é—œé–‰ï¼ˆ2-of-2 å¤šç°½ï¼‰ï¼Œç™¼èµ·è€…éœ€è¦ç­‰å¾… 1008 å€å¡Šå¾Œæ‰èƒ½å–®æ–¹é¢é—œé–‰ã€‚æ€è€ƒç‚ºä»€éº¼ç™¼èµ·è€…éœ€è¦å»¶é²è€Œæ¥æ”¶è€…ä¸éœ€è¦ã€‚</p>

<h3 id="ç·´ç¿’-3å®Œæ•´-htlc-ç”Ÿå‘½é€±æœŸ">ç·´ç¿’ 3ï¼šå®Œæ•´ HTLC ç”Ÿå‘½é€±æœŸ</h3>

<p>æ¨¡æ“¬ä¸€å€‹ HTLC çš„å®Œæ•´ç”Ÿå‘½é€±æœŸï¼šç”Ÿæˆ preimage å’Œ payment_hashï¼Œæ§‹å»º HTLC è…³æœ¬ï¼Œæ¨¡æ“¬æˆåŠŸé ˜å–è·¯å¾‘çš„è¦‹è­‰æ§‹é€ ï¼Œæ¨¡æ“¬è¶…æ™‚é€€æ¬¾è·¯å¾‘çš„è¦‹è­‰æ§‹é€ ã€‚æ¯”è¼ƒå…©ç¨®è·¯å¾‘çš„ä¸åŒè¦æ±‚ã€‚</p>

<hr />

<h2 id="åå°çµ">åã€å°çµ</h2>

<p>æœ¬ç¯‡æˆ‘å€‘æ·±å…¥æ¢è¨äº†æ¯”ç‰¹å¹£çš„æ™‚é–“é–æ©Ÿåˆ¶ï¼š</p>

<p><strong>nLocktime</strong> æ˜¯æœ€æ—©çš„æ™‚é–“é–ï¼Œåœ¨äº¤æ˜“å±¤ç´šå·¥ä½œï¼Œä½†å¯ä»¥è¢«æŒæœ‰ç§é‘°è€…ç¹éã€‚å®ƒä¸»è¦ç”¨æ–¼ã€Œå»¶é²ã€äº¤æ˜“å»£æ’­ï¼Œè€Œéå¼·åˆ¶åŸ·è¡Œæ™‚é–“æ¢ä»¶ã€‚</p>

<p><strong>CLTV</strong> å°‡çµ•å°æ™‚é–“é–å¸¶å…¥è…³æœ¬å±¤ç´šï¼Œé€éå…±è­˜è¦å‰‡å¼·åˆ¶åŸ·è¡Œï¼Œç„¡æ³•ç¹éã€‚å®ƒé©ç”¨æ–¼éœ€è¦æŒ‡å®šå…·é«”æ—¥æœŸæˆ–å€å¡Šé«˜åº¦çš„å ´æ™¯ï¼Œå¦‚éºç”¢è¦åŠƒã€åˆ†æœŸè§£é–ç­‰ã€‚</p>

<p><strong>nSequence</strong> ç¶“é BIP 68 é‡æ–°å®šç¾©ï¼Œå¯¦ç¾äº†äº¤æ˜“å±¤ç´šçš„ç›¸å°æ™‚é–“é–ã€‚å®ƒæŒ‡å®šå¾ UTXO ç¢ºèªé–‹å§‹å¿…é ˆç­‰å¾…çš„æ™‚é–“ï¼Œæ˜¯æ”¯ä»˜é€šé“çš„åŸºç¤ã€‚</p>

<p><strong>CSV</strong> æ˜¯ç›¸å°æ™‚é–“é–çš„è…³æœ¬ç‰ˆæœ¬ï¼ŒåŒæ¨£é€éå…±è­˜å¼·åˆ¶åŸ·è¡Œã€‚å®ƒæ˜¯é–ƒé›»ç¶²è·¯ä¸­ã€ŒæŒ‘æˆ°æœŸã€æ©Ÿåˆ¶çš„æ ¸å¿ƒï¼Œç¢ºä¿æ¬ºè©è¡Œç‚ºæœ‰æ™‚é–“è¢«ç™¼ç¾å’Œæ‡²ç½°ã€‚</p>

<p><strong>HTLC</strong> çµåˆäº†å“ˆå¸Œé–å’Œæ™‚é–“é–ï¼Œå‰µé€ äº†æ¢ä»¶æ”¯ä»˜çš„èƒ½åŠ›ã€‚å®ƒæ˜¯åŸå­äº¤æ›å’Œé–ƒé›»ç¶²è·¯å¤šè·³æ”¯ä»˜çš„åŸºç¤ï¼Œç¢ºä¿ã€Œè¦éº¼å…¨éƒ¨æˆåŠŸï¼Œè¦éº¼å…¨éƒ¨é€€æ¬¾ã€çš„åŸå­æ€§ã€‚</p>

<p>æ™‚é–“é–å¾å–®ç´”çš„ã€Œå»¶é²ã€åŠŸèƒ½ï¼Œæ¼”é€²æˆæ§‹å»ºè¤‡é›œé‡‘èå”è­°çš„æ ¸å¿ƒåŸèªã€‚ç†è§£é€™äº›æ©Ÿåˆ¶å¦‚ä½•å·¥ä½œï¼Œæ˜¯æŒæ¡æ¯”ç‰¹å¹£æ™ºèƒ½åˆç´„çš„é—œéµä¸€æ­¥ã€‚</p>

<hr />

<h2 id="ä¸‹ä¸€ç¯‡é å‘Š">ä¸‹ä¸€ç¯‡é å‘Š</h2>

<p>åœ¨æœ¬ç³»åˆ—çš„æœ€å¾Œä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å€‘å°‡æ¢è¨ Bitcoin Script çš„é€²éšæ‡‰ç”¨ï¼ŒåŒ…æ‹¬ Vault è¨­è¨ˆæ¨¡å¼ã€Discreet Log Contractsï¼ˆDLCï¼‰çš„åŸºç¤æ¦‚å¿µã€ä»¥åŠè…³æœ¬å„ªåŒ–æŠ€å·§ã€‚æˆ‘å€‘é‚„æœƒå±•æœ›æ¯”ç‰¹å¹£è…³æœ¬æœªä¾†å¯èƒ½çš„ç™¼å±•æ–¹å‘ï¼Œå¦‚ OP_CATã€OP_CTV ç­‰ææ¡ˆã€‚</p>

<hr />

<h2 id="åƒè€ƒè³‡æ–™">åƒè€ƒè³‡æ–™</h2>

<ul>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki">BIP 65: OP_CHECKLOCKTIMEVERIFY</a> - CLTV çš„åŸå§‹è¦æ ¼</li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki">BIP 68: Relative Lock-time</a> - nSequence ç›¸å°æ™‚é–“é–èªç¾©</li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki">BIP 112: OP_CHECKSEQUENCEVERIFY</a> - CSV çš„åŸå§‹è¦æ ¼</li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0113.mediawiki">BIP 113: Median Time-past</a> - MTP æ™‚é–“è¨ˆç®—è¦å‰‡</li>
  <li><a href="https://github.com/lightning/bolts/blob/master/03-transactions.md">BOLT #3: Transactions</a> - é–ƒé›»ç¶²è·¯äº¤æ˜“æ ¼å¼</li>
  <li><a href="https://github.com/lightning/bolts/blob/master/05-onchain.md">BOLT #5: On-chain Handling</a> - é–ƒé›»ç¶²è·¯éˆä¸Šè™•ç†å»ºè­°</li>
  <li><a href="https://bitcoinops.org/en/topics/timelocks/">Bitcoin Optech: Timelocks</a> - æ™‚é–“é–ä¸»é¡Œæ·±å…¥è§£æ</li>
</ul>]]></content><author><name>Cypherpunks Taiwan</name></author><category term="æŠ€è¡“æ•™å­¸" /><category term="bitcoin" /><category term="development" /><category term="bitcoin" /><category term="script" /><category term="timelock" /><category term="htlc" /><category term="lightning" /><summary type="html"><![CDATA[Bitcoin Script ç³»åˆ—ç¬¬äº”ç¯‡ï¼Œæ·±å…¥è§£ææ™‚é–“é–æ©Ÿåˆ¶ï¼ŒåŒ…æ‹¬ nLocktimeã€CLTVã€nSequenceã€CSVï¼Œä»¥åŠ HTLC çš„å¯¦éš›æ‡‰ç”¨ã€‚]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" /><media:content medium="image" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Bitcoin Script å¯¦æˆ°æ•™å­¸ï¼ˆå››ï¼‰ï¼šå¤šé‡ç°½åå®Œå…¨æŒ‡å—</title><link href="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/development/2025/03/18/bitcoin-script-tutorial-4-multisig/" rel="alternate" type="text/html" title="Bitcoin Script å¯¦æˆ°æ•™å­¸ï¼ˆå››ï¼‰ï¼šå¤šé‡ç°½åå®Œå…¨æŒ‡å—" /><published>2025-03-18T00:00:00+00:00</published><updated>2025-03-18T00:00:00+00:00</updated><id>https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/development/2025/03/18/bitcoin-script-tutorial-4-multisig</id><content type="html" xml:base="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/development/2025/03/18/bitcoin-script-tutorial-4-multisig/"><![CDATA[<h2 id="ç³»åˆ—å°è¨€">ç³»åˆ—å°è¨€</h2>

<p>é€™æ˜¯ã€ŒBitcoin Script å¯¦æˆ°æ•™å­¸ã€ç³»åˆ—çš„ç¬¬å››ç¯‡ã€‚æœ¬ç¯‡å°‡å…¨é¢æ¢è¨å¤šé‡ç°½åçš„å„ç¨®å¯¦ç¾æ–¹å¼ï¼Œå¾å‚³çµ±çš„ OP_CHECKMULTISIG åˆ°ç¾ä»£çš„ MuSig2ã€‚å¤šé‡ç°½åæ˜¯æ¯”ç‰¹å¹£è…³æœ¬ç³»çµ±æœ€é‡è¦çš„æ‡‰ç”¨ä¹‹ä¸€ï¼Œå®ƒå°‡æ¯”ç‰¹å¹£çš„å®‰å…¨æ€§å¾å–®ä¸€å¯†é‘°æå‡åˆ°åˆ†æ•£å¼ä¿¡ä»»æ¨¡å‹ï¼Œç‚ºå€‹äººè³‡ç”¢ä¿è­·ã€ä¼æ¥­è²¡å‹™ç®¡ç†ã€ä»¥åŠè¤‡é›œçš„æ™ºèƒ½åˆç´„å¥ å®šäº†åŸºç¤ã€‚</p>

<p><strong>ç³»åˆ—æ–‡ç« ï¼š</strong></p>
<ol>
  <li><a href="/bitcoin/development/2025/03/15/bitcoin-script-tutorial-1-fundamentals/">åŸºç¤æ¦‚å¿µèˆ‡æ“ä½œç¢¼</a></li>
  <li><a href="/bitcoin/development/2025/03/16/bitcoin-script-tutorial-2-standard-scripts/">æ¨™æº–è…³æœ¬é¡å‹è©³è§£</a></li>
  <li><a href="/bitcoin/development/2025/03/17/bitcoin-script-tutorial-3-segwit-taproot/">SegWit èˆ‡ Taproot</a></li>
  <li><strong>å¤šé‡ç°½åå®Œå…¨æŒ‡å—</strong>ï¼ˆæœ¬ç¯‡ï¼‰</li>
  <li>æ™‚é–“é–æ©Ÿåˆ¶</li>
  <li>é€²éšæ‡‰ç”¨èˆ‡æ™ºèƒ½åˆç´„</li>
</ol>

<hr />

<h2 id="ä¸€ç†è§£å¤šé‡ç°½å">ä¸€ã€ç†è§£å¤šé‡ç°½å</h2>

<h3 id="11-å¾å–®ç°½ååˆ°å¤šé‡ç°½å">1.1 å¾å–®ç°½ååˆ°å¤šé‡ç°½å</h3>

<p>åœ¨å‚³çµ±çš„æ¯”ç‰¹å¹£äº¤æ˜“ä¸­ï¼Œä¸€å€‹ç§é‘°å°æ‡‰ä¸€å€‹åœ°å€ï¼Œæ“æœ‰ç§é‘°å°±èƒ½å®Œå…¨æ§åˆ¶è©²åœ°å€ä¸‹çš„æ‰€æœ‰è³‡é‡‘ã€‚é€™ç¨®æ¨¡å‹ç°¡å–®ç›´æ¥ï¼Œä½†ä¹Ÿæœ‰æ˜é¡¯çš„é¢¨éšªï¼šç§é‘°ä¸€æ—¦ä¸Ÿå¤±æˆ–è¢«ç›œï¼Œè³‡é‡‘å°±æ°¸ä¹…ç„¡æ³•æ¢å¾©æˆ–è¢«ç«Šå–ã€‚</p>

<p>å¤šé‡ç°½åï¼ˆMultisignatureï¼Œç°¡ç¨± Multisigï¼‰æ˜¯ä¸€ç¨®éœ€è¦å¤šå€‹ç§é‘°æˆæ¬Šæ‰èƒ½èŠ±è²»è³‡é‡‘çš„æ©Ÿåˆ¶ã€‚å®ƒé€šå¸¸ç”¨ m-of-n çš„å½¢å¼è¡¨ç¤ºï¼Œå…¶ä¸­ n æ˜¯åƒèˆ‡çš„å…¬é‘°ç¸½æ•¸ï¼Œm æ˜¯éœ€è¦çš„æœ€å°‘ç°½åæ•¸é‡ã€‚ä¾‹å¦‚ï¼Œ2-of-3 å¤šé‡ç°½åæ„å‘³è‘—æœ‰ä¸‰å€‹äººå„æŒæœ‰ä¸€æŠŠç§é‘°ï¼Œä½†åªéœ€è¦å…¶ä¸­ä»»æ„å…©äººç°½åå°±èƒ½èŠ±è²»è³‡é‡‘ã€‚</p>

<p>é€™å€‹çœ‹ä¼¼ç°¡å–®çš„æ¦‚å¿µå¸¶ä¾†äº†æ·±é çš„å½±éŸ¿ã€‚å®ƒè®“æˆ‘å€‘èƒ½å¤ è¨­è¨ˆå‡ºå®¹éŒ¯æ€§æ›´å¼·çš„è³‡ç”¢ä¿ç®¡æ–¹æ¡ˆï¼Œå»ºç«‹éœ€è¦å¤šæ–¹åŒæ„çš„ä¼æ¥­è²¡å‹™ç³»çµ±ï¼Œç”šè‡³æ§‹å»ºå»ä¸­å¿ƒåŒ–çš„å”è­°å±¤æ‡‰ç”¨ã€‚</p>

<h3 id="12-ç‚ºä»€éº¼éœ€è¦å¤šé‡ç°½å">1.2 ç‚ºä»€éº¼éœ€è¦å¤šé‡ç°½åï¼Ÿ</h3>

<p>å¤šé‡ç°½åè§£æ±ºäº†åŠ å¯†è²¨å¹£ç®¡ç†ä¸­çš„å¹¾å€‹æ ¸å¿ƒå•é¡Œã€‚</p>

<p>é¦–å…ˆæ˜¯å®‰å…¨æ€§å•é¡Œã€‚å³ä½¿ä½ çš„ä¸€æŠŠç§é‘°è¢«ç›œï¼Œæ”»æ“Šè€…ä¹Ÿç„¡æ³•å‹•ç”¨è³‡é‡‘ï¼Œå› ç‚ºä»–å€‘é‚„éœ€è¦ç²å–å…¶ä»–å¯†é‘°ã€‚é€™ç¨®ã€Œå†—é¤˜å®‰å…¨ã€çš„æ¦‚å¿µèˆ‡å‚³çµ±éŠ€è¡Œä¿éšªç®±éœ€è¦å…©æŠŠé‘°åŒ™çš„åŸç†é¡ä¼¼ï¼Œä½†åœ¨æ•¸ä½é ˜åŸŸå¯¦ç¾å¾—æ›´åŠ å„ªé›…ã€‚</p>

<p>å…¶æ¬¡æ˜¯å¯æ¢å¾©æ€§å•é¡Œã€‚åœ¨ 2-of-3 é…ç½®ä¸­ï¼Œå³ä½¿ä½ ä¸Ÿå¤±äº†ä¸€æŠŠç§é‘°ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨å‰©é¤˜çš„å…©æŠŠå¯†é‘°æ¢å¾©å°è³‡é‡‘çš„æ§åˆ¶ã€‚é€™å¤§å¤§é™ä½äº†ã€Œå› ç‚ºå¿˜è¨˜å¯†ç¢¼è€Œæ°¸ä¹…å¤±å»æ¯”ç‰¹å¹£ã€é€™é¡æ‚²åŠ‡ç™¼ç”Ÿçš„å¯èƒ½æ€§ã€‚</p>

<p>ç¬¬ä¸‰æ˜¯æ²»ç†å•é¡Œã€‚å°æ–¼ä¼æ¥­æˆ–çµ„ç¹”ä¾†èªªï¼Œé‡å¤§è²¡å‹™æ±ºç­–ä¸æ‡‰è©²ç”±å–®ä¸€å€‹äººæ§åˆ¶ã€‚å¤šé‡ç°½åå¯ä»¥ç¢ºä¿è³‡é‡‘çš„å‹•ç”¨éœ€è¦å¤šå€‹æˆæ¬Šäººçš„åŒæ„ï¼Œé€™èˆ‡å‚³çµ±å…¬å¸æ²»ç†ä¸­çš„å¤šäººç°½æ ¸æµç¨‹ç›¸å‘¼æ‡‰ã€‚</p>

<p>æœ€å¾Œæ˜¯ä¿¡ä»»æœ€å°åŒ–ã€‚åœ¨æ¶‰åŠå¤šæ–¹çš„äº¤æ˜“å ´æ™¯ä¸­ï¼Œä¾‹å¦‚è¨—ç®¡æœå‹™æˆ–å»ä¸­å¿ƒåŒ–äº¤æ˜“ï¼Œå¤šé‡ç°½åå¯ä»¥è¨­è¨ˆå‡ºä¸éœ€è¦å®Œå…¨ä¿¡ä»»ä»»ä½•å–®ä¸€æ–¹çš„è§£æ±ºæ–¹æ¡ˆã€‚ç¶“å…¸çš„ 2-of-3 è¨—ç®¡å°±æ˜¯ä¸€å€‹ä¾‹å­ï¼šè²·å®¶ã€è³£å®¶ã€ä»²è£è€…å„æŒä¸€æŠŠå¯†é‘°ï¼Œæ­£å¸¸æƒ…æ³ä¸‹è²·è³£é›™æ–¹å®Œæˆäº¤æ˜“ï¼Œåªæœ‰ç™¼ç”Ÿçˆ­è­°æ™‚æ‰éœ€è¦ä»²è£è€…ä»‹å…¥ã€‚</p>

<h3 id="13-å¤šé‡ç°½åçš„æ­·å²æ¼”é€²">1.3 å¤šé‡ç°½åçš„æ­·å²æ¼”é€²</h3>

<p>æ¯”ç‰¹å¹£çš„å¤šé‡ç°½åç¶“æ­·äº†ä¸‰å€‹ä¸»è¦çš„ç™¼å±•éšæ®µï¼Œæ¯å€‹éšæ®µéƒ½å¸¶ä¾†äº†æ•ˆç‡å’Œéš±ç§çš„é¡¯è‘—æå‡ã€‚</p>

<p>ç¬¬ä¸€éšæ®µæ˜¯ 2012 å¹´éš¨ BIP 16 å¼•å…¥çš„ P2SH å¤šé‡ç°½åã€‚é€™æ˜¯æœ€æ—©è¢«å»£æ³›æ¡ç”¨çš„æ¨™æº–åŒ–å¤šç°½æ–¹æ¡ˆï¼Œä½¿ç”¨ OP_CHECKMULTISIG æ“ä½œç¢¼åœ¨è…³æœ¬å±¤é¢é©—è­‰å¤šå€‹ç°½åã€‚é›–ç„¶é€™ç¨®æ–¹æ³•åŠŸèƒ½å®Œå–„ï¼Œä½†å®ƒéœ€è¦åœ¨éˆä¸Šæš´éœ²æ‰€æœ‰å…¬é‘°å’Œæ‰€éœ€çš„æ‰€æœ‰ç°½åï¼Œå°è‡´è¼ƒå¤§çš„äº¤æ˜“é«”ç©å’Œè¼ƒé«˜çš„è²»ç”¨ã€‚</p>

<p>ç¬¬äºŒéšæ®µæ˜¯ 2017 å¹´ SegWit å¸¶ä¾†çš„ P2WSH å¤šé‡ç°½åã€‚é€™ç¨®æ–¹å¼åœ¨åŠŸèƒ½ä¸Šèˆ‡ P2SH é¡ä¼¼ï¼Œä½†ç”±æ–¼ç°½åæ•¸æ“šè¢«æ”¾å…¥ witness å€åŸŸä¸¦äº«å—è²»ç”¨æŠ˜æ‰£ï¼Œå¯¦éš›æˆæœ¬ä¸‹é™äº†ç´„ 35%ã€‚åŒæ™‚ï¼Œä½¿ç”¨ SHA256 æ›¿ä»£ HASH160 ä¹Ÿæå‡äº†å¯†ç¢¼å­¸å®‰å…¨æ€§ã€‚</p>

<p>ç¬¬ä¸‰éšæ®µæ˜¯ 2021 å¹´ Taproot å•Ÿå‹•å¾Œå¸¶ä¾†çš„é©å‘½æ€§è®ŠåŒ–ã€‚é€é Schnorr ç°½åçš„ç·šæ€§ç‰¹æ€§ï¼Œå¤šå€‹ç°½åç¾åœ¨å¯ä»¥è¢«èšåˆæˆä¸€å€‹å–®ä¸€ç°½åï¼Œåœ¨éˆä¸Šçœ‹èµ·ä¾†èˆ‡æ™®é€šçš„å–®ç°½åäº¤æ˜“å®Œå…¨ç›¸åŒã€‚é€™ä¸åƒ…å¤§å¹…é™ä½äº†è²»ç”¨ï¼Œæ›´é‡è¦çš„æ˜¯æä¾›äº†å‰æ‰€æœªæœ‰çš„éš±ç§ä¿è­·â€”â€”å¤–éƒ¨è§€å¯Ÿè€…ç„¡æ³•åˆ¤æ–·ä¸€ç­†äº¤æ˜“æ˜¯å–®äººæ§åˆ¶é‚„æ˜¯éœ€è¦å¤šæ–¹æˆæ¬Šã€‚</p>

<hr />

<h2 id="äºŒå‚³çµ±å¤šé‡ç°½åè©³è§£">äºŒã€å‚³çµ±å¤šé‡ç°½åè©³è§£</h2>

<h3 id="21-op_checkmultisig-çš„å·¥ä½œåŸç†">2.1 OP_CHECKMULTISIG çš„å·¥ä½œåŸç†</h3>

<p>OP_CHECKMULTISIG æ˜¯æ¯”ç‰¹å¹£æœ€æ—©æ”¯æ´å¤šé‡ç°½åçš„æ“ä½œç¢¼ã€‚å®ƒçš„è¨­è¨ˆç›¸ç•¶ç›´æ¥ï¼šå¾å †ç–Šä¸­å–å‡ºä¸€çµ„å…¬é‘°å’Œä¸€çµ„ç°½åï¼Œç„¶å¾Œé©—è­‰æ˜¯å¦æœ‰è¶³å¤ æ•¸é‡çš„æœ‰æ•ˆç°½åã€‚</p>

<p>ä¸€å€‹ 2-of-3 å¤šé‡ç°½åçš„è´–å›è…³æœ¬ï¼ˆRedeem Scriptï¼‰çœ‹èµ·ä¾†åƒé€™æ¨£ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>OP_2 &lt;pubkey1&gt; &lt;pubkey2&gt; &lt;pubkey3&gt; OP_3 OP_CHECKMULTISIG
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€™å€‹è…³æœ¬çš„å«ç¾©æ˜¯ï¼šé€™è£¡æœ‰ä¸‰å€‹å…¬é‘°ï¼Œéœ€è¦å…¶ä¸­å…©å€‹å°æ‡‰çš„æœ‰æ•ˆç°½åæ‰èƒ½èŠ±è²»é€™ç­†è³‡é‡‘ã€‚OP_2 æŒ‡å®šéœ€è¦çš„ç°½åæ•¸é‡ï¼ŒOP_3 æŒ‡å®šå…¬é‘°çš„ç¸½æ•¸ï¼Œè€Œ OP_CHECKMULTISIG åŸ·è¡Œå¯¦éš›çš„é©—è­‰é‚è¼¯ã€‚</p>

<p>ç•¶èŠ±è²»é€™ç­†è³‡é‡‘æ™‚ï¼ŒScriptSigï¼ˆè§£é–è…³æœ¬ï¼‰éœ€è¦æä¾›ç°½åå’ŒåŸå§‹çš„è´–å›è…³æœ¬ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>OP_0 &lt;signature1&gt; &lt;signature2&gt; &lt;redeemScript&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€™è£¡çš„ OP_0 æ˜¯ä¸€å€‹çœ‹èµ·ä¾†å¥‡æ€ªä½†å¿…éœ€çš„å…ƒç´ ï¼Œç¨å¾Œæˆ‘å€‘æœƒè§£é‡‹å®ƒçš„å­˜åœ¨åŸå› ã€‚</p>

<h3 id="22-è‡­åæ˜­è‘—çš„-off-by-one-bug">2.2 è‡­åæ˜­è‘—çš„ off-by-one Bug</h3>

<p>OP_CHECKMULTISIG æœ‰ä¸€å€‹å¾æ¯”ç‰¹å¹£èª•ç”Ÿä¹‹åˆå°±å­˜åœ¨çš„ç¨‹å¼éŒ¯èª¤ï¼šå®ƒæœƒå¾å †ç–Šä¸­å¤šå½ˆå‡ºä¸€å€‹å…ƒç´ ã€‚é€™å€‹è¢«ç¨±ç‚ºã€Œoff-by-one bugã€çš„å•é¡Œæºæ–¼åŸå§‹ç¨‹å¼ç¢¼ä¸­çš„ä¸€å€‹ç´¢å¼•éŒ¯èª¤ã€‚</p>

<p>å…·é«”ä¾†èªªï¼Œåœ¨é©—è­‰å®Œæ‰€æœ‰ç°½åä¹‹å¾Œï¼Œæ“ä½œç¢¼æœƒå˜—è©¦å½ˆå‡ºä¸€å€‹é¡å¤–çš„å…ƒç´ ã€‚å¦‚æœå †ç–Šä¸­æ²’æœ‰é€™å€‹å…ƒç´ ï¼Œè…³æœ¬å°±æœƒå¤±æ•—ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå½ˆå‡ºçš„é€™å€‹å…ƒç´ è¢«å®Œå…¨å¿½ç•¥â€”â€”å®ƒä¸åƒèˆ‡ä»»ä½•é©—è­‰é‚è¼¯ã€‚</p>

<p>ç‚ºäº†è®“è…³æœ¬æ­£ç¢ºåŸ·è¡Œï¼Œä½¿ç”¨è€…å¿…é ˆåœ¨ç°½åä¹‹å‰æ”¾ç½®ä¸€å€‹ã€Œå•ã€å…ƒç´ ã€‚é€™å€‹å…ƒç´ å¯ä»¥æ˜¯ä»»ä½•å€¼ï¼Œå› ç‚ºå®ƒåæ­£æœƒè¢«å¿½ç•¥ã€‚æ…£ä¾‹ä¸Šä½¿ç”¨ OP_0ï¼ˆç©ºä½å…ƒçµ„ï¼‰ï¼Œé€™å°±æ˜¯ç‚ºä»€éº¼ä½ æœƒåœ¨æ‰€æœ‰å¤šç°½ ScriptSig çš„é–‹é ­çœ‹åˆ°é€™å€‹çœ‹ä¼¼è«åå…¶å¦™çš„é›¶å€¼ã€‚</p>

<p>ç‚ºä»€éº¼é€™å€‹ bug æ²’æœ‰è¢«ä¿®å¾©ï¼Ÿå› ç‚ºæ¯”ç‰¹å¹£çš„å…±è­˜è¦å‰‡æ˜¯ç¥è–ä¸å¯ä¾µçŠ¯çš„ã€‚ä»»ä½•æ”¹è®Šè…³æœ¬é©—è­‰è¡Œç‚ºçš„ä¿®æ”¹éƒ½å¯èƒ½å°è‡´åŸæœ¬æœ‰æ•ˆçš„äº¤æ˜“è®Šå¾—ç„¡æ•ˆï¼Œå¾è€Œå¼•ç™¼ç¶²è·¯åˆ†è£‚ã€‚é€™å€‹ bug ä½œç‚ºã€Œæ­·å²éºç”¢ã€è¢«æ°¸ä¹…ä¿ç•™äº†ä¸‹ä¾†ã€‚</p>

<p>ä¸éï¼ŒBIP 147 å¼•å…¥äº†ä¸€å€‹è»Ÿåˆ†å‰è¦å‰‡ï¼ˆNULLDUMMYï¼‰ï¼Œè¦æ±‚é€™å€‹å•å…ƒç´ å¿…é ˆæ˜¯ç©ºä½å…ƒçµ„ OP_0ã€‚é€™é˜²æ­¢äº†ä¸€é¡æ½›åœ¨çš„äº¤æ˜“å»¶å±•æ€§æ”»æ“Šï¼Œå› ç‚ºåœ¨æ­¤ä¹‹å‰ï¼Œé€™å€‹è¢«å¿½ç•¥çš„å…ƒç´ å¯ä»¥è¢«ç¬¬ä¸‰æ–¹ä»»æ„ä¿®æ”¹è€Œä¸å½±éŸ¿äº¤æ˜“æœ‰æ•ˆæ€§ã€‚</p>

<h3 id="23-ç°½åé †åºçš„é™åˆ¶">2.3 ç°½åé †åºçš„é™åˆ¶</h3>

<p>OP_CHECKMULTISIG é‚„æœ‰ä¸€å€‹é‡è¦çš„é™åˆ¶ï¼šç°½åå¿…é ˆæŒ‰ç…§å…¬é‘°åœ¨è…³æœ¬ä¸­å‡ºç¾çš„é †åºæ’åˆ—ã€‚é€™æ„å‘³è‘—å¦‚æœä½ æœ‰å…¬é‘° Aã€Bã€Cï¼Œè€Œä¸”åªæœ‰ A å’Œ C ç°½åäº†ï¼Œä½ ä¸èƒ½æä¾›ç°½åé †åºç‚º Cã€Aâ€”â€”å¿…é ˆæ˜¯ Aã€Cã€‚</p>

<p>é€™å€‹è¨­è¨ˆé¸æ“‡æ˜¯ç‚ºäº†ç°¡åŒ–é©—è­‰é‚è¼¯ã€‚æ“ä½œç¢¼æŒ‰é †åºéæ­·å…¬é‘°ï¼Œå°æ¯å€‹ç°½åå˜—è©¦ç”¨ä¸‹ä¸€å€‹æœªåŒ¹é…çš„å…¬é‘°é©—è­‰ã€‚ä¸€æ—¦åŒ¹é…æˆåŠŸå°±ç§»å‹•åˆ°ä¸‹ä¸€å€‹ç°½åï¼Œå¦‚æœåˆ°é”å…¬é‘°åˆ—è¡¨æœ«å°¾è€Œé‚„æœ‰æœªé©—è­‰çš„ç°½åï¼Œå‰‡æ•´å€‹é©—è­‰å¤±æ•—ã€‚</p>

<p>é€™å€‹ç´„æŸçµ¦å¯¦éš›æ‡‰ç”¨å¸¶ä¾†äº†ä¸€äº›ä¸ä¾¿ã€‚åœ¨æ”¶é›†ç°½åæ™‚ï¼Œä½ éœ€è¦çŸ¥é“æ¯å€‹ç°½åè€…å°æ‡‰å“ªå€‹å…¬é‘°ï¼Œä¸¦æŒ‰æ­£ç¢ºé †åºæ’åˆ—ã€‚é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼å¾Œä¾†çš„ Tapscript æ¡ç”¨äº†ä¸åŒçš„è¨­è¨ˆã€‚</p>

<h3 id="24-å»ºç«‹-p2sh-å¤šé‡ç°½ååœ°å€">2.4 å»ºç«‹ P2SH å¤šé‡ç°½ååœ°å€</h3>

<p>è®“æˆ‘å€‘çœ‹ä¸€å€‹å®Œæ•´çš„å»ºç«‹ 2-of-3 P2SH å¤šé‡ç°½ååœ°å€çš„éç¨‹ã€‚</p>

<p>é¦–å…ˆï¼Œéœ€è¦æ”¶é›†æ‰€æœ‰åƒèˆ‡è€…çš„å…¬é‘°ã€‚åœ¨å¯¦è¸ä¸­ï¼Œé€™é€šå¸¸æ„å‘³è‘—æ¯å€‹åƒèˆ‡è€…ç”¨è‡ªå·±çš„éŒ¢åŒ…è»Ÿé«”æˆ–ç¡¬é«”éŒ¢åŒ…ç”Ÿæˆä¸€å€‹å…¬é‘°ä¸¦åˆ†äº«çµ¦å”èª¿è€…ã€‚é‡è¦çš„æ˜¯åªåˆ†äº«å…¬é‘°ï¼Œçµ•ä¸åˆ†äº«ç§é‘°ã€‚</p>

<p>æ¥ä¸‹ä¾†ï¼ŒæŒ‰ç…§å­—å…¸åºå°å…¬é‘°é€²è¡Œæ’åºã€‚é€™ä¸€æ­¥ç¢ºä¿ç„¡è«–èª°ä¾†å»ºç«‹åœ°å€ï¼Œä½¿ç”¨ç›¸åŒçš„å…¬é‘°é›†åˆéƒ½æœƒå¾—åˆ°ç›¸åŒçš„åœ°å€ã€‚æ²’æœ‰é€™å€‹æ¨™æº–åŒ–æ­¥é©Ÿï¼Œä¸åŒçš„æ’åºæœƒç”¢ç”Ÿä¸åŒçš„åœ°å€ï¼Œé€ æˆæ··äº‚ã€‚</p>

<p>ç„¶å¾Œï¼Œæ§‹å»ºè´–å›è…³æœ¬ä¸¦è¨ˆç®—å…¶ HASH160 é›œæ¹Šå€¼ã€‚é€™å€‹ 20 ä½å…ƒçµ„çš„é›œæ¹Šå€¼å°±æ˜¯ P2SH åœ°å€çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚æœ€å¾Œï¼ŒåŠ ä¸Šç‰ˆæœ¬å‰ç¶´ï¼ˆä¸»ç¶²ç‚º 0x05ï¼‰ä¸¦é€²è¡Œ Base58Check ç·¨ç¢¼ï¼Œå°±å¾—åˆ°äº†ä¸€å€‹ä»¥ã€Œ3ã€é–‹é ­çš„ P2SH åœ°å€ã€‚</p>

<p>æ¯å€‹åƒèˆ‡è€…éƒ½éœ€è¦ä¿å­˜å®Œæ•´çš„è´–å›è…³æœ¬ï¼Œå› ç‚ºèŠ±è²»æ™‚éœ€è¦æ­ç¤ºå®ƒã€‚å¯¦éš›ä¸Šï¼Œå¤§å¤šæ•¸å¤šç°½éŒ¢åŒ…æœƒåŒæ™‚è¨˜éŒ„æ‰€æœ‰å…¬é‘°ï¼Œä¸¦åœ¨éœ€è¦æ™‚é‡æ–°ç”Ÿæˆè…³æœ¬ï¼Œä»¥ç¢ºä¿ä¸€è‡´æ€§ã€‚</p>

<hr />

<h2 id="ä¸‰segwit-å¤šé‡ç°½å">ä¸‰ã€SegWit å¤šé‡ç°½å</h2>

<h3 id="31-p2wsh-çš„å„ªå‹¢">3.1 P2WSH çš„å„ªå‹¢</h3>

<p>SegWit ç‚ºå¤šé‡ç°½åå¸¶ä¾†äº†å¯¦è³ªæ€§çš„æ”¹é€²ï¼Œä¸»è¦é«”ç¾åœ¨ä¸‰å€‹æ–¹é¢ã€‚</p>

<p>è²»ç”¨ç¯€çœæ˜¯æœ€ç›´è§€çš„å¥½è™•ã€‚åœ¨ SegWit ä¸­ï¼Œwitness æ•¸æ“šï¼ˆåŒ…æ‹¬ç°½åï¼‰åªè¨ˆç®—å››åˆ†ä¹‹ä¸€çš„å€å¡Šæ¬Šé‡ã€‚å°æ–¼ç°½åä½”æ“šå¤§éƒ¨åˆ†é«”ç©çš„å¤šç°½äº¤æ˜“ä¾†èªªï¼Œé€™æ„å‘³è‘—é¡¯è‘—çš„æˆæœ¬ä¸‹é™ã€‚ä¸€å€‹ 2-of-3 çš„ P2WSH äº¤æ˜“ç›¸æ¯”ç­‰åƒ¹çš„ P2SH äº¤æ˜“ï¼Œå¯ä»¥ç¯€çœç´„ 35% çš„è²»ç”¨ã€‚éš¨è‘—ç°½åæ•¸é‡å¢åŠ ï¼Œç¯€çœçš„æ¯”ä¾‹é‚„æœƒæ›´é«˜ã€‚</p>

<p>å®‰å…¨æ€§ä¹Ÿå¾—åˆ°äº†æå‡ã€‚P2SH ä½¿ç”¨ HASH160ï¼ˆRIPEMD160(SHA256(x))ï¼‰ï¼Œç”¢ç”Ÿ 20 ä½å…ƒçµ„çš„é›œæ¹Šå€¼ï¼Œæä¾›ç´„ 80 ä½å…ƒçš„ç¢°æ’æŠµæŠ—ã€‚P2WSH å‰‡ç›´æ¥ä½¿ç”¨ SHA256ï¼Œç”¢ç”Ÿ 32 ä½å…ƒçµ„çš„é›œæ¹Šå€¼ï¼Œæä¾› 128 ä½å…ƒçš„ç¢°æ’æŠµæŠ—ã€‚é›–ç„¶ 80 ä½å…ƒåœ¨ç›®å‰çœ‹ä¾†å·²ç¶“è¶³å¤ å®‰å…¨ï¼Œä½†å°æ–¼å¯èƒ½å­˜åœ¨æ•¸åå¹´çš„å¤§é¡è³‡ç”¢ä¾†èªªï¼Œæ›´é«˜çš„å®‰å…¨é‚Šéš›æ˜¯å€¼å¾—çš„ã€‚</p>

<p>æ­¤å¤–ï¼ŒSegWit é‡æ–°è¨­è¨ˆçš„ç°½åé›œæ¹Šæ¼”ç®—æ³•ï¼ˆBIP 143ï¼‰è§£æ±ºäº†å‚³çµ±äº¤æ˜“çš„äºŒæ¬¡é›œæ¹Šå•é¡Œï¼Œä½¿å¾—é©—è­‰å¤§å‹å¤šç°½äº¤æ˜“çš„è¨ˆç®—æˆæœ¬æ›´åŠ å¯æ§ã€‚</p>

<h3 id="32-p2wsh-çš„çµæ§‹">3.2 P2WSH çš„çµæ§‹</h3>

<p>P2WSH å¤šé‡ç°½ååœ¨æ¦‚å¿µä¸Šèˆ‡ P2SH é¡ä¼¼ï¼Œä½†çµæ§‹æœ‰æ‰€ä¸åŒã€‚</p>

<p>ScriptPubKey è®Šæˆäº†æ¨™æº–çš„ SegWit v0 æ ¼å¼ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>OP_0 &lt;32-byte-SHA256-of-witnessScript&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ScriptSig ç¾åœ¨æ˜¯ç©ºçš„â€”â€”æ‰€æœ‰è§£é–æ•¸æ“šéƒ½ç§»åˆ°äº† witness å€åŸŸã€‚</p>

<p>witness çµæ§‹èˆ‡ P2SH çš„ ScriptSig é¡ä¼¼ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>&lt;empty-dummy&gt;
&lt;signature1&gt;
&lt;signature2&gt;
&lt;witnessScript&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>witnessScript çš„å…§å®¹èˆ‡å‚³çµ±çš„ redeemScript å®Œå…¨ç›¸åŒï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>OP_2 &lt;pubkey1&gt; &lt;pubkey2&gt; &lt;pubkey3&gt; OP_3 OP_CHECKMULTISIG
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€™ç¨®è¨­è¨ˆè®“å¾ P2SH é·ç§»åˆ° P2WSH è®Šå¾—ç›¸å°ç°¡å–®ï¼šæ ¸å¿ƒé‚è¼¯ä¸è®Šï¼Œåªæ˜¯å°è£æ–¹å¼æ”¹è®Šäº†ã€‚</p>

<h3 id="33-å·¢ç‹€-segwitp2sh-p2wsh">3.3 å·¢ç‹€ SegWitï¼ˆP2SH-P2WSHï¼‰</h3>

<p>åœ¨ SegWit æ—©æœŸæ¡ç”¨éšæ®µï¼Œè¨±å¤šäº¤æ˜“æ‰€å’Œæœå‹™å•†å°šæœªæ”¯æ´åŸç”Ÿ SegWit åœ°å€ã€‚ç‚ºäº†å…¼å®¹é€™äº›æœå‹™ï¼Œå‡ºç¾äº†ä¸€ç¨®éæ¸¡æ–¹æ¡ˆï¼šå°‡ P2WSH åŒ…è£åœ¨ P2SH å…§éƒ¨ã€‚</p>

<p>é€™ç¨®å·¢ç‹€çµæ§‹çš„ ScriptPubKey æ˜¯æ¨™æº–çš„ P2SH æ ¼å¼ï¼ˆåœ°å€ä»¥ã€Œ3ã€é–‹é ­ï¼‰ï¼Œä½† redeemScript åªåŒ…å«ä¸€å€‹ SegWit witness programï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>OP_0 &lt;32-byte-SHA256-of-witnessScript&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>èŠ±è²»æ™‚ï¼ŒScriptSig åªåŒ…å«é€™å€‹ redeemScriptï¼Œè€Œå¯¦éš›çš„ç°½åæ•¸æ“šä»ç„¶æ”¾åœ¨ witness å€åŸŸã€‚</p>

<p>é€™ç¨®æ–¹æ¡ˆæä¾›äº†éƒ¨åˆ† SegWit çš„è²»ç”¨å„ªæƒ ï¼ˆå› ç‚ºç°½åä»åœ¨ witness ä¸­ï¼‰ï¼ŒåŒæ™‚ä¿æŒäº†èˆ‡èˆŠç³»çµ±çš„å…¼å®¹æ€§ã€‚éš¨è‘—åŸç”Ÿ SegWit æ”¯æ´è¶Šä¾†è¶Šæ™®åŠï¼Œé€™ç¨®éæ¸¡æ ¼å¼çš„ä½¿ç”¨æ­£åœ¨æ¸›å°‘ã€‚</p>

<hr />

<h2 id="å››taproot-é©æ–°å¤šé‡ç°½å">å››ã€Taproot é©æ–°å¤šé‡ç°½å</h2>

<h3 id="41-å…©ç¨®è·¯å¾‘çš„è¨­è¨ˆå“²å­¸">4.1 å…©ç¨®è·¯å¾‘çš„è¨­è¨ˆå“²å­¸</h3>

<p>Taproot ç‚ºå¤šé‡ç°½åæä¾›äº†å…©ç¨®æˆªç„¶ä¸åŒçš„å¯¦ç¾æ–¹å¼ï¼Œæ¯ç¨®éƒ½æœ‰å…¶ç¨ç‰¹çš„å„ªå‹¢å’Œé©ç”¨å ´æ™¯ã€‚</p>

<p>Key Path ä½¿ç”¨ Schnorr ç°½åçš„èšåˆç‰¹æ€§ï¼Œå°‡å¤šå€‹ç°½åè€…çš„å…¬é‘°å’Œç°½ååˆä½µæˆä¸€å€‹ã€‚åœ¨éˆä¸Šï¼Œé€™çœ‹èµ·ä¾†å°±åƒæ™®é€šçš„å–®ç°½åäº¤æ˜“â€”â€”åªæœ‰ 64 ä½å…ƒçµ„çš„ç°½åï¼Œæ²’æœ‰å…¬é‘°åˆ—è¡¨ï¼Œæ²’æœ‰ä»»ä½•å¤šç°½çš„ç—•è·¡ã€‚é€™æä¾›äº†æœ€ä½³çš„æ•ˆç‡å’Œéš±ç§ï¼Œä½†è¦æ±‚æ‰€æœ‰ç°½åè€…éƒ½å¿…é ˆåƒèˆ‡ï¼ˆn-of-nï¼‰ã€‚</p>

<p>Script Path ä½¿ç”¨ Tapscript ä¸­çš„ OP_CHECKSIGADD æ“ä½œç¢¼ï¼Œå…è¨± m-of-n çš„ä»»æ„é–¾å€¼é…ç½®ã€‚é›–ç„¶é€™ç¨®æ–¹å¼éœ€è¦æ­ç¤ºè…³æœ¬ä¸¦åœ¨éˆä¸Šå¯è¦‹å¤šå€‹å…¬é‘°å’Œç°½åï¼Œä½†å®ƒæä¾›äº†æ›´å¤§çš„éˆæ´»æ€§â€”â€”ä¸éœ€è¦æ‰€æœ‰äººéƒ½åœ¨ç·šï¼Œåªéœ€è¦é”åˆ°é–¾å€¼å³å¯ã€‚</p>

<p>åœ¨å¯¦è¸ä¸­ï¼Œé€™å…©ç¨®æ–¹å¼é€šå¸¸æœƒçµåˆä½¿ç”¨ã€‚Key Path è¨­ç½®ç‚ºæ‰€æœ‰åƒèˆ‡è€…çš„èšåˆå…¬é‘°ï¼Œä½œç‚ºæœ€å¸¸è¦‹æƒ…æ³ï¼ˆå…±è­˜é”æˆï¼‰çš„é«˜æ•ˆè·¯å¾‘ã€‚Script Path ä¸­åŒ…å«å„ç¨®å‚™ç”¨æ–¹æ¡ˆï¼Œä¾‹å¦‚å­é›†é–¾å€¼ç°½åã€æ™‚é–“é–ä¿è­·çš„ç·Šæ€¥æ¢å¾©ç­‰ï¼Œä½œç‚ºç•°å¸¸æƒ…æ³çš„è™•ç†æ©Ÿåˆ¶ã€‚</p>

<h3 id="42-musig2èšåˆç°½åçš„å¯¦ç¾">4.2 MuSig2ï¼šèšåˆç°½åçš„å¯¦ç¾</h3>

<p>MuSig2 æ˜¯ç›®å‰æ¯”ç‰¹å¹£æ¡ç”¨çš„ Schnorr å¤šç°½èšåˆå”è­°ï¼Œç”± BIP 327 æ¨™æº–åŒ–ã€‚å®ƒå…è¨± n å€‹åƒèˆ‡è€…å…±åŒç”¢ç”Ÿä¸€å€‹çœ‹èµ·ä¾†åƒå–®ç°½åçš„èšåˆç°½åã€‚</p>

<p>å”è­°åˆ†ç‚ºå…©å€‹ä¸»è¦éšæ®µã€‚ç¬¬ä¸€éšæ®µæ˜¯å¯†é‘°èšåˆï¼šæ¯å€‹åƒèˆ‡è€…æä¾›è‡ªå·±çš„å…¬é‘°ï¼Œé€™äº›å…¬é‘°é€šéç‰¹å®šçš„æ¼”ç®—æ³•çµ„åˆæˆä¸€å€‹èšåˆå…¬é‘°ã€‚é€™å€‹èšåˆå…¬é‘°å°±æ˜¯ Taproot è¼¸å‡ºçš„å…§éƒ¨å…¬é‘°ï¼ˆæˆ–ç¶“éèª¿æ•´å¾Œçš„è¼¸å‡ºå…¬é‘°ï¼‰ã€‚</p>

<p>å¯†é‘°èšåˆä¸æ˜¯ç°¡å–®çš„ç›¸åŠ ã€‚ç‚ºäº†é˜²æ­¢ä¸€é¡ç¨±ç‚ºã€Œæµæ°“å¯†é‘°æ”»æ“Šã€çš„å®‰å…¨å•é¡Œï¼Œæ¯å€‹å…¬é‘°åœ¨ç›¸åŠ å‰æœƒä¹˜ä»¥ä¸€å€‹åŸºæ–¼æ‰€æœ‰å…¬é‘°çš„ä¿‚æ•¸ã€‚é€™ç¢ºä¿äº†æ²’æœ‰ä»»ä½•ä¸€æ–¹å¯ä»¥æƒ¡æ„é¸æ“‡è‡ªå·±çš„å…¬é‘°ä¾†æ“æ§èšåˆçµæœã€‚</p>

<p>ç¬¬äºŒéšæ®µæ˜¯ç°½åç”Ÿæˆã€‚MuSig2 éœ€è¦å…©è¼ªé€šè¨Šã€‚åœ¨ç¬¬ä¸€è¼ªï¼Œæ¯å€‹ç°½åè€…ç”Ÿæˆä¸€å°éš¨æ©Ÿ nonce ä¸¦åˆ†äº«å…¬é–‹éƒ¨åˆ†ã€‚åœ¨ç¬¬äºŒè¼ªï¼Œæ¯å€‹ç°½åè€…è¨ˆç®—è‡ªå·±çš„éƒ¨åˆ†ç°½åä¸¦åˆ†äº«ã€‚æœ€çµ‚ï¼Œé€™äº›éƒ¨åˆ†ç°½åè¢«èšåˆæˆä¸€å€‹å®Œæ•´çš„ Schnorr ç°½åã€‚</p>

<p>MuSig2 ç›¸æ¯”å…¶å‰èº« MuSig çš„ä¸»è¦æ”¹é€²æ˜¯å°‡äº’å‹•è¼ªæ¬¡å¾ä¸‰è¼ªæ¸›å°‘åˆ°å…©è¼ªï¼Œä¸¦ä¸”å…è¨± nonce é ç”Ÿæˆï¼Œé€™å¤§å¤§æå‡äº†å¯¦ç”¨æ€§ï¼Œç‰¹åˆ¥æ˜¯å°æ–¼ç¡¬é«”éŒ¢åŒ…ç­‰é›¢ç·šç°½åè¨­å‚™ã€‚</p>

<h3 id="43-nonce-å®‰å…¨æ€§çš„é—œéµæ€§">4.3 Nonce å®‰å…¨æ€§çš„é—œéµæ€§</h3>

<p>MuSig2 å¯¦ç¾ä¸­æœ€éœ€è¦è¬¹æ…è™•ç†çš„æ˜¯ nonceï¼ˆéš¨æ©Ÿæ•¸ï¼‰çš„ç®¡ç†ã€‚nonce é‡ç”¨å¯ä»¥å°è‡´ç§é‘°æ´©éœ²ï¼Œé€™ä¸æ˜¯ç†è«–ä¸Šçš„å¨è„…â€”â€”æ­·å²ä¸Šç¢ºå¯¦ç™¼ç”Ÿéå› ç‚º nonce å•é¡Œè€Œæå¤±å¤§é‡æ¯”ç‰¹å¹£çš„äº‹ä»¶ã€‚</p>

<p>æ¯æ¬¡ç°½åå¿…é ˆä½¿ç”¨å…¨æ–°çš„éš¨æ©Ÿ nonceã€‚ç‚ºäº†åœ¨é€™å€‹è¦æ±‚å’Œé›¢ç·šç°½åçš„ä¾¿åˆ©æ€§ä¹‹é–“å–å¾—å¹³è¡¡ï¼ŒMuSig2 å…è¨±é å…ˆç”Ÿæˆä¸€æ‰¹ nonce ä¸¦å®‰å…¨å­˜å„²ã€‚ä½†é€™å¸¶ä¾†äº†ç‹€æ…‹ç®¡ç†çš„è¤‡é›œæ€§ï¼šç³»çµ±å¿…é ˆç¢ºä¿æ¯å€‹ nonce åªä½¿ç”¨ä¸€æ¬¡ï¼Œå³ä½¿åœ¨å´©æ½°æ¢å¾©çš„æƒ…æ³ä¸‹ä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p>

<p>å°æ–¼ç¡¬é«”éŒ¢åŒ…é€™é¡å®‰å…¨æ•æ„Ÿçš„ç’°å¢ƒï¼Œé€šå¸¸æœƒæ¡ç”¨ç¢ºå®šæ€§ nonce ç”Ÿæˆæ–¹æ¡ˆï¼ŒåŸºæ–¼ç§é‘°å’Œè¨Šæ¯æ´¾ç”Ÿ nonceï¼Œå¾è€Œé¿å…ç‹€æ…‹ç®¡ç†çš„å•é¡Œã€‚ä½†é€™éœ€è¦è¬¹æ…çš„å¯†ç¢¼å­¸è¨­è¨ˆï¼Œä¸æ­£ç¢ºçš„å¯¦ç¾å¯èƒ½å¼•å…¥æ–°çš„æ¼æ´ã€‚</p>

<h3 id="44-tapscript-ä¸­çš„-op_checksigadd">4.4 Tapscript ä¸­çš„ OP_CHECKSIGADD</h3>

<p>ç•¶ n-of-n èšåˆä¸é©ç”¨æ™‚ï¼ˆæ¯”å¦‚åªéœ€è¦ m-of-n çš„å­é›†ï¼‰ï¼ŒTaproot æä¾›äº† Script Path ä½œç‚ºæ›¿ä»£æ–¹æ¡ˆã€‚Tapscript å¼•å…¥äº† OP_CHECKSIGADD æ“ä½œç¢¼ï¼Œé€™æ˜¯å‚³çµ± OP_CHECKMULTISIG çš„ç¾ä»£åŒ–æ›¿ä»£å“ã€‚</p>

<p>OP_CHECKSIGADD çš„è¨­è¨ˆæ›´åŠ ç°¡æ½”å’Œéˆæ´»ã€‚å®ƒå¾å †ç–Šå–ä¸‰å€‹å…ƒç´ ï¼šä¸€å€‹ç°½åã€ä¸€å€‹ç´¯åŠ å™¨å€¼ã€å’Œä¸€å€‹å…¬é‘°ã€‚å¦‚æœç°½åæœ‰æ•ˆï¼Œç´¯åŠ å™¨åŠ ä¸€ï¼›å¦‚æœç°½åç‚ºç©ºï¼ˆè¡¨ç¤ºè©²ç°½åè€…æ²’æœ‰ç°½åï¼‰ï¼Œç´¯åŠ å™¨ä¸è®Šã€‚æœ€å¾Œï¼Œç´¯åŠ å™¨è¢«æ¨å›å †ç–Šã€‚</p>

<p>ä¸€å€‹ 2-of-3 çš„ Tapscript çœ‹èµ·ä¾†åƒé€™æ¨£ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>&lt;pubkey1&gt; OP_CHECKSIG
&lt;pubkey2&gt; OP_CHECKSIGADD
&lt;pubkey3&gt; OP_CHECKSIGADD
2 OP_NUMEQUAL
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åŸ·è¡Œæ™‚ï¼Œå †ç–Šä¸Šæœƒç´¯ç©æœ‰æ•ˆç°½åçš„æ•¸é‡ï¼Œæœ€å¾Œèˆ‡æ‰€éœ€é–¾å€¼æ¯”è¼ƒã€‚</p>

<p>é€™ç¨®è¨­è¨ˆæœ‰å¹¾å€‹å„ªé»ã€‚é¦–å…ˆï¼Œå®ƒæ²’æœ‰ off-by-one bugï¼Œä¸éœ€è¦é‚£å€‹è«åå…¶å¦™çš„å•å…ƒç´ ã€‚å…¶æ¬¡ï¼Œç°½åé †åºæ˜¯éˆæ´»çš„â€”â€”ä¸éœ€è¦æŒ‰å…¬é‘°é †åºæ’åˆ—ï¼Œæœªç°½åçš„ä½ç½®åªéœ€æä¾›ç©ºå€¼ã€‚ç¬¬ä¸‰ï¼Œå®ƒæ”¯æ´é«˜æ•ˆçš„æ‰¹é‡é©—è­‰ï¼Œå› ç‚ºæ‰€æœ‰ç°½åå¯ä»¥è¢«æ”¶é›†èµ·ä¾†ä¸€æ¬¡æ€§é©—è­‰ã€‚</p>

<hr />

<h2 id="äº”é–¾å€¼ç°½åæ›´é€²ä¸€æ­¥">äº”ã€é–¾å€¼ç°½åï¼šæ›´é€²ä¸€æ­¥</h2>

<h3 id="51-å¾å¤šé‡ç°½ååˆ°é–¾å€¼ç°½å">5.1 å¾å¤šé‡ç°½ååˆ°é–¾å€¼ç°½å</h3>

<p>å¤šé‡ç°½åå’Œé–¾å€¼ç°½åéƒ½è§£æ±ºã€Œéœ€è¦å¤šæ–¹æˆæ¬Šã€çš„å•é¡Œï¼Œä½†å®ƒå€‘åœ¨æŠ€è¡“å¯¦ç¾ä¸Šæœ‰æ ¹æœ¬å€åˆ¥ã€‚</p>

<p>å‚³çµ±å¤šé‡ç°½åï¼ˆåŒ…æ‹¬ OP_CHECKMULTISIG å’Œ OP_CHECKSIGADDï¼‰åœ¨è…³æœ¬å±¤é¢å·¥ä½œï¼šæ¯å€‹åƒèˆ‡è€…ç¨ç«‹ç”¢ç”Ÿè‡ªå·±çš„ç°½åï¼Œè…³æœ¬é©—è­‰æ™‚æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ æ•¸é‡çš„æœ‰æ•ˆç°½åã€‚é€™æ„å‘³è‘—æ¯å€‹ç°½åéƒ½æ˜¯ç¨ç«‹å­˜åœ¨çš„ï¼Œéˆä¸Šå¯ä»¥çœ‹åˆ°æœ‰å¤šå°‘äººåƒèˆ‡ã€éœ€è¦å¤šå°‘äººç°½åã€‚</p>

<p>é–¾å€¼ç°½åå‰‡åœ¨å¯†ç¢¼å­¸å±¤é¢å·¥ä½œï¼šå¤šå€‹åƒèˆ‡è€…å”ä½œç”¢ç”Ÿä¸€å€‹å–®ä¸€çš„èšåˆç°½åï¼Œé€™å€‹ç°½åèˆ‡æ™®é€šçš„å–®äººç°½åç„¡æ³•å€åˆ†ã€‚æ²’æœ‰äººï¼ˆåŒ…æ‹¬å€å¡Šéˆåˆ†æè€…ï¼‰èƒ½å¤ çŸ¥é“é€™ç­†äº¤æ˜“å¯¦éš›ä¸Šéœ€è¦å¤šæ–¹æˆæ¬Šã€‚</p>

<p>MuSig2 å¯ä»¥çœ‹ä½œæ˜¯ n-of-n çš„é–¾å€¼ç°½åâ€”â€”æ‰€æœ‰äººéƒ½å¿…é ˆåƒèˆ‡æ‰èƒ½ç”¢ç”Ÿæœ‰æ•ˆç°½åã€‚ä½†å°æ–¼ m-of-nï¼ˆå…¶ä¸­ m &lt; nï¼‰çš„æƒ…æ³ï¼Œéœ€è¦æ›´è¤‡é›œçš„å”è­°ã€‚</p>

<h3 id="52-frost-å”è­°">5.2 FROST å”è­°</h3>

<p>FROSTï¼ˆFlexible Round-Optimized Schnorr Threshold signaturesï¼‰æ˜¯ç›®å‰æœ€æœ‰å‰æ™¯çš„é–¾å€¼ç°½åæ–¹æ¡ˆä¹‹ä¸€ã€‚å®ƒå…è¨±ä»»æ„ t-of-n é…ç½®ï¼ŒåŒæ™‚ä¿æŒåªéœ€å…©è¼ªé€šè¨Šçš„æ•ˆç‡ã€‚</p>

<p>FROST çš„å·¥ä½œåˆ†ç‚ºå…©å€‹éšæ®µã€‚å¯†é‘°ç”Ÿæˆéšæ®µï¼ˆDKGï¼ŒDistributed Key Generationï¼‰ä¸­ï¼Œåƒèˆ‡è€…å”ä½œç”Ÿæˆä¸€å€‹å…±äº«çš„å…¬é‘°å’Œå„è‡ªçš„ç§é‘°ä»½é¡ã€‚é€™å€‹éç¨‹ä½¿ç”¨å¯†ç¢¼å­¸æŠ€è¡“ï¼ˆå¦‚ Feldmanâ€™s VSSï¼‰ç¢ºä¿æ²’æœ‰ä»»ä½•äººçŸ¥é“å®Œæ•´çš„ç§é‘°ï¼Œç§é‘°åªå­˜åœ¨æ–¼æ•¸å­¸ä¸Šçš„ã€Œè™›æ“¬ã€å½¢å¼ã€‚</p>

<p>ç°½åéšæ®µä¸­ï¼Œä»»æ„ t å€‹åƒèˆ‡è€…å¯ä»¥åˆä½œç”¢ç”Ÿæœ‰æ•ˆç°½åã€‚ä»–å€‘å„è‡ªç”¨ç§é‘°ä»½é¡è¨ˆç®—ç°½åä»½é¡ï¼Œé€™äº›ä»½é¡è¢«èšåˆæˆæœ€çµ‚ç°½åã€‚åªéœ€è¦ t å€‹äººåœ¨ç·šï¼Œå…¶ä»–äººå¯ä»¥å®Œå…¨é›¢ç·šæˆ–ç”šè‡³æš«æ™‚å¤±è¯ã€‚</p>

<p>FROST çš„å„ªå‹¢åœ¨æ–¼å…¶éˆæ´»æ€§ã€‚è€ƒæ…®ä¸€å€‹ 3-of-5 çš„ä¼æ¥­é‡‘åº«ï¼šäº”ä½é«˜ç®¡å„æŒæœ‰ä¸€ä»½ç§é‘°ä»½é¡ï¼Œä»»æ„ä¸‰äººå¯ä»¥æˆæ¬Šæ”¯å‡ºã€‚å³ä½¿å…©äººé•·æœŸå‡ºå·®æˆ–é›¢è·ï¼Œå…¬å¸ä»ç„¶å¯ä»¥æ­£å¸¸é‹ç‡Ÿã€‚è€Œåœ¨éˆä¸Šï¼Œé€™èˆ‡å€‹äººéŒ¢åŒ…çš„äº¤æ˜“çœ‹èµ·ä¾†å®Œå…¨ä¸€æ¨£ã€‚</p>

<h3 id="53-å¯¦éš›æ‡‰ç”¨è€ƒé‡">5.3 å¯¦éš›æ‡‰ç”¨è€ƒé‡</h3>

<p>é–¾å€¼ç°½åé›–ç„¶å¼·å¤§ï¼Œä½†åœ¨å¯¦éš›éƒ¨ç½²ä¸­éœ€è¦è€ƒæ…®å¹¾å€‹å•é¡Œã€‚</p>

<p>é¦–å…ˆæ˜¯å¯†é‘°ç”Ÿæˆçš„è¤‡é›œæ€§ã€‚DKG å”è­°éœ€è¦åƒèˆ‡è€…ä¹‹é–“çš„åŒæ­¥é€šè¨Šï¼Œé€™åœ¨è·¨æ™‚å€ã€è·¨ç¶²è·¯ç’°å¢ƒçš„å ´æ™¯ä¸­å¯èƒ½æˆç‚ºæŒ‘æˆ°ã€‚ä¸€äº›å¯¦ç¾é¸æ“‡ä½¿ç”¨å¯ä¿¡ç¬¬ä¸‰æ–¹ä¾†ç°¡åŒ–é€™å€‹éç¨‹ï¼Œä½†é€™çŠ§ç‰²äº†éƒ¨åˆ†å»ä¸­å¿ƒåŒ–ç‰¹æ€§ã€‚</p>

<p>å…¶æ¬¡æ˜¯é–€æª»çš„é¸æ“‡ã€‚é–€æª»éä½æœƒé™ä½å®‰å…¨æ€§ï¼ˆæ”»æ“Šè€…åªéœ€æ§åˆ¶è¼ƒå°‘çš„ä»½é¡ï¼‰ï¼Œé–€æª»éé«˜æœƒé™ä½å¯ç”¨æ€§ï¼ˆéœ€è¦æ›´å¤šäººåŒæ™‚åœ¨ç·šï¼‰ã€‚ä¸åŒå ´æ™¯éœ€è¦æ ¹æ“šå…·é«”çš„å®‰å…¨å’Œå¯ç”¨æ€§éœ€æ±‚åšå‡ºæ¬Šè¡¡ã€‚</p>

<p>æœ€å¾Œæ˜¯å¯¦ç¾æˆç†Ÿåº¦ã€‚ç›¸æ¯”ç¶“éåå¤šå¹´ç”Ÿç”¢é©—è­‰çš„ OP_CHECKMULTISIGï¼Œé–¾å€¼ç°½åå”è­°ç›¸å°è¼ƒæ–°ã€‚é›–ç„¶å¯†ç¢¼å­¸åŸç†å·²ç¶“è¢«å……åˆ†ç ”ç©¶ï¼Œä½†å¯¦ç¾ä¸­çš„ç´°ç¯€å•é¡Œå¯èƒ½éœ€è¦æ™‚é–“ä¾†ç™¼ç¾å’Œè§£æ±ºã€‚</p>

<hr />

<h2 id="å…­psbtå¤šæ–¹å”ä½œçš„æ©‹æ¨‘">å…­ã€PSBTï¼šå¤šæ–¹å”ä½œçš„æ©‹æ¨‘</h2>

<h3 id="61-ç‚ºä»€éº¼éœ€è¦-psbt">6.1 ç‚ºä»€éº¼éœ€è¦ PSBT</h3>

<p>åœ¨å¤šé‡ç°½åçš„å·¥ä½œæµç¨‹ä¸­ï¼Œä¸€å€‹æ ¸å¿ƒæŒ‘æˆ°æ˜¯å¦‚ä½•åœ¨ä¸åŒçš„ç°½åè€…ä¹‹é–“å‚³éäº¤æ˜“è³‡è¨Šã€‚æ¯å€‹ç°½åè€…å¯èƒ½ä½¿ç”¨ä¸åŒçš„éŒ¢åŒ…è»Ÿé«”æˆ–ç¡¬é«”è¨­å‚™ï¼Œå¯èƒ½è™•æ–¼é›¢ç·šç‹€æ…‹ï¼Œç”šè‡³å¯èƒ½ä½æ–¼ä¸–ç•Œçš„ä¸åŒè§’è½ã€‚</p>

<p>PSBTï¼ˆPartially Signed Bitcoin Transactionï¼Œéƒ¨åˆ†ç°½åæ¯”ç‰¹å¹£äº¤æ˜“ï¼‰æ˜¯ BIP 174 å®šç¾©çš„æ¨™æº–æ ¼å¼ï¼Œå°ˆé–€è§£æ±ºé€™å€‹å•é¡Œã€‚å®ƒæ˜¯ä¸€ç¨®å¯ä»¥æ”œå¸¶äº¤æ˜“æ‰€æœ‰ç›¸é—œè³‡è¨Šçš„å®¹å™¨æ ¼å¼ï¼ŒåŒ…æ‹¬æœªç°½åçš„äº¤æ˜“æœ¬èº«ã€æ¯å€‹è¼¸å…¥çš„è©³ç´°è³‡è¨Šï¼ˆå¦‚ UTXO æ•¸æ“šã€è…³æœ¬ã€å·²æ”¶é›†çš„ç°½åç­‰ï¼‰ã€ä»¥åŠè¼¸å‡ºè³‡è¨Šã€‚</p>

<p>PSBT çš„è¨­è¨ˆç†å¿µæ˜¯è®“ä¸åŒçš„è»Ÿé«”å’Œè¨­å‚™å¯ä»¥å„è‡ªå®Œæˆè‡ªå·±èƒ½åšçš„éƒ¨åˆ†ï¼Œç„¶å¾Œå‚³éçµ¦ä¸‹ä¸€å€‹åƒèˆ‡è€…ã€‚ä¸€å€‹å‰µå»ºè€…å¯ä»¥æ§‹å»ºåŸºæœ¬äº¤æ˜“çµæ§‹ï¼Œæ›´æ–°è€…å¯ä»¥æ·»åŠ è¼¸å…¥è¼¸å‡ºçš„è©³ç´°è³‡è¨Šï¼Œå¤šå€‹ç°½åè€…å¯ä»¥ç¨ç«‹æ·»åŠ è‡ªå·±çš„ç°½åï¼Œçµ„åˆè€…å¯ä»¥å°‡ä¸åŒä¾†æºçš„ç°½ååˆä½µï¼Œå®Œæˆè€…å¯ä»¥æ§‹å»ºæœ€çµ‚çš„äº¤æ˜“æ ¼å¼ï¼Œæå–è€…å¯ä»¥å¾—åˆ°å¯å»£æ’­çš„åŸå§‹äº¤æ˜“ã€‚</p>

<h3 id="62-psbt-çš„çµæ§‹">6.2 PSBT çš„çµæ§‹</h3>

<p>PSBT ä½¿ç”¨éµå€¼å°æ ¼å¼å­˜å„²è³‡æ–™ï¼Œé€™ç¨®æ ¼å¼å…·æœ‰è‰¯å¥½çš„æ“´å±•æ€§â€”â€”æ–°çš„æ¬„ä½é¡å‹å¯ä»¥è¢«æ·»åŠ è€Œä¸ç ´å£èˆŠå¯¦ç¾çš„å…¼å®¹æ€§ã€‚</p>

<p>å…¨å±€æ•¸æ“šåŒ…å«äº¤æ˜“æœ¬èº«ï¼ˆæœªç°½åå½¢å¼ï¼‰å’Œ PSBT ç‰ˆæœ¬è³‡è¨Šã€‚æ¯å€‹è¼¸å…¥çš„æ•¸æ“šå¯èƒ½åŒ…å«ï¼šé witness UTXOï¼ˆå®Œæ•´çš„å‰åºäº¤æ˜“ï¼‰ã€witness UTXOï¼ˆåªæœ‰ç›¸é—œè¼¸å‡ºçš„è³‡è¨Šï¼‰ã€è´–å›è…³æœ¬ã€witness è…³æœ¬ã€å„ç¨®è¡ç”Ÿè·¯å¾‘è³‡è¨Šã€ä»¥åŠéƒ¨åˆ†ç°½åçš„é›†åˆã€‚æ¯å€‹è¼¸å‡ºçš„æ•¸æ“šé€šå¸¸åŒ…å«é‡‘é¡å’Œè…³æœ¬è³‡è¨Šã€‚</p>

<p>é€™ç¨®è±å¯Œçš„è³‡è¨Šçµæ§‹è®“ç°½åè¨­å‚™ï¼ˆç‰¹åˆ¥æ˜¯ç¡¬é«”éŒ¢åŒ…ï¼‰å¯ä»¥é©—è­‰äº¤æ˜“çš„æ‰€æœ‰é—œéµæ–¹é¢ï¼šè¼¸å…¥æ˜¯å¦å­˜åœ¨ã€è¼¸å‡ºæ˜¯å¦æ­£ç¢ºã€æ‰¾é›¶æ˜¯å¦åˆç†ã€è²»ç”¨æ˜¯å¦éé«˜ã€‚é€™äº›é©—è­‰å°æ–¼é˜²æ­¢ç°½åè€…è¢«æ¬ºé¨™è‡³é—œé‡è¦ã€‚</p>

<h3 id="63-å¤šç°½å·¥ä½œæµç¨‹">6.3 å¤šç°½å·¥ä½œæµç¨‹</h3>

<p>è®“æˆ‘å€‘çœ‹ä¸€å€‹ä½¿ç”¨ PSBT çš„ 2-of-3 å¤šç°½å®Œæ•´å·¥ä½œæµç¨‹ã€‚</p>

<p>å”èª¿è€…é¦–å…ˆå‰µå»ºä¸€å€‹ PSBTï¼ŒåŒ…å«è¦èŠ±è²»çš„ UTXO å’Œç›®æ¨™è¼¸å‡ºã€‚é€™å€‹åˆå§‹ PSBT é‚„æ²’æœ‰ä»»ä½•ç°½åï¼Œä½†åŒ…å«äº†è¶³å¤ çš„è³‡è¨Šè®“ç°½åè€…ç†è§£é€™ç­†äº¤æ˜“åœ¨åšä»€éº¼ã€‚</p>

<p>PSBT è¢«ç™¼é€çµ¦ç¬¬ä¸€å€‹ç°½åè€…ï¼ˆå¯èƒ½é€šéé›»å­éƒµä»¶ã€å³æ™‚é€šè¨Šã€æˆ–ä»»ä½•æª”æ¡ˆå‚³è¼¸æ–¹å¼ï¼‰ã€‚ç°½åè€…çš„éŒ¢åŒ…è»Ÿé«”æˆ–ç¡¬é«”è§£æ PSBTï¼Œé¡¯ç¤ºäº¤æ˜“è©³æƒ…ä¾›ç”¨æˆ¶ç¢ºèªï¼Œç„¶å¾Œç”¨è‡ªå·±çš„ç§é‘°ç°½åä¸¦å°‡éƒ¨åˆ†ç°½åæ·»åŠ åˆ° PSBT ä¸­ã€‚</p>

<p>ç¬¬ä¸€å€‹ç°½åè€…è¿”å›æ›´æ–°å¾Œçš„ PSBTï¼Œç„¶å¾Œç™¼é€çµ¦ç¬¬äºŒå€‹ç°½åè€…ã€‚ç¬¬äºŒå€‹ç°½åè€…é‡è¤‡åŒæ¨£çš„éç¨‹ï¼Œæ·»åŠ è‡ªå·±çš„ç°½åã€‚</p>

<p>ç¾åœ¨ PSBT åŒ…å«äº†è¶³å¤ çš„ç°½åï¼ˆ2 å€‹ï¼‰ã€‚çµ„åˆè€…ï¼ˆå¯èƒ½æ˜¯å”èª¿è€…æœ¬äººï¼‰é©—è­‰æ‰€æœ‰ç°½åçš„æœ‰æ•ˆæ€§ï¼Œç„¶å¾Œã€Œå®Œæˆã€PSBTâ€”â€”å°‡ç°½åå’Œè…³æœ¬çµ„åˆæˆæœ€çµ‚çš„ scriptSig æˆ– witness æ ¼å¼ã€‚</p>

<p>æœ€å¾Œï¼Œå¾å®Œæˆçš„ PSBT ä¸­æå–åŸå§‹äº¤æ˜“ä¸¦å»£æ’­åˆ°æ¯”ç‰¹å¹£ç¶²è·¯ã€‚</p>

<p>é€™å€‹æµç¨‹çš„å„ªé›…ä¹‹è™•åœ¨æ–¼å®ƒçš„æ¨¡çµ„åŒ–ï¼šæ¯å€‹åƒèˆ‡è€…åªéœ€è¦é—œå¿ƒè‡ªå·±çš„æ­¥é©Ÿï¼Œä¸éœ€è¦äº†è§£å…¶ä»–äººä½¿ç”¨ä»€éº¼è»Ÿé«”æˆ–åœ¨å“ªè£¡ç°½åã€‚</p>

<hr />

<h2 id="ä¸ƒå®‰å…¨æœ€ä½³å¯¦è¸">ä¸ƒã€å®‰å…¨æœ€ä½³å¯¦è¸</h2>

<h3 id="71-å¯†é‘°åˆ†æ•£åŸå‰‡">7.1 å¯†é‘°åˆ†æ•£åŸå‰‡</h3>

<p>å¤šé‡ç°½åçš„å®‰å…¨æ€§å»ºç«‹åœ¨å¯†é‘°åˆ†æ•£çš„åŸºç¤ä¸Šã€‚å¦‚æœæ‰€æœ‰å¯†é‘°éƒ½å­˜å„²åœ¨åŒä¸€å€‹åœ°æ–¹ï¼Œé‚£éº¼å¤šç°½å°±å¤±å»äº†æ„ç¾©â€”â€”æ”»æ“Šè€…åªéœ€è¦å…¥ä¾µä¸€å€‹ä½ç½®å°±èƒ½ç²å¾—æ‰€æœ‰å¯†é‘°ã€‚</p>

<p>åœ°ç†åˆ†æ•£æ˜¯ç¬¬ä¸€é“é˜²ç·šã€‚ä¸åŒçš„å¯†é‘°æ‡‰è©²å­˜å„²åœ¨ä¸åŒçš„ç‰©ç†ä½ç½®ï¼Œé€™æ¨£å³ä½¿ä¸€å€‹ä½ç½®è¢«å…¥ä¾µã€è¢«æ²’æ”¶ã€æˆ–è€…é­å—è‡ªç„¶ç½å®³ï¼Œå…¶ä»–å¯†é‘°ä»ç„¶å®‰å…¨ã€‚</p>

<p>è¨­å‚™å¤šæ¨£åŒ–æ˜¯å¦ä¸€å€‹é‡è¦è€ƒé‡ã€‚ä½¿ç”¨ä¸åŒå“ç‰Œã€ä¸åŒå‹è™Ÿçš„ç¡¬é«”éŒ¢åŒ…å¯ä»¥é˜²æ­¢æŸå€‹ç‰¹å®šè¨­å‚™çš„æ¼æ´å½±éŸ¿æ•´å€‹ç³»çµ±çš„å®‰å…¨ã€‚å¦‚æœæ‰€æœ‰å¯†é‘°éƒ½å­˜å„²åœ¨åŒä¸€å“ç‰Œçš„ç¡¬é«”éŒ¢åŒ…ä¸Šï¼Œé‚£éº¼è©²å“ç‰Œçš„å®‰å…¨æ¼æ´å°±å¯èƒ½æˆç‚ºè‡´å‘½å¼±é»ã€‚</p>

<p>äººå“¡åˆ†é›¢åœ¨ä¼æ¥­å ´æ™¯ä¸­å°¤ç‚ºé‡è¦ã€‚ä¸åŒçš„å¯†é‘°æ‡‰è©²ç”±ä¸åŒçš„äººæ§åˆ¶ï¼Œé€™æ¨£å¯ä»¥é˜²æ­¢å–®å€‹äººçš„èƒŒå›æˆ–å¤±è·å½±éŸ¿æ•´é«”å®‰å…¨ã€‚åŒæ™‚ï¼Œé€™ä¹Ÿç‚ºçµ„ç¹”æä¾›äº†è·è²¬åˆ†é›¢çš„ä¿éšœã€‚</p>

<h3 id="72-å‚™ä»½ç­–ç•¥">7.2 å‚™ä»½ç­–ç•¥</h3>

<p>å¤šç°½éŒ¢åŒ…çš„å‚™ä»½æ¯”å–®ç°½éŒ¢åŒ…æ›´è¤‡é›œï¼Œå› ç‚ºéœ€è¦è€ƒæ…®å¤šå€‹çµ„æˆéƒ¨åˆ†ã€‚</p>

<p>æ¯å€‹ç§é‘°ï¼ˆæˆ–åŠ©è¨˜è©ï¼‰éœ€è¦ç¨ç«‹å‚™ä»½ï¼Œä¸¦ä¸”å‚™ä»½æ‡‰è©²èˆ‡åŸå§‹å­˜å„²ä½ç½®åˆ†é–‹ã€‚å‚™ä»½çš„å®‰å…¨ç´šåˆ¥æ‡‰è©²èˆ‡åŸå§‹å¯†é‘°ç›¸ç•¶â€”â€”å¦‚æœåŸå§‹å¯†é‘°åœ¨ç¡¬é«”éŒ¢åŒ…ä¸­å—åˆ°ä¿è­·ï¼Œå‚™ä»½ä¹Ÿæ‡‰è©²è¢«å¦¥å–„åŠ å¯†æˆ–ç‰©ç†ä¿è­·ã€‚</p>

<p>é™¤äº†ç§é‘°æœ¬èº«ï¼Œé‚„éœ€è¦å‚™ä»½å¤šç°½é…ç½®è³‡è¨Šï¼šæ‰€æœ‰å…¬é‘°çš„åˆ—è¡¨ã€é–¾å€¼è¨­ç½®ï¼ˆm-of-nï¼‰ã€è…³æœ¬é¡å‹ï¼ˆP2SH/P2WSH/P2TRï¼‰ã€è¡ç”Ÿè·¯å¾‘ç­‰ã€‚æ²’æœ‰é€™äº›è³‡è¨Šï¼Œå³ä½¿æ“æœ‰æ‰€æœ‰ç§é‘°ä¹Ÿç„¡æ³•é‡å»ºéŒ¢åŒ…ã€‚</p>

<p>ä¸€å€‹å¸¸è¦‹çš„åšæ³•æ˜¯å‰µå»ºä¸€å€‹ã€Œè¨­ç½®æè¿°ç¬¦ã€ï¼Œé€™æ˜¯ä¸€ç¨®æ¨™æº–åŒ–æ ¼å¼ï¼Œå®Œæ•´æè¿°äº†å¤šç°½éŒ¢åŒ…çš„çµæ§‹ã€‚é€™å€‹æè¿°ç¬¦ä¸åŒ…å«ç§é‘°è³‡è¨Šï¼Œå¯ä»¥ç›¸å°å®‰å…¨åœ°å­˜å„²åœ¨å¤šå€‹ä½ç½®ã€‚</p>

<h3 id="73-æ¸¬è©¦æ¢å¾©æµç¨‹">7.3 æ¸¬è©¦æ¢å¾©æµç¨‹</h3>

<p>å‚™ä»½çš„åƒ¹å€¼åªæœ‰åœ¨æ¢å¾©æ™‚æ‰èƒ½é«”ç¾ã€‚å› æ­¤ï¼Œå®šæœŸæ¸¬è©¦æ¢å¾©æµç¨‹æ˜¯å®‰å…¨å¯¦è¸çš„é‡è¦çµ„æˆéƒ¨åˆ†ã€‚</p>

<p>åœ¨å°é¡æ¸¬è©¦è³‡é‡‘çš„æƒ…æ³ä¸‹ï¼Œå˜—è©¦å®Œæ•´çš„æ¢å¾©éç¨‹ï¼šä½¿ç”¨å‚™ä»½æ¢å¾©æ¯å€‹å¯†é‘°ã€é‡å»ºå¤šç°½éŒ¢åŒ…é…ç½®ã€å‰µå»ºä¸¦ç°½åæ¸¬è©¦äº¤æ˜“ã€‚é€™å€‹éç¨‹å¯ä»¥ç™¼ç¾å‚™ä»½ä¸­çš„å•é¡Œï¼Œä¹Ÿè®“ç›¸é—œäººå“¡ç†Ÿæ‚‰ç·Šæ€¥æƒ…æ³ä¸‹çš„æ“ä½œæµç¨‹ã€‚</p>

<p>å°æ–¼å¤§é¡è³‡ç”¢ï¼Œæ‡‰è©²å®šæœŸï¼ˆä¾‹å¦‚æ¯å¹´ä¸€æ¬¡ï¼‰é©—è­‰æ‰€æœ‰å‚™ä»½çš„å®Œæ•´æ€§å’Œå¯è¨ªå•æ€§ï¼Œä½†ä¸éœ€è¦æ¯æ¬¡éƒ½å¯¦éš›æ¢å¾©â€”â€”åªéœ€ç¢ºèªå‚™ä»½å­˜åœ¨ã€å¯è®€ã€ä¸”å…§å®¹æ­£ç¢ºå³å¯ã€‚</p>

<hr />

<h2 id="å…«å¯¦ä½œç·´ç¿’">å…«ã€å¯¦ä½œç·´ç¿’</h2>

<h3 id="ç·´ç¿’-1å»ºç«‹-2-of-3-p2wsh-å¤šç°½åœ°å€">ç·´ç¿’ 1ï¼šå»ºç«‹ 2-of-3 P2WSH å¤šç°½åœ°å€</h3>

<p>çµ¦å®šä¸‰å€‹å…¬é‘°ï¼Œæ‰‹å‹•è¨ˆç®— 2-of-3 P2WSH å¤šç°½åœ°å€ã€‚æ­¥é©ŸåŒ…æ‹¬ï¼šæŒ‰å­—å…¸åºå°å…¬é‘°æ’åºã€æ§‹å»º witness scriptã€è¨ˆç®— SHA256 é›œæ¹Šã€ç”¨ Bech32 ç·¨ç¢¼ç”Ÿæˆåœ°å€ã€‚å˜—è©¦ç”¨ä½ ç†Ÿæ‚‰çš„ç¨‹å¼èªè¨€å¯¦ç¾é€™å€‹éç¨‹ã€‚</p>

<h3 id="ç·´ç¿’-2æ¨¡æ“¬-psbt-å·¥ä½œæµç¨‹">ç·´ç¿’ 2ï¼šæ¨¡æ“¬ PSBT å·¥ä½œæµç¨‹</h3>

<p>è¨­è¨ˆä¸€å€‹ç°¡å–®çš„å¤šç°½äº¤æ˜“å ´æ™¯ï¼ŒåŒ…æ‹¬ï¼šå‰µå»ºåˆå§‹ PSBTã€ç¬¬ä¸€å€‹ç°½åè€…æ·»åŠ ç°½åã€ç¬¬äºŒå€‹ç°½åè€…æ·»åŠ ç°½åã€çµ„åˆä¸¦å®Œæˆ PSBTã€æå–æœ€çµ‚äº¤æ˜“ã€‚å¯ä»¥ä½¿ç”¨ Bitcoin Core çš„ RPC å‘½ä»¤æˆ–ä»»ä½•æ”¯æ´ PSBT çš„ç¨‹å¼åº«ã€‚</p>

<h3 id="ç·´ç¿’-3æ¯”è¼ƒä¸åŒå¤šç°½æ–¹æ¡ˆçš„æ•ˆç‡">ç·´ç¿’ 3ï¼šæ¯”è¼ƒä¸åŒå¤šç°½æ–¹æ¡ˆçš„æ•ˆç‡</h3>

<p>è¨ˆç®—ç›¸åŒ 2-of-3 é…ç½®åœ¨ä¸åŒæ–¹æ¡ˆä¸‹çš„äº¤æ˜“å¤§å°ï¼šP2SHã€P2WSHã€Taproot Script Pathã€Taproot Key Pathï¼ˆå‡è¨­ä½¿ç”¨ MuSig2ï¼‰ã€‚åˆ†ææ¯ç¨®æ–¹æ¡ˆçš„ç©ºé–“æ•ˆç‡å’Œéš±ç§ç‰¹æ€§ã€‚</p>

<hr />

<h2 id="ä¹å°çµ">ä¹ã€å°çµ</h2>

<p>æœ¬ç¯‡æˆ‘å€‘æ·±å…¥æ¢è¨äº†æ¯”ç‰¹å¹£å¤šé‡ç°½åçš„å„å€‹å±¤é¢ï¼š</p>

<p><strong>å‚³çµ±å¤šç°½</strong>ä½¿ç”¨ OP_CHECKMULTISIGï¼Œæ˜¯æœ€æ—©çš„æ¨™æº–åŒ–æ–¹æ¡ˆã€‚é›–ç„¶æœ‰ off-by-one bug å’Œç°½åé †åºé™åˆ¶ç­‰æ­·å²åŒ…è¢±ï¼Œä½†å®ƒç¶“éäº†åå¤šå¹´çš„ç”Ÿç”¢é©—è­‰ï¼Œä»ç„¶æ˜¯å¯é çš„é¸æ“‡ã€‚</p>

<p><strong>SegWit å¤šç°½</strong>ï¼ˆP2WSHï¼‰æä¾›äº†ç´„ 35% çš„è²»ç”¨ç¯€çœå’Œæ›´å¼·çš„é›œæ¹Šå®‰å…¨æ€§ï¼Œæ˜¯ç›®å‰ä¼æ¥­æ‡‰ç”¨çš„ä¸»æµé¸æ“‡ã€‚</p>

<p><strong>Taproot å¤šç°½</strong>å¸¶ä¾†äº†é©å‘½æ€§çš„æ”¹é€²ã€‚é€é MuSig2 çš„ Key Pathï¼Œn-of-n å¤šç°½å¯ä»¥é”åˆ°èˆ‡å–®ç°½åç›¸åŒçš„æ•ˆç‡å’Œéš±ç§ï¼›é€é Tapscript çš„ OP_CHECKSIGADDï¼Œm-of-n é…ç½®ç²å¾—äº†æ›´å¥½çš„éˆæ´»æ€§å’Œæ‰¹é‡é©—è­‰æ”¯æ´ã€‚</p>

<p><strong>é–¾å€¼ç°½å</strong>å¦‚ FROST ä»£è¡¨äº†ä¸‹ä¸€ä»£å¤šæ–¹å®‰å…¨æŠ€è¡“ï¼Œå¯ä»¥åœ¨å¯†ç¢¼å­¸å±¤é¢å¯¦ç¾å°å¤–å®Œå…¨éš±è—çš„å¤šæ–¹æˆæ¬Šã€‚</p>

<p><strong>PSBT</strong> ä½œç‚ºå¤šç°½å·¥ä½œæµç¨‹çš„æ¨™æº–åŒ–æ ¼å¼ï¼Œè§£æ±ºäº†ä¸åŒè»Ÿé«”å’Œè¨­å‚™ä¹‹é–“çš„äº’æ“ä½œæ€§å•é¡Œã€‚</p>

<p>é¸æ“‡å“ªç¨®å¤šç°½æ–¹æ¡ˆå–æ±ºæ–¼å…·é«”éœ€æ±‚ï¼šéœ€è¦æœ€é«˜éš±ç§å’Œæ•ˆç‡ï¼Œé¸æ“‡ Taproot Key Pathï¼›éœ€è¦éˆæ´»çš„é–¾å€¼é…ç½®ï¼Œé¸æ“‡ Taproot Script Path æˆ–å‚³çµ±æ–¹æ¡ˆï¼›éœ€è¦èˆ‡èˆŠç³»çµ±å…¼å®¹ï¼Œé¸æ“‡ P2WSH æˆ– P2SHã€‚</p>

<hr />

<h2 id="ä¸‹ä¸€ç¯‡é å‘Š">ä¸‹ä¸€ç¯‡é å‘Š</h2>

<p>åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å€‘å°‡æ¢è¨æ™‚é–“é–æ©Ÿåˆ¶â€”â€”æ¯”ç‰¹å¹£è…³æœ¬ä¸­æ§åˆ¶ã€Œä½•æ™‚ã€å¯ä»¥èŠ±è²»è³‡é‡‘çš„å¼·å¤§å·¥å…·ã€‚æˆ‘å€‘æœƒæ·±å…¥äº†è§£çµ•å°æ™‚é–“é–ï¼ˆnLocktimeã€OP_CHECKLOCKTIMEVERIFYï¼‰å’Œç›¸å°æ™‚é–“é–ï¼ˆnSequenceã€OP_CHECKSEQUENCEVERIFYï¼‰ï¼Œä¸¦æ¢è¨å®ƒå€‘åœ¨é–ƒé›»ç¶²è·¯ã€åŸå­äº¤æ›ã€éºç”¢è¦åŠƒç­‰å ´æ™¯ä¸­çš„æ‡‰ç”¨ã€‚</p>

<hr />

<h2 id="åƒè€ƒè³‡æ–™">åƒè€ƒè³‡æ–™</h2>

<ul>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0011.mediawiki">BIP 11: M-of-N æ¨™æº–äº¤æ˜“</a> - æœ€æ—©çš„å¤šç°½æ¨™æº–</li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0016.mediawiki">BIP 16: P2SH</a> - Pay to Script Hash è¦ç¯„</li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0147.mediawiki">BIP 147: NULLDUMMY</a> - ä¿®å¾©å¤šç°½å»¶å±•æ€§</li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki">BIP 174: PSBT</a> - éƒ¨åˆ†ç°½åäº¤æ˜“æ ¼å¼</li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0327.mediawiki">BIP 327: MuSig2</a> - Schnorr å¤šç°½èšåˆå”è­°</li>
  <li><a href="https://bitcoinops.org/en/topics/multisignature/">Bitcoin Optech: Multisig</a> - å¤šç°½ä¸»é¡Œæ·±å…¥è§£æ</li>
  <li><a href="https://eprint.iacr.org/2020/852">FROST è«–æ–‡</a> - é–¾å€¼ç°½åçš„å­¸è¡“åŸºç¤</li>
</ul>]]></content><author><name>Cypherpunks Taiwan</name></author><category term="æŠ€è¡“æ•™å­¸" /><category term="bitcoin" /><category term="development" /><category term="bitcoin" /><category term="script" /><category term="multisig" /><category term="musig" /><category term="threshold" /><summary type="html"><![CDATA[Bitcoin Script ç³»åˆ—ç¬¬å››ç¯‡ï¼Œæ·±å…¥è§£æå¤šé‡ç°½åçš„å„ç¨®å¯¦ç¾æ–¹å¼ï¼ŒåŒ…æ‹¬å‚³çµ± P2SHã€SegWitã€Taproot MuSig2ï¼Œä»¥åŠé–¾å€¼ç°½åæ–¹æ¡ˆã€‚]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" /><media:content medium="image" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Bitcoin Script å¯¦æˆ°æ•™å­¸ï¼ˆä¸‰ï¼‰ï¼šSegWit èˆ‡ Taproot æ·±å…¥è§£æ</title><link href="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/development/2025/03/17/bitcoin-script-tutorial-3-segwit-taproot/" rel="alternate" type="text/html" title="Bitcoin Script å¯¦æˆ°æ•™å­¸ï¼ˆä¸‰ï¼‰ï¼šSegWit èˆ‡ Taproot æ·±å…¥è§£æ" /><published>2025-03-17T00:00:00+00:00</published><updated>2025-03-17T00:00:00+00:00</updated><id>https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/development/2025/03/17/bitcoin-script-tutorial-3-segwit-taproot</id><content type="html" xml:base="https://cypherpunks-core.github.io/%E6%8A%80%E8%A1%93%E6%95%99%E5%AD%B8/bitcoin/development/2025/03/17/bitcoin-script-tutorial-3-segwit-taproot/"><![CDATA[<h2 id="ç³»åˆ—å°è¨€">ç³»åˆ—å°è¨€</h2>

<p>é€™æ˜¯ã€ŒBitcoin Script å¯¦æˆ°æ•™å­¸ã€ç³»åˆ—çš„ç¬¬ä¸‰ç¯‡ã€‚æœ¬ç¯‡å°‡æ·±å…¥æ¢è¨ SegWit å’Œ Taproot é€™å…©å€‹é‡è¦å‡ç´šå¦‚ä½•æ”¹è®Šäº†æ¯”ç‰¹å¹£è…³æœ¬çš„åŸ·è¡Œæ–¹å¼ã€‚é€™å…©å€‹å‡ç´šä»£è¡¨äº†æ¯”ç‰¹å¹£å”è­°æ­·å²ä¸Šæœ€é‡è¦çš„æŠ€è¡“é©æ–°ï¼Œä¸åƒ…è§£æ±ºäº†é•·æœŸå­˜åœ¨çš„æŠ€è¡“å•é¡Œï¼Œæ›´ç‚ºæ¯”ç‰¹å¹£çš„æœªä¾†ç™¼å±•å¥ å®šäº†åŸºç¤ã€‚</p>

<p><strong>ç³»åˆ—æ–‡ç« ï¼š</strong></p>
<ol>
  <li><a href="/bitcoin/development/2025/03/15/bitcoin-script-tutorial-1-fundamentals/">åŸºç¤æ¦‚å¿µèˆ‡æ“ä½œç¢¼</a></li>
  <li><a href="/bitcoin/development/2025/03/16/bitcoin-script-tutorial-2-standard-scripts/">æ¨™æº–è…³æœ¬é¡å‹è©³è§£</a></li>
  <li><strong>SegWit èˆ‡ Taproot æ·±å…¥è§£æ</strong>ï¼ˆæœ¬ç¯‡ï¼‰</li>
  <li>å¤šé‡ç°½åå¯¦ç¾</li>
  <li>æ™‚é–“é–æ©Ÿåˆ¶</li>
  <li>é€²éšæ‡‰ç”¨èˆ‡æ™ºèƒ½åˆç´„</li>
</ol>

<hr />

<h2 id="ä¸€segwit-æ·±å…¥è§£æ">ä¸€ã€SegWit æ·±å…¥è§£æ</h2>

<h3 id="11-ä»€éº¼æ˜¯-segwit">1.1 ä»€éº¼æ˜¯ SegWitï¼Ÿ</h3>

<p>SegWit æ˜¯ Segregated Witnessï¼ˆéš”é›¢è¦‹è­‰ï¼‰çš„ç¸®å¯«ï¼Œæ–¼ 2017 å¹´ 8 æœˆé€éè»Ÿåˆ†å‰æ–¹å¼åœ¨æ¯”ç‰¹å¹£ä¸»ç¶²å•Ÿå‹•ã€‚é€™å€‹å‡ç´šçš„æ ¸å¿ƒæ€æƒ³éå¸¸ç°¡å–®ä½†å½±éŸ¿æ·±é ï¼šå°‡äº¤æ˜“çš„ç°½åæ•¸æ“šï¼ˆwitnessï¼‰å¾äº¤æ˜“ä¸»é«”ä¸­åˆ†é›¢å‡ºä¾†ã€‚</p>

<p>ã€Œè¦‹è­‰ã€åœ¨å¯†ç¢¼å­¸å’Œæ³•å¾‹ç”¨èªä¸­éƒ½æŒ‡çš„æ˜¯ã€Œè­‰æ˜æŸäº‹ç‚ºçœŸçš„è­‰æ“šã€ã€‚åœ¨æ¯”ç‰¹å¹£äº¤æ˜“ä¸­ï¼Œè¦‹è­‰å°±æ˜¯æ•¸ä½ç°½åâ€”â€”å®ƒè­‰æ˜äº¤æ˜“ç™¼èµ·è€…ç¢ºå¯¦æ“æœ‰èŠ±è²»é€™äº›æ¯”ç‰¹å¹£çš„æ¬Šé™ã€‚åœ¨ SegWit ä¹‹å‰ï¼Œé€™äº›ç°½åæ•¸æ“šå’Œäº¤æ˜“çš„å…¶ä»–éƒ¨åˆ†æ··åˆåœ¨ä¸€èµ·ï¼›SegWit å‰‡å°‡å®ƒå€‘ã€Œéš”é›¢ã€åˆ°ä¸€å€‹ç¨ç«‹çš„å€åŸŸã€‚</p>

<p>é€™å€‹çœ‹ä¼¼ç°¡å–®çš„æ¶æ§‹æ”¹è®Šï¼Œè§£æ±ºäº†å›°æ“¾æ¯”ç‰¹å¹£å¤šå¹´çš„å¹¾å€‹é—œéµå•é¡Œã€‚</p>

<h3 id="12-äº¤æ˜“å»¶å±•æ€§å•é¡Œ">1.2 äº¤æ˜“å»¶å±•æ€§å•é¡Œ</h3>

<p>äº¤æ˜“å»¶å±•æ€§ï¼ˆTransaction Malleabilityï¼‰æ˜¯ SegWit è§£æ±ºçš„æœ€é‡è¦å•é¡Œä¹‹ä¸€ã€‚è¦ç†è§£é€™å€‹å•é¡Œï¼Œæˆ‘å€‘éœ€è¦å…ˆäº†è§£æ¯”ç‰¹å¹£å¦‚ä½•è­˜åˆ¥äº¤æ˜“ã€‚</p>

<p>æ¯ç­†æ¯”ç‰¹å¹£äº¤æ˜“éƒ½æœ‰ä¸€å€‹å”¯ä¸€è­˜åˆ¥ç¢¼ï¼Œç¨±ç‚ºäº¤æ˜“ IDï¼ˆtxidï¼‰ã€‚é€™å€‹ ID æ˜¯é€éå°æ•´å€‹äº¤æ˜“é€²è¡Œé›™é‡ SHA-256 é›œæ¹Šé‹ç®—å¾—åˆ°çš„ã€‚å•é¡Œåœ¨æ–¼ï¼Œåœ¨å‚³çµ±äº¤æ˜“æ ¼å¼ä¸­ï¼Œç°½åæ•¸æ“šä¹ŸåŒ…å«åœ¨é€™å€‹é›œæ¹Šè¨ˆç®—ä¸­ã€‚</p>

<p>ECDSA ç°½åæœ‰ä¸€å€‹æ•¸å­¸ç‰¹æ€§ï¼šå°æ–¼åŒä¸€å€‹è¨Šæ¯ï¼Œå­˜åœ¨å¤šå€‹æ•¸å­¸ä¸Šç­‰åƒ¹çš„æœ‰æ•ˆç°½åã€‚å…·é«”ä¾†èªªï¼Œå¦‚æœ (r, s) æ˜¯ä¸€å€‹æœ‰æ•ˆç°½åï¼Œé‚£éº¼ (r, -s mod n) ä¹Ÿæ˜¯æœ‰æ•ˆçš„ã€‚é€™æ„å‘³è‘—ä»»ä½•äººï¼ˆä¸éœ€è¦ç§é‘°ï¼‰éƒ½å¯ä»¥ä¿®æ”¹äº¤æ˜“ä¸­çš„ç°½åï¼Œç”¢ç”Ÿä¸€å€‹ä¸åŒçš„ txidï¼Œä½†äº¤æ˜“ä»ç„¶æœ‰æ•ˆã€‚</p>

<p>é€™å€‹å•é¡Œå°æ–¼ä¸€èˆ¬çš„å–®ç­†äº¤æ˜“å½±éŸ¿ä¸å¤§ï¼Œä½†å°æ–¼ä¾è³´æœªç¢ºèªäº¤æ˜“ txid çš„æ‡‰ç”¨ä¾†èªªæ˜¯ç½é›£æ€§çš„ã€‚æœ€å…¸å‹çš„ä¾‹å­æ˜¯é–ƒé›»ç¶²è·¯ï¼šå®ƒéœ€è¦å»ºç«‹ä¸€é€£ä¸²ç›¸äº’ä¾è³´çš„äº¤æ˜“ï¼Œå¦‚æœå…¶ä¸­ä¸€ç­†äº¤æ˜“çš„ txid è¢«ä¿®æ”¹ï¼Œæ•´å€‹äº¤æ˜“éˆå°±æœƒæ–·è£‚ã€‚2014 å¹´ï¼ŒMt. Gox äº¤æ˜“æ‰€çš„éƒ¨åˆ†æå¤±å°±èˆ‡äº¤æ˜“å»¶å±•æ€§æ”»æ“Šæœ‰é—œã€‚</p>

<p>SegWit çš„è§£æ±ºæ–¹æ¡ˆéå¸¸å„ªé›…ï¼šæ—¢ç„¶å•é¡Œå‡ºåœ¨ç°½åæœƒå½±éŸ¿ txidï¼Œé‚£å°±æŠŠç°½åç§»åˆ° txid è¨ˆç®—ç¯„åœä¹‹å¤–ã€‚äº¤æ˜“çš„æ ¸å¿ƒæ•¸æ“šï¼ˆç™¼é€è€…ã€æ¥æ”¶è€…ã€é‡‘é¡ï¼‰ç”¨ä¾†è¨ˆç®— txidï¼Œè€Œç°½åå‰‡å­˜æ”¾åœ¨ç¨ç«‹çš„ witness å€åŸŸã€‚é€™æ¨£ï¼Œç„¡è«–ç°½åå¦‚ä½•è¢«ä¿®æ”¹ï¼Œtxid éƒ½ä¿æŒä¸è®Šã€‚</p>

<h3 id="13-å€å¡Šå®¹é‡æå‡">1.3 å€å¡Šå®¹é‡æå‡</h3>

<p>æ¯”ç‰¹å¹£å€å¡Šå¤§å°é™åˆ¶ç‚º 1MBï¼Œé€™å€‹é™åˆ¶æºè‡ªä¸­æœ¬è°æ—©æœŸç‚ºé˜²æ­¢åƒåœ¾äº¤æ˜“æ”»æ“Šæ‰€è¨­ç½®çš„åƒæ•¸ã€‚éš¨è‘—æ¯”ç‰¹å¹£ä½¿ç”¨é‡å¢åŠ ï¼Œé€™å€‹é™åˆ¶é–‹å§‹åˆ¶ç´„äº¤æ˜“è™•ç†èƒ½åŠ›ï¼Œå°è‡´äº¤æ˜“è²»ç”¨ä¸Šå‡å’Œç¢ºèªæ™‚é–“å»¶é•·ã€‚</p>

<p>ç›´æ¥å¢åŠ å€å¡Šå¤§å°éœ€è¦ç¡¬åˆ†å‰ï¼Œé€™æ„å‘³è‘—æ‰€æœ‰ç¯€é»å¿…é ˆåŒæ™‚å‡ç´šï¼Œå¦å‰‡ç¶²è·¯æœƒåˆ†è£‚ã€‚é€™åœ¨ç¤¾å€ä¸­å¼•ç™¼äº†æ¿€çƒˆçˆ­è«–ï¼Œæœ€çµ‚å°è‡´äº† 2017 å¹´çš„åˆ†å‰äº‹ä»¶ã€‚</p>

<p>SegWit æ¡ç”¨äº†ä¸€å€‹å·§å¦™çš„æ–¹æ³•ï¼šå¼•å…¥ã€Œå€å¡Šæ¬Šé‡ã€çš„æ¦‚å¿µä¾†ä»£æ›¿å›ºå®šçš„å€å¡Šå¤§å°é™åˆ¶ã€‚æ–°çš„è¦å‰‡è¦å®šå€å¡Šçš„æœ€å¤§æ¬Šé‡ç‚º 4,000,000 æ¬Šé‡å–®ä½ï¼ˆWUï¼‰ã€‚å‚³çµ±äº¤æ˜“æ•¸æ“šçš„æ¯å€‹ä½å…ƒçµ„è¨ˆç®—ç‚º 4 WUï¼Œè€Œ witness æ•¸æ“šçš„æ¯å€‹ä½å…ƒçµ„åªè¨ˆç®—ç‚º 1 WUã€‚</p>

<p>é€™å€‹è¨­è¨ˆæœ‰å¹¾å€‹é‡è¦å«ç¾©ã€‚é¦–å…ˆï¼ŒèˆŠç¯€é»åªçœ‹åˆ°å‚³çµ±å€å¡Šæ•¸æ“šï¼Œå°å®ƒå€‘ä¾†èªªå€å¡Šä»ç„¶åœ¨ 1MB é™åˆ¶å…§ï¼Œä¿æŒäº†å‘å¾Œç›¸å®¹æ€§ã€‚å…¶æ¬¡ï¼Œç”±æ–¼ witness æ•¸æ“šä½”ç”¨æ¬Šé‡è¼ƒå°‘ï¼Œä½¿ç”¨ SegWit çš„ç”¨æˆ¶å¯ä»¥äº«å—è¼ƒä½çš„äº¤æ˜“è²»ç”¨ã€‚å¯¦éš›ä¸Šï¼Œé€™å‰µé€ äº†ä¸€å€‹ç¶“æ¿Ÿèª˜å› ï¼Œé¼“å‹µç”¨æˆ¶å’ŒéŒ¢åŒ…æ¡ç”¨ SegWitã€‚</p>

<p>åœ¨å¯¦è¸ä¸­ï¼Œå®Œå…¨ä½¿ç”¨ SegWit äº¤æ˜“çš„å€å¡Šå¯ä»¥é”åˆ°ç´„ 2MB åˆ° 2.3MB çš„å¯¦éš›å¤§å°ï¼Œæœ‰æ•ˆåœ°å°‡å€å¡Šå®¹é‡æå‡äº†ä¸€å€ä»¥ä¸Šã€‚</p>

<h3 id="14-äºŒæ¬¡é›œæ¹Šå•é¡Œ">1.4 äºŒæ¬¡é›œæ¹Šå•é¡Œ</h3>

<p>åœ¨å‚³çµ±æ¯”ç‰¹å¹£äº¤æ˜“ä¸­ï¼Œç°½åé›œæ¹Šçš„è¨ˆç®—æ–¹å¼å­˜åœ¨ä¸€å€‹æ•ˆèƒ½å•é¡Œã€‚å°æ–¼ä¸€ç­†æœ‰ n å€‹è¼¸å…¥çš„äº¤æ˜“ï¼Œæ¯å€‹è¼¸å…¥çš„ç°½åéƒ½éœ€è¦å°æ•´å€‹äº¤æ˜“é€²è¡Œé›œæ¹Šï¼Œé€™å°è‡´ç¸½çš„è¨ˆç®—é‡èˆ‡ nÂ² æˆæ­£æ¯”â€”â€”é€™å°±æ˜¯æ‰€è¬‚çš„äºŒæ¬¡é›œæ¹Šå•é¡Œã€‚</p>

<p>å°æ–¼æ™®é€šäº¤æ˜“ä¾†èªªï¼Œé€™å€‹å•é¡Œä¸å¤ªæ˜é¡¯ã€‚ä½†å°æ–¼è¼¸å…¥æ•¸é‡å¾ˆå¤šçš„å¤§å‹äº¤æ˜“ï¼Œè¨ˆç®—æˆæœ¬æœƒæ€¥åŠ‡ä¸Šå‡ã€‚æƒ¡æ„æ”»æ“Šè€…å¯ä»¥æ§‹é€ ç‰¹æ®Šçš„äº¤æ˜“ï¼Œè®“ç¯€é»èŠ±è²»å¤§é‡æ™‚é–“é©—è­‰ï¼Œé€™è¢«ç¨±ç‚ºã€Œäº¤æ˜“é©—è­‰æ‹’çµ•æœå‹™æ”»æ“Šã€ã€‚</p>

<p>SegWit é€é BIP 143 é‡æ–°è¨­è¨ˆäº†ç°½åé›œæ¹Šæ¼”ç®—æ³•ã€‚æ–°æ¼”ç®—æ³•é å…ˆè¨ˆç®—å¯è¤‡ç”¨çš„ä¸­é–“å€¼ï¼Œä½¿å¾—ç°½åé©—è­‰çš„è¤‡é›œåº¦å¾ O(nÂ²) é™ä½åˆ° O(n)ã€‚é€™ä¸åƒ…æé«˜äº†æ•ˆèƒ½ï¼Œä¹Ÿæ¶ˆé™¤äº†ä¸€é¡æ½›åœ¨çš„æ”»æ“Šå‘é‡ã€‚</p>

<h3 id="15-witness-ç¨‹å¼çµæ§‹">1.5 Witness ç¨‹å¼çµæ§‹</h3>

<p>SegWit å¼•å…¥äº†ä¸€ç¨®æ–°çš„è¼¸å‡ºé¡å‹ï¼Œç¨±ç‚º witness programï¼ˆè¦‹è­‰ç¨‹å¼ï¼‰ã€‚é€™ç¨®è¼¸å‡ºçš„ ScriptPubKey æ ¼å¼éå¸¸ç°¡æ½”ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>&lt;version&gt; &lt;witness program&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç‰ˆæœ¬ä½å…ƒçµ„è¡¨ç¤º witness ç¨‹å¼çš„é¡å‹ã€‚ç‰ˆæœ¬ 0 æ˜¯ç›®å‰æœ€å¸¸ç”¨çš„ï¼Œæ”¯æ´å…©ç¨®æ¨™æº–è…³æœ¬ã€‚ç•¶ witness program çš„é•·åº¦ç‚º 20 ä½å…ƒçµ„æ™‚ï¼Œå®ƒè¢«è§£é‡‹ç‚º P2WPKHï¼ˆPay to Witness Public Key Hashï¼‰ï¼Œé€™æ˜¯ SegWit ç‰ˆæœ¬çš„ P2PKHã€‚ç•¶é•·åº¦ç‚º 32 ä½å…ƒçµ„æ™‚ï¼Œå‰‡æ˜¯ P2WSHï¼ˆPay to Witness Script Hashï¼‰ï¼Œé€™æ˜¯ SegWit ç‰ˆæœ¬çš„ P2SHã€‚</p>

<p>ç‰ˆæœ¬ 1 æ˜¯ç‚º Taproot ä¿ç•™çš„ï¼Œä½¿ç”¨ 32 ä½å…ƒçµ„çš„ witness programã€‚ç‰ˆæœ¬ 2 åˆ° 16 ä¿ç•™çµ¦æœªä¾†çš„å‡ç´šä½¿ç”¨ã€‚é€™ç¨®ç‰ˆæœ¬åŒ–çš„è¨­è¨ˆç¢ºä¿äº†æ¯”ç‰¹å¹£å¯ä»¥æŒçºŒæ¼”é€²ï¼ŒåŒæ™‚ä¿æŒå‘å¾Œç›¸å®¹æ€§ã€‚</p>

<h3 id="16-segwit-äº¤æ˜“çµæ§‹">1.6 SegWit äº¤æ˜“çµæ§‹</h3>

<p>å‚³çµ±æ¯”ç‰¹å¹£äº¤æ˜“çš„çµæ§‹ç›¸å°ç°¡å–®ï¼šç‰ˆæœ¬è™Ÿã€è¼¸å…¥åˆ—è¡¨ï¼ˆåŒ…å« ScriptSigï¼‰ã€è¼¸å‡ºåˆ—è¡¨ã€é–å®šæ™‚é–“ã€‚SegWit äº¤æ˜“å‰‡åœ¨æ­¤åŸºç¤ä¸Šå¢åŠ äº†æ¨™è¨˜ä½å…ƒçµ„å’Œ witness å€åŸŸã€‚</p>

<p>SegWit äº¤æ˜“åœ¨ç‰ˆæœ¬è™Ÿä¹‹å¾Œæ’å…¥å…©å€‹ç‰¹æ®Šä½å…ƒçµ„ï¼šæ¨™è¨˜ï¼ˆmarkerï¼Œå€¼ç‚º 0x00ï¼‰å’Œæ——æ¨™ï¼ˆflagï¼Œå€¼ç‚º 0x01ï¼‰ã€‚é€™å…©å€‹ä½å…ƒçµ„å‘Šè¨´æ”¯æ´ SegWit çš„ç¯€é»ï¼Œé€™æ˜¯ä¸€ç­† SegWit äº¤æ˜“ã€‚å°æ–¼ä¸æ”¯æ´ SegWit çš„èˆŠç¯€é»ï¼Œé€™äº›ä½å…ƒçµ„æœƒè¢«èª¤è§£ç‚ºç©ºçš„è¼¸å…¥åˆ—è¡¨ï¼Œå°è‡´äº¤æ˜“è¢«è¦–ç‚ºç„¡æ•ˆè€Œå¿½ç•¥â€”â€”é€™æ­£æ˜¯è»Ÿåˆ†å‰çš„å·§å¦™ä¹‹è™•ã€‚</p>

<p>witness å€åŸŸä½æ–¼è¼¸å‡ºåˆ—è¡¨å’Œé–å®šæ™‚é–“ä¹‹é–“ã€‚æ¯å€‹è¼¸å…¥éƒ½æœ‰å°æ‡‰çš„ witness å †ç–Šï¼ŒåŒ…å«ç°½åå’Œå…¶ä»–å¿…è¦çš„é©—è­‰æ•¸æ“šã€‚é€™äº›æ•¸æ“šä¸åƒèˆ‡ txid çš„è¨ˆç®—ï¼Œä½†æœƒè¢«é©—è­‰ç¯€é»ç”¨ä¾†ç¢ºèªäº¤æ˜“çš„æœ‰æ•ˆæ€§ã€‚</p>

<hr />

<h2 id="äºŒtaproot-å‡ç´šæ¦‚è¿°">äºŒã€Taproot å‡ç´šæ¦‚è¿°</h2>

<h3 id="21-taproot-çš„æ­·å²èƒŒæ™¯">2.1 Taproot çš„æ­·å²èƒŒæ™¯</h3>

<p>Taproot æ–¼ 2021 å¹´ 11 æœˆåœ¨å€å¡Šé«˜åº¦ 709,632 å•Ÿå‹•ï¼Œæ˜¯è‡ª SegWit ä»¥ä¾†æ¯”ç‰¹å¹£æœ€é‡è¦çš„å”è­°å‡ç´šã€‚é€™å€‹å‡ç´šç”±ä¸‰å€‹ç›¸äº’é—œè¯çš„ BIP çµ„æˆï¼šBIP 340 å®šç¾©äº† Schnorr ç°½åæ–¹æ¡ˆï¼ŒBIP 341 å®šç¾©äº† Taproot çš„è¼¸å‡ºå’ŒèŠ±è²»è¦å‰‡ï¼ŒBIP 342 å®šç¾©äº† Tapscriptâ€”â€”ä¸€å€‹æ”¹é€²ç‰ˆçš„è…³æœ¬èªè¨€ã€‚</p>

<p>Taproot çš„è¨­è¨ˆç†å¿µå¯ä»¥è¿½æº¯åˆ° 2018 å¹´ï¼Œç”±æ¯”ç‰¹å¹£æ ¸å¿ƒé–‹ç™¼è€… Greg Maxwell æå‡ºã€‚ä»–çš„æ´è¦‹åœ¨æ–¼ï¼šå¤§å¤šæ•¸è¤‡é›œçš„æ¯”ç‰¹å¹£åˆç´„æœ€çµ‚éƒ½æœƒä»¥æ‰€æœ‰åƒèˆ‡æ–¹é”æˆå…±è­˜çš„æ–¹å¼çµç®—ï¼Œåªæœ‰åœ¨å‡ºç¾çˆ­è­°æ™‚æ‰éœ€è¦åŸ·è¡Œè¤‡é›œçš„è…³æœ¬é‚è¼¯ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘å€‘èƒ½è®“å…±è­˜çµç®—çœ‹èµ·ä¾†åƒæ™®é€šçš„å–®ç°½åäº¤æ˜“ï¼Œå°±èƒ½å¤§å¹…æå‡éš±ç§æ€§å’Œæ•ˆç‡ã€‚</p>

<p>é€™å€‹è§€å¯Ÿå¼•å°äº† Taproot çš„æ ¸å¿ƒè¨­è¨ˆï¼šæ¯å€‹ Taproot è¼¸å‡ºéƒ½æœ‰å…©ç¨®èŠ±è²»æ–¹å¼ã€‚Key pathï¼ˆå¯†é‘°è·¯å¾‘ï¼‰å…è¨±é€éä¸€å€‹èšåˆç°½åç›´æ¥èŠ±è²»ï¼Œå°±åƒæ™®é€šçš„å–®ç°½åäº¤æ˜“ä¸€æ¨£ã€‚Script pathï¼ˆè…³æœ¬è·¯å¾‘ï¼‰å‰‡å…è¨±æ­ç¤ºä¸¦åŸ·è¡Œé å…ˆæ‰¿è«¾çš„è…³æœ¬ï¼Œç”¨æ–¼è™•ç†éå…±è­˜æƒ…æ³ã€‚</p>

<h3 id="22-ç‚ºä»€éº¼é¸æ“‡-schnorr-ç°½å">2.2 ç‚ºä»€éº¼é¸æ“‡ Schnorr ç°½åï¼Ÿ</h3>

<p>åœ¨æ·±å…¥ Taproot ä¹‹å‰ï¼Œæˆ‘å€‘éœ€è¦ç†è§£ Schnorr ç°½åç‚ºä»€éº¼æ˜¯é€™å€‹å‡ç´šçš„åŸºçŸ³ã€‚æ¯”ç‰¹å¹£å¾å‰µå§‹ä¹‹åˆå°±ä½¿ç”¨ ECDSAï¼ˆæ©¢åœ“æ›²ç·šæ•¸ä½ç°½åæ¼”ç®—æ³•ï¼‰ï¼Œé€™æ˜¯ä¸€å€‹æˆç†Ÿä¸”å»£æ³›ä½¿ç”¨çš„ç°½åæ–¹æ¡ˆã€‚ç„¶è€Œï¼ŒECDSA æœ‰ä¸€äº›å›ºæœ‰çš„é™åˆ¶ã€‚</p>

<p>Schnorr ç°½åç”±å¾·åœ‹å¯†ç¢¼å­¸å®¶ Claus Schnorr åœ¨ 1989 å¹´ç™¼æ˜ï¼Œå¯¦éš›ä¸Šæ¯” ECDSA æ›´æ—©ã€‚å®ƒæ²’æœ‰è¢«æ¯”ç‰¹å¹£æœ€åˆæ¡ç”¨çš„åŸå› å¾ˆç°¡å–®ï¼šç•¶æ™‚ Schnorr ç°½åå—å°ˆåˆ©ä¿è­·ï¼Œè€Œ ECDSA æ˜¯è‡ªç”±ä½¿ç”¨çš„ã€‚Schnorr å°ˆåˆ©åœ¨ 2008 å¹´éæœŸï¼Œä½†æ¯”ç‰¹å¹£å·²ç¶“åœ¨ 2009 å¹´åˆä»¥ ECDSA çš„å½¢å¼èª•ç”Ÿäº†ã€‚</p>

<p>Schnorr ç°½åç›¸æ¯” ECDSA æœ‰å¹¾å€‹é‡è¦å„ªå‹¢ã€‚é¦–å…ˆæ˜¯æ•¸å­¸çµæ§‹çš„ç°¡æ½”æ€§ã€‚ECDSA çš„å®‰å…¨æ€§è­‰æ˜ç›¸ç•¶è¤‡é›œï¼Œè€Œ Schnorr ç°½åæœ‰è‘—å„ªé›…çš„æ•¸å­¸è­‰æ˜ï¼ŒåŸºæ–¼é›¢æ•£å°æ•¸å•é¡Œçš„å›°é›£æ€§ã€‚é€™ç¨®ç°¡æ½”æ€§ä¸åƒ…ä¾¿æ–¼åˆ†æï¼Œä¹Ÿä½¿å¾—å¯¦ç¾æ›´ä¸å®¹æ˜“å‡ºéŒ¯ã€‚</p>

<p>å…¶æ¬¡æ˜¯ç·šæ€§ç‰¹æ€§ã€‚Schnorr ç°½åå…·æœ‰åŠ æ³•åŒæ…‹æ€§ï¼Œé€™æ„å‘³è‘—å¤šå€‹ç°½åå¯ä»¥æ•¸å­¸ä¸Šç›¸åŠ æˆä¸€å€‹èšåˆç°½åã€‚å°æ–¼å¤šé‡ç°½åå ´æ™¯ï¼Œé€™å¸¶ä¾†äº†é©å‘½æ€§çš„æ”¹é€²ï¼šn-of-n å¤šç°½åªéœ€è¦ä¸€å€‹ 64 ä½å…ƒçµ„çš„ç°½åï¼Œè€Œä¸æ˜¯ n å€‹ç¨ç«‹ç°½åã€‚</p>

<p>ç¬¬ä¸‰æ˜¯æ‰¹é‡é©—è­‰æ•ˆç‡ã€‚ç•¶éœ€è¦é©—è­‰å¤šå€‹ Schnorr ç°½åæ™‚ï¼Œå¯ä»¥å°‡å®ƒå€‘åˆä½µæˆä¸€å€‹é‹ç®—ï¼Œå¤§å¹…æ¸›å°‘è¨ˆç®—é‡ã€‚é€™å°æ–¼å€å¡Šé©—è­‰ç‰¹åˆ¥æœ‰åƒ¹å€¼ï¼Œå› ç‚ºæ¯å€‹å€å¡Šå¯èƒ½åŒ…å«æ•¸åƒå€‹ç°½åã€‚</p>

<hr />

<h2 id="ä¸‰schnorr-ç°½åè©³è§£">ä¸‰ã€Schnorr ç°½åè©³è§£</h2>

<h3 id="31-æ•¸å­¸åŸºç¤">3.1 æ•¸å­¸åŸºç¤</h3>

<p>è¦ç†è§£ Schnorr ç°½åçš„å·¥ä½œåŸç†ï¼Œæˆ‘å€‘éœ€è¦ä¸€äº›æ©¢åœ“æ›²ç·šå¯†ç¢¼å­¸çš„åŸºç¤çŸ¥è­˜ã€‚æ¯”ç‰¹å¹£ä½¿ç”¨çš„æ˜¯ secp256k1 æ›²ç·šï¼Œé€™æ˜¯ä¸€å€‹å®šç¾©åœ¨æœ‰é™åŸŸä¸Šçš„æ©¢åœ“æ›²ç·šã€‚æ›²ç·šä¸Šæœ‰ä¸€å€‹ç‰¹æ®Šçš„é» Gï¼Œç¨±ç‚ºç”Ÿæˆé»ï¼Œä»»ä½•ç§é‘° d å°æ‡‰çš„å…¬é‘°éƒ½æ˜¯ P = d Ã— Gï¼ˆé€™è£¡çš„ä¹˜æ³•æ˜¯æ©¢åœ“æ›²ç·šä¸Šçš„ç´”é‡ä¹˜æ³•ï¼‰ã€‚</p>

<p>Schnorr ç°½åçš„å®‰å…¨æ€§åŸºæ–¼é›¢æ•£å°æ•¸å•é¡Œçš„å›°é›£æ€§ï¼šçµ¦å®š P å’Œ Gï¼Œåœ¨è¨ˆç®—ä¸Šä¸å¯èƒ½æ¨å°å‡º dã€‚é€™èˆ‡ ECDSA ä½¿ç”¨ç›¸åŒçš„æ•¸å­¸é›£é¡Œï¼Œä½† Schnorr çš„æ§‹é€ æ–¹å¼æ›´ç‚ºç›´æ¥ã€‚</p>

<table>
  <tbody>
    <tr>
      <td>ç°½åéç¨‹å¦‚ä¸‹ã€‚ç°½åè€…é¦–å…ˆé¸æ“‡ä¸€å€‹éš¨æ©Ÿæ•¸ kï¼ˆç¨±ç‚º nonceï¼‰ï¼Œè¨ˆç®— R = k Ã— Gã€‚ç„¶å¾Œè¨ˆç®— e = H(R</td>
      <td>Â </td>
      <td>P</td>
      <td>Â </td>
      <td>m)ï¼Œå…¶ä¸­ H æ˜¯é›œæ¹Šå‡½æ•¸ï¼Œm æ˜¯è¦ç°½åçš„è¨Šæ¯ï¼Œ</td>
      <td>Â </td>
      <td>è¡¨ç¤ºé€£æ¥ã€‚æœ€å¾Œè¨ˆç®— s = k + e Ã— dã€‚ç°½åå°±æ˜¯ (R, s) é€™å°å€¼ã€‚</td>
    </tr>
  </tbody>
</table>

<p>é©—è­‰åŒæ¨£ç°¡æ½”ï¼šæª¢æŸ¥ s Ã— G æ˜¯å¦ç­‰æ–¼ R + e Ã— Pã€‚é€™å€‹ç­‰å¼æˆç«‹çš„åŸå› å¯ä»¥é€™æ¨£ç†è§£ï¼šs Ã— G = (k + e Ã— d) Ã— G = k Ã— G + e Ã— d Ã— G = R + e Ã— Pã€‚åªæœ‰çŸ¥é“ç§é‘° d çš„äººæ‰èƒ½è¨ˆç®—å‡ºæ­£ç¢ºçš„ s å€¼ã€‚</p>

<h3 id="32-èˆ‡-ecdsa-çš„å…·é«”å·®ç•°">3.2 èˆ‡ ECDSA çš„å…·é«”å·®ç•°</h3>

<p>åœ¨æ¯”ç‰¹å¹£çš„å¯¦éš›æ‡‰ç”¨ä¸­ï¼ŒSchnorr å’Œ ECDSA ç°½åæœ‰å¹¾å€‹å…·é«”çš„å·®ç•°ã€‚</p>

<p>é¦–å…ˆæ˜¯ç°½åæ ¼å¼ã€‚ECDSA ç°½åä½¿ç”¨ DER ç·¨ç¢¼ï¼Œé•·åº¦é€šå¸¸åœ¨ 71 åˆ° 72 ä½å…ƒçµ„ä¹‹é–“ï¼ˆå–æ±ºæ–¼ r å’Œ s å€¼çš„å…·é«”ä½å…ƒæ•¸ï¼‰ã€‚Schnorr ç°½åå›ºå®šç‚º 64 ä½å…ƒçµ„ï¼šR é»çš„ x åº§æ¨™ä½” 32 ä½å…ƒçµ„ï¼Œs å€¼ä½” 32 ä½å…ƒçµ„ã€‚</p>

<p>å…¶æ¬¡æ˜¯å…¬é‘°æ ¼å¼ã€‚å‚³çµ±æ¯”ç‰¹å¹£ä½¿ç”¨å£“ç¸®å…¬é‘°ï¼ˆ33 ä½å…ƒçµ„ï¼ŒåŒ…å«ä¸€å€‹å‰ç¶´ä½å…ƒçµ„è¡¨ç¤º y åº§æ¨™çš„å¥‡å¶æ€§ï¼‰æˆ–éå£“ç¸®å…¬é‘°ï¼ˆ65 ä½å…ƒçµ„ï¼‰ã€‚BIP 340 å¼•å…¥äº†ã€Œx-onlyã€å…¬é‘°â€”â€”åªæœ‰ 32 ä½å…ƒçµ„çš„ x åº§æ¨™ã€‚é€™ç¨®æ ¼å¼æ˜¯å¯è¡Œçš„ï¼Œå› ç‚ºå°æ–¼ä»»ä½• x åº§æ¨™ï¼Œæœ€å¤šåªæœ‰å…©å€‹æœ‰æ•ˆçš„ y åº§æ¨™ï¼Œè€Œ BIP 340 è¦å®šæ°¸é é¸æ“‡ã€Œå¶æ•¸ã€çš„é‚£å€‹ã€‚</p>

<p>é€™ç¨®ç°¡åŒ–ç¯€çœäº†ç©ºé–“ï¼Œä½†ä¹Ÿæ„å‘³è‘—ç§é‘°å¯èƒ½éœ€è¦ã€Œç¿»è½‰ã€ã€‚å¦‚æœè¨ˆç®—å‡ºçš„å…¬é‘° y åº§æ¨™æ˜¯å¥‡æ•¸ï¼Œå°±éœ€è¦ç”¨æ›²ç·šçš„éšæ¸›å»ç§é‘°ï¼Œä½¿å¾—å°æ‡‰çš„å…¬é‘° y åº§æ¨™è®Šç‚ºå¶æ•¸ã€‚é€™æ˜¯ Taproot å¯¦ç¾ä¸­çš„ä¸€å€‹å¾®å¦™ç´°ç¯€ã€‚</p>

<h3 id="33-å¤šé‡ç°½åèšåˆ">3.3 å¤šé‡ç°½åèšåˆ</h3>

<p>Schnorr ç°½åæœ€å¼•äººæ³¨ç›®çš„ç‰¹æ€§æ˜¯æ”¯æ´ç°½åèšåˆã€‚è€ƒæ…®ä¸€å€‹ 2-of-2 å¤šç°½å ´æ™¯ï¼ŒAlice å’Œ Bob å…±åŒæ§åˆ¶ä¸€ç­†è³‡é‡‘ã€‚</p>

<p>åœ¨ ECDSA ä¸–ç•Œä¸­ï¼Œé€™éœ€è¦ä¸€å€‹ P2SH è…³æœ¬ï¼ŒåŒ…å«å…©å€‹å…¬é‘°å’Œ OP_CHECKMULTISIGã€‚èŠ±è²»æ™‚éœ€è¦æä¾›å…©å€‹å®Œæ•´çš„ç°½åï¼Œç¸½å…±ç´„ 144 ä½å…ƒçµ„çš„ç°½åæ•¸æ“šã€‚</p>

<p>ä½¿ç”¨ Schnorr ç°½åçš„ MuSig2 å”è­°ï¼ŒAlice å’Œ Bob é¦–å…ˆå„è‡ªé¸æ“‡éš¨æ©Ÿæ•¸ä¸¦äº¤æ› R å€¼çš„æ‰¿è«¾ï¼Œç„¶å¾Œäº¤æ›å¯¦éš›çš„ R å€¼ä¸¦è¨ˆç®—èšåˆ R = R_A + R_Bã€‚æ¥è‘—ï¼Œé›™æ–¹ç¨ç«‹è¨ˆç®—å„è‡ªçš„éƒ¨åˆ†ç°½å s_A å’Œ s_Bï¼Œæœ€çµ‚èšåˆç°½åå°±æ˜¯ (R, s_A + s_B)ã€‚</p>

<p>é€™å€‹èšåˆç°½ååªæœ‰ 64 ä½å…ƒçµ„ï¼Œèˆ‡å–®ä¸€ç°½åå®Œå…¨ç›¸åŒã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå¾éˆä¸Šè§€å¯Ÿè€…çš„è§’åº¦ä¾†çœ‹ï¼Œé€™èˆ‡æ™®é€šçš„å–®ç°½åäº¤æ˜“æ²’æœ‰ä»»ä½•å€åˆ¥ã€‚æ²’æœ‰äººçŸ¥é“é€™ç­†äº¤æ˜“å¯¦éš›ä¸Šéœ€è¦å…©å€‹äººçš„æˆæ¬Šã€‚</p>

<p>MuSig2 æ˜¯ MuSig å”è­°çš„æ”¹é€²ç‰ˆæœ¬ï¼Œå°‡äº’å‹•è¼ªæ¬¡å¾ä¸‰è¼ªæ¸›å°‘åˆ°å…©è¼ªï¼Œå¤§å¹…æå‡äº†å¯¦ç”¨æ€§ã€‚ç„¶è€Œï¼Œå®ƒçš„å¯¦ç¾ä»ç„¶æ¯”æ™®é€šç°½åè¤‡é›œå¾—å¤šï¼Œç‰¹åˆ¥æ˜¯åœ¨ç¢ºä¿ nonce å®‰å…¨æ€§æ–¹é¢éœ€è¦ç‰¹åˆ¥å°å¿ƒã€‚</p>

<hr />

<h2 id="å››p2trpay-to-taprootè©³è§£">å››ã€P2TRï¼ˆPay to Taprootï¼‰è©³è§£</h2>

<h3 id="41-taproot-è¼¸å‡ºçš„çµæ§‹">4.1 Taproot è¼¸å‡ºçš„çµæ§‹</h3>

<p>Taproot è¼¸å‡ºçš„ ScriptPubKey æ ¼å¼éå¸¸ç°¡æ½”ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>OP_1 &lt;32-byte x-only pubkey&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€™è£¡çš„ OP_1ï¼ˆ0x51ï¼‰è¡¨ç¤º witness ç‰ˆæœ¬ 1ï¼Œå¾Œé¢è·Ÿè‘— 32 ä½å…ƒçµ„çš„ x-only å…¬é‘°ã€‚é€™å€‹å…¬é‘°ä¸æ˜¯æ™®é€šçš„å…¬é‘°ï¼Œè€Œæ˜¯ç¶“éã€Œèª¿æ•´ã€ï¼ˆtweakedï¼‰çš„è¼¸å‡ºå…¬é‘°ï¼Œè˜Šå«è‘—è±å¯Œçš„è³‡è¨Šã€‚</p>

<p>Taproot åœ°å€ä½¿ç”¨ Bech32m ç·¨ç¢¼ï¼ˆBIP 350 å®šç¾©ï¼‰ï¼Œä¸»ç¶²åœ°å€ä»¥ bc1p é–‹é ­ï¼Œæ¸¬è©¦ç¶²åœ°å€ä»¥ tb1p é–‹é ­ã€‚é€™è£¡çš„ p ä»£è¡¨ç‰ˆæœ¬ 1ï¼ˆç‰ˆæœ¬ 0 ä½¿ç”¨ qï¼Œå› ç‚ºåœ¨ Bech32 ç·¨ç¢¼ä¸­ 0 å°æ‡‰ qï¼Œ1 å°æ‡‰ pï¼‰ã€‚</p>

<h3 id="42-å…¬é‘°èª¿æ•´æ©Ÿåˆ¶">4.2 å…¬é‘°èª¿æ•´æ©Ÿåˆ¶</h3>

<p>Taproot çš„æ ¸å¿ƒå‰µæ–°åœ¨æ–¼å…¬é‘°èª¿æ•´ï¼ˆkey tweakingï¼‰æ©Ÿåˆ¶ã€‚å‡è¨­æˆ‘å€‘æœ‰ä¸€å€‹å…§éƒ¨å…¬é‘° Pï¼ˆå¯èƒ½æ˜¯å–®ä¸€å…¬é‘°ï¼Œä¹Ÿå¯èƒ½æ˜¯å¤šæ–¹èšåˆå…¬é‘°ï¼‰ï¼Œä»¥åŠä¸€å€‹å¯é¸çš„è…³æœ¬æ¨¹ã€‚æˆ‘å€‘éœ€è¦æ§‹é€ ä¸€å€‹è¼¸å‡ºå…¬é‘° Qã€‚</p>

<table>
  <tbody>
    <tr>
      <td>å¦‚æœæ²’æœ‰è…³æœ¬æ¨¹ï¼Œèª¿æ•´å€¼ t è¨ˆç®—ç‚ºï¼št = H_TapTweak(P)ã€‚å¦‚æœæœ‰è…³æœ¬æ¨¹ï¼Œå‰‡å…ˆè¨ˆç®—æ¨¹çš„ Merkle æ ¹ mï¼Œèª¿æ•´å€¼ç‚ºï¼št = H_TapTweak(P</td>
      <td>Â </td>
      <td>m)ã€‚é€™è£¡çš„ H_TapTweak æ˜¯ä¸€å€‹æ¨™ç±¤é›œæ¹Šå‡½æ•¸ï¼Œå…¶å®šç¾©ç¢ºä¿äº†ä¸åŒç”¨é€”çš„é›œæ¹Šä¸æœƒç¢°æ’ã€‚</td>
    </tr>
  </tbody>
</table>

<p>è¼¸å‡ºå…¬é‘° Q = P + t Ã— Gã€‚é€™å€‹ Q å°±æ˜¯å­˜æ”¾åœ¨ ScriptPubKey ä¸­çš„å€¼ã€‚</p>

<p>é€™å€‹è¨­è¨ˆçš„å·§å¦™ä¹‹è™•åœ¨æ–¼æ‰¿è«¾æ–¹å¼ã€‚å¦‚æœ Q = P + t Ã— Gï¼Œé‚£éº¼çŸ¥é“ P å’Œ t çš„äººå¯ä»¥é©—è­‰ Q ç¢ºå¯¦æ˜¯ç”± P èª¿æ•´è€Œä¾†çš„ã€‚è€Œ t æœ¬èº«åŒ…å«äº†è…³æœ¬æ¨¹çš„ Merkle æ ¹ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰ï¼Œæ‰€ä»¥ Q å¯¦éš›ä¸Šæ‰¿è«¾äº†æ•´å€‹è…³æœ¬æ¨¹çš„å…§å®¹ï¼Œä½†é™¤ééœ€è¦ä½¿ç”¨è…³æœ¬è·¯å¾‘ï¼Œå¦å‰‡é€™äº›è…³æœ¬æ°¸é ä¸æœƒæš´éœ²ã€‚</p>

<h3 id="43-key-path-èŠ±è²»">4.3 Key Path èŠ±è²»</h3>

<p>Key path æ˜¯ Taproot è¼¸å‡ºæœ€å¸¸è¦‹çš„èŠ±è²»æ–¹å¼ï¼Œä¹Ÿæ˜¯æœ€é«˜æ•ˆçš„æ–¹å¼ã€‚è¦é€é key path èŠ±è²»ï¼Œç°½åè€…éœ€è¦çŸ¥é“å…§éƒ¨ç§é‘° dï¼Œç„¶å¾Œè¨ˆç®—èª¿æ•´å¾Œçš„ç§é‘° dâ€™ = d + tã€‚ä½¿ç”¨ dâ€™ å°äº¤æ˜“é€²è¡Œ Schnorr ç°½åï¼Œé€™å€‹ç°½åå°±å¯ä»¥é€šé Q çš„é©—è­‰ã€‚</p>

<p>witness åªåŒ…å«ä¸€å€‹å…ƒç´ ï¼š64 ä½å…ƒçµ„çš„ Schnorr ç°½åã€‚æ²’æœ‰è…³æœ¬ï¼Œæ²’æœ‰å…¬é‘°æ­ç¤ºï¼Œæ²’æœ‰ä»»ä½•å…¶ä»–æ•¸æ“šã€‚é€™æ„å‘³è‘—ç„¡è«–èƒŒå¾Œçš„è…³æœ¬æœ‰å¤šè¤‡é›œï¼Œåªè¦æ‰€æœ‰åƒèˆ‡æ–¹é”æˆå…±è­˜ï¼ŒèŠ±è²»çš„æ–¹å¼å°±å’Œæœ€ç°¡å–®çš„å–®ç°½åäº¤æ˜“ä¸€æ¨£ã€‚</p>

<p>é€™å°éš±ç§æœ‰å·¨å¤§çš„æ„ç¾©ã€‚ä¸€å€‹è¤‡é›œçš„å¤šæ–¹åˆç´„â€”â€”æ¯”å¦‚é–ƒé›»ç¶²è·¯é€šé“çš„é–‹è¨­å’Œé—œé–‰â€”â€”åœ¨éˆä¸Šçœ‹èµ·ä¾†èˆ‡æ™®é€šçš„å€‹äººè½‰å¸³æ²’æœ‰å€åˆ¥ã€‚è§€å¯Ÿè€…ç„¡æ³•çŸ¥é“é€™ç­†äº¤æ˜“èƒŒå¾Œæ˜¯ä¸€å€‹äººé‚„æ˜¯ä¸€ç™¾å€‹äººï¼Œæ˜¯å¦æœ‰ä»»ä½•å‚™ç”¨è…³æœ¬å­˜åœ¨ã€‚</p>

<h3 id="44-script-path-èŠ±è²»">4.4 Script Path èŠ±è²»</h3>

<p>ç•¶éœ€è¦ä½¿ç”¨å‚™ç”¨è…³æœ¬æ™‚ï¼Œå°±éœ€è¦é€é script path èŠ±è²»ã€‚é€™ç¨®æƒ…æ³ä¸‹ï¼Œwitness éœ€è¦åŒ…å«ä¸‰éƒ¨åˆ†ï¼šè…³æœ¬çš„è¼¸å…¥æ•¸æ“šï¼ˆå¦‚ç°½åï¼‰ã€è¦åŸ·è¡Œçš„è…³æœ¬æœ¬èº«ï¼Œä»¥åŠæ§åˆ¶å€å¡Šï¼ˆcontrol blockï¼‰ã€‚</p>

<p>æ§åˆ¶å€å¡Šçš„çµæ§‹åŒ…å«ï¼šä¸€å€‹ç‰ˆæœ¬ä½å…ƒçµ„ï¼ˆå…¶ä¸­åŒ…å«è‘‰å­ç‰ˆæœ¬å’Œ Q çš„ y åº§æ¨™å¥‡å¶æ€§ï¼‰ã€32 ä½å…ƒçµ„çš„å…§éƒ¨å…¬é‘° Pï¼Œä»¥åŠ Merkle è­‰æ˜è·¯å¾‘ï¼ˆæ¯å€‹ç¯€é» 32 ä½å…ƒçµ„ï¼‰ã€‚</p>

<table>
  <tbody>
    <tr>
      <td>Merkle è­‰æ˜è·¯å¾‘å…è¨±é©—è­‰è€…ç¢ºèªæ‰€æ­ç¤ºçš„è…³æœ¬ç¢ºå¯¦æ˜¯è¼¸å‡ºæ‰¿è«¾çš„è…³æœ¬æ¨¹çš„ä¸€éƒ¨åˆ†ã€‚é©—è­‰éç¨‹æ˜¯ï¼šé¦–å…ˆç”¨è…³æœ¬å’Œè‘‰å­ç‰ˆæœ¬è¨ˆç®—è‘‰å­é›œæ¹Šï¼Œç„¶å¾Œæ²¿è‘—è­‰æ˜è·¯å¾‘å‘ä¸Šè¨ˆç®—ç›´åˆ°å¾—åˆ° Merkle æ ¹ï¼Œæœ€å¾Œé©—è­‰ Q = P + H_TapTweak(P</td>
      <td>Â </td>
      <td>root) Ã— Gã€‚</td>
    </tr>
  </tbody>
</table>

<p>é€™å€‹æ©Ÿåˆ¶çš„å„ªç¾ä¹‹è™•åœ¨æ–¼ï¼Œåªéœ€è¦æ­ç¤ºä½ å¯¦éš›ä½¿ç”¨çš„è…³æœ¬å’Œå®ƒçš„è­‰æ˜è·¯å¾‘ï¼Œè€Œä¸éœ€è¦æ­ç¤ºæ•´å€‹è…³æœ¬æ¨¹ã€‚å¦‚æœæ¨¹ä¸­æœ‰ 128 å€‹è…³æœ¬ï¼Œä½¿ç”¨å…¶ä¸­ä¸€å€‹åªéœ€è¦ 7 å±¤çš„è­‰æ˜ï¼ˆlogâ‚‚(128) = 7ï¼‰ï¼Œå…¶ä»– 127 å€‹è…³æœ¬ä¿æŒå®Œå…¨ä¿å¯†ã€‚</p>

<h3 id="45-mast-çš„å¯¦ç¾">4.5 MAST çš„å¯¦ç¾</h3>

<p>Taproot å¯¦éš›ä¸Šå¯¦ç¾äº†ä¸€å€‹å«åš MASTï¼ˆMerkle Abstract Syntax Treeï¼Œé»˜å…‹çˆ¾æŠ½è±¡èªæ³•æ¨¹ï¼‰çš„æ¦‚å¿µã€‚é€™å€‹æ¦‚å¿µåœ¨æ¯”ç‰¹å¹£ç¤¾å€è¨è«–å¤šå¹´ï¼Œè€Œ Taproot çµ‚æ–¼å°‡å®ƒè®Šæˆäº†ç¾å¯¦ã€‚</p>

<p>å‚³çµ±çš„ P2SH éœ€è¦åœ¨èŠ±è²»æ™‚æ­ç¤ºæ•´å€‹è´–å›è…³æœ¬ï¼Œç„¡è«–å…¶ä¸­æœ‰å¤šå°‘åˆ†æ”¯ã€‚å¦‚æœä½ æœ‰ä¸€å€‹ã€ŒAlice å¯ä»¥éš¨æ™‚èŠ±è²»ï¼Œæˆ–è€… Bob åœ¨ä¸€å¹´å¾Œå¯ä»¥èŠ±è²»ã€çš„è…³æœ¬ï¼Œå³ä½¿ Alice èŠ±è²»ï¼Œä¹Ÿéœ€è¦æ­ç¤º Bob çš„å‚™ç”¨æ¢ä»¶å­˜åœ¨ã€‚</p>

<p>ä½¿ç”¨ Taprootï¼ŒAlice å’Œ Bob å¯ä»¥æ§‹å»ºä¸€å€‹è…³æœ¬æ¨¹ï¼šæ ¹ç¯€é»ä¸‹æœ‰å…©å€‹è‘‰å­ï¼Œåˆ†åˆ¥æ˜¯ Alice çš„æ¢ä»¶å’Œ Bob çš„æ™‚é–“é–æ¢ä»¶ã€‚æ›´å¥½çš„æ˜¯ï¼Œä»–å€‘å¯ä»¥ç”¨èšåˆå…¬é‘°ä½œç‚º key pathâ€”â€”å¦‚æœé›™æ–¹åˆä½œï¼Œå®Œå…¨ä¸éœ€è¦æ­ç¤ºä»»ä½•è…³æœ¬ã€‚åªæœ‰ç•¶ä»–å€‘ç„¡æ³•åˆä½œï¼ˆæ¯”å¦‚ Alice å¤±è¯ï¼‰æ™‚ï¼ŒBob æ‰éœ€è¦ä½¿ç”¨ script pathï¼Œæ­¤æ™‚åªæ­ç¤ºè‡ªå·±çš„åˆ†æ”¯ï¼ŒAlice çš„è…³æœ¬ä¿æŒç§å¯†ã€‚</p>

<p>é€™ç¨®æ¶æ§‹å°æ–¼é–ƒé›»ç¶²è·¯ç­‰è¤‡é›œå”è­°ç‰¹åˆ¥æœ‰åƒ¹å€¼ã€‚é–ƒé›»ç¶²è·¯é€šé“çš„æ‰¿è«¾äº¤æ˜“åŒ…å«å¤šå€‹å¯èƒ½çš„èŠ±è²»è·¯å¾‘ï¼Œä½¿ç”¨ Taproot å¯ä»¥å¤§å¹…ç°¡åŒ–é€™äº›äº¤æ˜“çš„çµæ§‹ä¸¦æå‡éš±ç§æ€§ã€‚</p>

<hr />

<h2 id="äº”tapscript-æ–°è¦å‰‡">äº”ã€Tapscript æ–°è¦å‰‡</h2>

<h3 id="51-tapscript-çš„è¨­è¨ˆç›®æ¨™">5.1 Tapscript çš„è¨­è¨ˆç›®æ¨™</h3>

<p>Tapscript æ˜¯ Taproot è…³æœ¬è·¯å¾‘ä¸­ä½¿ç”¨çš„è…³æœ¬è¦å‰‡ï¼Œç”± BIP 342 å®šç¾©ã€‚å®ƒåŸºæ–¼ SegWit çš„è…³æœ¬è¦å‰‡ï¼Œä½†åšäº†å¹¾å€‹é‡è¦çš„ä¿®æ”¹å’Œæ”¹é€²ã€‚</p>

<p>è¨­è¨ˆ Tapscript çš„ä¸»è¦ç›®æ¨™æ˜¯ï¼šé©é… Schnorr ç°½åã€æ”¹é€²å¤šç°½æ•ˆç‡ã€æ”¾å¯¬æŸäº›é™åˆ¶ã€ä»¥åŠç‚ºæœªä¾†å‡ç´šé ç•™ç©ºé–“ã€‚</p>

<h3 id="52-op_checksigadd">5.2 OP_CHECKSIGADD</h3>

<p>Tapscript æœ€é‡è¦çš„æ–°æ“ä½œç¢¼æ˜¯ OP_CHECKSIGADDï¼ˆ0xbaï¼‰ã€‚é€™å€‹æ“ä½œç¢¼å°ˆé–€ç‚º Schnorr ç°½åçš„æ‰¹é‡é©—è­‰å„ªåŒ–è¨­è¨ˆï¼Œç”¨ä¾†å–ä»£å‚³çµ±çš„ OP_CHECKMULTISIGã€‚</p>

<p>OP_CHECKMULTISIG æœ‰ä¸€å€‹è‘—åçš„ã€Œoff-by-oneã€bugï¼šå®ƒæœƒå¤šå¾å †ç–Šä¸­å½ˆå‡ºä¸€å€‹æœªä½¿ç”¨çš„å…ƒç´ ã€‚é€™å€‹ bug å¾æ¯”ç‰¹å¹£èª•ç”Ÿä¹‹åˆå°±å­˜åœ¨ï¼Œç”±æ–¼å…±è­˜è¦å‰‡ç„¡æ³•è¼•æ˜“ä¿®æ”¹ï¼Œä¸€ç›´ä¿ç•™è‡³ä»Šã€‚OP_CHECKSIGADD é¿å…äº†é€™å€‹å•é¡Œã€‚</p>

<p>OP_CHECKSIGADD çš„èªç¾©å¾ˆç°¡å–®ï¼šå®ƒå¾å †ç–Šå–ä¸‰å€‹å…ƒç´ â€”â€”ç°½åã€è¨ˆæ•¸å™¨ nã€å…¬é‘°ã€‚å¦‚æœç°½åæœ‰æ•ˆï¼Œå°‡ n+1 æ¨å›å †ç–Šï¼›å¦‚æœç°½åç„¡æ•ˆï¼ˆç©ºç°½åï¼‰ï¼Œå°‡ n æ¨å›å †ç–Šã€‚é€™å…è¨±ç”¨ç°¡å–®çš„ç´¯åŠ é‚è¼¯å¯¦ç¾ k-of-n å¤šç°½ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>&lt;pk1&gt; OP_CHECKSIG
&lt;pk2&gt; OP_CHECKSIGADD
&lt;pk3&gt; OP_CHECKSIGADD
2 OP_NUMEQUAL
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é€™å€‹è…³æœ¬æª¢æŸ¥ä¸‰å€‹å…¬é‘°ä¸­æ˜¯å¦è‡³å°‘æœ‰å…©å€‹å°æ‡‰æœ‰æ•ˆç°½åã€‚èˆ‡ OP_CHECKMULTISIG ä¸åŒï¼Œç°½åçš„é †åºä¸éœ€è¦èˆ‡å…¬é‘°é †åºåŒ¹é…â€”â€”æœªç°½åçš„å…¬é‘°å°æ‡‰ç©ºç°½åå³å¯ã€‚</p>

<p>æ›´é‡è¦çš„æ˜¯ï¼Œé€™ç¨®çµæ§‹å…è¨±æœ‰æ•ˆçš„æ‰¹é‡é©—è­‰ã€‚é©—è­‰è€…å¯ä»¥æ”¶é›†æ‰€æœ‰çš„ (å…¬é‘°, è¨Šæ¯, ç°½å) ä¸‰å…ƒçµ„ï¼Œä½¿ç”¨ Schnorr çš„æ‰¹é‡é©—è­‰æ¼”ç®—æ³•ä¸€æ¬¡æ€§é©—è­‰æ‰€æœ‰ç°½åï¼Œé€™æ¯”é€å€‹é©—è­‰å¿«å¾—å¤šã€‚</p>

<h3 id="53-æ”¾å¯¬çš„é™åˆ¶">5.3 æ”¾å¯¬çš„é™åˆ¶</h3>

<p>Tapscript ç§»é™¤äº†å¹¾å€‹å‚³çµ±è…³æœ¬çš„é™åˆ¶ã€‚</p>

<p>è…³æœ¬å¤§å°é™åˆ¶ï¼šå‚³çµ±è…³æœ¬é™åˆ¶ç‚º 10,000 ä½å…ƒçµ„ï¼ŒTapscript æ²’æœ‰é€™å€‹é™åˆ¶ï¼ˆä½†ä»å—å€å¡Šæ¬Šé‡é™åˆ¶ï¼‰ã€‚é€™å°æ–¼æŸäº›éœ€è¦å¤§é‡å…¬é‘°æˆ–è¤‡é›œé‚è¼¯çš„æ‡‰ç”¨ä¾†èªªæ˜¯é‡è¦çš„æ”¹é€²ã€‚</p>

<p>æ“ä½œç¢¼æ•¸é‡é™åˆ¶ï¼šå‚³çµ±è…³æœ¬é™åˆ¶æ¯å€‹è…³æœ¬æœ€å¤š 201 å€‹æ“ä½œç¢¼ï¼ŒTapscript ç§»é™¤äº†é€™å€‹é™åˆ¶ã€‚é€™å°æ–¼éœ€è¦å¤§é‡æ¢ä»¶åˆ†æ”¯çš„è¤‡é›œè…³æœ¬å¾ˆæœ‰ç”¨ã€‚</p>

<p>å †ç–Šå…ƒç´ å¤§å°ï¼šå‚³çµ±è…³æœ¬é™åˆ¶å–®å€‹å †ç–Šå…ƒç´ æœ€å¤§ 520 ä½å…ƒçµ„ã€‚Tapscript ä»ç„¶æœ‰é€™å€‹é™åˆ¶ï¼Œä½†ç”±æ–¼ OP_SUCCESS çš„å­˜åœ¨ï¼Œæœªä¾†å¯ä»¥é€éè»Ÿåˆ†å‰æ”¾å¯¬ã€‚</p>

<h3 id="54-op_success-èˆ‡æœªä¾†å‡ç´š">5.4 OP_SUCCESS èˆ‡æœªä¾†å‡ç´š</h3>

<p>Tapscript å¼•å…¥äº†ä¸€å€‹å‰µæ–°çš„å‡ç´šæ©Ÿåˆ¶ï¼šOP_SUCCESS æ“ä½œç¢¼ã€‚é€™äº›æ˜¯ä¸€çµ„ç›®å‰æœªå®šç¾©çš„æ“ä½œç¢¼ï¼ˆåŒ…æ‹¬ 0x50, 0x62, 0x89-0x8a ç­‰ï¼‰ï¼Œåœ¨ Tapscript ä¸­è¢«è§£é‡‹ç‚ºã€Œç«‹å³æˆåŠŸã€â€”â€”é‡åˆ°é€™äº›æ“ä½œç¢¼æ™‚ï¼Œè…³æœ¬é©—è­‰ç«‹å³æˆåŠŸï¼Œä¸ç®¡å…¶ä»–æ¢ä»¶ã€‚</p>

<p>é€™çœ‹èµ·ä¾†åƒæ˜¯ä¸€å€‹å®‰å…¨æ¼æ´â€”â€”ä½¿ç”¨é€™äº›æ“ä½œç¢¼çš„è…³æœ¬ä¸å°±å¯ä»¥ç„¡æ¢ä»¶è¢«ä»»ä½•äººèŠ±è²»å—ï¼Ÿç¢ºå¯¦å¦‚æ­¤ã€‚ä½†é—œéµåœ¨æ–¼ï¼Œé€™å…è¨±æœªä¾†é€éè»Ÿåˆ†å‰è³¦äºˆé€™äº›æ“ä½œç¢¼å¯¦éš›æ„ç¾©ã€‚ä¸€æ—¦ä¸€å€‹ OP_SUCCESS è¢«é‡æ–°å®šç¾©ï¼Œä½¿ç”¨å®ƒçš„è…³æœ¬å°±éœ€è¦æ»¿è¶³æ–°çš„æ¢ä»¶æ‰èƒ½è¢«èŠ±è²»ã€‚</p>

<p>é€™ç¨®ã€Œå…ˆé–‹æ”¾å†æ”¶ç·Šã€çš„å‡ç´šç­–ç•¥æ¯”å‚³çµ±çš„ã€Œå…ˆç¦ç”¨å†å•Ÿç”¨ã€æ›´åŠ éˆæ´»ã€‚å‚³çµ±è…³æœ¬ä¸­çš„ç¦ç”¨æ“ä½œç¢¼ï¼ˆå¦‚ OP_CATï¼‰ä¸€æ—¦è¢«åŸ·è¡Œå°±æœƒä½¿è…³æœ¬å¤±æ•—ï¼Œé€™æ„å‘³è‘—å•Ÿç”¨å®ƒå€‘éœ€è¦è¤‡é›œçš„ç‰ˆæœ¬æ§åˆ¶æ©Ÿåˆ¶ã€‚è€Œ OP_SUCCESS å¯ä»¥è¢«ç°¡å–®åœ°é‡æ–°å®šç¾©ï¼Œåªè¦æ–°çš„è¦å‰‡æ¯”ã€Œç„¡æ¢ä»¶æˆåŠŸã€æ›´åš´æ ¼ï¼Œå°±æ˜¯å‘å¾Œç›¸å®¹çš„è»Ÿåˆ†å‰ã€‚</p>

<hr />

<h2 id="å…­bech32m-åœ°å€ç·¨ç¢¼">å…­ã€Bech32m åœ°å€ç·¨ç¢¼</h2>

<h3 id="61-å¾-bech32-åˆ°-bech32m">6.1 å¾ Bech32 åˆ° Bech32m</h3>

<p>SegWit v0 å¼•å…¥äº† Bech32 åœ°å€ç·¨ç¢¼ï¼Œé€™æ˜¯ä¸€ç¨®å°ˆç‚ºäººé¡å¯è®€æ€§è¨­è¨ˆçš„ç·¨ç¢¼æ ¼å¼ï¼Œä½¿ç”¨ 32 å€‹å­—å…ƒï¼ˆqpzry9x8gf2tvdw0s3jn54khce6mua7lï¼‰ä¾†è¡¨ç¤ºæ•¸æ“šï¼Œä¸¦åŒ…å«å¼·å¤§çš„éŒ¯èª¤æª¢æ¸¬èƒ½åŠ›ã€‚</p>

<p>ç„¶è€Œï¼ŒBech32 è¢«ç™¼ç¾å­˜åœ¨ä¸€å€‹å¼±é»ï¼šåœ¨æŸäº›æƒ…æ³ä¸‹ï¼Œåœ°å€æœ«å°¾çš„ q å­—å…ƒå¯ä»¥è¢«æ·»åŠ æˆ–åˆªé™¤è€Œä¸æ”¹è®Šæ ¡é©—å’Œã€‚é€™å€‹å•é¡Œå°æ–¼ SegWit v0 åœ°å€å½±éŸ¿è¼ƒå°ï¼ˆå› ç‚ºé•·åº¦æ˜¯å›ºå®šçš„ï¼‰ï¼Œä½†å°æ–¼æœªä¾†å¯èƒ½æœ‰ä¸åŒé•·åº¦çš„ witness ç‰ˆæœ¬ä¾†èªªæ˜¯å€‹å•é¡Œã€‚</p>

<p>BIP 350 å®šç¾©äº† Bech32m ä¾†è§£æ±ºé€™å€‹å•é¡Œã€‚å®ƒä½¿ç”¨äº†ä¸åŒçš„æ ¡é©—å’Œå¸¸æ•¸ï¼Œä½¿å¾—æ·»åŠ æˆ–åˆªé™¤å­—å…ƒæœƒè¢«æª¢æ¸¬åˆ°ã€‚è¦å‰‡æ˜¯ï¼šSegWit v0 åœ°å€ç¹¼çºŒä½¿ç”¨åŸå§‹ Bech32 ç·¨ç¢¼ï¼Œè€Œ SegWit v1 åŠæ›´é«˜ç‰ˆæœ¬ä½¿ç”¨ Bech32mã€‚</p>

<p>é€™å°±æ˜¯ç‚ºä»€éº¼ P2WPKH å’Œ P2WSH åœ°å€ä»¥ bc1q é–‹é ­ï¼ˆq æ˜¯ç‰ˆæœ¬ 0 åœ¨ Bech32 ä¸­çš„è¡¨ç¤ºï¼‰ï¼Œè€Œ P2TR åœ°å€ä»¥ bc1p é–‹é ­ï¼ˆp æ˜¯ç‰ˆæœ¬ 1 åœ¨ Bech32 ä¸­çš„è¡¨ç¤ºï¼‰ã€‚</p>

<h3 id="62-åœ°å€é¡å‹è­˜åˆ¥">6.2 åœ°å€é¡å‹è­˜åˆ¥</h3>

<p>ä½œç‚ºé–‹ç™¼è€…ï¼Œäº†è§£å¦‚ä½•è­˜åˆ¥ä¸åŒçš„æ¯”ç‰¹å¹£åœ°å€é¡å‹å¾ˆæœ‰ç”¨ï¼š</p>

<p>ä»¥ 1 é–‹é ­çš„æ˜¯å‚³çµ± P2PKH åœ°å€ï¼Œä½¿ç”¨ Base58Check ç·¨ç¢¼ã€‚ä»¥ 3 é–‹é ­çš„æ˜¯ P2SH åœ°å€ï¼Œå¯èƒ½åŒ…è£ä»»ä½•é¡å‹çš„è…³æœ¬ï¼ŒåŒ…æ‹¬ SegWitï¼ˆP2SH-wrapped SegWitï¼‰ã€‚ä»¥ bc1q é–‹é ­çš„æ˜¯åŸç”Ÿ SegWit v0 åœ°å€ï¼ˆP2WPKH æˆ– P2WSHï¼‰ã€‚ä»¥ bc1p é–‹é ­çš„æ˜¯ Taprootï¼ˆP2TRï¼‰åœ°å€ã€‚</p>

<p>æ¸¬è©¦ç¶²ä½¿ç”¨ä¸åŒçš„å‰ç¶´ï¼šm æˆ– n é–‹é ­æ˜¯æ¸¬è©¦ç¶² P2PKHï¼Œ2 é–‹é ­æ˜¯æ¸¬è©¦ç¶² P2SHï¼Œtb1q æ˜¯æ¸¬è©¦ç¶² SegWit v0ï¼Œtb1p æ˜¯æ¸¬è©¦ç¶² Taprootã€‚</p>

<hr />

<h2 id="ä¸ƒå¯¦éš›æ‡‰ç”¨æ¡ˆä¾‹">ä¸ƒã€å¯¦éš›æ‡‰ç”¨æ¡ˆä¾‹</h2>

<h3 id="71-é–ƒé›»ç¶²è·¯é€šé“">7.1 é–ƒé›»ç¶²è·¯é€šé“</h3>

<p>é–ƒé›»ç¶²è·¯æ˜¯ Taproot æœ€é‡è¦çš„å—ç›Šè€…ä¹‹ä¸€ã€‚å‚³çµ±çš„é–ƒé›»ç¶²è·¯é€šé“é–‹è¨­äº¤æ˜“ä½¿ç”¨ 2-of-2 P2WSH å¤šç°½ï¼Œåœ¨éˆä¸Šæ¸…æ™°å¯è¦‹ã€‚ä½¿ç”¨ Taprootï¼Œé€šé“é–‹è¨­åªéœ€è¦ä¸€å€‹æ™®é€šçš„ P2TR è¼¸å‡ºï¼Œç„¡æ³•èˆ‡æ™®é€šæ”¯ä»˜å€åˆ†ã€‚</p>

<p>é€šé“æ‰¿è«¾äº¤æ˜“åŒ…å«å¤šå€‹å¯èƒ½çš„èŠ±è²»è·¯å¾‘ï¼šåˆä½œé—œé–‰ã€å–®æ–¹é¢é—œé–‰ã€æ‡²ç½°äº¤æ˜“ç­‰ã€‚ä½¿ç”¨ MAST çµæ§‹ï¼Œé€™äº›è¤‡é›œçš„é‚è¼¯å¯ä»¥è¢«éš±è—åœ¨è…³æœ¬æ¨¹ä¸­ï¼Œåªåœ¨å¿…è¦æ™‚æ­ç¤ºã€‚</p>

<h3 id="72-å¤šç°½éŒ¢åŒ…">7.2 å¤šç°½éŒ¢åŒ…</h3>

<p>å°æ–¼éœ€è¦å¤šæ–¹æˆæ¬Šçš„ä¼æ¥­æˆ–é«˜åƒ¹å€¼éŒ¢åŒ…ï¼ŒTaproot æä¾›äº†é¡¯è‘—çš„éš±ç§å’Œæˆæœ¬å„ªå‹¢ã€‚ä¸€å€‹ 3-of-5 çš„å¤šç°½è¨­ç½®ï¼Œä½¿ç”¨ Schnorr èšåˆå¯ä»¥è®“æ‰€æœ‰ç°½åè€…å…±åŒç”¢ç”Ÿä¸€å€‹å–®ä¸€ç°½åã€‚åœ¨éˆä¸Šï¼Œé€™èˆ‡å€‹äººéŒ¢åŒ…çš„äº¤æ˜“çœ‹èµ·ä¾†å®Œå…¨ä¸€æ¨£ã€‚</p>

<p>å¦‚æœæŸäº›ç°½åè€…ç„¡æ³•åƒèˆ‡ï¼Œå¯ä»¥é€é script path ä½¿ç”¨å‚™ç”¨çš„é–¾å€¼æ–¹æ¡ˆï¼Œåªéœ€è¦æ­ç¤ºéœ€è¦çš„é‚£å€‹åˆ†æ”¯ã€‚</p>

<h3 id="73-éºç”¢è¦åŠƒ">7.3 éºç”¢è¦åŠƒ</h3>

<p>Taproot å°æ–¼åŠ å¯†è²¨å¹£éºç”¢è¦åŠƒä¹Ÿå¾ˆæœ‰ç”¨ã€‚å‡è¨­ Alice æƒ³è¨­ç½®ä¸€å€‹è¼¸å‡ºï¼šæ­£å¸¸æƒ…æ³ä¸‹å¥¹è‡ªå·±å¯ä»¥èŠ±è²»ï¼Œä½†å¦‚æœå¥¹å¤±è¯è¶…éä¸€å¹´ï¼Œå¥¹çš„ç¹¼æ‰¿äººå¯ä»¥é€é 2-of-3 å¤šç°½ä¾†èŠ±è²»ã€‚</p>

<p>ä½¿ç”¨ Taprootï¼ŒAlice çš„å…¬é‘°å¯ä»¥ä½œç‚º key pathâ€”â€”æ—¥å¸¸ä½¿ç”¨æ™‚å°±åƒæ™®é€šéŒ¢åŒ…ä¸€æ¨£ã€‚è…³æœ¬æ¨¹ä¸­åŒ…å«ä¸€å€‹å¸¶æ™‚é–“é–çš„ç¹¼æ‰¿äººå¤šç°½è…³æœ¬ã€‚åªæœ‰ç•¶ Alice çœŸçš„ç„¡æ³•ä½¿ç”¨ key path æ™‚ï¼Œç¹¼æ‰¿äººæ‰éœ€è¦æ­ç¤ºé€™å€‹è…³æœ¬ã€‚</p>

<hr />

<h2 id="å…«å¯¦ä½œç·´ç¿’">å…«ã€å¯¦ä½œç·´ç¿’</h2>

<h3 id="ç·´ç¿’-1å‰µå»º-taproot-åœ°å€">ç·´ç¿’ 1ï¼šå‰µå»º Taproot åœ°å€</h3>

<p>å˜—è©¦ç”¨ä½ ç†Ÿæ‚‰çš„ç¨‹å¼èªè¨€å‰µå»ºä¸€å€‹ç°¡å–®çš„ Taproot åœ°å€ã€‚æ­¥é©ŸåŒ…æ‹¬ï¼šç”Ÿæˆä¸€å€‹éš¨æ©Ÿç§é‘°ï¼Œè¨ˆç®—å°æ‡‰çš„å…¬é‘°ï¼ˆæ³¨æ„è½‰æ›ç‚º x-only æ ¼å¼ï¼‰ï¼Œè¨ˆç®—ç„¡è…³æœ¬çš„ tap tweakï¼Œèª¿æ•´å…¬é‘°ï¼Œä½¿ç”¨ Bech32m ç·¨ç¢¼ç”Ÿæˆåœ°å€ã€‚</p>

<h3 id="ç·´ç¿’-2è¨­è¨ˆè…³æœ¬æ¨¹">ç·´ç¿’ 2ï¼šè¨­è¨ˆè…³æœ¬æ¨¹</h3>

<p>è¨­è¨ˆä¸€å€‹ Taproot è¼¸å‡ºï¼Œæ”¯æ´ä»¥ä¸‹å ´æ™¯ï¼šAlice å’Œ Bob å¯ä»¥éš¨æ™‚å…±åŒç°½åï¼ˆkey pathï¼‰ï¼ŒAlice å¯ä»¥åœ¨ 30 å¤©å¾Œå–®ç¨èŠ±è²»ï¼ŒCarol å¯ä»¥åœ¨ 180 å¤©å¾Œä½œç‚ºç·Šæ€¥æ¢å¾©ã€‚ç•«å‡ºè…³æœ¬æ¨¹çµæ§‹ï¼Œä¸¦è€ƒæ…®å¦‚ä½•å„ªåŒ–æ¨¹çš„æ·±åº¦ä»¥æœ€å°åŒ–æœªä¾†å¯èƒ½çš„è¦‹è­‰å¤§å°ã€‚</p>

<h3 id="ç·´ç¿’-3æ¯”è¼ƒæ•ˆç‡">ç·´ç¿’ 3ï¼šæ¯”è¼ƒæ•ˆç‡</h3>

<p>è¨ˆç®—ä»¥ä¸‹å ´æ™¯çš„ witness å¤§å°ï¼š2-of-3 å¤šç°½ä½¿ç”¨å‚³çµ± P2SHã€ä½¿ç”¨ P2WSHã€ä½¿ç”¨ Taproot key pathï¼ˆå‡è¨­ MuSig2 èšåˆï¼‰ã€ä½¿ç”¨ Taproot script pathã€‚åˆ†æä¸åŒæ–¹æ¡ˆçš„æ¬Šè¡¡ã€‚</p>

<hr />

<h2 id="ä¹å°çµ">ä¹ã€å°çµ</h2>

<p>æœ¬ç¯‡æˆ‘å€‘æ·±å…¥æ¢è¨äº†æ¯”ç‰¹å¹£å…©å€‹æœ€é‡è¦çš„å‡ç´šï¼š</p>

<p><strong>SegWit çš„è²¢ç»</strong>åŒ…æ‹¬ï¼šè§£æ±ºäº†äº¤æ˜“å»¶å±•æ€§å•é¡Œï¼Œä½¿é–ƒé›»ç¶²è·¯ç­‰äºŒå±¤å”è­°æˆç‚ºå¯èƒ½ï¼›æå‡äº†æœ‰æ•ˆå€å¡Šå®¹é‡ï¼›å„ªåŒ–äº†ç°½åé›œæ¹Šè¨ˆç®—çš„æ•ˆç‡ï¼›å¼•å…¥äº†ç‰ˆæœ¬åŒ–çš„ witness ç¨‹å¼ï¼Œç‚ºæœªä¾†å‡ç´šå¥ å®šåŸºç¤ã€‚</p>

<p><strong>Taproot çš„å‰µæ–°</strong>åŒ…æ‹¬ï¼šå¼•å…¥ Schnorr ç°½åï¼Œæä¾›æ›´é«˜æ•ˆçš„ç°½åå’Œæ‰¹é‡é©—è­‰ï¼›å¯¦ç¾ MASTï¼Œå…è¨±è¤‡é›œè…³æœ¬ä¿æŒç§å¯†ï¼›é€é key path/script path é›™è·¯å¾‘è¨­è¨ˆï¼Œè®“å¤§å¤šæ•¸äº¤æ˜“çœ‹èµ·ä¾†åƒç°¡å–®çš„å–®ç°½åï¼›Tapscript æ”¹é€²äº†è…³æœ¬èªè¨€ä¸¦ç‚ºæœªä¾†å‡ç´šé ç•™ç©ºé–“ã€‚</p>

<p>é€™äº›æŠ€è¡“ä¸åƒ…æå‡äº†æ¯”ç‰¹å¹£çš„æ•ˆç‡å’Œå¯æ“´å±•æ€§ï¼Œæ›´é‡è¦çš„æ˜¯å¤§å¹…å¢å¼·äº†éš±ç§æ€§â€”â€”è®“è¤‡é›œçš„æ™ºèƒ½åˆç´„åœ¨éˆä¸Šçœ‹èµ·ä¾†èˆ‡æ™®é€šäº¤æ˜“ç„¡ç•°ã€‚</p>

<hr />

<h2 id="ä¸‹ä¸€ç¯‡é å‘Š">ä¸‹ä¸€ç¯‡é å‘Š</h2>

<p>åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å€‘å°‡æ¢è¨å¤šé‡ç°½åçš„å„ç¨®å¯¦ç¾æ–¹å¼ï¼ŒåŒ…æ‹¬å‚³çµ±çš„ OP_CHECKMULTISIGã€Tapscript çš„ OP_CHECKSIGADDã€ä»¥åŠ MuSig2 å”è­°çš„ç´°ç¯€ã€‚</p>

<hr />

<h2 id="åƒè€ƒè³‡æ–™">åƒè€ƒè³‡æ–™</h2>

<ul>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki">BIP 141: SegWit</a> - SegWit çš„åŸå§‹è¦æ ¼</li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0143.mediawiki">BIP 143: SegWit ç°½åå“ˆå¸Œ</a> - æ–°çš„ç°½åé›œæ¹Šæ¼”ç®—æ³•</li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki">BIP 340: Schnorr ç°½å</a> - Schnorr ç°½åçš„æ¯”ç‰¹å¹£æ¨™æº–</li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki">BIP 341: Taproot</a> - Taproot çš„å®Œæ•´è¦æ ¼</li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0342.mediawiki">BIP 342: Tapscript</a> - Tapscript è…³æœ¬è¦å‰‡</li>
  <li><a href="https://github.com/bitcoin/bips/blob/master/bip-0350.mediawiki">BIP 350: Bech32m</a> - æ”¹é€²çš„åœ°å€ç·¨ç¢¼</li>
  <li><a href="https://bitcoinops.org/en/topics/taproot/">Bitcoin Optech: Taproot</a> - æ·±å…¥çš„æŠ€è¡“è§£èªª</li>
</ul>]]></content><author><name>Cypherpunks Taiwan</name></author><category term="æŠ€è¡“æ•™å­¸" /><category term="bitcoin" /><category term="development" /><category term="bitcoin" /><category term="script" /><category term="segwit" /><category term="taproot" /><category term="schnorr" /><summary type="html"><![CDATA[Bitcoin Script ç³»åˆ—ç¬¬ä¸‰ç¯‡ï¼Œæ·±å…¥è§£æ SegWit çš„æŠ€è¡“ç´°ç¯€ã€Taproot å‡ç´šã€Schnorr ç°½åï¼Œä»¥åŠ Tapscript çš„æ–°æ“ä½œç¢¼ã€‚]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" /><media:content medium="image" url="https://cypherpunks-core.github.io/img/bitcoin-dev.svg" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>